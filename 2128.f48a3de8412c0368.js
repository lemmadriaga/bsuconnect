"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[2128],{2128:(Xy,Ff,ge)=>{ge.d(Ff,{m:()=>py});var Ut,Bu,b=ge(467),nr=ge(4572),gt=ge(7673),Ds=ge(8455),fn=ge(5558),mn=ge(6354),rr=ge(9437),Fu=ge(7935),Mf=ge(4412),Of=ge(3345),hi=ge(8742),Mu=ge(1362),Qe=ge(8041),ee=ge(1076),Ou=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},Lu={};(function(){var r;function n(){this.blockSize=-1,this.blockSize=64,this.g=Array(4),this.B=Array(this.blockSize),this.o=this.h=0,this.s()}function i(T,g,I){I||(I=0);var E=Array(16);if("string"==typeof g)for(var v=0;16>v;++v)E[v]=g.charCodeAt(I++)|g.charCodeAt(I++)<<8|g.charCodeAt(I++)<<16|g.charCodeAt(I++)<<24;else for(v=0;16>v;++v)E[v]=g[I++]|g[I++]<<8|g[I++]<<16|g[I++]<<24;var P=T.g[3],y=(g=T.g[0])+(P^(I=T.g[1])&((v=T.g[2])^P))+E[0]+3614090360&4294967295;y=(I=(v=(P=(g=(I=(v=(P=(g=(I=(v=(P=(g=(I=(v=(P=(g=(I=(v=(P=(g=(I=(v=(P=(g=(I=(v=(P=(g=(I=(v=(P=(g=(I=(v=(P=(g=(I=(v=(P=(g=(I=(v=(P=(g=(I=(v=(P=(g=(I=(v=(P=(g=(I=(v=(P=(g=(I=(v=(P=(g=I+(y<<7&4294967295|y>>>25))+((y=P+(v^g&(I^v))+E[1]+3905402710&4294967295)<<12&4294967295|y>>>20))+((y=v+(I^P&(g^I))+E[2]+606105819&4294967295)<<17&4294967295|y>>>15))+((y=I+(g^v&(P^g))+E[3]+3250441966&4294967295)<<22&4294967295|y>>>10))+((y=g+(P^I&(v^P))+E[4]+4118548399&4294967295)<<7&4294967295|y>>>25))+((y=P+(v^g&(I^v))+E[5]+1200080426&4294967295)<<12&4294967295|y>>>20))+((y=v+(I^P&(g^I))+E[6]+2821735955&4294967295)<<17&4294967295|y>>>15))+((y=I+(g^v&(P^g))+E[7]+4249261313&4294967295)<<22&4294967295|y>>>10))+((y=g+(P^I&(v^P))+E[8]+1770035416&4294967295)<<7&4294967295|y>>>25))+((y=P+(v^g&(I^v))+E[9]+2336552879&4294967295)<<12&4294967295|y>>>20))+((y=v+(I^P&(g^I))+E[10]+4294925233&4294967295)<<17&4294967295|y>>>15))+((y=I+(g^v&(P^g))+E[11]+2304563134&4294967295)<<22&4294967295|y>>>10))+((y=g+(P^I&(v^P))+E[12]+1804603682&4294967295)<<7&4294967295|y>>>25))+((y=P+(v^g&(I^v))+E[13]+4254626195&4294967295)<<12&4294967295|y>>>20))+((y=v+(I^P&(g^I))+E[14]+2792965006&4294967295)<<17&4294967295|y>>>15))+((y=I+(g^v&(P^g))+E[15]+1236535329&4294967295)<<22&4294967295|y>>>10))+((y=g+(v^P&(I^v))+E[1]+4129170786&4294967295)<<5&4294967295|y>>>27))+((y=P+(I^v&(g^I))+E[6]+3225465664&4294967295)<<9&4294967295|y>>>23))+((y=v+(g^I&(P^g))+E[11]+643717713&4294967295)<<14&4294967295|y>>>18))+((y=I+(P^g&(v^P))+E[0]+3921069994&4294967295)<<20&4294967295|y>>>12))+((y=g+(v^P&(I^v))+E[5]+3593408605&4294967295)<<5&4294967295|y>>>27))+((y=P+(I^v&(g^I))+E[10]+38016083&4294967295)<<9&4294967295|y>>>23))+((y=v+(g^I&(P^g))+E[15]+3634488961&4294967295)<<14&4294967295|y>>>18))+((y=I+(P^g&(v^P))+E[4]+3889429448&4294967295)<<20&4294967295|y>>>12))+((y=g+(v^P&(I^v))+E[9]+568446438&4294967295)<<5&4294967295|y>>>27))+((y=P+(I^v&(g^I))+E[14]+3275163606&4294967295)<<9&4294967295|y>>>23))+((y=v+(g^I&(P^g))+E[3]+4107603335&4294967295)<<14&4294967295|y>>>18))+((y=I+(P^g&(v^P))+E[8]+1163531501&4294967295)<<20&4294967295|y>>>12))+((y=g+(v^P&(I^v))+E[13]+2850285829&4294967295)<<5&4294967295|y>>>27))+((y=P+(I^v&(g^I))+E[2]+4243563512&4294967295)<<9&4294967295|y>>>23))+((y=v+(g^I&(P^g))+E[7]+1735328473&4294967295)<<14&4294967295|y>>>18))+((y=I+(P^g&(v^P))+E[12]+2368359562&4294967295)<<20&4294967295|y>>>12))+((y=g+(I^v^P)+E[5]+4294588738&4294967295)<<4&4294967295|y>>>28))+((y=P+(g^I^v)+E[8]+2272392833&4294967295)<<11&4294967295|y>>>21))+((y=v+(P^g^I)+E[11]+1839030562&4294967295)<<16&4294967295|y>>>16))+((y=I+(v^P^g)+E[14]+4259657740&4294967295)<<23&4294967295|y>>>9))+((y=g+(I^v^P)+E[1]+2763975236&4294967295)<<4&4294967295|y>>>28))+((y=P+(g^I^v)+E[4]+1272893353&4294967295)<<11&4294967295|y>>>21))+((y=v+(P^g^I)+E[7]+4139469664&4294967295)<<16&4294967295|y>>>16))+((y=I+(v^P^g)+E[10]+3200236656&4294967295)<<23&4294967295|y>>>9))+((y=g+(I^v^P)+E[13]+681279174&4294967295)<<4&4294967295|y>>>28))+((y=P+(g^I^v)+E[0]+3936430074&4294967295)<<11&4294967295|y>>>21))+((y=v+(P^g^I)+E[3]+3572445317&4294967295)<<16&4294967295|y>>>16))+((y=I+(v^P^g)+E[6]+76029189&4294967295)<<23&4294967295|y>>>9))+((y=g+(I^v^P)+E[9]+3654602809&4294967295)<<4&4294967295|y>>>28))+((y=P+(g^I^v)+E[12]+3873151461&4294967295)<<11&4294967295|y>>>21))+((y=v+(P^g^I)+E[15]+530742520&4294967295)<<16&4294967295|y>>>16))+((y=I+(v^P^g)+E[2]+3299628645&4294967295)<<23&4294967295|y>>>9))+((y=g+(v^(I|~P))+E[0]+4096336452&4294967295)<<6&4294967295|y>>>26))+((y=P+(I^(g|~v))+E[7]+1126891415&4294967295)<<10&4294967295|y>>>22))+((y=v+(g^(P|~I))+E[14]+2878612391&4294967295)<<15&4294967295|y>>>17))+((y=I+(P^(v|~g))+E[5]+4237533241&4294967295)<<21&4294967295|y>>>11))+((y=g+(v^(I|~P))+E[12]+1700485571&4294967295)<<6&4294967295|y>>>26))+((y=P+(I^(g|~v))+E[3]+2399980690&4294967295)<<10&4294967295|y>>>22))+((y=v+(g^(P|~I))+E[10]+4293915773&4294967295)<<15&4294967295|y>>>17))+((y=I+(P^(v|~g))+E[1]+2240044497&4294967295)<<21&4294967295|y>>>11))+((y=g+(v^(I|~P))+E[8]+1873313359&4294967295)<<6&4294967295|y>>>26))+((y=P+(I^(g|~v))+E[15]+4264355552&4294967295)<<10&4294967295|y>>>22))+((y=v+(g^(P|~I))+E[6]+2734768916&4294967295)<<15&4294967295|y>>>17))+((y=I+(P^(v|~g))+E[13]+1309151649&4294967295)<<21&4294967295|y>>>11))+((P=(g=I+((y=g+(v^(I|~P))+E[4]+4149444226&4294967295)<<6&4294967295|y>>>26))+((y=P+(I^(g|~v))+E[11]+3174756917&4294967295)<<10&4294967295|y>>>22))^((v=P+((y=v+(g^(P|~I))+E[2]+718787259&4294967295)<<15&4294967295|y>>>17))|~g))+E[9]+3951481745&4294967295,T.g[0]=T.g[0]+g&4294967295,T.g[1]=T.g[1]+(v+(y<<21&4294967295|y>>>11))&4294967295,T.g[2]=T.g[2]+v&4294967295,T.g[3]=T.g[3]+P&4294967295}function a(T,g){this.h=g;for(var I=[],E=!0,v=T.length-1;0<=v;v--){var P=0|T[v];E&&P==g||(I[v]=P,E=!1)}this.g=I}(function e(T,g){function I(){}I.prototype=g.prototype,T.D=g.prototype,T.prototype=new I,T.prototype.constructor=T,T.C=function(E,v,P){for(var y=Array(arguments.length-2),ft=2;ft<arguments.length;ft++)y[ft-2]=arguments[ft];return g.prototype[v].apply(E,y)}})(n,function t(){this.blockSize=-1}),n.prototype.s=function(){this.g[0]=1732584193,this.g[1]=4023233417,this.g[2]=2562383102,this.g[3]=271733878,this.o=this.h=0},n.prototype.u=function(T,g){void 0===g&&(g=T.length);for(var I=g-this.blockSize,E=this.B,v=this.h,P=0;P<g;){if(0==v)for(;P<=I;)i(this,T,P),P+=this.blockSize;if("string"==typeof T){for(;P<g;)if(E[v++]=T.charCodeAt(P++),v==this.blockSize){i(this,E),v=0;break}}else for(;P<g;)if(E[v++]=T[P++],v==this.blockSize){i(this,E),v=0;break}}this.h=v,this.o+=g},n.prototype.v=function(){var T=Array((56>this.h?this.blockSize:2*this.blockSize)-this.h);T[0]=128;for(var g=1;g<T.length-8;++g)T[g]=0;var I=8*this.o;for(g=T.length-8;g<T.length;++g)T[g]=255&I,I/=256;for(this.u(T),T=Array(16),g=I=0;4>g;++g)for(var E=0;32>E;E+=8)T[I++]=this.g[g]>>>E&255;return T};var u={};function l(T){return-128<=T&&128>T?function s(T,g){var I=u;return Object.prototype.hasOwnProperty.call(I,T)?I[T]:I[T]=g(T)}(T,function(g){return new a([0|g],0>g?-1:0)}):new a([0|T],0>T?-1:0)}function h(T){if(isNaN(T)||!isFinite(T))return _;if(0>T)return D(h(-T));for(var g=[],I=1,E=0;T>=I;E++)g[E]=T/I|0,I*=4294967296;return new a(g,0)}var _=l(0),p=l(1),R=l(16777216);function x(T){if(0!=T.h)return!1;for(var g=0;g<T.g.length;g++)if(0!=T.g[g])return!1;return!0}function k(T){return-1==T.h}function D(T){for(var g=T.g.length,I=[],E=0;E<g;E++)I[E]=~T.g[E];return new a(I,~T.h).add(p)}function U(T,g){return T.add(D(g))}function $(T,g){for(;(65535&T[g])!=T[g];)T[g+1]+=T[g]>>>16,T[g]&=65535,g++}function q(T,g){this.g=T,this.h=g}function K(T,g){if(x(g))throw Error("division by zero");if(x(T))return new q(_,_);if(k(T))return g=K(D(T),g),new q(D(g.g),D(g.h));if(k(g))return g=K(T,D(g)),new q(D(g.g),g.h);if(30<T.g.length){if(k(T)||k(g))throw Error("slowDivide_ only works with positive integers.");for(var I=p,E=g;0>=E.l(T);)I=X(I),E=X(E);var v=W(I,1),P=W(E,1);for(E=W(E,2),I=W(I,2);!x(E);){var y=P.add(E);0>=y.l(T)&&(v=v.add(I),P=y),E=W(E,1),I=W(I,1)}return g=U(T,v.j(g)),new q(v,g)}for(v=_;0<=T.l(g);){for(I=Math.max(1,Math.floor(T.m()/g.m())),E=48>=(E=Math.ceil(Math.log(I)/Math.LN2))?1:Math.pow(2,E-48),y=(P=h(I)).j(g);k(y)||0<y.l(T);)y=(P=h(I-=E)).j(g);x(P)&&(P=p),v=v.add(P),T=U(T,y)}return new q(v,T)}function X(T){for(var g=T.g.length+1,I=[],E=0;E<g;E++)I[E]=T.i(E)<<1|T.i(E-1)>>>31;return new a(I,T.h)}function W(T,g){var I=g>>5;g%=32;for(var E=T.g.length-I,v=[],P=0;P<E;P++)v[P]=0<g?T.i(P+I)>>>g|T.i(P+I+1)<<32-g:T.i(P+I);return new a(v,T.h)}(r=a.prototype).m=function(){if(k(this))return-D(this).m();for(var T=0,g=1,I=0;I<this.g.length;I++){var E=this.i(I);T+=(0<=E?E:4294967296+E)*g,g*=4294967296}return T},r.toString=function(T){if(2>(T=T||10)||36<T)throw Error("radix out of range: "+T);if(x(this))return"0";if(k(this))return"-"+D(this).toString(T);for(var g=h(Math.pow(T,6)),I=this,E="";;){var v=K(I,g).g,P=((0<(I=U(I,v.j(g))).g.length?I.g[0]:I.h)>>>0).toString(T);if(x(I=v))return P+E;for(;6>P.length;)P="0"+P;E=P+E}},r.i=function(T){return 0>T?0:T<this.g.length?this.g[T]:this.h},r.l=function(T){return k(T=U(this,T))?-1:x(T)?0:1},r.abs=function(){return k(this)?D(this):this},r.add=function(T){for(var g=Math.max(this.g.length,T.g.length),I=[],E=0,v=0;v<=g;v++){var P=E+(65535&this.i(v))+(65535&T.i(v)),y=(P>>>16)+(this.i(v)>>>16)+(T.i(v)>>>16);E=y>>>16,I[v]=(y&=65535)<<16|(P&=65535)}return new a(I,-2147483648&I[I.length-1]?-1:0)},r.j=function(T){if(x(this)||x(T))return _;if(k(this))return k(T)?D(this).j(D(T)):D(D(this).j(T));if(k(T))return D(this.j(D(T)));if(0>this.l(R)&&0>T.l(R))return h(this.m()*T.m());for(var g=this.g.length+T.g.length,I=[],E=0;E<2*g;E++)I[E]=0;for(E=0;E<this.g.length;E++)for(var v=0;v<T.g.length;v++){var P=this.i(E)>>>16,y=65535&this.i(E),ft=T.i(v)>>>16,jr=65535&T.i(v);I[2*E+2*v]+=y*jr,$(I,2*E+2*v),I[2*E+2*v+1]+=P*jr,$(I,2*E+2*v+1),I[2*E+2*v+1]+=y*ft,$(I,2*E+2*v+1),I[2*E+2*v+2]+=P*ft,$(I,2*E+2*v+2)}for(E=0;E<g;E++)I[E]=I[2*E+1]<<16|I[2*E];for(E=g;E<2*g;E++)I[E]=0;return new a(I,0)},r.A=function(T){return K(this,T).h},r.and=function(T){for(var g=Math.max(this.g.length,T.g.length),I=[],E=0;E<g;E++)I[E]=this.i(E)&T.i(E);return new a(I,this.h&T.h)},r.or=function(T){for(var g=Math.max(this.g.length,T.g.length),I=[],E=0;E<g;E++)I[E]=this.i(E)|T.i(E);return new a(I,this.h|T.h)},r.xor=function(T){for(var g=Math.max(this.g.length,T.g.length),I=[],E=0;E<g;E++)I[E]=this.i(E)^T.i(E);return new a(I,this.h^T.h)},n.prototype.digest=n.prototype.v,n.prototype.reset=n.prototype.s,n.prototype.update=n.prototype.u,Bu=Lu.Md5=n,a.prototype.add=a.prototype.add,a.prototype.multiply=a.prototype.j,a.prototype.modulo=a.prototype.A,a.prototype.compare=a.prototype.l,a.prototype.toNumber=a.prototype.m,a.prototype.toString=a.prototype.toString,a.prototype.getBits=a.prototype.i,a.fromNumber=h,a.fromString=function f(T,g){if(0==T.length)throw Error("number format error: empty string");if(2>(g=g||10)||36<g)throw Error("radix out of range: "+g);if("-"==T.charAt(0))return D(f(T.substring(1),g));if(0<=T.indexOf("-"))throw Error('number format error: interior "-" character');for(var I=h(Math.pow(g,8)),E=_,v=0;v<T.length;v+=8){var P=Math.min(8,T.length-v),y=parseInt(T.substring(v,v+P),g);8>P?(P=h(Math.pow(g,P)),E=E.j(P).add(h(y))):E=(E=E.j(I)).add(h(y))}return E},Ut=Lu.Integer=a}).apply(typeof Ou<"u"?Ou:typeof self<"u"?self:typeof window<"u"?window:{});var Uu,ir,qu,fi,Ns,zu,$u,Gu,di=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},nt={};(function(){var r,e="function"==typeof Object.defineProperties?Object.defineProperty:function(o,c,d){return o==Array.prototype||o==Object.prototype||(o[c]=d.value),o},n=function t(o){o=["object"==typeof globalThis&&globalThis,o,"object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof di&&di];for(var c=0;c<o.length;++c){var d=o[c];if(d&&d.Math==Math)return d}throw Error("Cannot find global object")}(this);!function i(o,c){if(c)e:{var d=n;o=o.split(".");for(var m=0;m<o.length-1;m++){var A=o[m];if(!(A in d))break e;d=d[A]}(c=c(m=d[o=o[o.length-1]]))!=m&&null!=c&&e(d,o,{configurable:!0,writable:!0,value:c})}}("Array.prototype.values",function(o){return o||function(){return function s(o,c){o instanceof String&&(o+="");var d=0,m=!1,A={next:function(){if(!m&&d<o.length){var S=d++;return{value:c(S,o[S]),done:!1}}return m=!0,{done:!0,value:void 0}}};return A[Symbol.iterator]=function(){return A},A}(this,function(c,d){return d})}});var a=a||{},u=this||self;function l(o){var c=typeof o;return"array"==(c="object"!=c?c:o?Array.isArray(o)?"array":c:"null")||"object"==c&&"number"==typeof o.length}function h(o){var c=typeof o;return"object"==c&&null!=o||"function"==c}function f(o,c,d){return o.call.apply(o.bind,arguments)}function _(o,c,d){if(!o)throw Error();if(2<arguments.length){var m=Array.prototype.slice.call(arguments,2);return function(){var A=Array.prototype.slice.call(arguments);return Array.prototype.unshift.apply(A,m),o.apply(c,A)}}return function(){return o.apply(c,arguments)}}function p(o,c,d){return(p=Function.prototype.bind&&-1!=Function.prototype.bind.toString().indexOf("native code")?f:_).apply(null,arguments)}function R(o,c){var d=Array.prototype.slice.call(arguments,1);return function(){var m=d.slice();return m.push.apply(m,arguments),o.apply(this,m)}}function x(o,c){function d(){}d.prototype=c.prototype,o.aa=c.prototype,o.prototype=new d,o.prototype.constructor=o,o.Qb=function(m,A,S){for(var M=Array(arguments.length-2),ie=2;ie<arguments.length;ie++)M[ie-2]=arguments[ie];return c.prototype[A].apply(m,M)}}function k(o){const c=o.length;if(0<c){const d=Array(c);for(let m=0;m<c;m++)d[m]=o[m];return d}return[]}function D(o,c){for(let d=1;d<arguments.length;d++){const m=arguments[d];if(l(m)){const A=o.length||0,S=m.length||0;o.length=A+S;for(let M=0;M<S;M++)o[A+M]=m[M]}else o.push(m)}}function $(o){return/^[\s\xa0]*$/.test(o)}function q(){var o=u.navigator;return o&&(o=o.userAgent)?o:""}function K(o){return K[" "](o),o}K[" "]=function(){};var X=!(-1==q().indexOf("Gecko")||-1!=q().toLowerCase().indexOf("webkit")&&-1==q().indexOf("Edge")||-1!=q().indexOf("Trident")||-1!=q().indexOf("MSIE")||-1!=q().indexOf("Edge"));function W(o,c,d){for(const m in o)c.call(d,o[m],m,o)}function g(o){const c={};for(const d in o)c[d]=o[d];return c}const I="constructor hasOwnProperty isPrototypeOf propertyIsEnumerable toLocaleString toString valueOf".split(" ");function E(o,c){let d,m;for(let A=1;A<arguments.length;A++){for(d in m=arguments[A],m)o[d]=m[d];for(let S=0;S<I.length;S++)d=I[S],Object.prototype.hasOwnProperty.call(m,d)&&(o[d]=m[d])}}function v(o){var c=1;o=o.split(":");const d=[];for(;0<c&&o.length;)d.push(o.shift()),c--;return o.length&&d.push(o.join(":")),d}function P(o){u.setTimeout(()=>{throw o},0)}function y(){var o=cu;let c=null;return o.g&&(c=o.g,o.g=o.g.next,o.g||(o.h=null),c.next=null),c}var jr=new class U{constructor(c,d){this.i=c,this.j=d,this.h=0,this.g=null}get(){let c;return 0<this.h?(this.h--,c=this.g,this.g=c.next,c.next=null):c=this.i(),c}}(()=>new yy,o=>o.reset());class yy{constructor(){this.next=this.g=this.h=null}set(c,d){this.h=c,this.g=d,this.next=null}reset(){this.next=this.g=this.h=null}}let Wr,Qr=!1,cu=new class ft{constructor(){this.h=this.g=null}add(c,d){const m=jr.get();m.set(c,d),this.h?this.h.next=m:this.g=m,this.h=m}},Nd=()=>{const o=u.Promise.resolve(void 0);Wr=()=>{o.then(Iy)}};var Iy=()=>{for(var o;o=y();){try{o.h.call(o.g)}catch(d){P(d)}var c=jr;c.j(o),100>c.h&&(c.h++,o.next=c.g,c.g=o)}Qr=!1};function Mt(){this.s=this.s,this.C=this.C}function De(o,c){this.type=o,this.g=this.target=c,this.defaultPrevented=!1}Mt.prototype.s=!1,Mt.prototype.ma=function(){this.s||(this.s=!0,this.N())},Mt.prototype.N=function(){if(this.C)for(;this.C.length;)this.C.shift()()},De.prototype.h=function(){this.defaultPrevented=!0};var Ty=function(){if(!u.addEventListener||!Object.defineProperty)return!1;var o=!1,c=Object.defineProperty({},"passive",{get:function(){o=!0}});try{const d=()=>{};u.addEventListener("test",d,c),u.removeEventListener("test",d,c)}catch{}return o}();function Hr(o,c){if(De.call(this,o?o.type:""),this.relatedTarget=this.g=this.target=null,this.button=this.screenY=this.screenX=this.clientY=this.clientX=0,this.key="",this.metaKey=this.shiftKey=this.altKey=this.ctrlKey=!1,this.state=null,this.pointerId=0,this.pointerType="",this.i=null,o){var d=this.type=o.type,m=o.changedTouches&&o.changedTouches.length?o.changedTouches[0]:null;if(this.target=o.target||o.srcElement,this.g=c,c=o.relatedTarget){if(X){e:{try{K(c.nodeName);var A=!0;break e}catch{}A=!1}A||(c=null)}}else"mouseover"==d?c=o.fromElement:"mouseout"==d&&(c=o.toElement);this.relatedTarget=c,m?(this.clientX=void 0!==m.clientX?m.clientX:m.pageX,this.clientY=void 0!==m.clientY?m.clientY:m.pageY,this.screenX=m.screenX||0,this.screenY=m.screenY||0):(this.clientX=void 0!==o.clientX?o.clientX:o.pageX,this.clientY=void 0!==o.clientY?o.clientY:o.pageY,this.screenX=o.screenX||0,this.screenY=o.screenY||0),this.button=o.button,this.key=o.key||"",this.ctrlKey=o.ctrlKey,this.altKey=o.altKey,this.shiftKey=o.shiftKey,this.metaKey=o.metaKey,this.pointerId=o.pointerId||0,this.pointerType="string"==typeof o.pointerType?o.pointerType:Ey[o.pointerType]||"",this.state=o.state,this.i=o,o.defaultPrevented&&Hr.aa.h.call(this)}}x(Hr,De);var Ey={2:"touch",3:"pen",4:"mouse"};Hr.prototype.h=function(){Hr.aa.h.call(this);var o=this.i;o.preventDefault?o.preventDefault():o.returnValue=!1};var Jr="closure_listenable_"+(1e6*Math.random()|0),vy=0;function Ay(o,c,d,m,A){this.listener=o,this.proxy=null,this.src=c,this.type=d,this.capture=!!m,this.ha=A,this.key=++vy,this.da=this.fa=!1}function _s(o){o.da=!0,o.listener=null,o.proxy=null,o.src=null,o.ha=null}function gs(o){this.src=o,this.g={},this.h=0}function hu(o,c){var d=c.type;if(d in o.g){var S,m=o.g[d],A=Array.prototype.indexOf.call(m,c,void 0);(S=0<=A)&&Array.prototype.splice.call(m,A,1),S&&(_s(c),0==o.g[d].length&&(delete o.g[d],o.h--))}}function du(o,c,d,m){for(var A=0;A<o.length;++A){var S=o[A];if(!S.da&&S.listener==c&&S.capture==!!d&&S.ha==m)return A}return-1}gs.prototype.add=function(o,c,d,m,A){var S=o.toString();(o=this.g[S])||(o=this.g[S]=[],this.h++);var M=du(o,c,m,A);return-1<M?(c=o[M],d||(c.fa=!1)):((c=new Ay(c,this.src,S,!!m,A)).fa=d,o.push(c)),c};var fu="closure_lm_"+(1e6*Math.random()|0),mu={};function kd(o,c,d,m,A){if(m&&m.once)return Md(o,c,d,m,A);if(Array.isArray(c)){for(var S=0;S<c.length;S++)kd(o,c[S],d,m,A);return null}return d=yu(d),o&&o[Jr]?o.K(c,d,h(m)?!!m.capture:!!m,A):Fd(o,c,d,!1,m,A)}function Fd(o,c,d,m,A,S){if(!c)throw Error("Invalid event type");var M=h(A)?!!A.capture:!!A,ie=gu(o);if(ie||(o[fu]=ie=new gs(o)),(d=ie.add(c,d,m,M,S)).proxy)return d;if(m=function wy(){const c=Ry;return function o(d){return c.call(o.src,o.listener,d)}}(),d.proxy=m,m.src=o,m.listener=d,o.addEventListener)Ty||(A=M),void 0===A&&(A=!1),o.addEventListener(c.toString(),m,A);else if(o.attachEvent)o.attachEvent(Ld(c.toString()),m);else{if(!o.addListener||!o.removeListener)throw Error("addEventListener and attachEvent are unavailable.");o.addListener(m)}return d}function Md(o,c,d,m,A){if(Array.isArray(c)){for(var S=0;S<c.length;S++)Md(o,c[S],d,m,A);return null}return d=yu(d),o&&o[Jr]?o.L(c,d,h(m)?!!m.capture:!!m,A):Fd(o,c,d,!0,m,A)}function Od(o,c,d,m,A){if(Array.isArray(c))for(var S=0;S<c.length;S++)Od(o,c[S],d,m,A);else m=h(m)?!!m.capture:!!m,d=yu(d),o&&o[Jr]?(o=o.i,(c=String(c).toString())in o.g&&-1<(d=du(S=o.g[c],d,m,A))&&(_s(S[d]),Array.prototype.splice.call(S,d,1),0==S.length&&(delete o.g[c],o.h--))):o&&(o=gu(o))&&(c=o.g[c.toString()],o=-1,c&&(o=du(c,d,m,A)),(d=-1<o?c[o]:null)&&_u(d))}function _u(o){if("number"!=typeof o&&o&&!o.da){var c=o.src;if(c&&c[Jr])hu(c.i,o);else{var d=o.type,m=o.proxy;c.removeEventListener?c.removeEventListener(d,m,o.capture):c.detachEvent?c.detachEvent(Ld(d),m):c.addListener&&c.removeListener&&c.removeListener(m),(d=gu(c))?(hu(d,o),0==d.h&&(d.src=null,c[fu]=null)):_s(o)}}}function Ld(o){return o in mu?mu[o]:mu[o]="on"+o}function Ry(o,c){if(o.da)o=!0;else{c=new Hr(c,this);var d=o.listener,m=o.ha||o.src;o.fa&&_u(o),o=d.call(m,c)}return o}function gu(o){return(o=o[fu])instanceof gs?o:null}var pu="__closure_events_fn_"+(1e9*Math.random()>>>0);function yu(o){return"function"==typeof o?o:(o[pu]||(o[pu]=function(c){return o.handleEvent(c)}),o[pu])}function Ne(){Mt.call(this),this.i=new gs(this),this.M=this,this.F=null}function Le(o,c){var d,m=o.F;if(m)for(d=[];m;m=m.F)d.push(m);if(o=o.M,m=c.type||c,"string"==typeof c)c=new De(c,o);else if(c instanceof De)c.target=c.target||o;else{var A=c;E(c=new De(m,o),A)}if(A=!0,d)for(var S=d.length-1;0<=S;S--){var M=c.g=d[S];A=ps(M,m,!0,c)&&A}if(A=ps(M=c.g=o,m,!0,c)&&A,A=ps(M,m,!1,c)&&A,d)for(S=0;S<d.length;S++)A=ps(M=c.g=d[S],m,!1,c)&&A}function ps(o,c,d,m){if(!(c=o.i.g[String(c)]))return!0;c=c.concat();for(var A=!0,S=0;S<c.length;++S){var M=c[S];if(M&&!M.da&&M.capture==d){var ie=M.listener,Ve=M.ha||M.src;M.fa&&hu(o.i,M),A=!1!==ie.call(Ve,m)&&A}}return A&&!m.defaultPrevented}function Bd(o,c,d){if("function"==typeof o)d&&(o=p(o,d));else{if(!o||"function"!=typeof o.handleEvent)throw Error("Invalid listener argument");o=p(o.handleEvent,o)}return 2147483647<Number(c)?-1:u.setTimeout(o,c||0)}function Ud(o){o.g=Bd(()=>{o.g=null,o.i&&(o.i=!1,Ud(o))},o.l);const c=o.h;o.h=null,o.m.apply(null,c)}x(Ne,Mt),Ne.prototype[Jr]=!0,Ne.prototype.removeEventListener=function(o,c,d,m){Od(this,o,c,d,m)},Ne.prototype.N=function(){if(Ne.aa.N.call(this),this.i){var c,o=this.i;for(c in o.g){for(var d=o.g[c],m=0;m<d.length;m++)_s(d[m]);delete o.g[c],o.h--}}this.F=null},Ne.prototype.K=function(o,c,d,m){return this.i.add(String(o),c,!1,d,m)},Ne.prototype.L=function(o,c,d,m){return this.i.add(String(o),c,!0,d,m)};class Py extends Mt{constructor(c,d){super(),this.m=c,this.l=d,this.h=null,this.i=!1,this.g=null}j(c){this.h=arguments,this.g?this.i=!0:Ud(this)}N(){super.N(),this.g&&(u.clearTimeout(this.g),this.g=null,this.i=!1,this.h=null)}}function Yr(o){Mt.call(this),this.h=o,this.g={}}x(Yr,Mt);var qd=[];function zd(o){W(o.g,function(c,d){this.g.hasOwnProperty(d)&&_u(c)},o),o.g={}}Yr.prototype.N=function(){Yr.aa.N.call(this),zd(this)},Yr.prototype.handleEvent=function(){throw Error("EventHandler.handleEvent not implemented")};var Iu=u.JSON.stringify,Vy=u.JSON.parse,Sy=class{stringify(o){return u.JSON.stringify(o,void 0)}parse(o){return u.JSON.parse(o,void 0)}};function Tu(){}function Gd(){}Tu.prototype.h=null;var Xr={OPEN:"a",kb:"b",Ja:"c",wb:"d"};function Eu(){De.call(this,"d")}function vu(){De.call(this,"c")}x(Eu,De),x(vu,De);var ln={},Kd=null;function ys(){return Kd=Kd||new Ne}function jd(o){De.call(this,ln.La,o)}function Zr(o){const c=ys();Le(c,new jd(c))}function Wd(o,c){De.call(this,ln.STAT_EVENT,o),this.stat=c}function Be(o){const c=ys();Le(c,new Wd(c,o))}function Qd(o,c){De.call(this,ln.Ma,o),this.size=c}function ei(o,c){if("function"!=typeof o)throw Error("Fn must not be null and must be a function");return u.setTimeout(function(){o()},c)}function ti(){this.g=!0}function Xn(o,c,d,m){o.info(function(){return"XMLHTTP TEXT ("+c+"): "+function Dy(o,c){if(!o.g)return c;if(!c)return null;try{var d=JSON.parse(c);if(d)for(o=0;o<d.length;o++)if(Array.isArray(d[o])){var m=d[o];if(!(2>m.length)){var A=m[1];if(Array.isArray(A)&&!(1>A.length)){var S=A[0];if("noop"!=S&&"stop"!=S&&"close"!=S)for(var M=1;M<A.length;M++)A[M]=""}}}return Iu(d)}catch{return c}}(o,d)+(m?" "+m:"")})}ln.La="serverreachability",x(jd,De),ln.STAT_EVENT="statevent",x(Wd,De),ln.Ma="timingevent",x(Qd,De),ti.prototype.xa=function(){this.g=!1},ti.prototype.info=function(){};var Au,Is={NO_ERROR:0,gb:1,tb:2,sb:3,nb:4,rb:5,ub:6,Ia:7,TIMEOUT:8,xb:9},Hd={lb:"complete",Hb:"success",Ja:"error",Ia:"abort",zb:"ready",Ab:"readystatechange",TIMEOUT:"timeout",vb:"incrementaldata",yb:"progress",ob:"downloadprogress",Pb:"uploadprogress"};function Ts(){}function Ot(o,c,d,m){this.j=o,this.i=c,this.l=d,this.R=m||1,this.U=new Yr(this),this.I=45e3,this.H=null,this.o=!1,this.m=this.A=this.v=this.L=this.F=this.S=this.B=null,this.D=[],this.g=null,this.C=0,this.s=this.u=null,this.X=-1,this.J=!1,this.O=0,this.M=null,this.W=this.K=this.T=this.P=!1,this.h=new Jd}function Jd(){this.i=null,this.g="",this.h=!1}x(Ts,Tu),Ts.prototype.g=function(){return new XMLHttpRequest},Ts.prototype.i=function(){return{}},Au=new Ts;var Yd={},wu={};function Ru(o,c,d){o.L=1,o.v=ws(mt(c)),o.m=d,o.P=!0,Xd(o,null)}function Xd(o,c){o.F=Date.now(),Es(o),o.A=mt(o.v);var d=o.A,m=o.R;Array.isArray(m)||(m=[String(m)]),ff(d.i,"t",m),o.C=0,d=o.j.J,o.h=new Jd,o.g=Cf(o.j,d?c:null,!o.m),0<o.O&&(o.M=new Py(p(o.Y,o,o.g),o.O)),c=o.U,d=o.g,m=o.ca;var A="readystatechange";Array.isArray(A)||(A&&(qd[0]=A.toString()),A=qd);for(var S=0;S<A.length;S++){var M=kd(d,A[S],m||c.handleEvent,!1,c.h||c);if(!M)break;c.g[M.key]=M}c=o.H?g(o.H):{},o.m?(o.u||(o.u="POST"),c["Content-Type"]="application/x-www-form-urlencoded",o.g.ea(o.A,o.u,o.m,c)):(o.u="GET",o.g.ea(o.A,o.u,null,c)),Zr(),function by(o,c,d,m,A,S){o.info(function(){if(o.g)if(S)for(var M="",ie=S.split("&"),Ve=0;Ve<ie.length;Ve++){var Z=ie[Ve].split("=");if(1<Z.length){var ke=Z[0];Z=Z[1];var Fe=ke.split("_");M=2<=Fe.length&&"type"==Fe[1]?M+(ke+"=")+Z+"&":M+(ke+"=redacted&")}}else M=null;else M=S;return"XMLHTTP REQ ("+m+") [attempt "+A+"]: "+c+"\n"+d+"\n"+M})}(o.i,o.u,o.A,o.l,o.R,o.m)}function Zd(o){return!!o.g&&"GET"==o.u&&2!=o.L&&o.j.Ca}function Ny(o,c){var d=o.C,m=c.indexOf("\n",d);return-1==m?wu:(d=Number(c.substring(d,m)),isNaN(d)?Yd:(m+=1)+d>c.length?wu:(c=c.slice(m,m+d),o.C=m+d,c))}function Es(o){o.S=Date.now()+o.I,ef(o,o.I)}function ef(o,c){if(null!=o.B)throw Error("WatchDog timer not null");o.B=ei(p(o.ba,o),c)}function Pu(o){o.B&&(u.clearTimeout(o.B),o.B=null)}function ni(o){0==o.j.G||o.J||Vf(o.j,o)}function cn(o){Pu(o);var c=o.M;c&&"function"==typeof c.ma&&c.ma(),o.M=null,zd(o.U),o.g&&(c=o.g,o.g=null,c.abort(),c.ma())}function Vu(o,c){try{var d=o.j;if(0!=d.G&&(d.g==o||Su(d.h,o)))if(!o.K&&Su(d.h,o)&&3==d.G){try{var m=d.Da.g.parse(c)}catch{m=null}if(Array.isArray(m)&&3==m.length){var A=m;if(0==A[0]){e:if(!d.u){if(d.g){if(!(d.g.F+3e3<o.F))break e;bs(d),Vs(d)}Du(d),Be(18)}}else d.za=A[1],0<d.za-d.T&&37500>A[2]&&d.F&&0==d.v&&!d.C&&(d.C=ei(p(d.Za,d),6e3));if(1>=rf(d.h)&&d.ca){try{d.ca()}catch{}d.ca=void 0}}else dn(d,11)}else if((o.K||d.g==o)&&bs(d),!$(c))for(A=d.Da.g.parse(c),c=0;c<A.length;c++){let Z=A[c];if(d.T=Z[0],Z=Z[1],2==d.G)if("c"==Z[0]){d.K=Z[1],d.ia=Z[2];const ke=Z[3];null!=ke&&(d.la=ke,d.j.info("VER="+d.la));const Fe=Z[4];null!=Fe&&(d.Aa=Fe,d.j.info("SVER="+d.Aa));const tr=Z[5];null!=tr&&"number"==typeof tr&&0<tr&&(d.L=m=1.5*tr,d.j.info("backChannelRequestTimeoutMs_="+m)),m=d;const We=o.g;if(We){const Cs=We.g?We.g.getResponseHeader("X-Client-Wire-Protocol"):null;if(Cs){var S=m.h;S.g||-1==Cs.indexOf("spdy")&&-1==Cs.indexOf("quic")&&-1==Cs.indexOf("h2")||(S.j=S.l,S.g=new Set,S.h&&(bu(S,S.h),S.h=null))}if(m.D){const ku=We.g?We.g.getResponseHeader("X-HTTP-Session-Id"):null;ku&&(m.ya=ku,le(m.I,m.D,ku))}}d.G=3,d.l&&d.l.ua(),d.ba&&(d.R=Date.now()-o.F,d.j.info("Handshake RTT: "+d.R+"ms"));var M=o;if((m=d).qa=xf(m,m.J?m.ia:null,m.W),M.K){sf(m.h,M);var ie=M,Ve=m.L;Ve&&(ie.I=Ve),ie.B&&(Pu(ie),Es(ie)),m.g=M}else Rf(m);0<d.i.length&&Ss(d)}else"stop"!=Z[0]&&"close"!=Z[0]||dn(d,7);else 3==d.G&&("stop"==Z[0]||"close"==Z[0]?"stop"==Z[0]?dn(d,7):Cu(d):"noop"!=Z[0]&&d.l&&d.l.ta(Z),d.v=0)}Zr()}catch{}}Ot.prototype.ca=function(o){o=o.target;const c=this.M;c&&3==_t(o)?c.j():this.Y(o)},Ot.prototype.Y=function(o){try{if(o==this.g)e:{const Fe=_t(this.g);var c=this.g.Ba();if(this.g.Z(),!(3>Fe)&&(3!=Fe||this.g&&(this.h.h||this.g.oa()||Tf(this.g)))){this.J||4!=Fe||7==c||Zr(),Pu(this);var d=this.g.Z();this.X=d;t:if(Zd(this)){var m=Tf(this.g);o="";var A=m.length,S=4==_t(this.g);if(!this.h.i){if(typeof TextDecoder>"u"){cn(this),ni(this);var M="";break t}this.h.i=new u.TextDecoder}for(c=0;c<A;c++)this.h.h=!0,o+=this.h.i.decode(m[c],{stream:!(S&&c==A-1)});m.length=0,this.h.g+=o,this.C=0,M=this.h.g}else M=this.g.oa();if(this.o=200==d,function xy(o,c,d,m,A,S,M){o.info(function(){return"XMLHTTP RESP ("+m+") [ attempt "+A+"]: "+c+"\n"+d+"\n"+S+" "+M})}(this.i,this.u,this.A,this.l,this.R,Fe,d),this.o){if(this.T&&!this.K){t:{if(this.g){var ie,Ve=this.g;if((ie=Ve.g?Ve.g.getResponseHeader("X-HTTP-Initial-Response"):null)&&!$(ie)){var Z=ie;break t}}Z=null}if(!(d=Z)){this.o=!1,this.s=3,Be(12),cn(this),ni(this);break e}Xn(this.i,this.l,d,"Initial handshake response via X-HTTP-Initial-Response"),this.K=!0,Vu(this,d)}if(this.P){let We;for(d=!0;!this.J&&this.C<M.length;){if(We=Ny(this,M),We==wu){4==Fe&&(this.s=4,Be(14),d=!1),Xn(this.i,this.l,null,"[Incomplete Response]");break}if(We==Yd){this.s=4,Be(15),Xn(this.i,this.l,M,"[Invalid Chunk]"),d=!1;break}Xn(this.i,this.l,We,null),Vu(this,We)}if(Zd(this)&&0!=this.C&&(this.h.g=this.h.g.slice(this.C),this.C=0),4!=Fe||0!=M.length||this.h.h||(this.s=1,Be(16),d=!1),this.o=this.o&&d,d){if(0<M.length&&!this.W){this.W=!0;var ke=this.j;ke.g==this&&ke.ba&&!ke.M&&(ke.j.info("Great, no buffering proxy detected. Bytes received: "+M.length),Nu(ke),ke.M=!0,Be(11))}}else Xn(this.i,this.l,M,"[Invalid Chunked Response]"),cn(this),ni(this)}else Xn(this.i,this.l,M,null),Vu(this,M);4==Fe&&cn(this),this.o&&!this.J&&(4==Fe?Vf(this.j,this):(this.o=!1,Es(this)))}else(function Jy(o){const c={};o=(o.g&&2<=_t(o)&&o.g.getAllResponseHeaders()||"").split("\r\n");for(let m=0;m<o.length;m++){if($(o[m]))continue;var d=v(o[m]);const A=d[0];if("string"!=typeof(d=d[1]))continue;d=d.trim();const S=c[A]||[];c[A]=S,S.push(d)}!function T(o,c){for(const d in o)c.call(void 0,o[d],d,o)}(c,function(m){return m.join(", ")})})(this.g),400==d&&0<M.indexOf("Unknown SID")?(this.s=3,Be(12)):(this.s=0,Be(13)),cn(this),ni(this)}}}catch{}},Ot.prototype.cancel=function(){this.J=!0,cn(this)},Ot.prototype.ba=function(){this.B=null;const o=Date.now();0<=o-this.S?(function Cy(o,c){o.info(function(){return"TIMEOUT: "+c})}(this.i,this.A),2!=this.L&&(Zr(),Be(17)),cn(this),this.s=2,ni(this)):ef(this,this.S-o)};var ky=class{constructor(o,c){this.g=o,this.map=c}};function tf(o){this.l=o||10,o=u.PerformanceNavigationTiming?0<(o=u.performance.getEntriesByType("navigation")).length&&("hq"==o[0].nextHopProtocol||"h2"==o[0].nextHopProtocol):!!(u.chrome&&u.chrome.loadTimes&&u.chrome.loadTimes()&&u.chrome.loadTimes().wasFetchedViaSpdy),this.j=o?this.l:1,this.g=null,1<this.j&&(this.g=new Set),this.h=null,this.i=[]}function nf(o){return!!o.h||!!o.g&&o.g.size>=o.j}function rf(o){return o.h?1:o.g?o.g.size:0}function Su(o,c){return o.h?o.h==c:!!o.g&&o.g.has(c)}function bu(o,c){o.g?o.g.add(c):o.h=c}function sf(o,c){o.h&&o.h==c?o.h=null:o.g&&o.g.has(c)&&o.g.delete(c)}function of(o){if(null!=o.h)return o.i.concat(o.h.D);if(null!=o.g&&0!==o.g.size){let c=o.i;for(const d of o.g.values())c=c.concat(d.D);return c}return k(o.i)}function af(o,c){if(o.forEach&&"function"==typeof o.forEach)o.forEach(c,void 0);else if(l(o)||"string"==typeof o)Array.prototype.forEach.call(o,c,void 0);else for(var d=function My(o){if(o.na&&"function"==typeof o.na)return o.na();if(!o.V||"function"!=typeof o.V){if(typeof Map<"u"&&o instanceof Map)return Array.from(o.keys());if(!(typeof Set<"u"&&o instanceof Set)){if(l(o)||"string"==typeof o){var c=[];o=o.length;for(var d=0;d<o;d++)c.push(d);return c}c=[],d=0;for(const m in o)c[d++]=m;return c}}}(o),m=function Fy(o){if(o.V&&"function"==typeof o.V)return o.V();if(typeof Map<"u"&&o instanceof Map||typeof Set<"u"&&o instanceof Set)return Array.from(o.values());if("string"==typeof o)return o.split("");if(l(o)){for(var c=[],d=o.length,m=0;m<d;m++)c.push(o[m]);return c}for(m in c=[],d=0,o)c[d++]=o[m];return c}(o),A=m.length,S=0;S<A;S++)c.call(void 0,m[S],d&&d[S],o)}tf.prototype.cancel=function(){if(this.i=of(this),this.h)this.h.cancel(),this.h=null;else if(this.g&&0!==this.g.size){for(const o of this.g.values())o.cancel();this.g.clear()}};var uf=RegExp("^(?:([^:/?#.]+):)?(?://(?:([^\\\\/?#]*)@)?([^\\\\/?#]*?)(?::([0-9]+))?(?=[\\\\/?#]|$))?([^?#]+)?(?:\\?([^#]*))?(?:#([\\s\\S]*))?$");function hn(o){if(this.g=this.o=this.j="",this.s=null,this.m=this.l="",this.h=!1,o instanceof hn){this.h=o.h,vs(this,o.j),this.o=o.o,this.g=o.g,As(this,o.s),this.l=o.l;var c=o.i,d=new si;d.i=c.i,c.g&&(d.g=new Map(c.g),d.h=c.h),lf(this,d),this.m=o.m}else o&&(c=String(o).match(uf))?(this.h=!1,vs(this,c[1]||"",!0),this.o=ri(c[2]||""),this.g=ri(c[3]||"",!0),As(this,c[4]),this.l=ri(c[5]||"",!0),lf(this,c[6]||"",!0),this.m=ri(c[7]||"")):(this.h=!1,this.i=new si(null,this.h))}function mt(o){return new hn(o)}function vs(o,c,d){o.j=d?ri(c,!0):c,o.j&&(o.j=o.j.replace(/:$/,""))}function As(o,c){if(c){if(c=Number(c),isNaN(c)||0>c)throw Error("Bad port number "+c);o.s=c}else o.s=null}function lf(o,c,d){c instanceof si?(o.i=c,function $y(o,c){c&&!o.j&&(Lt(o),o.i=null,o.g.forEach(function(d,m){var A=m.toLowerCase();m!=A&&(hf(this,m),ff(this,A,d))},o)),o.j=c}(o.i,o.h)):(d||(c=ii(c,qy)),o.i=new si(c,o.h))}function le(o,c,d){o.i.set(c,d)}function ws(o){return le(o,"zx",Math.floor(2147483648*Math.random()).toString(36)+Math.abs(Math.floor(2147483648*Math.random())^Date.now()).toString(36)),o}function ri(o,c){return o?c?decodeURI(o.replace(/%25/g,"%2525")):decodeURIComponent(o):""}function ii(o,c,d){return"string"==typeof o?(o=encodeURI(o).replace(c,Ly),d&&(o=o.replace(/%25([0-9a-fA-F]{2})/g,"%$1")),o):null}function Ly(o){return"%"+((o=o.charCodeAt(0))>>4&15).toString(16)+(15&o).toString(16)}hn.prototype.toString=function(){var o=[],c=this.j;c&&o.push(ii(c,cf,!0),":");var d=this.g;return(d||"file"==c)&&(o.push("//"),(c=this.o)&&o.push(ii(c,cf,!0),"@"),o.push(encodeURIComponent(String(d)).replace(/%25([0-9a-fA-F]{2})/g,"%$1")),null!=(d=this.s)&&o.push(":",String(d))),(d=this.l)&&(this.g&&"/"!=d.charAt(0)&&o.push("/"),o.push(ii(d,"/"==d.charAt(0)?Uy:By,!0))),(d=this.i.toString())&&o.push("?",d),(d=this.m)&&o.push("#",ii(d,zy)),o.join("")};var cf=/[#\/\?@]/g,By=/[#\?:]/g,Uy=/[#\?]/g,qy=/[#\?@]/g,zy=/#/g;function si(o,c){this.h=this.g=null,this.i=o||null,this.j=!!c}function Lt(o){o.g||(o.g=new Map,o.h=0,o.i&&function Oy(o,c){if(o){o=o.split("&");for(var d=0;d<o.length;d++){var m=o[d].indexOf("="),A=null;if(0<=m){var S=o[d].substring(0,m);A=o[d].substring(m+1)}else S=o[d];c(S,A?decodeURIComponent(A.replace(/\+/g," ")):"")}}}(o.i,function(c,d){o.add(decodeURIComponent(c.replace(/\+/g," ")),d)}))}function hf(o,c){Lt(o),c=Zn(o,c),o.g.has(c)&&(o.i=null,o.h-=o.g.get(c).length,o.g.delete(c))}function df(o,c){return Lt(o),c=Zn(o,c),o.g.has(c)}function ff(o,c,d){hf(o,c),0<d.length&&(o.i=null,o.g.set(Zn(o,c),k(d)),o.h+=d.length)}function Zn(o,c){return c=String(c),o.j&&(c=c.toLowerCase()),c}function Bt(o,c,d,m,A){try{A&&(A.onload=null,A.onerror=null,A.onabort=null,A.ontimeout=null),m(d)}catch{}}function jy(){this.g=new Sy}function Wy(o,c,d){const m=d||"";try{af(o,function(A,S){let M=A;h(A)&&(M=Iu(A)),c.push(m+S+"="+encodeURIComponent(M))})}catch(A){throw c.push(m+"type="+encodeURIComponent("_badmap")),A}}function oi(o){this.l=o.Ub||null,this.j=o.eb||!1}function Rs(o,c){Ne.call(this),this.D=o,this.o=c,this.m=void 0,this.status=this.readyState=0,this.responseType=this.responseText=this.response=this.statusText="",this.onreadystatechange=null,this.u=new Headers,this.h=null,this.B="GET",this.A="",this.g=!1,this.v=this.j=this.l=null}function mf(o){o.j.read().then(o.Pa.bind(o)).catch(o.ga.bind(o))}function ai(o){o.readyState=4,o.l=null,o.j=null,o.v=null,ui(o)}function ui(o){o.onreadystatechange&&o.onreadystatechange.call(o)}function _f(o){let c="";return W(o,function(d,m){c+=m,c+=":",c+=d,c+="\r\n"}),c}function xu(o,c,d){e:{for(m in d){var m=!1;break e}m=!0}m||(d=_f(d),"string"==typeof o?null!=d&&encodeURIComponent(String(d)):le(o,c,d))}function _e(o){Ne.call(this),this.headers=new Map,this.o=o||null,this.h=!1,this.v=this.g=null,this.D="",this.m=0,this.l="",this.j=this.B=this.u=this.A=!1,this.I=null,this.H="",this.J=!1}(r=si.prototype).add=function(o,c){Lt(this),this.i=null,o=Zn(this,o);var d=this.g.get(o);return d||this.g.set(o,d=[]),d.push(c),this.h+=1,this},r.forEach=function(o,c){Lt(this),this.g.forEach(function(d,m){d.forEach(function(A){o.call(c,A,m,this)},this)},this)},r.na=function(){Lt(this);const o=Array.from(this.g.values()),c=Array.from(this.g.keys()),d=[];for(let m=0;m<c.length;m++){const A=o[m];for(let S=0;S<A.length;S++)d.push(c[m])}return d},r.V=function(o){Lt(this);let c=[];if("string"==typeof o)df(this,o)&&(c=c.concat(this.g.get(Zn(this,o))));else{o=Array.from(this.g.values());for(let d=0;d<o.length;d++)c=c.concat(o[d])}return c},r.set=function(o,c){return Lt(this),this.i=null,df(this,o=Zn(this,o))&&(this.h-=this.g.get(o).length),this.g.set(o,[c]),this.h+=1,this},r.get=function(o,c){return o&&0<(o=this.V(o)).length?String(o[0]):c},r.toString=function(){if(this.i)return this.i;if(!this.g)return"";const o=[],c=Array.from(this.g.keys());for(var d=0;d<c.length;d++){var m=c[d];const S=encodeURIComponent(String(m)),M=this.V(m);for(m=0;m<M.length;m++){var A=S;""!==M[m]&&(A+="="+encodeURIComponent(String(M[m]))),o.push(A)}}return this.i=o.join("&")},x(oi,Tu),oi.prototype.g=function(){return new Rs(this.l,this.j)},oi.prototype.i=function(o){return function(){return o}}({}),x(Rs,Ne),(r=Rs.prototype).open=function(o,c){if(0!=this.readyState)throw this.abort(),Error("Error reopening a connection");this.B=o,this.A=c,this.readyState=1,ui(this)},r.send=function(o){if(1!=this.readyState)throw this.abort(),Error("need to call open() first. ");this.g=!0;const c={headers:this.u,method:this.B,credentials:this.m,cache:void 0};o&&(c.body=o),(this.D||u).fetch(new Request(this.A,c)).then(this.Sa.bind(this),this.ga.bind(this))},r.abort=function(){this.response=this.responseText="",this.u=new Headers,this.status=0,this.j&&this.j.cancel("Request was aborted.").catch(()=>{}),1<=this.readyState&&this.g&&4!=this.readyState&&(this.g=!1,ai(this)),this.readyState=0},r.Sa=function(o){if(this.g&&(this.l=o,this.h||(this.status=this.l.status,this.statusText=this.l.statusText,this.h=o.headers,this.readyState=2,ui(this)),this.g&&(this.readyState=3,ui(this),this.g)))if("arraybuffer"===this.responseType)o.arrayBuffer().then(this.Qa.bind(this),this.ga.bind(this));else if(typeof u.ReadableStream<"u"&&"body"in o){if(this.j=o.body.getReader(),this.o){if(this.responseType)throw Error('responseType must be empty for "streamBinaryChunks" mode responses.');this.response=[]}else this.response=this.responseText="",this.v=new TextDecoder;mf(this)}else o.text().then(this.Ra.bind(this),this.ga.bind(this))},r.Pa=function(o){if(this.g){if(this.o&&o.value)this.response.push(o.value);else if(!this.o){var c=o.value?o.value:new Uint8Array(0);(c=this.v.decode(c,{stream:!o.done}))&&(this.response=this.responseText+=c)}o.done?ai(this):ui(this),3==this.readyState&&mf(this)}},r.Ra=function(o){this.g&&(this.response=this.responseText=o,ai(this))},r.Qa=function(o){this.g&&(this.response=o,ai(this))},r.ga=function(){this.g&&ai(this)},r.setRequestHeader=function(o,c){this.u.append(o,c)},r.getResponseHeader=function(o){return this.h&&this.h.get(o.toLowerCase())||""},r.getAllResponseHeaders=function(){if(!this.h)return"";const o=[],c=this.h.entries();for(var d=c.next();!d.done;)o.push((d=d.value)[0]+": "+d[1]),d=c.next();return o.join("\r\n")},Object.defineProperty(Rs.prototype,"withCredentials",{get:function(){return"include"===this.m},set:function(o){this.m=o?"include":"same-origin"}}),x(_e,Ne);var Qy=/^https?$/i,Hy=["POST","PUT"];function gf(o,c){o.h=!1,o.g&&(o.j=!0,o.g.abort(),o.j=!1),o.l=c,o.m=5,pf(o),Ps(o)}function pf(o){o.A||(o.A=!0,Le(o,"complete"),Le(o,"error"))}function yf(o){if(o.h&&typeof a<"u"&&(!o.v[1]||4!=_t(o)||2!=o.Z()))if(o.u&&4==_t(o))Bd(o.Ea,0,o);else if(Le(o,"readystatechange"),4==_t(o)){o.h=!1;try{const M=o.Z();e:switch(M){case 200:case 201:case 202:case 204:case 206:case 304:case 1223:var c=!0;break e;default:c=!1}var d;if(!(d=c)){var m;if(m=0===M){var A=String(o.D).match(uf)[1]||null;!A&&u.self&&u.self.location&&(A=u.self.location.protocol.slice(0,-1)),m=!Qy.test(A?A.toLowerCase():"")}d=m}if(d)Le(o,"complete"),Le(o,"success");else{o.m=6;try{var S=2<_t(o)?o.g.statusText:""}catch{S=""}o.l=S+" ["+o.Z()+"]",pf(o)}}finally{Ps(o)}}}function Ps(o,c){if(o.g){If(o);const d=o.g,m=o.v[0]?()=>{}:null;o.g=null,o.v=null,c||Le(o,"ready");try{d.onreadystatechange=m}catch{}}}function If(o){o.I&&(u.clearTimeout(o.I),o.I=null)}function _t(o){return o.g?o.g.readyState:0}function Tf(o){try{if(!o.g)return null;if("response"in o.g)return o.g.response;switch(o.H){case"":case"text":return o.g.responseText;case"arraybuffer":if("mozResponseArrayBuffer"in o.g)return o.g.mozResponseArrayBuffer}return null}catch{return null}}function li(o,c,d){return d&&d.internalChannelParams&&d.internalChannelParams[o]||c}function Ef(o){this.Aa=0,this.i=[],this.j=new ti,this.ia=this.qa=this.I=this.W=this.g=this.ya=this.D=this.H=this.m=this.S=this.o=null,this.Ya=this.U=0,this.Va=li("failFast",!1,o),this.F=this.C=this.u=this.s=this.l=null,this.X=!0,this.za=this.T=-1,this.Y=this.v=this.B=0,this.Ta=li("baseRetryDelayMs",5e3,o),this.cb=li("retryDelaySeedMs",1e4,o),this.Wa=li("forwardChannelMaxRetries",2,o),this.wa=li("forwardChannelRequestTimeoutMs",2e4,o),this.pa=o&&o.xmlHttpFactory||void 0,this.Xa=o&&o.Tb||void 0,this.Ca=o&&o.useFetchStreams||!1,this.L=void 0,this.J=o&&o.supportsCrossDomainXhr||!1,this.K="",this.h=new tf(o&&o.concurrentRequestLimit),this.Da=new jy,this.P=o&&o.fastHandshake||!1,this.O=o&&o.encodeInitMessageHeaders||!1,this.P&&this.O&&(this.O=!1),this.Ua=o&&o.Rb||!1,o&&o.xa&&this.j.xa(),o&&o.forceLongPolling&&(this.X=!1),this.ba=!this.P&&this.X&&o&&o.detectBufferingProxy||!1,this.ja=void 0,o&&o.longPollingTimeout&&0<o.longPollingTimeout&&(this.ja=o.longPollingTimeout),this.ca=void 0,this.R=0,this.M=!1,this.ka=this.A=null}function Cu(o){if(vf(o),3==o.G){var c=o.U++,d=mt(o.I);if(le(d,"SID",o.K),le(d,"RID",c),le(d,"TYPE","terminate"),ci(o,d),(c=new Ot(o,o.j,c)).L=2,c.v=ws(mt(d)),d=!1,u.navigator&&u.navigator.sendBeacon)try{d=u.navigator.sendBeacon(c.v.toString(),"")}catch{}!d&&u.Image&&((new Image).src=c.v,d=!0),d||(c.g=Cf(c.j,null),c.g.ea(c.v)),c.F=Date.now(),Es(c)}bf(o)}function Vs(o){o.g&&(Nu(o),o.g.cancel(),o.g=null)}function vf(o){Vs(o),o.u&&(u.clearTimeout(o.u),o.u=null),bs(o),o.h.cancel(),o.s&&("number"==typeof o.s&&u.clearTimeout(o.s),o.s=null)}function Ss(o){if(!nf(o.h)&&!o.s){o.s=!0;var c=o.Ga;Wr||Nd(),Qr||(Wr(),Qr=!0),cu.add(c,o),o.B=0}}function Af(o,c){var d;d=c?c.l:o.U++;const m=mt(o.I);le(m,"SID",o.K),le(m,"RID",d),le(m,"AID",o.T),ci(o,m),o.m&&o.o&&xu(m,o.m,o.o),d=new Ot(o,o.j,d,o.B+1),null===o.m&&(d.H=o.o),c&&(o.i=c.D.concat(o.i)),c=wf(o,d,1e3),d.I=Math.round(.5*o.wa)+Math.round(.5*o.wa*Math.random()),bu(o.h,d),Ru(d,m,c)}function ci(o,c){o.H&&W(o.H,function(d,m){le(c,m,d)}),o.l&&af({},function(d,m){le(c,m,d)})}function wf(o,c,d){d=Math.min(o.i.length,d);var m=o.l?p(o.l.Na,o.l,o):null;e:{var A=o.i;let S=-1;for(;;){const M=["count="+d];-1==S?0<d?(S=A[0].g,M.push("ofs="+S)):S=0:M.push("ofs="+S);let ie=!0;for(let Ve=0;Ve<d;Ve++){let Z=A[Ve].g;const ke=A[Ve].map;if(Z-=S,0>Z)S=Math.max(0,A[Ve].g-100),ie=!1;else try{Wy(ke,M,"req"+Z+"_")}catch{m&&m(ke)}}if(ie){m=M.join("&");break e}}}return o=o.i.splice(0,d),c.D=o,m}function Rf(o){if(!o.g&&!o.u){o.Y=1;var c=o.Fa;Wr||Nd(),Qr||(Wr(),Qr=!0),cu.add(c,o),o.v=0}}function Du(o){return!(o.g||o.u||3<=o.v||(o.Y++,o.u=ei(p(o.Fa,o),Sf(o,o.v)),o.v++,0))}function Nu(o){null!=o.A&&(u.clearTimeout(o.A),o.A=null)}function Pf(o){o.g=new Ot(o,o.j,"rpc",o.Y),null===o.m&&(o.g.H=o.o),o.g.O=0;var c=mt(o.qa);le(c,"RID","rpc"),le(c,"SID",o.K),le(c,"AID",o.T),le(c,"CI",o.F?"0":"1"),!o.F&&o.ja&&le(c,"TO",o.ja),le(c,"TYPE","xmlhttp"),ci(o,c),o.m&&o.o&&xu(c,o.m,o.o),o.L&&(o.g.I=o.L);var d=o.g;o=o.ia,d.L=1,d.v=ws(mt(c)),d.m=null,d.P=!0,Xd(d,o)}function bs(o){null!=o.C&&(u.clearTimeout(o.C),o.C=null)}function Vf(o,c){var d=null;if(o.g==c){bs(o),Nu(o),o.g=null;var m=2}else{if(!Su(o.h,c))return;d=c.D,sf(o.h,c),m=1}if(0!=o.G)if(c.o)if(1==m){d=c.m?c.m.length:0,c=Date.now()-c.F;var A=o.B;Le(m=ys(),new Qd(m,d)),Ss(o)}else Rf(o);else if(3==(A=c.s)||0==A&&0<c.X||!(1==m&&function Yy(o,c){return!(rf(o.h)>=o.h.j-(o.s?1:0)||(o.s?(o.i=c.D.concat(o.i),0):1==o.G||2==o.G||o.B>=(o.Va?0:o.Wa)||(o.s=ei(p(o.Ga,o,c),Sf(o,o.B)),o.B++,0)))}(o,c)||2==m&&Du(o)))switch(d&&0<d.length&&(c=o.h,c.i=c.i.concat(d)),A){case 1:dn(o,5);break;case 4:dn(o,10);break;case 3:dn(o,6);break;default:dn(o,2)}}function Sf(o,c){let d=o.Ta+Math.floor(Math.random()*o.cb);return o.isActive()||(d*=2),d*c}function dn(o,c){if(o.j.info("Error code "+c),2==c){var d=p(o.fb,o),m=o.Xa;const A=!m;m=new hn(m||"//www.google.com/images/cleardot.gif"),u.location&&"http"==u.location.protocol||vs(m,"https"),ws(m),A?function Gy(o,c){const d=new ti;if(u.Image){const m=new Image;m.onload=R(Bt,d,"TestLoadImage: loaded",!0,c,m),m.onerror=R(Bt,d,"TestLoadImage: error",!1,c,m),m.onabort=R(Bt,d,"TestLoadImage: abort",!1,c,m),m.ontimeout=R(Bt,d,"TestLoadImage: timeout",!1,c,m),u.setTimeout(function(){m.ontimeout&&m.ontimeout()},1e4),m.src=o}else c(!1)}(m.toString(),d):function Ky(o,c){new ti;const m=new AbortController,A=setTimeout(()=>{m.abort(),Bt(0,0,!1,c)},1e4);fetch(o,{signal:m.signal}).then(S=>{clearTimeout(A),Bt(0,0,!!S.ok,c)}).catch(()=>{clearTimeout(A),Bt(0,0,!1,c)})}(m.toString(),d)}else Be(2);o.G=0,o.l&&o.l.sa(c),bf(o),vf(o)}function bf(o){if(o.G=0,o.ka=[],o.l){const c=of(o.h);(0!=c.length||0!=o.i.length)&&(D(o.ka,c),D(o.ka,o.i),o.h.i.length=0,k(o.i),o.i.length=0),o.l.ra()}}function xf(o,c,d){var m=d instanceof hn?mt(d):new hn(d);if(""!=m.g)c&&(m.g=c+"."+m.g),As(m,m.s);else{var A=u.location;m=A.protocol,c=c?c+"."+A.hostname:A.hostname,A=+A.port;var S=new hn(null);m&&vs(S,m),c&&(S.g=c),A&&As(S,A),d&&(S.l=d),m=S}return c=o.ya,(d=o.D)&&c&&le(m,d,c),le(m,"VER",o.la),ci(o,m),m}function Cf(o,c,d){if(c&&!o.J)throw Error("Can't create secondary domain capable XhrIo object.");return(c=new _e(o.Ca&&!o.pa?new oi({eb:d}):o.pa)).Ha(o.J),c}function Df(){}function xs(){}function Ke(o,c){Ne.call(this),this.g=new Ef(c),this.l=o,this.h=c&&c.messageUrlParams||null,o=c&&c.messageHeaders||null,c&&c.clientProtocolHeaderRequired&&(o?o["X-Client-Protocol"]="webchannel":o={"X-Client-Protocol":"webchannel"}),this.g.o=o,o=c&&c.initMessageHeaders||null,c&&c.messageContentType&&(o?o["X-WebChannel-Content-Type"]=c.messageContentType:o={"X-WebChannel-Content-Type":c.messageContentType}),c&&c.va&&(o?o["X-WebChannel-Client-Profile"]=c.va:o={"X-WebChannel-Client-Profile":c.va}),this.g.S=o,(o=c&&c.Sb)&&!$(o)&&(this.g.m=o),this.v=c&&c.supportsCrossDomainXhr||!1,this.u=c&&c.sendRawJson||!1,(c=c&&c.httpSessionIdParam)&&!$(c)&&(this.g.D=c,null!==(o=this.h)&&c in o&&c in(o=this.h)&&delete o[c]),this.j=new er(this)}function Nf(o){Eu.call(this),o.__headers__&&(this.headers=o.__headers__,this.statusCode=o.__status__,delete o.__headers__,delete o.__status__);var c=o.__sm__;if(c){e:{for(const d in c){o=d;break e}o=void 0}(this.i=o)&&(o=this.i,c=null!==c&&o in c?c[o]:void 0),this.data=c}else this.data=o}function kf(){vu.call(this),this.status=1}function er(o){this.g=o}(r=_e.prototype).Ha=function(o){this.J=o},r.ea=function(o,c,d,m){if(this.g)throw Error("[goog.net.XhrIo] Object is active with another request="+this.D+"; newUri="+o);c=c?c.toUpperCase():"GET",this.D=o,this.l="",this.m=0,this.A=!1,this.h=!0,this.g=this.o?this.o.g():Au.g(),this.v=function $d(o){return o.h||(o.h=o.i())}(this.o?this.o:Au),this.g.onreadystatechange=p(this.Ea,this);try{this.B=!0,this.g.open(c,String(o),!0),this.B=!1}catch(S){return void gf(this,S)}if(o=d||"",d=new Map(this.headers),m)if(Object.getPrototypeOf(m)===Object.prototype)for(var A in m)d.set(A,m[A]);else{if("function"!=typeof m.keys||"function"!=typeof m.get)throw Error("Unknown input type for opt_headers: "+String(m));for(const S of m.keys())d.set(S,m.get(S))}m=Array.from(d.keys()).find(S=>"content-type"==S.toLowerCase()),A=u.FormData&&o instanceof u.FormData,!(0<=Array.prototype.indexOf.call(Hy,c,void 0))||m||A||d.set("Content-Type","application/x-www-form-urlencoded;charset=utf-8");for(const[S,M]of d)this.g.setRequestHeader(S,M);this.H&&(this.g.responseType=this.H),"withCredentials"in this.g&&this.g.withCredentials!==this.J&&(this.g.withCredentials=this.J);try{If(this),this.u=!0,this.g.send(o),this.u=!1}catch(S){gf(this,S)}},r.abort=function(o){this.g&&this.h&&(this.h=!1,this.j=!0,this.g.abort(),this.j=!1,this.m=o||7,Le(this,"complete"),Le(this,"abort"),Ps(this))},r.N=function(){this.g&&(this.h&&(this.h=!1,this.j=!0,this.g.abort(),this.j=!1),Ps(this,!0)),_e.aa.N.call(this)},r.Ea=function(){this.s||(this.B||this.u||this.j?yf(this):this.bb())},r.bb=function(){yf(this)},r.isActive=function(){return!!this.g},r.Z=function(){try{return 2<_t(this)?this.g.status:-1}catch{return-1}},r.oa=function(){try{return this.g?this.g.responseText:""}catch{return""}},r.Oa=function(o){if(this.g){var c=this.g.responseText;return o&&0==c.indexOf(o)&&(c=c.substring(o.length)),Vy(c)}},r.Ba=function(){return this.m},r.Ka=function(){return"string"==typeof this.l?this.l:String(this.l)},(r=Ef.prototype).la=8,r.G=1,r.connect=function(o,c,d,m){Be(0),this.W=o,this.H=c||{},d&&void 0!==m&&(this.H.OSID=d,this.H.OAID=m),this.F=this.X,this.I=xf(this,null,this.W),Ss(this)},r.Ga=function(o){if(this.s)if(this.s=null,1==this.G){if(!o){this.U=Math.floor(1e5*Math.random()),o=this.U++;const A=new Ot(this,this.j,o);let S=this.o;if(this.S&&(S?(S=g(S),E(S,this.S)):S=this.S),null!==this.m||this.O||(A.H=S,S=null),this.P)e:{for(var c=0,d=0;d<this.i.length;d++){var m=this.i[d];if(void 0===(m="__data__"in m.map&&"string"==typeof(m=m.map.__data__)?m.length:void 0))break;if(4096<(c+=m)){c=d;break e}if(4096===c||d===this.i.length-1){c=d+1;break e}}c=1e3}else c=1e3;c=wf(this,A,c),le(d=mt(this.I),"RID",o),le(d,"CVER",22),this.D&&le(d,"X-HTTP-Session-Id",this.D),ci(this,d),S&&(this.O?c="headers="+encodeURIComponent(String(_f(S)))+"&"+c:this.m&&xu(d,this.m,S)),bu(this.h,A),this.Ua&&le(d,"TYPE","init"),this.P?(le(d,"$req",c),le(d,"SID","null"),A.T=!0,Ru(A,d,null)):Ru(A,d,c),this.G=2}}else 3==this.G&&(o?Af(this,o):0==this.i.length||nf(this.h)||Af(this))},r.Fa=function(){if(this.u=null,Pf(this),this.ba&&!(this.M||null==this.g||0>=this.R)){var o=2*this.R;this.j.info("BP detection timer enabled: "+o),this.A=ei(p(this.ab,this),o)}},r.ab=function(){this.A&&(this.A=null,this.j.info("BP detection timeout reached."),this.j.info("Buffering proxy detected and switch to long-polling!"),this.F=!1,this.M=!0,Be(10),Vs(this),Pf(this))},r.Za=function(){null!=this.C&&(this.C=null,Vs(this),Du(this),Be(19))},r.fb=function(o){o?(this.j.info("Successfully pinged google.com"),Be(2)):(this.j.info("Failed to ping google.com"),Be(1))},r.isActive=function(){return!!this.l&&this.l.isActive(this)},(r=Df.prototype).ua=function(){},r.ta=function(){},r.sa=function(){},r.ra=function(){},r.isActive=function(){return!0},r.Na=function(){},xs.prototype.g=function(o,c){return new Ke(o,c)},x(Ke,Ne),Ke.prototype.m=function(){this.g.l=this.j,this.v&&(this.g.J=!0),this.g.connect(this.l,this.h||void 0)},Ke.prototype.close=function(){Cu(this.g)},Ke.prototype.o=function(o){var c=this.g;if("string"==typeof o){var d={};d.__data__=o,o=d}else this.u&&((d={}).__data__=Iu(o),o=d);c.i.push(new ky(c.Ya++,o)),3==c.G&&Ss(c)},Ke.prototype.N=function(){this.g.l=null,delete this.j,Cu(this.g),delete this.g,Ke.aa.N.call(this)},x(Nf,Eu),x(kf,vu),x(er,Df),er.prototype.ua=function(){Le(this.g,"a")},er.prototype.ta=function(o){Le(this.g,new Nf(o))},er.prototype.sa=function(o){Le(this.g,new kf)},er.prototype.ra=function(){Le(this.g,"b")},xs.prototype.createWebChannel=xs.prototype.g,Ke.prototype.send=Ke.prototype.o,Ke.prototype.open=Ke.prototype.m,Ke.prototype.close=Ke.prototype.close,Gu=nt.createWebChannelTransport=function(){return new xs},$u=nt.getStatEventTarget=function(){return ys()},zu=nt.Event=ln,Ns=nt.Stat={mb:0,pb:1,qb:2,Jb:3,Ob:4,Lb:5,Mb:6,Kb:7,Ib:8,Nb:9,PROXY:10,NOPROXY:11,Gb:12,Cb:13,Db:14,Bb:15,Eb:16,Fb:17,ib:18,hb:19,jb:20},Is.NO_ERROR=0,Is.TIMEOUT=8,Is.HTTP_ERROR=6,fi=nt.ErrorCode=Is,Hd.COMPLETE="complete",qu=nt.EventType=Hd,Gd.EventType=Xr,Xr.OPEN="a",Xr.CLOSE="b",Xr.ERROR="c",Xr.MESSAGE="d",Ne.prototype.listen=Ne.prototype.K,ir=nt.WebChannel=Gd,nt.FetchXmlHttpFactory=oi,_e.prototype.listenOnce=_e.prototype.L,_e.prototype.getLastError=_e.prototype.Ka,_e.prototype.getLastErrorCode=_e.prototype.Ba,_e.prototype.getStatus=_e.prototype.Z,_e.prototype.getResponseJson=_e.prototype.Oa,_e.prototype.getResponseText=_e.prototype.oa,_e.prototype.send=_e.prototype.ea,_e.prototype.setWithCredentials=_e.prototype.Ha,Uu=nt.XhrIo=_e}).apply(typeof di<"u"?di:typeof self<"u"?self:typeof window<"u"?window:{});const Ku="@firebase/firestore";class Ee{constructor(e){this.uid=e}isAuthenticated(){return null!=this.uid}toKey(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"}isEqual(e){return e.uid===this.uid}}Ee.UNAUTHENTICATED=new Ee(null),Ee.GOOGLE_CREDENTIALS=new Ee("google-credentials-uid"),Ee.FIRST_PARTY=new Ee("first-party-uid"),Ee.MOCK_USER=new Ee("mock-user");let _n="11.0.0";const pt=new Qe.Vy("@firebase/firestore");function gn(){return pt.logLevel}function N(r,...e){if(pt.logLevel<=Qe.$b.DEBUG){const t=e.map(ks);pt.debug(`Firestore (${_n}): ${r}`,...t)}}function pe(r,...e){if(pt.logLevel<=Qe.$b.ERROR){const t=e.map(ks);pt.error(`Firestore (${_n}): ${r}`,...t)}}function ze(r,...e){if(pt.logLevel<=Qe.$b.WARN){const t=e.map(ks);pt.warn(`Firestore (${_n}): ${r}`,...t)}}function ks(r){if("string"==typeof r)return r;try{return JSON.stringify(r)}catch{return r}}function L(r="Unexpected state"){const e=`FIRESTORE (${_n}) INTERNAL ASSERTION FAILED: `+r;throw pe(e),new Error(e)}function B(r,e){r||L()}function F(r,e){return r}const V={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"};class C extends ee.g{constructor(e,t){super(e,t),this.code=e,this.message=t,this.toString=()=>`${this.name}: [code=${this.code}]: ${this.message}`}}class ve{constructor(){this.promise=new Promise((e,t)=>{this.resolve=e,this.reject=t})}}class ju{constructor(e,t){this.user=t,this.type="OAuth",this.headers=new Map,this.headers.set("Authorization",`Bearer ${e}`)}}class qf{getToken(){return Promise.resolve(null)}invalidateToken(){}start(e,t){e.enqueueRetryable(()=>t(Ee.UNAUTHENTICATED))}shutdown(){}}class zf{constructor(e){this.token=e,this.changeListener=null}getToken(){return Promise.resolve(this.token)}invalidateToken(){}start(e,t){this.changeListener=t,e.enqueueRetryable(()=>t(this.token.user))}shutdown(){this.changeListener=null}}class $f{constructor(e){this.t=e,this.currentUser=Ee.UNAUTHENTICATED,this.i=0,this.forceRefresh=!1,this.auth=null}start(e,t){var n=this;B(void 0===this.o);let i=this.i;const s=h=>this.i!==i?(i=this.i,t(h)):Promise.resolve();let a=new ve;this.o=()=>{this.i++,this.currentUser=this.u(),a.resolve(),a=new ve,e.enqueueRetryable(()=>s(this.currentUser))};const u=()=>{const h=a;e.enqueueRetryable((0,b.A)(function*(){yield h.promise,yield s(n.currentUser)}))},l=h=>{N("FirebaseAuthCredentialsProvider","Auth detected"),this.auth=h,this.o&&(this.auth.addAuthTokenListener(this.o),u())};this.t.onInit(h=>l(h)),setTimeout(()=>{if(!this.auth){const h=this.t.getImmediate({optional:!0});h?l(h):(N("FirebaseAuthCredentialsProvider","Auth not yet detected"),a.resolve(),a=new ve)}},0),u()}getToken(){const e=this.i,t=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(t).then(n=>this.i!==e?(N("FirebaseAuthCredentialsProvider","getToken aborted due to token change."),this.getToken()):n?(B("string"==typeof n.accessToken),new ju(n.accessToken,this.currentUser)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.auth&&this.o&&this.auth.removeAuthTokenListener(this.o),this.o=void 0}u(){const e=this.auth&&this.auth.getUid();return B(null===e||"string"==typeof e),new Ee(e)}}class Gf{constructor(e,t,n){this.l=e,this.h=t,this.P=n,this.type="FirstParty",this.user=Ee.FIRST_PARTY,this.I=new Map}T(){return this.P?this.P():null}get headers(){this.I.set("X-Goog-AuthUser",this.l);const e=this.T();return e&&this.I.set("Authorization",e),this.h&&this.I.set("X-Goog-Iam-Authorization-Token",this.h),this.I}}class Kf{constructor(e,t,n){this.l=e,this.h=t,this.P=n}getToken(){return Promise.resolve(new Gf(this.l,this.h,this.P))}start(e,t){e.enqueueRetryable(()=>t(Ee.FIRST_PARTY))}shutdown(){}invalidateToken(){}}class Wu{constructor(e){this.value=e,this.type="AppCheck",this.headers=new Map,e&&e.length>0&&this.headers.set("x-firebase-appcheck",this.value)}}class jf{constructor(e){this.A=e,this.forceRefresh=!1,this.appCheck=null,this.R=null}start(e,t){B(void 0===this.o);const n=s=>{null!=s.error&&N("FirebaseAppCheckTokenProvider",`Error getting App Check token; using placeholder token instead. Error: ${s.error.message}`);const a=s.token!==this.R;return this.R=s.token,N("FirebaseAppCheckTokenProvider",`Received ${a?"new":"existing"} token.`),a?t(s.token):Promise.resolve()};this.o=s=>{e.enqueueRetryable(()=>n(s))};const i=s=>{N("FirebaseAppCheckTokenProvider","AppCheck detected"),this.appCheck=s,this.o&&this.appCheck.addTokenListener(this.o)};this.A.onInit(s=>i(s)),setTimeout(()=>{if(!this.appCheck){const s=this.A.getImmediate({optional:!0});s?i(s):N("FirebaseAppCheckTokenProvider","AppCheck not yet detected")}},0)}getToken(){const e=this.forceRefresh;return this.forceRefresh=!1,this.appCheck?this.appCheck.getToken(e).then(t=>t?(B("string"==typeof t.token),this.R=t.token,new Wu(t.token)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.appCheck&&this.o&&this.appCheck.removeTokenListener(this.o),this.o=void 0}}function Wf(r){const e=typeof self<"u"&&(self.crypto||self.msCrypto),t=new Uint8Array(r);if(e&&"function"==typeof e.getRandomValues)e.getRandomValues(t);else for(let n=0;n<r;n++)t[n]=Math.floor(256*Math.random());return t}class Qu{static newId(){const t=62*Math.floor(256/62);let n="";for(;n.length<20;){const i=Wf(40);for(let s=0;s<i.length;++s)n.length<20&&i[s]<t&&(n+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789".charAt(i[s]%62))}return n}}function G(r,e){return r<e?-1:r>e?1:0}function pn(r,e,t){return r.length===e.length&&r.every((n,i)=>t(n,e[i]))}function Hu(r){return r+"\0"}class ce{constructor(e,t){if(this.seconds=e,this.nanoseconds=t,t<0)throw new C(V.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(t>=1e9)throw new C(V.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(e<-62135596800)throw new C(V.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e);if(e>=253402300800)throw new C(V.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e)}static now(){return ce.fromMillis(Date.now())}static fromDate(e){return ce.fromMillis(e.getTime())}static fromMillis(e){const t=Math.floor(e/1e3),n=Math.floor(1e6*(e-1e3*t));return new ce(t,n)}toDate(){return new Date(this.toMillis())}toMillis(){return 1e3*this.seconds+this.nanoseconds/1e6}_compareTo(e){return this.seconds===e.seconds?G(this.nanoseconds,e.nanoseconds):G(this.seconds,e.seconds)}isEqual(e){return e.seconds===this.seconds&&e.nanoseconds===this.nanoseconds}toString(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"}toJSON(){return{seconds:this.seconds,nanoseconds:this.nanoseconds}}valueOf(){return String(this.seconds- -62135596800).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")}}class z{constructor(e){this.timestamp=e}static fromTimestamp(e){return new z(e)}static min(){return new z(new ce(0,0))}static max(){return new z(new ce(253402300799,999999999))}compareTo(e){return this.timestamp._compareTo(e.timestamp)}isEqual(e){return this.timestamp.isEqual(e.timestamp)}toMicroseconds(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3}toString(){return"SnapshotVersion("+this.timestamp.toString()+")"}toTimestamp(){return this.timestamp}}class sr{constructor(e,t,n){void 0===t?t=0:t>e.length&&L(),void 0===n?n=e.length-t:n>e.length-t&&L(),this.segments=e,this.offset=t,this.len=n}get length(){return this.len}isEqual(e){return 0===sr.comparator(this,e)}child(e){const t=this.segments.slice(this.offset,this.limit());return e instanceof sr?e.forEach(n=>{t.push(n)}):t.push(e),this.construct(t)}limit(){return this.offset+this.length}popFirst(e){return this.construct(this.segments,this.offset+(e=void 0===e?1:e),this.length-e)}popLast(){return this.construct(this.segments,this.offset,this.length-1)}firstSegment(){return this.segments[this.offset]}lastSegment(){return this.get(this.length-1)}get(e){return this.segments[this.offset+e]}isEmpty(){return 0===this.length}isPrefixOf(e){if(e.length<this.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}isImmediateParentOf(e){if(this.length+1!==e.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}forEach(e){for(let t=this.offset,n=this.limit();t<n;t++)e(this.segments[t])}toArray(){return this.segments.slice(this.offset,this.limit())}static comparator(e,t){const n=Math.min(e.length,t.length);for(let i=0;i<n;i++){const s=e.get(i),a=t.get(i);if(s<a)return-1;if(s>a)return 1}return e.length<t.length?-1:e.length>t.length?1:0}}class H extends sr{construct(e,t,n){return new H(e,t,n)}canonicalString(){return this.toArray().join("/")}toString(){return this.canonicalString()}toUriEncodedString(){return this.toArray().map(encodeURIComponent).join("/")}static fromString(...e){const t=[];for(const n of e){if(n.indexOf("//")>=0)throw new C(V.INVALID_ARGUMENT,`Invalid segment (${n}). Paths must not contain // in them.`);t.push(...n.split("/").filter(i=>i.length>0))}return new H(t)}static emptyPath(){return new H([])}}const Qf=/^[_a-zA-Z][_a-zA-Z0-9]*$/;class oe extends sr{construct(e,t,n){return new oe(e,t,n)}static isValidIdentifier(e){return Qf.test(e)}canonicalString(){return this.toArray().map(e=>(e=e.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),oe.isValidIdentifier(e)||(e="`"+e+"`"),e)).join(".")}toString(){return this.canonicalString()}isKeyField(){return 1===this.length&&"__name__"===this.get(0)}static keyField(){return new oe(["__name__"])}static fromServerFormat(e){const t=[];let n="",i=0;const s=()=>{if(0===n.length)throw new C(V.INVALID_ARGUMENT,`Invalid field path (${e}). Paths must not be empty, begin with '.', end with '.', or contain '..'`);t.push(n),n=""};let a=!1;for(;i<e.length;){const u=e[i];if("\\"===u){if(i+1===e.length)throw new C(V.INVALID_ARGUMENT,"Path has trailing escape character: "+e);const l=e[i+1];if("\\"!==l&&"."!==l&&"`"!==l)throw new C(V.INVALID_ARGUMENT,"Path has invalid escape sequence: "+e);n+=l,i+=2}else"`"===u?(a=!a,i++):"."!==u||a?(n+=u,i++):(s(),i++)}if(s(),a)throw new C(V.INVALID_ARGUMENT,"Unterminated ` in path: "+e);return new oe(t)}static emptyPath(){return new oe([])}}class O{constructor(e){this.path=e}static fromPath(e){return new O(H.fromString(e))}static fromName(e){return new O(H.fromString(e).popFirst(5))}static empty(){return new O(H.emptyPath())}get collectionGroup(){return this.path.popLast().lastSegment()}hasCollectionId(e){return this.path.length>=2&&this.path.get(this.path.length-2)===e}getCollectionGroup(){return this.path.get(this.path.length-2)}getCollectionPath(){return this.path.popLast()}isEqual(e){return null!==e&&0===H.comparator(this.path,e.path)}toString(){return this.path.toString()}static comparator(e,t){return H.comparator(e.path,t.path)}static isDocumentKey(e){return e.length%2==0}static fromSegments(e){return new O(new H(e.slice()))}}class yn{constructor(e,t,n,i){this.indexId=e,this.collectionGroup=t,this.fields=n,this.indexState=i}}function Fs(r){return r.fields.find(e=>2===e.kind)}function qt(r){return r.fields.filter(e=>2!==e.kind)}yn.UNKNOWN_ID=-1;class zt{constructor(e,t){this.fieldPath=e,this.kind=t}}class In{constructor(e,t){this.sequenceNumber=e,this.offset=t}static empty(){return new In(0,$e.min())}}function Ju(r,e){const t=r.toTimestamp().seconds,n=r.toTimestamp().nanoseconds+1,i=z.fromTimestamp(1e9===n?new ce(t+1,0):new ce(t,n));return new $e(i,O.empty(),e)}function Yu(r){return new $e(r.readTime,r.key,-1)}class $e{constructor(e,t,n){this.readTime=e,this.documentKey=t,this.largestBatchId=n}static min(){return new $e(z.min(),O.empty(),-1)}static max(){return new $e(z.max(),O.empty(),-1)}}function Ms(r,e){let t=r.readTime.compareTo(e.readTime);return 0!==t?t:(t=O.comparator(r.documentKey,e.documentKey),0!==t?t:G(r.largestBatchId,e.largestBatchId))}const Xu="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.";class Zu{constructor(){this.onCommittedListeners=[]}addOnCommittedListener(e){this.onCommittedListeners.push(e)}raiseOnCommittedEvent(){this.onCommittedListeners.forEach(e=>e())}}function yt(r){return Os.apply(this,arguments)}function Os(){return(Os=(0,b.A)(function*(r){if(r.code!==V.FAILED_PRECONDITION||r.message!==Xu)throw r;N("LocalStore","Unexpectedly lost primary lease")})).apply(this,arguments)}class w{constructor(e){this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,e(t=>{this.isDone=!0,this.result=t,this.nextCallback&&this.nextCallback(t)},t=>{this.isDone=!0,this.error=t,this.catchCallback&&this.catchCallback(t)})}catch(e){return this.next(void 0,e)}next(e,t){return this.callbackAttached&&L(),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(t,this.error):this.wrapSuccess(e,this.result):new w((n,i)=>{this.nextCallback=s=>{this.wrapSuccess(e,s).next(n,i)},this.catchCallback=s=>{this.wrapFailure(t,s).next(n,i)}})}toPromise(){return new Promise((e,t)=>{this.next(e,t)})}wrapUserFunction(e){try{const t=e();return t instanceof w?t:w.resolve(t)}catch(t){return w.reject(t)}}wrapSuccess(e,t){return e?this.wrapUserFunction(()=>e(t)):w.resolve(t)}wrapFailure(e,t){return e?this.wrapUserFunction(()=>e(t)):w.reject(t)}static resolve(e){return new w((t,n)=>{t(e)})}static reject(e){return new w((t,n)=>{n(e)})}static waitFor(e){return new w((t,n)=>{let i=0,s=0,a=!1;e.forEach(u=>{++i,u.next(()=>{++s,a&&s===i&&t()},l=>n(l))}),a=!0,s===i&&t()})}static or(e){let t=w.resolve(!1);for(const n of e)t=t.next(i=>i?w.resolve(i):n());return t}static forEach(e,t){const n=[];return e.forEach((i,s)=>{n.push(t.call(this,i,s))}),this.waitFor(n)}static mapArray(e,t){return new w((n,i)=>{const s=e.length,a=new Array(s);let u=0;for(let l=0;l<s;l++){const h=l;t(e[h]).next(f=>{a[h]=f,++u,u===s&&n(a)},f=>i(f))}})}static doWhile(e,t){return new w((n,i)=>{const s=()=>{!0===e()?t().next(()=>{s()},i):n()};s()})}}class mi{constructor(e,t){this.action=e,this.transaction=t,this.aborted=!1,this.V=new ve,this.transaction.oncomplete=()=>{this.V.resolve()},this.transaction.onabort=()=>{t.error?this.V.reject(new or(e,t.error)):this.V.resolve()},this.transaction.onerror=n=>{const i=Ls(n.target.error);this.V.reject(new or(e,i))}}static open(e,t,n,i){try{return new mi(t,e.transaction(i,n))}catch(s){throw new or(t,s)}}get m(){return this.V.promise}abort(e){e&&this.V.reject(e),this.aborted||(N("SimpleDb","Aborting transaction:",e?e.message:"Client-initiated abort"),this.aborted=!0,this.transaction.abort())}g(){const e=this.transaction;this.aborted||"function"!=typeof e.commit||e.commit()}store(e){const t=this.transaction.objectStore(e);return new Xf(t)}}class He{constructor(e,t,n){this.name=e,this.version=t,this.p=n,12.2===He.S((0,ee.ZQ)())&&pe("Firestore persistence suffers from a bug in iOS 12.2 Safari that may cause your app to stop working. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.")}static delete(e){return N("SimpleDb","Removing database:",e),$t(window.indexedDB.deleteDatabase(e)).toPromise()}static D(){if(!(0,ee.zW)())return!1;if(He.v())return!0;const e=(0,ee.ZQ)(),t=He.S(e),n=0<t&&t<10,i=el(e),s=0<i&&i<4.5;return!(e.indexOf("MSIE ")>0||e.indexOf("Trident/")>0||e.indexOf("Edge/")>0||n||s)}static v(){var e;return typeof process<"u"&&"YES"===(null===(e=process.__PRIVATE_env)||void 0===e?void 0:e.C)}static F(e,t){return e.store(t)}static S(e){const t=e.match(/i(?:phone|pad|pod) os ([\d_]+)/i),n=t?t[1].split("_").slice(0,2).join("."):"-1";return Number(n)}M(e){var t=this;return(0,b.A)(function*(){return t.db||(N("SimpleDb","Opening database:",t.name),t.db=yield new Promise((n,i)=>{const s=indexedDB.open(t.name,t.version);s.onsuccess=a=>{n(a.target.result)},s.onblocked=()=>{i(new or(e,"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))},s.onerror=a=>{const u=a.target.error;i("VersionError"===u.name?new C(V.FAILED_PRECONDITION,"A newer version of the Firestore SDK was previously used and so the persisted data is not compatible with the version of the SDK you are now using. The SDK will operate with persistence disabled. If you need persistence, please re-upgrade to a newer version of the SDK or else clear the persisted IndexedDB data for your app to start fresh."):"InvalidStateError"===u.name?new C(V.FAILED_PRECONDITION,"Unable to open an IndexedDB connection. This could be due to running in a private browsing session on a browser whose private browsing sessions do not support IndexedDB: "+u):new or(e,u))},s.onupgradeneeded=a=>{N("SimpleDb",'Database "'+t.name+'" requires upgrade from version:',a.oldVersion),t.p.O(a.target.result,s.transaction,a.oldVersion,t.version).next(()=>{N("SimpleDb","Database upgrade to version "+t.version+" complete")})}})),t.N&&(t.db.onversionchange=n=>t.N(n)),t.db})()}L(e){this.N=e,this.db&&(this.db.onversionchange=t=>e(t))}runTransaction(e,t,n,i){var s=this;return(0,b.A)(function*(){const a="readonly"===t;let u=0;for(;;){++u;try{s.db=yield s.M(e);const l=mi.open(s.db,e,a?"readonly":"readwrite",n),h=i(l).next(f=>(l.g(),f)).catch(f=>(l.abort(f),w.reject(f))).toPromise();return h.catch(()=>{}),yield l.m,h}catch(l){const h=l,f="FirebaseError"!==h.name&&u<3;if(N("SimpleDb","Transaction failed with error:",h.message,"Retrying:",f),s.close(),!f)return Promise.reject(h)}}})()}close(){this.db&&this.db.close(),this.db=void 0}}function el(r){const e=r.match(/Android ([\d.]+)/i),t=e?e[1].split(".").slice(0,2).join("."):"-1";return Number(t)}class Yf{constructor(e){this.B=e,this.k=!1,this.q=null}get isDone(){return this.k}get K(){return this.q}set cursor(e){this.B=e}done(){this.k=!0}$(e){this.q=e}delete(){return $t(this.B.delete())}}class or extends C{constructor(e,t){super(V.UNAVAILABLE,`IndexedDB transaction '${e}' failed: ${t}`),this.name="IndexedDbTransactionError"}}function It(r){return"IndexedDbTransactionError"===r.name}class Xf{constructor(e){this.store=e}put(e,t){let n;return void 0!==t?(N("SimpleDb","PUT",this.store.name,e,t),n=this.store.put(t,e)):(N("SimpleDb","PUT",this.store.name,"<auto-key>",e),n=this.store.put(e)),$t(n)}add(e){return N("SimpleDb","ADD",this.store.name,e,e),$t(this.store.add(e))}get(e){return $t(this.store.get(e)).next(t=>(void 0===t&&(t=null),N("SimpleDb","GET",this.store.name,e,t),t))}delete(e){return N("SimpleDb","DELETE",this.store.name,e),$t(this.store.delete(e))}count(){return N("SimpleDb","COUNT",this.store.name),$t(this.store.count())}U(e,t){const n=this.options(e,t),i=n.index?this.store.index(n.index):this.store;if("function"==typeof i.getAll){const s=i.getAll(n.range);return new w((a,u)=>{s.onerror=l=>{u(l.target.error)},s.onsuccess=l=>{a(l.target.result)}})}{const s=this.cursor(n),a=[];return this.W(s,(u,l)=>{a.push(l)}).next(()=>a)}}G(e,t){const n=this.store.getAll(e,null===t?void 0:t);return new w((i,s)=>{n.onerror=a=>{s(a.target.error)},n.onsuccess=a=>{i(a.target.result)}})}j(e,t){N("SimpleDb","DELETE ALL",this.store.name);const n=this.options(e,t);n.H=!1;const i=this.cursor(n);return this.W(i,(s,a,u)=>u.delete())}J(e,t){let n;t?n=e:(n={},t=e);const i=this.cursor(n);return this.W(i,t)}Y(e){const t=this.cursor({});return new w((n,i)=>{t.onerror=s=>{const a=Ls(s.target.error);i(a)},t.onsuccess=s=>{const a=s.target.result;a?e(a.primaryKey,a.value).next(u=>{u?a.continue():n()}):n()}})}W(e,t){const n=[];return new w((i,s)=>{e.onerror=a=>{s(a.target.error)},e.onsuccess=a=>{const u=a.target.result;if(!u)return void i();const l=new Yf(u),h=t(u.primaryKey,u.value,l);if(h instanceof w){const f=h.catch(_=>(l.done(),w.reject(_)));n.push(f)}l.isDone?i():null===l.K?u.continue():u.continue(l.K)}}).next(()=>w.waitFor(n))}options(e,t){let n;return void 0!==e&&("string"==typeof e?n=e:t=e),{index:n,range:t}}cursor(e){let t="next";if(e.reverse&&(t="prev"),e.index){const n=this.store.index(e.index);return e.H?n.openKeyCursor(e.range,t):n.openCursor(e.range,t)}return this.store.openCursor(e.range,t)}}function $t(r){return new w((e,t)=>{r.onsuccess=n=>{e(n.target.result)},r.onerror=n=>{const i=Ls(n.target.error);t(i)}})}let tl=!1;function Ls(r){const e=He.S((0,ee.ZQ)());if(e>=12.2&&e<13){const t="An internal error was encountered in the Indexed Database server";if(r.message.indexOf(t)>=0){const n=new C("internal",`IOS_INDEXEDDB_BUG1: IndexedDb has thrown '${t}'. This is likely due to an unavoidable bug in iOS. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.`);return tl||(tl=!0,setTimeout(()=>{throw n},0)),n}}return r}class Zf{constructor(e,t){this.asyncQueue=e,this.Z=t,this.task=null}start(){this.X(15e3)}stop(){this.task&&(this.task.cancel(),this.task=null)}get started(){return null!==this.task}X(e){var t=this;N("IndexBackfiller",`Scheduled in ${e}ms`),this.task=this.asyncQueue.enqueueAfterDelay("index_backfill",e,(0,b.A)(function*(){t.task=null;try{N("IndexBackfiller",`Documents written: ${yield t.Z.ee()}`)}catch(n){It(n)?N("IndexBackfiller","Ignoring IndexedDB error during index backfill: ",n):yield yt(n)}yield t.X(6e4)}))}}class em{constructor(e,t){this.localStore=e,this.persistence=t}ee(e=50){var t=this;return(0,b.A)(function*(){return t.persistence.runTransaction("Backfill Indexes","readwrite-primary",n=>t.te(n,e))})()}te(e,t){const n=new Set;let i=t,s=!0;return w.doWhile(()=>!0===s&&i>0,()=>this.localStore.indexManager.getNextCollectionGroupToUpdate(e).next(a=>{if(null!==a&&!n.has(a))return N("IndexBackfiller",`Processing collection: ${a}`),this.ne(e,a,i).next(u=>{i-=u,n.add(a)});s=!1})).next(()=>t-i)}ne(e,t,n){return this.localStore.indexManager.getMinOffsetFromCollectionGroup(e,t).next(i=>this.localStore.localDocuments.getNextDocuments(e,t,i,n).next(s=>{const a=s.changes;return this.localStore.indexManager.updateIndexEntries(e,a).next(()=>this.re(i,s)).next(u=>(N("IndexBackfiller",`Updating offset: ${u}`),this.localStore.indexManager.updateCollectionGroup(e,t,u))).next(()=>a.size)}))}re(e,t){let n=e;return t.changes.forEach((i,s)=>{const a=Yu(s);Ms(a,n)>0&&(n=a)}),new $e(n.readTime,n.documentKey,Math.max(t.batchId,e.largestBatchId))}}let Ge=(()=>{class r{constructor(t,n){this.previousValue=t,n&&(n.sequenceNumberHandler=i=>this.ie(i),this.se=i=>n.writeSequenceNumber(i))}ie(t){return this.previousValue=Math.max(t,this.previousValue),this.previousValue}next(){const t=++this.previousValue;return this.se&&this.se(t),t}}return r.oe=-1,r})();function ar(r){return null==r}function ur(r){return 0===r&&1/r==-1/0}function nl(r){return"number"==typeof r&&Number.isInteger(r)&&!ur(r)&&r<=Number.MAX_SAFE_INTEGER&&r>=Number.MIN_SAFE_INTEGER}function Se(r){let e="";for(let t=0;t<r.length;t++)e.length>0&&(e=rl(e)),e=tm(r.get(t),e);return rl(e)}function tm(r,e){let t=e;const n=r.length;for(let i=0;i<n;i++){const s=r.charAt(i);switch(s){case"\0":t+="\x01\x10";break;case"\x01":t+="\x01\x11";break;default:t+=s}}return t}function rl(r){return r+"\x01\x01"}function Je(r){const e=r.length;if(B(e>=2),2===e)return B("\x01"===r.charAt(0)&&"\x01"===r.charAt(1)),H.emptyPath();const t=e-2,n=[];let i="";for(let s=0;s<e;){const a=r.indexOf("\x01",s);switch((a<0||a>t)&&L(),r.charAt(a+1)){case"\x01":const u=r.substring(s,a);let l;0===i.length?l=u:(i+=u,l=i,i=""),n.push(l);break;case"\x10":i+=r.substring(s,a),i+="\0";break;case"\x11":i+=r.substring(s,a+1);break;default:L()}s=a+2}return new H(n)}const il=["userId","batchId"];function _i(r,e){return[r,Se(e)]}function sl(r,e,t){return[r,Se(e),t]}const nm={},rm=["prefixPath","collectionGroup","readTime","documentId"],im=["prefixPath","collectionGroup","documentId"],sm=["collectionGroup","readTime","prefixPath","documentId"],om=["canonicalId","targetId"],am=["targetId","path"],um=["path","targetId"],lm=["collectionId","parent"],cm=["indexId","uid"],hm=["uid","sequenceNumber"],dm=["indexId","uid","arrayValue","directionalValue","orderedDocumentKey","documentKey"],fm=["indexId","uid","orderedDocumentKey"],mm=["userId","collectionPath","documentId"],_m=["userId","collectionPath","largestBatchId"],gm=["userId","collectionGroup","largestBatchId"],ol=["mutationQueues","mutations","documentMutations","remoteDocuments","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries"],pm=[...ol,"documentOverlays"],al=["mutationQueues","mutations","documentMutations","remoteDocumentsV14","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries","documentOverlays"],ul=al,Bs=[...ul,"indexConfiguration","indexState","indexEntries"],ym=Bs,Im=[...Bs,"globals"];class Us extends Zu{constructor(e,t){super(),this._e=e,this.currentSequenceNumber=t}}function Te(r,e){const t=F(r);return He.F(t._e,e)}function ll(r){let e=0;for(const t in r)Object.prototype.hasOwnProperty.call(r,t)&&e++;return e}function Tt(r,e){for(const t in r)Object.prototype.hasOwnProperty.call(r,t)&&e(t,r[t])}function hl(r){for(const e in r)if(Object.prototype.hasOwnProperty.call(r,e))return!1;return!0}class se{constructor(e,t){this.comparator=e,this.root=t||we.EMPTY}insert(e,t){return new se(this.comparator,this.root.insert(e,t,this.comparator).copy(null,null,we.BLACK,null,null))}remove(e){return new se(this.comparator,this.root.remove(e,this.comparator).copy(null,null,we.BLACK,null,null))}get(e){let t=this.root;for(;!t.isEmpty();){const n=this.comparator(e,t.key);if(0===n)return t.value;n<0?t=t.left:n>0&&(t=t.right)}return null}indexOf(e){let t=0,n=this.root;for(;!n.isEmpty();){const i=this.comparator(e,n.key);if(0===i)return t+n.left.size;i<0?n=n.left:(t+=n.left.size+1,n=n.right)}return-1}isEmpty(){return this.root.isEmpty()}get size(){return this.root.size}minKey(){return this.root.minKey()}maxKey(){return this.root.maxKey()}inorderTraversal(e){return this.root.inorderTraversal(e)}forEach(e){this.inorderTraversal((t,n)=>(e(t,n),!1))}toString(){const e=[];return this.inorderTraversal((t,n)=>(e.push(`${t}:${n}`),!1)),`{${e.join(", ")}}`}reverseTraversal(e){return this.root.reverseTraversal(e)}getIterator(){return new gi(this.root,null,this.comparator,!1)}getIteratorFrom(e){return new gi(this.root,e,this.comparator,!1)}getReverseIterator(){return new gi(this.root,null,this.comparator,!0)}getReverseIteratorFrom(e){return new gi(this.root,e,this.comparator,!0)}}class gi{constructor(e,t,n,i){this.isReverse=i,this.nodeStack=[];let s=1;for(;!e.isEmpty();)if(s=t?n(e.key,t):1,t&&i&&(s*=-1),s<0)e=this.isReverse?e.left:e.right;else{if(0===s){this.nodeStack.push(e);break}this.nodeStack.push(e),e=this.isReverse?e.right:e.left}}getNext(){let e=this.nodeStack.pop();const t={key:e.key,value:e.value};if(this.isReverse)for(e=e.left;!e.isEmpty();)this.nodeStack.push(e),e=e.right;else for(e=e.right;!e.isEmpty();)this.nodeStack.push(e),e=e.left;return t}hasNext(){return this.nodeStack.length>0}peek(){if(0===this.nodeStack.length)return null;const e=this.nodeStack[this.nodeStack.length-1];return{key:e.key,value:e.value}}}class we{constructor(e,t,n,i,s){this.key=e,this.value=t,this.color=null!=n?n:we.RED,this.left=null!=i?i:we.EMPTY,this.right=null!=s?s:we.EMPTY,this.size=this.left.size+1+this.right.size}copy(e,t,n,i,s){return new we(null!=e?e:this.key,null!=t?t:this.value,null!=n?n:this.color,null!=i?i:this.left,null!=s?s:this.right)}isEmpty(){return!1}inorderTraversal(e){return this.left.inorderTraversal(e)||e(this.key,this.value)||this.right.inorderTraversal(e)}reverseTraversal(e){return this.right.reverseTraversal(e)||e(this.key,this.value)||this.left.reverseTraversal(e)}min(){return this.left.isEmpty()?this:this.left.min()}minKey(){return this.min().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(e,t,n){let i=this;const s=n(e,i.key);return i=s<0?i.copy(null,null,null,i.left.insert(e,t,n),null):0===s?i.copy(null,t,null,null,null):i.copy(null,null,null,null,i.right.insert(e,t,n)),i.fixUp()}removeMin(){if(this.left.isEmpty())return we.EMPTY;let e=this;return e.left.isRed()||e.left.left.isRed()||(e=e.moveRedLeft()),e=e.copy(null,null,null,e.left.removeMin(),null),e.fixUp()}remove(e,t){let n,i=this;if(t(e,i.key)<0)i.left.isEmpty()||i.left.isRed()||i.left.left.isRed()||(i=i.moveRedLeft()),i=i.copy(null,null,null,i.left.remove(e,t),null);else{if(i.left.isRed()&&(i=i.rotateRight()),i.right.isEmpty()||i.right.isRed()||i.right.left.isRed()||(i=i.moveRedRight()),0===t(e,i.key)){if(i.right.isEmpty())return we.EMPTY;n=i.right.min(),i=i.copy(n.key,n.value,null,null,i.right.removeMin())}i=i.copy(null,null,null,null,i.right.remove(e,t))}return i.fixUp()}isRed(){return this.color}fixUp(){let e=this;return e.right.isRed()&&!e.left.isRed()&&(e=e.rotateLeft()),e.left.isRed()&&e.left.left.isRed()&&(e=e.rotateRight()),e.left.isRed()&&e.right.isRed()&&(e=e.colorFlip()),e}moveRedLeft(){let e=this.colorFlip();return e.right.left.isRed()&&(e=e.copy(null,null,null,null,e.right.rotateRight()),e=e.rotateLeft(),e=e.colorFlip()),e}moveRedRight(){let e=this.colorFlip();return e.left.left.isRed()&&(e=e.rotateRight(),e=e.colorFlip()),e}rotateLeft(){const e=this.copy(null,null,we.RED,null,this.right.left);return this.right.copy(null,null,this.color,e,null)}rotateRight(){const e=this.copy(null,null,we.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,e)}colorFlip(){const e=this.left.copy(null,null,!this.left.color,null,null),t=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,e,t)}checkMaxDepth(){const e=this.check();return Math.pow(2,e)<=this.size+1}check(){if(this.isRed()&&this.left.isRed()||this.right.isRed())throw L();const e=this.left.check();if(e!==this.right.check())throw L();return e+(this.isRed()?0:1)}}we.EMPTY=null,we.RED=!0,we.BLACK=!1,we.EMPTY=new class{constructor(){this.size=0}get key(){throw L()}get value(){throw L()}get color(){throw L()}get left(){throw L()}get right(){throw L()}copy(e,t,n,i,s){return this}insert(e,t,n){return new we(e,t)}remove(e,t){return this}isEmpty(){return!0}inorderTraversal(e){return!1}reverseTraversal(e){return!1}minKey(){return null}maxKey(){return null}isRed(){return!1}checkMaxDepth(){return!0}check(){return 0}};class ne{constructor(e){this.comparator=e,this.data=new se(this.comparator)}has(e){return null!==this.data.get(e)}first(){return this.data.minKey()}last(){return this.data.maxKey()}get size(){return this.data.size}indexOf(e){return this.data.indexOf(e)}forEach(e){this.data.inorderTraversal((t,n)=>(e(t),!1))}forEachInRange(e,t){const n=this.data.getIteratorFrom(e[0]);for(;n.hasNext();){const i=n.getNext();if(this.comparator(i.key,e[1])>=0)return;t(i.key)}}forEachWhile(e,t){let n;for(n=void 0!==t?this.data.getIteratorFrom(t):this.data.getIterator();n.hasNext();)if(!e(n.getNext().key))return}firstAfterOrEqual(e){const t=this.data.getIteratorFrom(e);return t.hasNext()?t.getNext().key:null}getIterator(){return new dl(this.data.getIterator())}getIteratorFrom(e){return new dl(this.data.getIteratorFrom(e))}add(e){return this.copy(this.data.remove(e).insert(e,!0))}delete(e){return this.has(e)?this.copy(this.data.remove(e)):this}isEmpty(){return this.data.isEmpty()}unionWith(e){let t=this;return t.size<e.size&&(t=e,e=this),e.forEach(n=>{t=t.add(n)}),t}isEqual(e){if(!(e instanceof ne)||this.size!==e.size)return!1;const t=this.data.getIterator(),n=e.data.getIterator();for(;t.hasNext();){const i=t.getNext().key,s=n.getNext().key;if(0!==this.comparator(i,s))return!1}return!0}toArray(){const e=[];return this.forEach(t=>{e.push(t)}),e}toString(){const e=[];return this.forEach(t=>e.push(t)),"SortedSet("+e.toString()+")"}copy(e){const t=new ne(this.comparator);return t.data=e,t}}class dl{constructor(e){this.iter=e}getNext(){return this.iter.getNext().key}hasNext(){return this.iter.hasNext()}}function Tn(r){return r.hasNext()?r.getNext():void 0}class Ue{constructor(e){this.fields=e,e.sort(oe.comparator)}static empty(){return new Ue([])}unionWith(e){let t=new ne(oe.comparator);for(const n of this.fields)t=t.add(n);for(const n of e)t=t.add(n);return new Ue(t.toArray())}covers(e){for(const t of this.fields)if(t.isPrefixOf(e))return!0;return!1}isEqual(e){return pn(this.fields,e.fields,(t,n)=>t.isEqual(n))}}class fl extends Error{constructor(){super(...arguments),this.name="Base64DecodeError"}}class me{constructor(e){this.binaryString=e}static fromBase64String(e){const t=function(i){try{return atob(i)}catch(s){throw typeof DOMException<"u"&&s instanceof DOMException?new fl("Invalid base64 string: "+s):s}}(e);return new me(t)}static fromUint8Array(e){const t=function(i){let s="";for(let a=0;a<i.length;++a)s+=String.fromCharCode(i[a]);return s}(e);return new me(t)}[Symbol.iterator](){let e=0;return{next:()=>e<this.binaryString.length?{value:this.binaryString.charCodeAt(e++),done:!1}:{value:void 0,done:!0}}}toBase64(){return btoa(this.binaryString)}toUint8Array(){return function(t){const n=new Uint8Array(t.length);for(let i=0;i<t.length;i++)n[i]=t.charCodeAt(i);return n}(this.binaryString)}approximateByteSize(){return 2*this.binaryString.length}compareTo(e){return G(this.binaryString,e.binaryString)}isEqual(e){return this.binaryString===e.binaryString}}me.EMPTY_BYTE_STRING=new me("");const Em=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function rt(r){if(B(!!r),"string"==typeof r){let e=0;const t=Em.exec(r);if(B(!!t),t[1]){let i=t[1];i=(i+"000000000").substr(0,9),e=Number(i)}const n=new Date(r);return{seconds:Math.floor(n.getTime()/1e3),nanos:e}}return{seconds:he(r.seconds),nanos:he(r.nanos)}}function he(r){return"number"==typeof r?r:"string"==typeof r?Number(r):0}function it(r){return"string"==typeof r?me.fromBase64String(r):me.fromUint8Array(r)}function pi(r){var e,t;return"server_timestamp"===(null===(t=((null===(e=null==r?void 0:r.mapValue)||void 0===e?void 0:e.fields)||{}).__type__)||void 0===t?void 0:t.stringValue)}function yi(r){const e=r.mapValue.fields.__previous_value__;return pi(e)?yi(e):e}function lr(r){const e=rt(r.mapValue.fields.__local_write_time__.timestampValue);return new ce(e.seconds,e.nanos)}class vm{constructor(e,t,n,i,s,a,u,l,h){this.databaseId=e,this.appId=t,this.persistenceKey=n,this.host=i,this.ssl=s,this.forceLongPolling=a,this.autoDetectLongPolling=u,this.longPollingOptions=l,this.useFetchStreams=h}}class Et{constructor(e,t){this.projectId=e,this.database=t||"(default)"}static empty(){return new Et("","")}get isDefaultDatabase(){return"(default)"===this.database}isEqual(e){return e instanceof Et&&e.projectId===this.projectId&&e.database===this.database}}const vt={mapValue:{fields:{__type__:{stringValue:"__max__"}}}},Ii={nullValue:"NULL_VALUE"};function At(r){return"nullValue"in r?0:"booleanValue"in r?1:"integerValue"in r||"doubleValue"in r?2:"timestampValue"in r?3:"stringValue"in r?5:"bytesValue"in r?6:"referenceValue"in r?7:"geoPointValue"in r?8:"arrayValue"in r?9:"mapValue"in r?pi(r)?4:yl(r)?9007199254740991:vi(r)?10:11:L()}function Ye(r,e){if(r===e)return!0;const t=At(r);if(t!==At(e))return!1;switch(t){case 0:case 9007199254740991:return!0;case 1:return r.booleanValue===e.booleanValue;case 4:return lr(r).isEqual(lr(e));case 3:return function(i,s){if("string"==typeof i.timestampValue&&"string"==typeof s.timestampValue&&i.timestampValue.length===s.timestampValue.length)return i.timestampValue===s.timestampValue;const a=rt(i.timestampValue),u=rt(s.timestampValue);return a.seconds===u.seconds&&a.nanos===u.nanos}(r,e);case 5:return r.stringValue===e.stringValue;case 6:return s=e,it(r.bytesValue).isEqual(it(s.bytesValue));case 7:return r.referenceValue===e.referenceValue;case 8:return function(i,s){return he(i.geoPointValue.latitude)===he(s.geoPointValue.latitude)&&he(i.geoPointValue.longitude)===he(s.geoPointValue.longitude)}(r,e);case 2:return function(i,s){if("integerValue"in i&&"integerValue"in s)return he(i.integerValue)===he(s.integerValue);if("doubleValue"in i&&"doubleValue"in s){const a=he(i.doubleValue),u=he(s.doubleValue);return a===u?ur(a)===ur(u):isNaN(a)&&isNaN(u)}return!1}(r,e);case 9:return pn(r.arrayValue.values||[],e.arrayValue.values||[],Ye);case 10:case 11:return function(i,s){const a=i.mapValue.fields||{},u=s.mapValue.fields||{};if(ll(a)!==ll(u))return!1;for(const l in a)if(a.hasOwnProperty(l)&&(void 0===u[l]||!Ye(a[l],u[l])))return!1;return!0}(r,e);default:return L()}var s}function cr(r,e){return void 0!==(r.values||[]).find(t=>Ye(t,e))}function wt(r,e){if(r===e)return 0;const t=At(r),n=At(e);if(t!==n)return G(t,n);switch(t){case 0:case 9007199254740991:return 0;case 1:return G(r.booleanValue,e.booleanValue);case 2:return function(s,a){const u=he(s.integerValue||s.doubleValue),l=he(a.integerValue||a.doubleValue);return u<l?-1:u>l?1:u===l?0:isNaN(u)?isNaN(l)?0:-1:1}(r,e);case 3:return ml(r.timestampValue,e.timestampValue);case 4:return ml(lr(r),lr(e));case 5:return G(r.stringValue,e.stringValue);case 6:return function(s,a){const u=it(s),l=it(a);return u.compareTo(l)}(r.bytesValue,e.bytesValue);case 7:return function(s,a){const u=s.split("/"),l=a.split("/");for(let h=0;h<u.length&&h<l.length;h++){const f=G(u[h],l[h]);if(0!==f)return f}return G(u.length,l.length)}(r.referenceValue,e.referenceValue);case 8:return function(s,a){const u=G(he(s.latitude),he(a.latitude));return 0!==u?u:G(he(s.longitude),he(a.longitude))}(r.geoPointValue,e.geoPointValue);case 9:return _l(r.arrayValue,e.arrayValue);case 10:return function(s,a){var u,l,h,f;const R=null===(u=(s.fields||{}).value)||void 0===u?void 0:u.arrayValue,x=null===(l=(a.fields||{}).value)||void 0===l?void 0:l.arrayValue,k=G((null===(h=null==R?void 0:R.values)||void 0===h?void 0:h.length)||0,(null===(f=null==x?void 0:x.values)||void 0===f?void 0:f.length)||0);return 0!==k?k:_l(R,x)}(r.mapValue,e.mapValue);case 11:return function(s,a){if(s===vt.mapValue&&a===vt.mapValue)return 0;if(s===vt.mapValue)return 1;if(a===vt.mapValue)return-1;const u=s.fields||{},l=Object.keys(u),h=a.fields||{},f=Object.keys(h);l.sort(),f.sort();for(let _=0;_<l.length&&_<f.length;++_){const p=G(l[_],f[_]);if(0!==p)return p;const R=wt(u[l[_]],h[f[_]]);if(0!==R)return R}return G(l.length,f.length)}(r.mapValue,e.mapValue);default:throw L()}}function ml(r,e){if("string"==typeof r&&"string"==typeof e&&r.length===e.length)return G(r,e);const t=rt(r),n=rt(e),i=G(t.seconds,n.seconds);return 0!==i?i:G(t.nanos,n.nanos)}function _l(r,e){const t=r.values||[],n=e.values||[];for(let i=0;i<t.length&&i<n.length;++i){const s=wt(t[i],n[i]);if(s)return s}return G(t.length,n.length)}function En(r){return qs(r)}function qs(r){return"nullValue"in r?"null":"booleanValue"in r?""+r.booleanValue:"integerValue"in r?""+r.integerValue:"doubleValue"in r?""+r.doubleValue:"timestampValue"in r?function(t){const n=rt(t);return`time(${n.seconds},${n.nanos})`}(r.timestampValue):"stringValue"in r?r.stringValue:"bytesValue"in r?it(r.bytesValue).toBase64():"referenceValue"in r?O.fromName(r.referenceValue).toString():"geoPointValue"in r?function(t){return`geo(${t.latitude},${t.longitude})`}(r.geoPointValue):"arrayValue"in r?function(t){let n="[",i=!0;for(const s of t.values||[])i?i=!1:n+=",",n+=qs(s);return n+"]"}(r.arrayValue):"mapValue"in r?function(t){const n=Object.keys(t.fields||{}).sort();let i="{",s=!0;for(const a of n)s?s=!1:i+=",",i+=`${a}:${qs(t.fields[a])}`;return i+"}"}(r.mapValue):L()}function Ti(r){switch(At(r)){case 0:case 1:return 4;case 2:return 8;case 3:case 8:return 16;case 4:const e=yi(r);return e?16+Ti(e):16;case 5:return 2*r.stringValue.length;case 6:return it(r.bytesValue).approximateByteSize();case 7:return r.referenceValue.length;case 9:return(r.arrayValue.values||[]).reduce((i,s)=>i+Ti(s),0);case 10:case 11:return function(n){let i=0;return Tt(n.fields,(s,a)=>{i+=s.length+Ti(a)}),i}(r.mapValue);default:throw L()}}function Gt(r,e){return{referenceValue:`projects/${r.projectId}/databases/${r.database}/documents/${e.path.canonicalString()}`}}function zs(r){return!!r&&"integerValue"in r}function hr(r){return!!r&&"arrayValue"in r}function gl(r){return!!r&&"nullValue"in r}function pl(r){return!!r&&"doubleValue"in r&&isNaN(Number(r.doubleValue))}function Ei(r){return!!r&&"mapValue"in r}function vi(r){var e,t;return"__vector__"===(null===(t=((null===(e=null==r?void 0:r.mapValue)||void 0===e?void 0:e.fields)||{}).__type__)||void 0===t?void 0:t.stringValue)}function dr(r){if(r.geoPointValue)return{geoPointValue:Object.assign({},r.geoPointValue)};if(r.timestampValue&&"object"==typeof r.timestampValue)return{timestampValue:Object.assign({},r.timestampValue)};if(r.mapValue){const e={mapValue:{fields:{}}};return Tt(r.mapValue.fields,(t,n)=>e.mapValue.fields[t]=dr(n)),e}if(r.arrayValue){const e={arrayValue:{values:[]}};for(let t=0;t<(r.arrayValue.values||[]).length;++t)e.arrayValue.values[t]=dr(r.arrayValue.values[t]);return e}return Object.assign({},r)}function yl(r){return"__max__"===(((r.mapValue||{}).fields||{}).__type__||{}).stringValue}const Il={mapValue:{fields:{__type__:{stringValue:"__vector__"},value:{arrayValue:{}}}}};function Am(r){return"nullValue"in r?Ii:"booleanValue"in r?{booleanValue:!1}:"integerValue"in r||"doubleValue"in r?{doubleValue:NaN}:"timestampValue"in r?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"stringValue"in r?{stringValue:""}:"bytesValue"in r?{bytesValue:""}:"referenceValue"in r?Gt(Et.empty(),O.empty()):"geoPointValue"in r?{geoPointValue:{latitude:-90,longitude:-180}}:"arrayValue"in r?{arrayValue:{}}:"mapValue"in r?vi(r)?Il:{mapValue:{}}:L()}function wm(r){return"nullValue"in r?{booleanValue:!1}:"booleanValue"in r?{doubleValue:NaN}:"integerValue"in r||"doubleValue"in r?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"timestampValue"in r?{stringValue:""}:"stringValue"in r?{bytesValue:""}:"bytesValue"in r?Gt(Et.empty(),O.empty()):"referenceValue"in r?{geoPointValue:{latitude:-90,longitude:-180}}:"geoPointValue"in r?{arrayValue:{}}:"arrayValue"in r?Il:"mapValue"in r?vi(r)?{mapValue:{}}:vt:L()}function Tl(r,e){const t=wt(r.value,e.value);return 0!==t?t:r.inclusive&&!e.inclusive?-1:!r.inclusive&&e.inclusive?1:0}function El(r,e){const t=wt(r.value,e.value);return 0!==t?t:r.inclusive&&!e.inclusive?1:!r.inclusive&&e.inclusive?-1:0}class Re{constructor(e){this.value=e}static empty(){return new Re({mapValue:{}})}field(e){if(e.isEmpty())return this.value;{let t=this.value;for(let n=0;n<e.length-1;++n)if(t=(t.mapValue.fields||{})[e.get(n)],!Ei(t))return null;return t=(t.mapValue.fields||{})[e.lastSegment()],t||null}}set(e,t){this.getFieldsMap(e.popLast())[e.lastSegment()]=dr(t)}setAll(e){let t=oe.emptyPath(),n={},i=[];e.forEach((a,u)=>{if(!t.isImmediateParentOf(u)){const l=this.getFieldsMap(t);this.applyChanges(l,n,i),n={},i=[],t=u.popLast()}a?n[u.lastSegment()]=dr(a):i.push(u.lastSegment())});const s=this.getFieldsMap(t);this.applyChanges(s,n,i)}delete(e){const t=this.field(e.popLast());Ei(t)&&t.mapValue.fields&&delete t.mapValue.fields[e.lastSegment()]}isEqual(e){return Ye(this.value,e.value)}getFieldsMap(e){let t=this.value;t.mapValue.fields||(t.mapValue={fields:{}});for(let n=0;n<e.length;++n){let i=t.mapValue.fields[e.get(n)];Ei(i)&&i.mapValue.fields||(i={mapValue:{fields:{}}},t.mapValue.fields[e.get(n)]=i),t=i}return t.mapValue.fields}applyChanges(e,t,n){Tt(t,(i,s)=>e[i]=s);for(const i of n)delete e[i]}clone(){return new Re(dr(this.value))}}function vl(r){const e=[];return Tt(r.fields,(t,n)=>{const i=new oe([t]);if(Ei(n)){const s=vl(n.mapValue).fields;if(0===s.length)e.push(i);else for(const a of s)e.push(i.child(a))}else e.push(i)}),new Ue(e)}class ae{constructor(e,t,n,i,s,a,u){this.key=e,this.documentType=t,this.version=n,this.readTime=i,this.createTime=s,this.data=a,this.documentState=u}static newInvalidDocument(e){return new ae(e,0,z.min(),z.min(),z.min(),Re.empty(),0)}static newFoundDocument(e,t,n,i){return new ae(e,1,t,z.min(),n,i,0)}static newNoDocument(e,t){return new ae(e,2,t,z.min(),z.min(),Re.empty(),0)}static newUnknownDocument(e,t){return new ae(e,3,t,z.min(),z.min(),Re.empty(),2)}convertToFoundDocument(e,t){return!this.createTime.isEqual(z.min())||2!==this.documentType&&0!==this.documentType||(this.createTime=e),this.version=e,this.documentType=1,this.data=t,this.documentState=0,this}convertToNoDocument(e){return this.version=e,this.documentType=2,this.data=Re.empty(),this.documentState=0,this}convertToUnknownDocument(e){return this.version=e,this.documentType=3,this.data=Re.empty(),this.documentState=2,this}setHasCommittedMutations(){return this.documentState=2,this}setHasLocalMutations(){return this.documentState=1,this.version=z.min(),this}setReadTime(e){return this.readTime=e,this}get hasLocalMutations(){return 1===this.documentState}get hasCommittedMutations(){return 2===this.documentState}get hasPendingWrites(){return this.hasLocalMutations||this.hasCommittedMutations}isValidDocument(){return 0!==this.documentType}isFoundDocument(){return 1===this.documentType}isNoDocument(){return 2===this.documentType}isUnknownDocument(){return 3===this.documentType}isEqual(e){return e instanceof ae&&this.key.isEqual(e.key)&&this.version.isEqual(e.version)&&this.documentType===e.documentType&&this.documentState===e.documentState&&this.data.isEqual(e.data)}mutableCopy(){return new ae(this.key,this.documentType,this.version,this.readTime,this.createTime,this.data.clone(),this.documentState)}toString(){return`Document(${this.key}, ${this.version}, ${JSON.stringify(this.data.value)}, {createTime: ${this.createTime}}), {documentType: ${this.documentType}}), {documentState: ${this.documentState}})`}}class Rt{constructor(e,t){this.position=e,this.inclusive=t}}function Al(r,e,t){let n=0;for(let i=0;i<r.position.length;i++){const s=e[i],a=r.position[i];if(n=s.field.isKeyField()?O.comparator(O.fromName(a.referenceValue),t.key):wt(a,t.data.field(s.field)),"desc"===s.dir&&(n*=-1),0!==n)break}return n}function wl(r,e){if(null===r)return null===e;if(null===e||r.inclusive!==e.inclusive||r.position.length!==e.position.length)return!1;for(let t=0;t<r.position.length;t++)if(!Ye(r.position[t],e.position[t]))return!1;return!0}class fr{constructor(e,t="asc"){this.field=e,this.dir=t}}function Rm(r,e){return r.dir===e.dir&&r.field.isEqual(e.field)}class Rl{}class J extends Rl{constructor(e,t,n){super(),this.field=e,this.op=t,this.value=n}static create(e,t,n){return e.isKeyField()?"in"===t||"not-in"===t?this.createKeyFieldInFilter(e,t,n):new Pm(e,t,n):"array-contains"===t?new bm(e,n):"in"===t?new Cl(e,n):"not-in"===t?new xm(e,n):"array-contains-any"===t?new Cm(e,n):new J(e,t,n)}static createKeyFieldInFilter(e,t,n){return"in"===t?new Vm(e,n):new Sm(e,n)}matches(e){const t=e.data.field(this.field);return"!="===this.op?null!==t&&this.matchesComparison(wt(t,this.value)):null!==t&&At(this.value)===At(t)&&this.matchesComparison(wt(t,this.value))}matchesComparison(e){switch(this.op){case"<":return e<0;case"<=":return e<=0;case"==":return 0===e;case"!=":return 0!==e;case">":return e>0;case">=":return e>=0;default:return L()}}isInequality(){return["<","<=",">",">=","!=","not-in"].indexOf(this.op)>=0}getFlattenedFilters(){return[this]}getFilters(){return[this]}}class te extends Rl{constructor(e,t){super(),this.filters=e,this.op=t,this.ae=null}static create(e,t){return new te(e,t)}matches(e){return vn(this)?void 0===this.filters.find(t=>!t.matches(e)):void 0!==this.filters.find(t=>t.matches(e))}getFlattenedFilters(){return null!==this.ae||(this.ae=this.filters.reduce((e,t)=>e.concat(t.getFlattenedFilters()),[])),this.ae}getFilters(){return Object.assign([],this.filters)}}function vn(r){return"and"===r.op}function $s(r){return"or"===r.op}function Gs(r){return Pl(r)&&vn(r)}function Pl(r){for(const e of r.filters)if(e instanceof te)return!1;return!0}function Ks(r){if(r instanceof J)return r.field.canonicalString()+r.op.toString()+En(r.value);if(Gs(r))return r.filters.map(e=>Ks(e)).join(",");{const e=r.filters.map(t=>Ks(t)).join(",");return`${r.op}(${e})`}}function Vl(r,e){return r instanceof J?(n=r,(i=e)instanceof J&&n.op===i.op&&n.field.isEqual(i.field)&&Ye(n.value,i.value)):r instanceof te?function(n,i){return i instanceof te&&n.op===i.op&&n.filters.length===i.filters.length&&n.filters.reduce((s,a,u)=>s&&Vl(a,i.filters[u]),!0)}(r,e):void L();var n,i}function Sl(r,e){const t=r.filters.concat(e);return te.create(t,r.op)}function bl(r){return r instanceof J?`${(t=r).field.canonicalString()} ${t.op} ${En(t.value)}`:r instanceof te?function(t){return t.op.toString()+" {"+t.getFilters().map(bl).join(" ,")+"}"}(r):"Filter";var t}class Pm extends J{constructor(e,t,n){super(e,t,n),this.key=O.fromName(n.referenceValue)}matches(e){const t=O.comparator(e.key,this.key);return this.matchesComparison(t)}}class Vm extends J{constructor(e,t){super(e,"in",t),this.keys=xl(0,t)}matches(e){return this.keys.some(t=>t.isEqual(e.key))}}class Sm extends J{constructor(e,t){super(e,"not-in",t),this.keys=xl(0,t)}matches(e){return!this.keys.some(t=>t.isEqual(e.key))}}function xl(r,e){var t;return((null===(t=e.arrayValue)||void 0===t?void 0:t.values)||[]).map(n=>O.fromName(n.referenceValue))}class bm extends J{constructor(e,t){super(e,"array-contains",t)}matches(e){const t=e.data.field(this.field);return hr(t)&&cr(t.arrayValue,this.value)}}class Cl extends J{constructor(e,t){super(e,"in",t)}matches(e){const t=e.data.field(this.field);return null!==t&&cr(this.value.arrayValue,t)}}class xm extends J{constructor(e,t){super(e,"not-in",t)}matches(e){if(cr(this.value.arrayValue,{nullValue:"NULL_VALUE"}))return!1;const t=e.data.field(this.field);return null!==t&&!cr(this.value.arrayValue,t)}}class Cm extends J{constructor(e,t){super(e,"array-contains-any",t)}matches(e){const t=e.data.field(this.field);return!(!hr(t)||!t.arrayValue.values)&&t.arrayValue.values.some(n=>cr(this.value.arrayValue,n))}}class Dm{constructor(e,t=null,n=[],i=[],s=null,a=null,u=null){this.path=e,this.collectionGroup=t,this.orderBy=n,this.filters=i,this.limit=s,this.startAt=a,this.endAt=u,this.ue=null}}function js(r,e=null,t=[],n=[],i=null,s=null,a=null){return new Dm(r,e,t,n,i,s,a)}function Kt(r){const e=F(r);if(null===e.ue){let t=e.path.canonicalString();null!==e.collectionGroup&&(t+="|cg:"+e.collectionGroup),t+="|f:",t+=e.filters.map(n=>Ks(n)).join(","),t+="|ob:",t+=e.orderBy.map(n=>{return(s=n).field.canonicalString()+s.dir;var s}).join(","),ar(e.limit)||(t+="|l:",t+=e.limit),e.startAt&&(t+="|lb:",t+=e.startAt.inclusive?"b:":"a:",t+=e.startAt.position.map(n=>En(n)).join(",")),e.endAt&&(t+="|ub:",t+=e.endAt.inclusive?"a:":"b:",t+=e.endAt.position.map(n=>En(n)).join(",")),e.ue=t}return e.ue}function mr(r,e){if(r.limit!==e.limit||r.orderBy.length!==e.orderBy.length)return!1;for(let t=0;t<r.orderBy.length;t++)if(!Rm(r.orderBy[t],e.orderBy[t]))return!1;if(r.filters.length!==e.filters.length)return!1;for(let t=0;t<r.filters.length;t++)if(!Vl(r.filters[t],e.filters[t]))return!1;return r.collectionGroup===e.collectionGroup&&!!r.path.isEqual(e.path)&&!!wl(r.startAt,e.startAt)&&wl(r.endAt,e.endAt)}function Ai(r){return O.isDocumentKey(r.path)&&null===r.collectionGroup&&0===r.filters.length}function wi(r,e){return r.filters.filter(t=>t instanceof J&&t.field.isEqual(e))}function Dl(r,e,t){let n=Ii,i=!0;for(const s of wi(r,e)){let a=Ii,u=!0;switch(s.op){case"<":case"<=":a=Am(s.value);break;case"==":case"in":case">=":a=s.value;break;case">":a=s.value,u=!1;break;case"!=":case"not-in":a=Ii}Tl({value:n,inclusive:i},{value:a,inclusive:u})<0&&(n=a,i=u)}if(null!==t)for(let s=0;s<r.orderBy.length;++s)if(r.orderBy[s].field.isEqual(e)){const a=t.position[s];Tl({value:n,inclusive:i},{value:a,inclusive:t.inclusive})<0&&(n=a,i=t.inclusive);break}return{value:n,inclusive:i}}function Nl(r,e,t){let n=vt,i=!0;for(const s of wi(r,e)){let a=vt,u=!0;switch(s.op){case">=":case">":a=wm(s.value),u=!1;break;case"==":case"in":case"<=":a=s.value;break;case"<":a=s.value,u=!1;break;case"!=":case"not-in":a=vt}El({value:n,inclusive:i},{value:a,inclusive:u})>0&&(n=a,i=u)}if(null!==t)for(let s=0;s<r.orderBy.length;++s)if(r.orderBy[s].field.isEqual(e)){const a=t.position[s];El({value:n,inclusive:i},{value:a,inclusive:t.inclusive})>0&&(n=a,i=t.inclusive);break}return{value:n,inclusive:i}}class st{constructor(e,t=null,n=[],i=[],s=null,a="F",u=null,l=null){this.path=e,this.collectionGroup=t,this.explicitOrderBy=n,this.filters=i,this.limit=s,this.limitType=a,this.startAt=u,this.endAt=l,this.ce=null,this.le=null,this.he=null}}function kl(r,e,t,n,i,s,a,u){return new st(r,e,t,n,i,s,a,u)}function An(r){return new st(r)}function Fl(r){return 0===r.filters.length&&null===r.limit&&null==r.startAt&&null==r.endAt&&(0===r.explicitOrderBy.length||1===r.explicitOrderBy.length&&r.explicitOrderBy[0].field.isKeyField())}function Ws(r){return null!==r.collectionGroup}function wn(r){const e=F(r);if(null===e.ce){e.ce=[];const t=new Set;for(const s of e.explicitOrderBy)e.ce.push(s),t.add(s.field.canonicalString());const n=e.explicitOrderBy.length>0?e.explicitOrderBy[e.explicitOrderBy.length-1].dir:"asc";(function(a){let u=new ne(oe.comparator);return a.filters.forEach(l=>{l.getFlattenedFilters().forEach(h=>{h.isInequality()&&(u=u.add(h.field))})}),u})(e).forEach(s=>{t.has(s.canonicalString())||s.isKeyField()||e.ce.push(new fr(s,n))}),t.has(oe.keyField().canonicalString())||e.ce.push(new fr(oe.keyField(),n))}return e.ce}function be(r){const e=F(r);return e.le||(e.le=function Ol(r,e){if("F"===r.limitType)return js(r.path,r.collectionGroup,e,r.filters,r.limit,r.startAt,r.endAt);{e=e.map(i=>new fr(i.field,"desc"===i.dir?"asc":"desc"));const t=r.endAt?new Rt(r.endAt.position,r.endAt.inclusive):null,n=r.startAt?new Rt(r.startAt.position,r.startAt.inclusive):null;return js(r.path,r.collectionGroup,e,r.filters,r.limit,t,n)}}(e,wn(r))),e.le}function Qs(r,e){const t=r.filters.concat([e]);return new st(r.path,r.collectionGroup,r.explicitOrderBy.slice(),t,r.limit,r.limitType,r.startAt,r.endAt)}function Ri(r,e,t){return new st(r.path,r.collectionGroup,r.explicitOrderBy.slice(),r.filters.slice(),e,t,r.startAt,r.endAt)}function _r(r,e){return mr(be(r),be(e))&&r.limitType===e.limitType}function Ll(r){return`${Kt(be(r))}|lt:${r.limitType}`}function Rn(r){return`Query(target=${function(t){let n=t.path.canonicalString();return null!==t.collectionGroup&&(n+=" collectionGroup="+t.collectionGroup),t.filters.length>0&&(n+=`, filters: [${t.filters.map(i=>bl(i)).join(", ")}]`),ar(t.limit)||(n+=", limit: "+t.limit),t.orderBy.length>0&&(n+=`, orderBy: [${t.orderBy.map(i=>{return`${(a=i).field.canonicalString()} (${a.dir})`;var a}).join(", ")}]`),t.startAt&&(n+=", startAt: ",n+=t.startAt.inclusive?"b:":"a:",n+=t.startAt.position.map(i=>En(i)).join(",")),t.endAt&&(n+=", endAt: ",n+=t.endAt.inclusive?"a:":"b:",n+=t.endAt.position.map(i=>En(i)).join(",")),`Target(${n})`}(be(r))}; limitType=${r.limitType})`}function gr(r,e){return e.isFoundDocument()&&function(n,i){const s=i.key.path;return null!==n.collectionGroup?i.key.hasCollectionId(n.collectionGroup)&&n.path.isPrefixOf(s):O.isDocumentKey(n.path)?n.path.isEqual(s):n.path.isImmediateParentOf(s)}(r,e)&&function(n,i){for(const s of wn(n))if(!s.field.isKeyField()&&null===i.data.field(s.field))return!1;return!0}(r,e)&&function(n,i){for(const s of n.filters)if(!s.matches(i))return!1;return!0}(r,e)&&(i=e,!((n=r).startAt&&!function(a,u,l){const h=Al(a,u,l);return a.inclusive?h<=0:h<0}(n.startAt,wn(n),i)||n.endAt&&!function(a,u,l){const h=Al(a,u,l);return a.inclusive?h>=0:h>0}(n.endAt,wn(n),i)));var n,i}function Bl(r){return r.collectionGroup||(r.path.length%2==1?r.path.lastSegment():r.path.get(r.path.length-2))}function Ul(r){return(e,t)=>{let n=!1;for(const i of wn(r)){const s=Nm(i,e,t);if(0!==s)return s;n=n||i.field.isKeyField()}return 0}}function Nm(r,e,t){const n=r.field.isKeyField()?O.comparator(e.key,t.key):function(s,a,u){const l=a.data.field(s),h=u.data.field(s);return null!==l&&null!==h?wt(l,h):L()}(r.field,e,t);switch(r.dir){case"asc":return n;case"desc":return-1*n;default:return L()}}class ot{constructor(e,t){this.mapKeyFn=e,this.equalsFn=t,this.inner={},this.innerSize=0}get(e){const t=this.mapKeyFn(e),n=this.inner[t];if(void 0!==n)for(const[i,s]of n)if(this.equalsFn(i,e))return s}has(e){return void 0!==this.get(e)}set(e,t){const n=this.mapKeyFn(e),i=this.inner[n];if(void 0===i)return this.inner[n]=[[e,t]],void this.innerSize++;for(let s=0;s<i.length;s++)if(this.equalsFn(i[s][0],e))return void(i[s]=[e,t]);i.push([e,t]),this.innerSize++}delete(e){const t=this.mapKeyFn(e),n=this.inner[t];if(void 0===n)return!1;for(let i=0;i<n.length;i++)if(this.equalsFn(n[i][0],e))return 1===n.length?delete this.inner[t]:n.splice(i,1),this.innerSize--,!0;return!1}forEach(e){Tt(this.inner,(t,n)=>{for(const[i,s]of n)e(i,s)})}isEmpty(){return hl(this.inner)}size(){return this.innerSize}}const km=new se(O.comparator);function qe(){return km}const ql=new se(O.comparator);function pr(...r){let e=ql;for(const t of r)e=e.insert(t.key,t);return e}function zl(r){let e=ql;return r.forEach((t,n)=>e=e.insert(t,n.overlayedDocument)),e}function Xe(){return yr()}function $l(){return yr()}function yr(){return new ot(r=>r.toString(),(r,e)=>r.isEqual(e))}const Fm=new se(O.comparator),Mm=new ne(O.comparator);function j(...r){let e=Mm;for(const t of r)e=e.add(t);return e}const Om=new ne(G);function Hs(){return Om}function Js(r,e){if(r.useProto3Json){if(isNaN(e))return{doubleValue:"NaN"};if(e===1/0)return{doubleValue:"Infinity"};if(e===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:ur(e)?"-0":e}}function Gl(r){return{integerValue:""+r}}function Kl(r,e){return nl(e)?Gl(e):Js(r,e)}class Pi{constructor(){this._=void 0}}function Lm(r,e,t){return r instanceof Pn?function(i,s){const a={fields:{__type__:{stringValue:"server_timestamp"},__local_write_time__:{timestampValue:{seconds:i.seconds,nanos:i.nanoseconds}}}};return s&&pi(s)&&(s=yi(s)),s&&(a.fields.__previous_value__=s),{mapValue:a}}(t,e):r instanceof jt?Wl(r,e):r instanceof Wt?Ql(r,e):function(i,s){const a=jl(i,s),u=Hl(a)+Hl(i.Pe);return zs(a)&&zs(i.Pe)?Gl(u):Js(i.serializer,u)}(r,e)}function Bm(r,e,t){return r instanceof jt?Wl(r,e):r instanceof Wt?Ql(r,e):t}function jl(r,e){return r instanceof Vn?zs(n=e)||(s=n)&&"doubleValue"in s?e:{integerValue:0}:null;var n,s}class Pn extends Pi{}class jt extends Pi{constructor(e){super(),this.elements=e}}function Wl(r,e){const t=Jl(e);for(const n of r.elements)t.some(i=>Ye(i,n))||t.push(n);return{arrayValue:{values:t}}}class Wt extends Pi{constructor(e){super(),this.elements=e}}function Ql(r,e){let t=Jl(e);for(const n of r.elements)t=t.filter(i=>!Ye(i,n));return{arrayValue:{values:t}}}class Vn extends Pi{constructor(e,t){super(),this.serializer=e,this.Pe=t}}function Hl(r){return he(r.integerValue||r.doubleValue)}function Jl(r){return hr(r)&&r.arrayValue.values?r.arrayValue.values.slice():[]}class Ir{constructor(e,t){this.field=e,this.transform=t}}class qm{constructor(e,t){this.version=e,this.transformResults=t}}class de{constructor(e,t){this.updateTime=e,this.exists=t}static none(){return new de}static exists(e){return new de(void 0,e)}static updateTime(e){return new de(e)}get isNone(){return void 0===this.updateTime&&void 0===this.exists}isEqual(e){return this.exists===e.exists&&(this.updateTime?!!e.updateTime&&this.updateTime.isEqual(e.updateTime):!e.updateTime)}}function Vi(r,e){return void 0!==r.updateTime?e.isFoundDocument()&&e.version.isEqual(r.updateTime):void 0===r.exists||r.exists===e.isFoundDocument()}class Si{}function Yl(r,e){if(!r.hasLocalMutations||e&&0===e.fields.length)return null;if(null===e)return r.isNoDocument()?new bn(r.key,de.none()):new Sn(r.key,r.data,de.none());{const t=r.data,n=Re.empty();let i=new ne(oe.comparator);for(let s of e.fields)if(!i.has(s)){let a=t.field(s);null===a&&s.length>1&&(s=s.popLast(),a=t.field(s)),null===a?n.delete(s):n.set(s,a),i=i.add(s)}return new at(r.key,n,new Ue(i.toArray()),de.none())}}function zm(r,e,t){r instanceof Sn?function(i,s,a){const u=i.value.clone(),l=ec(i.fieldTransforms,s,a.transformResults);u.setAll(l),s.convertToFoundDocument(a.version,u).setHasCommittedMutations()}(r,e,t):r instanceof at?function(i,s,a){if(!Vi(i.precondition,s))return void s.convertToUnknownDocument(a.version);const u=ec(i.fieldTransforms,s,a.transformResults),l=s.data;l.setAll(Zl(i)),l.setAll(u),s.convertToFoundDocument(a.version,l).setHasCommittedMutations()}(r,e,t):e.convertToNoDocument(t.version).setHasCommittedMutations()}function Tr(r,e,t,n){return r instanceof Sn?function(s,a,u,l){if(!Vi(s.precondition,a))return u;const h=s.value.clone(),f=tc(s.fieldTransforms,l,a);return h.setAll(f),a.convertToFoundDocument(a.version,h).setHasLocalMutations(),null}(r,e,t,n):r instanceof at?function(s,a,u,l){if(!Vi(s.precondition,a))return u;const h=tc(s.fieldTransforms,l,a),f=a.data;return f.setAll(Zl(s)),f.setAll(h),a.convertToFoundDocument(a.version,f).setHasLocalMutations(),null===u?null:u.unionWith(s.fieldMask.fields).unionWith(s.fieldTransforms.map(_=>_.field))}(r,e,t,n):(u=t,Vi(r.precondition,a=e)?(a.convertToNoDocument(a.version).setHasLocalMutations(),null):u);var a,u}function $m(r,e){let t=null;for(const n of r.fieldTransforms){const i=e.data.field(n.field),s=jl(n.transform,i||null);null!=s&&(null===t&&(t=Re.empty()),t.set(n.field,s))}return t||null}function Xl(r,e){return r.type===e.type&&!!r.key.isEqual(e.key)&&!!r.precondition.isEqual(e.precondition)&&(i=e.fieldTransforms,!!(void 0===(n=r.fieldTransforms)&&void 0===i||n&&i&&pn(n,i,(s,a)=>function Um(r,e){return r.field.isEqual(e.field)&&(i=e.transform,(n=r.transform)instanceof jt&&i instanceof jt||n instanceof Wt&&i instanceof Wt?pn(n.elements,i.elements,Ye):n instanceof Vn&&i instanceof Vn?Ye(n.Pe,i.Pe):n instanceof Pn&&i instanceof Pn);var n,i}(s,a))))&&(0===r.type?r.value.isEqual(e.value):1!==r.type||r.data.isEqual(e.data)&&r.fieldMask.isEqual(e.fieldMask));var n,i}class Sn extends Si{constructor(e,t,n,i=[]){super(),this.key=e,this.value=t,this.precondition=n,this.fieldTransforms=i,this.type=0}getFieldMask(){return null}}class at extends Si{constructor(e,t,n,i,s=[]){super(),this.key=e,this.data=t,this.fieldMask=n,this.precondition=i,this.fieldTransforms=s,this.type=1}getFieldMask(){return this.fieldMask}}function Zl(r){const e=new Map;return r.fieldMask.fields.forEach(t=>{if(!t.isEmpty()){const n=r.data.field(t);e.set(t,n)}}),e}function ec(r,e,t){const n=new Map;B(r.length===t.length);for(let i=0;i<t.length;i++){const s=r[i],a=s.transform,u=e.data.field(s.field);n.set(s.field,Bm(a,u,t[i]))}return n}function tc(r,e,t){const n=new Map;for(const i of r){const s=i.transform,a=t.data.field(i.field);n.set(i.field,Lm(s,a,e))}return n}class bn extends Si{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=2,this.fieldTransforms=[]}getFieldMask(){return null}}class Ys extends Si{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=3,this.fieldTransforms=[]}getFieldMask(){return null}}class Xs{constructor(e,t,n,i){this.batchId=e,this.localWriteTime=t,this.baseMutations=n,this.mutations=i}applyToRemoteDocument(e,t){const n=t.mutationResults;for(let i=0;i<this.mutations.length;i++){const s=this.mutations[i];s.key.isEqual(e.key)&&zm(s,e,n[i])}}applyToLocalView(e,t){for(const n of this.baseMutations)n.key.isEqual(e.key)&&(t=Tr(n,e,t,this.localWriteTime));for(const n of this.mutations)n.key.isEqual(e.key)&&(t=Tr(n,e,t,this.localWriteTime));return t}applyToLocalDocumentSet(e,t){const n=$l();return this.mutations.forEach(i=>{const s=e.get(i.key),a=s.overlayedDocument;let u=this.applyToLocalView(a,s.mutatedFields);u=t.has(i.key)?null:u;const l=Yl(a,u);null!==l&&n.set(i.key,l),a.isValidDocument()||a.convertToNoDocument(z.min())}),n}keys(){return this.mutations.reduce((e,t)=>e.add(t.key),j())}isEqual(e){return this.batchId===e.batchId&&pn(this.mutations,e.mutations,(t,n)=>Xl(t,n))&&pn(this.baseMutations,e.baseMutations,(t,n)=>Xl(t,n))}}class Zs{constructor(e,t,n,i){this.batch=e,this.commitVersion=t,this.mutationResults=n,this.docVersions=i}static from(e,t,n){B(e.mutations.length===n.length);let i=function(){return Fm}();const s=e.mutations;for(let a=0;a<s.length;a++)i=i.insert(s[a].key,n[a].version);return new Zs(e,t,n,i)}}class eo{constructor(e,t){this.largestBatchId=e,this.mutation=t}getKey(){return this.mutation.key}isEqual(e){return null!==e&&this.mutation===e.mutation}toString(){return`Overlay{\n      largestBatchId: ${this.largestBatchId},\n      mutation: ${this.mutation.toString()}\n    }`}}class Gm{constructor(e,t){this.count=e,this.unchangedNames=t}}var Ie,Y;function rc(r){switch(r){default:return L();case V.CANCELLED:case V.UNKNOWN:case V.DEADLINE_EXCEEDED:case V.RESOURCE_EXHAUSTED:case V.INTERNAL:case V.UNAVAILABLE:case V.UNAUTHENTICATED:return!1;case V.INVALID_ARGUMENT:case V.NOT_FOUND:case V.ALREADY_EXISTS:case V.PERMISSION_DENIED:case V.FAILED_PRECONDITION:case V.ABORTED:case V.OUT_OF_RANGE:case V.UNIMPLEMENTED:case V.DATA_LOSS:return!0}}function ic(r){if(void 0===r)return pe("GRPC error has no .code"),V.UNKNOWN;switch(r){case Ie.OK:return V.OK;case Ie.CANCELLED:return V.CANCELLED;case Ie.UNKNOWN:return V.UNKNOWN;case Ie.DEADLINE_EXCEEDED:return V.DEADLINE_EXCEEDED;case Ie.RESOURCE_EXHAUSTED:return V.RESOURCE_EXHAUSTED;case Ie.INTERNAL:return V.INTERNAL;case Ie.UNAVAILABLE:return V.UNAVAILABLE;case Ie.UNAUTHENTICATED:return V.UNAUTHENTICATED;case Ie.INVALID_ARGUMENT:return V.INVALID_ARGUMENT;case Ie.NOT_FOUND:return V.NOT_FOUND;case Ie.ALREADY_EXISTS:return V.ALREADY_EXISTS;case Ie.PERMISSION_DENIED:return V.PERMISSION_DENIED;case Ie.FAILED_PRECONDITION:return V.FAILED_PRECONDITION;case Ie.ABORTED:return V.ABORTED;case Ie.OUT_OF_RANGE:return V.OUT_OF_RANGE;case Ie.UNIMPLEMENTED:return V.UNIMPLEMENTED;case Ie.DATA_LOSS:return V.DATA_LOSS;default:return L()}}(Y=Ie||(Ie={}))[Y.OK=0]="OK",Y[Y.CANCELLED=1]="CANCELLED",Y[Y.UNKNOWN=2]="UNKNOWN",Y[Y.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",Y[Y.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",Y[Y.NOT_FOUND=5]="NOT_FOUND",Y[Y.ALREADY_EXISTS=6]="ALREADY_EXISTS",Y[Y.PERMISSION_DENIED=7]="PERMISSION_DENIED",Y[Y.UNAUTHENTICATED=16]="UNAUTHENTICATED",Y[Y.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",Y[Y.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",Y[Y.ABORTED=10]="ABORTED",Y[Y.OUT_OF_RANGE=11]="OUT_OF_RANGE",Y[Y.UNIMPLEMENTED=12]="UNIMPLEMENTED",Y[Y.INTERNAL=13]="INTERNAL",Y[Y.UNAVAILABLE=14]="UNAVAILABLE",Y[Y.DATA_LOSS=15]="DATA_LOSS";function sc(){return new TextEncoder}const Km=new Ut([4294967295,4294967295],0);function oc(r){const e=sc().encode(r),t=new Bu;return t.update(e),new Uint8Array(t.digest())}function ac(r){const e=new DataView(r.buffer),t=e.getUint32(0,!0),n=e.getUint32(4,!0),i=e.getUint32(8,!0),s=e.getUint32(12,!0);return[new Ut([t,n],0),new Ut([i,s],0)]}class to{constructor(e,t,n){if(this.bitmap=e,this.padding=t,this.hashCount=n,t<0||t>=8)throw new Er(`Invalid padding: ${t}`);if(n<0)throw new Er(`Invalid hash count: ${n}`);if(e.length>0&&0===this.hashCount)throw new Er(`Invalid hash count: ${n}`);if(0===e.length&&0!==t)throw new Er(`Invalid padding when bitmap length is 0: ${t}`);this.Ie=8*e.length-t,this.Te=Ut.fromNumber(this.Ie)}Ee(e,t,n){let i=e.add(t.multiply(Ut.fromNumber(n)));return 1===i.compare(Km)&&(i=new Ut([i.getBits(0),i.getBits(1)],0)),i.modulo(this.Te).toNumber()}de(e){return!!(this.bitmap[Math.floor(e/8)]&1<<e%8)}mightContain(e){if(0===this.Ie)return!1;const t=oc(e),[n,i]=ac(t);for(let s=0;s<this.hashCount;s++){const a=this.Ee(n,i,s);if(!this.de(a))return!1}return!0}static create(e,t,n){const i=e%8==0?0:8-e%8,s=new Uint8Array(Math.ceil(e/8)),a=new to(s,i,t);return n.forEach(u=>a.insert(u)),a}insert(e){if(0===this.Ie)return;const t=oc(e),[n,i]=ac(t);for(let s=0;s<this.hashCount;s++){const a=this.Ee(n,i,s);this.Ae(a)}}Ae(e){const t=Math.floor(e/8);this.bitmap[t]|=1<<e%8}}class Er extends Error{constructor(){super(...arguments),this.name="BloomFilterError"}}class vr{constructor(e,t,n,i,s){this.snapshotVersion=e,this.targetChanges=t,this.targetMismatches=n,this.documentUpdates=i,this.resolvedLimboDocuments=s}static createSynthesizedRemoteEventForCurrentChange(e,t,n){const i=new Map;return i.set(e,Ar.createSynthesizedTargetChangeForCurrentChange(e,t,n)),new vr(z.min(),i,new se(G),qe(),j())}}class Ar{constructor(e,t,n,i,s){this.resumeToken=e,this.current=t,this.addedDocuments=n,this.modifiedDocuments=i,this.removedDocuments=s}static createSynthesizedTargetChangeForCurrentChange(e,t,n){return new Ar(n,t,j(),j(),j())}}class xi{constructor(e,t,n,i){this.Re=e,this.removedTargetIds=t,this.key=n,this.Ve=i}}class uc{constructor(e,t){this.targetId=e,this.me=t}}class lc{constructor(e,t,n=me.EMPTY_BYTE_STRING,i=null){this.state=e,this.targetIds=t,this.resumeToken=n,this.cause=i}}class cc{constructor(){this.fe=0,this.ge=dc(),this.pe=me.EMPTY_BYTE_STRING,this.ye=!1,this.we=!0}get current(){return this.ye}get resumeToken(){return this.pe}get Se(){return 0!==this.fe}get be(){return this.we}De(e){e.approximateByteSize()>0&&(this.we=!0,this.pe=e)}ve(){let e=j(),t=j(),n=j();return this.ge.forEach((i,s)=>{switch(s){case 0:e=e.add(i);break;case 2:t=t.add(i);break;case 1:n=n.add(i);break;default:L()}}),new Ar(this.pe,this.ye,e,t,n)}Ce(){this.we=!1,this.ge=dc()}Fe(e,t){this.we=!0,this.ge=this.ge.insert(e,t)}Me(e){this.we=!0,this.ge=this.ge.remove(e)}xe(){this.fe+=1}Oe(){this.fe-=1,B(this.fe>=0)}Ne(){this.we=!0,this.ye=!0}}class jm{constructor(e){this.Le=e,this.Be=new Map,this.ke=qe(),this.qe=hc(),this.Qe=new se(G)}Ke(e){for(const t of e.Re)e.Ve&&e.Ve.isFoundDocument()?this.$e(t,e.Ve):this.Ue(t,e.key,e.Ve);for(const t of e.removedTargetIds)this.Ue(t,e.key,e.Ve)}We(e){this.forEachTarget(e,t=>{const n=this.Ge(t);switch(e.state){case 0:this.ze(t)&&n.De(e.resumeToken);break;case 1:n.Oe(),n.Se||n.Ce(),n.De(e.resumeToken);break;case 2:n.Oe(),n.Se||this.removeTarget(t);break;case 3:this.ze(t)&&(n.Ne(),n.De(e.resumeToken));break;case 4:this.ze(t)&&(this.je(t),n.De(e.resumeToken));break;default:L()}})}forEachTarget(e,t){e.targetIds.length>0?e.targetIds.forEach(t):this.Be.forEach((n,i)=>{this.ze(i)&&t(i)})}He(e){const t=e.targetId,n=e.me.count,i=this.Je(t);if(i){const s=i.target;if(Ai(s))if(0===n){const a=new O(s.path);this.Ue(t,a,ae.newNoDocument(a,z.min()))}else B(1===n);else{const a=this.Ye(t);if(a!==n){const u=this.Ze(e),l=u?this.Xe(u,e,a):1;0!==l&&(this.je(t),this.Qe=this.Qe.insert(t,2===l?"TargetPurposeExistenceFilterMismatchBloom":"TargetPurposeExistenceFilterMismatch"))}}}}Ze(e){const t=e.me.unchangedNames;if(!t||!t.bits)return null;const{bits:{bitmap:n="",padding:i=0},hashCount:s=0}=t;let a,u;try{a=it(n).toUint8Array()}catch(l){if(l instanceof fl)return ze("Decoding the base64 bloom filter in existence filter failed ("+l.message+"); ignoring the bloom filter and falling back to full re-query."),null;throw l}try{u=new to(a,i,s)}catch(l){return ze(l instanceof Er?"BloomFilter error: ":"Applying bloom filter failed: ",l),null}return 0===u.Ie?null:u}Xe(e,t,n){return t.me.count===n-this.nt(e,t.targetId)?0:2}nt(e,t){const n=this.Le.getRemoteKeysForTarget(t);let i=0;return n.forEach(s=>{const a=this.Le.tt(),u=`projects/${a.projectId}/databases/${a.database}/documents/${s.path.canonicalString()}`;e.mightContain(u)||(this.Ue(t,s,null),i++)}),i}rt(e){const t=new Map;this.Be.forEach((s,a)=>{const u=this.Je(a);if(u){if(s.current&&Ai(u.target)){const l=new O(u.target.path);null!==this.ke.get(l)||this.it(a,l)||this.Ue(a,l,ae.newNoDocument(l,e))}s.be&&(t.set(a,s.ve()),s.Ce())}});let n=j();this.qe.forEach((s,a)=>{let u=!0;a.forEachWhile(l=>{const h=this.Je(l);return!h||"TargetPurposeLimboResolution"===h.purpose||(u=!1,!1)}),u&&(n=n.add(s))}),this.ke.forEach((s,a)=>a.setReadTime(e));const i=new vr(e,t,this.Qe,this.ke,n);return this.ke=qe(),this.qe=hc(),this.Qe=new se(G),i}$e(e,t){if(!this.ze(e))return;const n=this.it(e,t.key)?2:0;this.Ge(e).Fe(t.key,n),this.ke=this.ke.insert(t.key,t),this.qe=this.qe.insert(t.key,this.st(t.key).add(e))}Ue(e,t,n){if(!this.ze(e))return;const i=this.Ge(e);this.it(e,t)?i.Fe(t,1):i.Me(t),this.qe=this.qe.insert(t,this.st(t).delete(e)),n&&(this.ke=this.ke.insert(t,n))}removeTarget(e){this.Be.delete(e)}Ye(e){const t=this.Ge(e).ve();return this.Le.getRemoteKeysForTarget(e).size+t.addedDocuments.size-t.removedDocuments.size}xe(e){this.Ge(e).xe()}Ge(e){let t=this.Be.get(e);return t||(t=new cc,this.Be.set(e,t)),t}st(e){let t=this.qe.get(e);return t||(t=new ne(G),this.qe=this.qe.insert(e,t)),t}ze(e){const t=null!==this.Je(e);return t||N("WatchChangeAggregator","Detected inactive target",e),t}Je(e){const t=this.Be.get(e);return t&&t.Se?null:this.Le.ot(e)}je(e){this.Be.set(e,new cc),this.Le.getRemoteKeysForTarget(e).forEach(t=>{this.Ue(e,t,null)})}it(e,t){return this.Le.getRemoteKeysForTarget(e).has(t)}}function hc(){return new se(O.comparator)}function dc(){return new se(O.comparator)}const Wm={asc:"ASCENDING",desc:"DESCENDING"},Qm={"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","==":"EQUAL","!=":"NOT_EQUAL","array-contains":"ARRAY_CONTAINS",in:"IN","not-in":"NOT_IN","array-contains-any":"ARRAY_CONTAINS_ANY"},Hm={and:"AND",or:"OR"};class Jm{constructor(e,t){this.databaseId=e,this.useProto3Json=t}}function no(r,e){return r.useProto3Json||ar(e)?e:{value:e}}function xn(r,e){return r.useProto3Json?`${new Date(1e3*e.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")}.${("000000000"+e.nanoseconds).slice(-9)}Z`:{seconds:""+e.seconds,nanos:e.nanoseconds}}function fc(r,e){return r.useProto3Json?e.toBase64():e.toUint8Array()}function Ym(r,e){return xn(r,e.toTimestamp())}function ye(r){return B(!!r),z.fromTimestamp(function(t){const n=rt(t);return new ce(n.seconds,n.nanos)}(r))}function ro(r,e){return io(r,e).canonicalString()}function io(r,e){const t=(i=r,new H(["projects",i.projectId,"databases",i.database])).child("documents");var i;return void 0===e?t:t.child(e)}function mc(r){const e=H.fromString(r);return B(Rc(e)),e}function wr(r,e){return ro(r.databaseId,e.path)}function Ze(r,e){const t=mc(e);if(t.get(1)!==r.databaseId.projectId)throw new C(V.INVALID_ARGUMENT,"Tried to deserialize key from different project: "+t.get(1)+" vs "+r.databaseId.projectId);if(t.get(3)!==r.databaseId.database)throw new C(V.INVALID_ARGUMENT,"Tried to deserialize key from different database: "+t.get(3)+" vs "+r.databaseId.database);return new O(pc(t))}function _c(r,e){return ro(r.databaseId,e)}function gc(r){const e=mc(r);return 4===e.length?H.emptyPath():pc(e)}function so(r){return new H(["projects",r.databaseId.projectId,"databases",r.databaseId.database]).canonicalString()}function pc(r){return B(r.length>4&&"documents"===r.get(4)),r.popFirst(5)}function yc(r,e,t){return{name:wr(r,e),fields:t.value.mapValue.fields}}function Ic(r,e,t){const n=Ze(r,e.name),i=ye(e.updateTime),s=e.createTime?ye(e.createTime):z.min(),a=new Re({mapValue:{fields:e.fields}}),u=ae.newFoundDocument(n,i,s,a);return t&&u.setHasCommittedMutations(),t?u.setHasCommittedMutations():u}function Rr(r,e){let t;if(e instanceof Sn)t={update:yc(r,e.key,e.value)};else if(e instanceof bn)t={delete:wr(r,e.key)};else if(e instanceof at)t={update:yc(r,e.key,e.data),updateMask:s_(e.fieldMask)};else{if(!(e instanceof Ys))return L();t={verify:wr(r,e.key)}}return e.fieldTransforms.length>0&&(t.updateTransforms=e.fieldTransforms.map(n=>function(s,a){const u=a.transform;if(u instanceof Pn)return{fieldPath:a.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(u instanceof jt)return{fieldPath:a.field.canonicalString(),appendMissingElements:{values:u.elements}};if(u instanceof Wt)return{fieldPath:a.field.canonicalString(),removeAllFromArray:{values:u.elements}};if(u instanceof Vn)return{fieldPath:a.field.canonicalString(),increment:u.Pe};throw L()}(0,n))),e.precondition.isNone||(t.currentDocument=void 0!==(s=e.precondition).updateTime?{updateTime:Ym(r,s.updateTime)}:void 0!==s.exists?{exists:s.exists}:L()),t;var s}function oo(r,e){const t=e.currentDocument?void 0!==(s=e.currentDocument).updateTime?de.updateTime(ye(s.updateTime)):void 0!==s.exists?de.exists(s.exists):de.none():de.none(),n=e.updateTransforms?e.updateTransforms.map(i=>function(a,u){let l=null;"setToServerValue"in u?(B("REQUEST_TIME"===u.setToServerValue),l=new Pn):"appendMissingElements"in u?l=new jt(u.appendMissingElements.values||[]):"removeAllFromArray"in u?l=new Wt(u.removeAllFromArray.values||[]):"increment"in u?l=new Vn(a,u.increment):L();const h=oe.fromServerFormat(u.fieldPath);return new Ir(h,l)}(r,i)):[];var s;if(e.update){const i=Ze(r,e.update.name),s=new Re({mapValue:{fields:e.update.fields}});if(e.updateMask){const a=new Ue((e.updateMask.fieldPaths||[]).map(f=>oe.fromServerFormat(f)));return new at(i,s,a,t,n)}return new Sn(i,s,t,n)}if(e.delete){const i=Ze(r,e.delete);return new bn(i,t)}if(e.verify){const i=Ze(r,e.verify);return new Ys(i,t)}return L()}function Tc(r,e){return{documents:[_c(r,e.path)]}}function Ci(r,e){const t={structuredQuery:{}},n=e.path;let i;null!==e.collectionGroup?(i=n,t.structuredQuery.from=[{collectionId:e.collectionGroup,allDescendants:!0}]):(i=n.popLast(),t.structuredQuery.from=[{collectionId:n.lastSegment()}]),t.parent=_c(r,i);const s=function(h){if(0!==h.length)return wc(te.create(h,"and"))}(e.filters);s&&(t.structuredQuery.where=s);const a=function(h){if(0!==h.length)return h.map(f=>{return{field:Pt((p=f).field),direction:n_(p.dir)};var p})}(e.orderBy);a&&(t.structuredQuery.orderBy=a);const u=no(r,e.limit);return null!==u&&(t.structuredQuery.limit=u),e.startAt&&(t.structuredQuery.startAt={before:(h=e.startAt).inclusive,values:h.position}),e.endAt&&(t.structuredQuery.endAt=function(h){return{before:!h.inclusive,values:h.position}}(e.endAt)),{_t:t,parent:i};var h}function vc(r){let e=gc(r.parent);const t=r.structuredQuery,n=t.from?t.from.length:0;let i=null;if(n>0){B(1===n);const f=t.from[0];f.allDescendants?i=f.collectionId:e=e.child(f.collectionId)}let s=[];t.where&&(s=function(_){const p=Ac(_);return p instanceof te&&Gs(p)?p.getFilters():[p]}(t.where));let a=[];t.orderBy&&(a=t.orderBy.map(p=>{return new fr(Cn((x=p).field),function(D){switch(D){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}}(x.direction));var x}));let u=null;t.limit&&(u=function(_){let p;return p="object"==typeof _?_.value:_,ar(p)?null:p}(t.limit));let l=null;var _;t.startAt&&(l=new Rt((_=t.startAt).values||[],!!_.before));let h=null;return t.endAt&&(h=function(_){return new Rt(_.values||[],!_.before)}(t.endAt)),kl(e,i,a,s,u,"F",l,h)}function Ac(r){return void 0!==r.unaryFilter?function(t){switch(t.unaryFilter.op){case"IS_NAN":const n=Cn(t.unaryFilter.field);return J.create(n,"==",{doubleValue:NaN});case"IS_NULL":const i=Cn(t.unaryFilter.field);return J.create(i,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":const s=Cn(t.unaryFilter.field);return J.create(s,"!=",{doubleValue:NaN});case"IS_NOT_NULL":const a=Cn(t.unaryFilter.field);return J.create(a,"!=",{nullValue:"NULL_VALUE"});default:return L()}}(r):void 0!==r.fieldFilter?J.create(Cn((t=r).fieldFilter.field),function(i){switch(i){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";default:return L()}}(t.fieldFilter.op),t.fieldFilter.value):void 0!==r.compositeFilter?function(t){return te.create(t.compositeFilter.filters.map(n=>Ac(n)),function(i){switch(i){case"AND":return"and";case"OR":return"or";default:return L()}}(t.compositeFilter.op))}(r):L();var t}function n_(r){return Wm[r]}function r_(r){return Qm[r]}function i_(r){return Hm[r]}function Pt(r){return{fieldPath:r.canonicalString()}}function Cn(r){return oe.fromServerFormat(r.fieldPath)}function wc(r){return r instanceof J?function(t){if("=="===t.op){if(pl(t.value))return{unaryFilter:{field:Pt(t.field),op:"IS_NAN"}};if(gl(t.value))return{unaryFilter:{field:Pt(t.field),op:"IS_NULL"}}}else if("!="===t.op){if(pl(t.value))return{unaryFilter:{field:Pt(t.field),op:"IS_NOT_NAN"}};if(gl(t.value))return{unaryFilter:{field:Pt(t.field),op:"IS_NOT_NULL"}}}return{fieldFilter:{field:Pt(t.field),op:r_(t.op),value:t.value}}}(r):r instanceof te?function(t){const n=t.getFilters().map(i=>wc(i));return 1===n.length?n[0]:{compositeFilter:{op:i_(t.op),filters:n}}}(r):L()}function s_(r){const e=[];return r.fields.forEach(t=>e.push(t.canonicalString())),{fieldPaths:e}}function Rc(r){return r.length>=4&&"projects"===r.get(0)&&"databases"===r.get(2)}class ut{constructor(e,t,n,i,s=z.min(),a=z.min(),u=me.EMPTY_BYTE_STRING,l=null){this.target=e,this.targetId=t,this.purpose=n,this.sequenceNumber=i,this.snapshotVersion=s,this.lastLimboFreeSnapshotVersion=a,this.resumeToken=u,this.expectedCount=l}withSequenceNumber(e){return new ut(this.target,this.targetId,this.purpose,e,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,this.expectedCount)}withResumeToken(e,t){return new ut(this.target,this.targetId,this.purpose,this.sequenceNumber,t,this.lastLimboFreeSnapshotVersion,e,null)}withExpectedCount(e){return new ut(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,e)}withLastLimboFreeSnapshotVersion(e){return new ut(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,e,this.resumeToken,this.expectedCount)}}class Pc{constructor(e){this.ct=e}}function Vc(r,e){const t=e.key,n={prefixPath:t.getCollectionPath().popLast().toArray(),collectionGroup:t.collectionGroup,documentId:t.path.lastSegment(),readTime:Di(e.readTime),hasCommittedMutations:e.hasCommittedMutations};if(e.isFoundDocument())n.document={name:wr(s=r.ct,(a=e).key),fields:a.data.value.mapValue.fields,updateTime:xn(s,a.version.toTimestamp()),createTime:xn(s,a.createTime.toTimestamp())};else if(e.isNoDocument())n.noDocument={path:t.path.toArray(),readTime:Qt(e.version)};else{if(!e.isUnknownDocument())return L();n.unknownDocument={path:t.path.toArray(),version:Qt(e.version)}}var s,a;return n}function Di(r){const e=r.toTimestamp();return[e.seconds,e.nanoseconds]}function Qt(r){const e=r.toTimestamp();return{seconds:e.seconds,nanoseconds:e.nanoseconds}}function Ht(r){const e=new ce(r.seconds,r.nanoseconds);return z.fromTimestamp(e)}function Jt(r,e){const t=(e.baseMutations||[]).map(s=>oo(r.ct,s));for(let s=0;s<e.mutations.length-1;++s)s+1<e.mutations.length&&void 0!==e.mutations[s+1].transform&&(e.mutations[s].updateTransforms=e.mutations[s+1].transform.fieldTransforms,e.mutations.splice(s+1,1),++s);const n=e.mutations.map(s=>oo(r.ct,s)),i=ce.fromMillis(e.localWriteTimeMs);return new Xs(e.batchId,i,t,n)}function Pr(r){const e=Ht(r.readTime),t=void 0!==r.lastLimboFreeSnapshotVersion?Ht(r.lastLimboFreeSnapshotVersion):z.min();let n;return n=void 0!==r.query.documents?(B(1===(s=r.query).documents.length),be(An(gc(s.documents[0])))):function(s){return be(vc(s))}(r.query),new ut(n,r.targetId,"TargetPurposeListen",r.lastListenSequenceNumber,e,t,me.fromBase64String(r.resumeToken));var s}function Sc(r,e){const t=Qt(e.snapshotVersion),n=Qt(e.lastLimboFreeSnapshotVersion);let i;i=Ai(e.target)?Tc(r.ct,e.target):Ci(r.ct,e.target)._t;const s=e.resumeToken.toBase64();return{targetId:e.targetId,canonicalId:Kt(e.target),readTime:t,resumeToken:s,lastListenSequenceNumber:e.sequenceNumber,lastLimboFreeSnapshotVersion:n,query:i}}function ao(r){const e=vc({parent:r.parent,structuredQuery:r.structuredQuery});return"LAST"===r.limitType?Ri(e,e.limit,"L"):e}function uo(r,e){return new eo(e.largestBatchId,oo(r.ct,e.overlayMutation))}function bc(r,e){const t=e.path.lastSegment();return[r,Se(e.path.popLast()),t]}function xc(r,e,t,n){return{indexId:r,uid:e,sequenceNumber:t,readTime:Qt(n.readTime),documentKey:Se(n.documentKey.path),largestBatchId:n.largestBatchId}}class a_{getBundleMetadata(e,t){return Cc(e).get(t).next(n=>{if(n)return{id:(s=n).bundleId,createTime:Ht(s.createTime),version:s.version};var s})}saveBundleMetadata(e,t){return Cc(e).put({bundleId:(i=t).id,createTime:Qt(ye(i.createTime)),version:i.version});var i}getNamedQuery(e,t){return Dc(e).get(t).next(n=>{if(n)return{name:(s=n).name,query:ao(s.bundledQuery),readTime:Ht(s.readTime)};var s})}saveNamedQuery(e,t){return Dc(e).put({name:(i=t).name,readTime:Qt(ye(i.readTime)),bundledQuery:i.bundledQuery});var i}}function Cc(r){return Te(r,"bundles")}function Dc(r){return Te(r,"namedQueries")}class Ni{constructor(e,t){this.serializer=e,this.userId=t}static lt(e,t){return new Ni(e,t.uid||"")}getOverlay(e,t){return Vr(e).get(bc(this.userId,t)).next(n=>n?uo(this.serializer,n):null)}getOverlays(e,t){const n=Xe();return w.forEach(t,i=>this.getOverlay(e,i).next(s=>{null!==s&&n.set(i,s)})).next(()=>n)}saveOverlays(e,t,n){const i=[];return n.forEach((s,a)=>{const u=new eo(t,a);i.push(this.ht(e,u))}),w.waitFor(i)}removeOverlaysForBatchId(e,t,n){const i=new Set;t.forEach(a=>i.add(Se(a.getCollectionPath())));const s=[];return i.forEach(a=>{const u=IDBKeyRange.bound([this.userId,a,n],[this.userId,a,n+1],!1,!0);s.push(Vr(e).j("collectionPathOverlayIndex",u))}),w.waitFor(s)}getOverlaysForCollection(e,t,n){const i=Xe(),s=Se(t),a=IDBKeyRange.bound([this.userId,s,n],[this.userId,s,Number.POSITIVE_INFINITY],!0);return Vr(e).U("collectionPathOverlayIndex",a).next(u=>{for(const l of u){const h=uo(this.serializer,l);i.set(h.getKey(),h)}return i})}getOverlaysForCollectionGroup(e,t,n,i){const s=Xe();let a;const u=IDBKeyRange.bound([this.userId,t,n],[this.userId,t,Number.POSITIVE_INFINITY],!0);return Vr(e).J({index:"collectionGroupOverlayIndex",range:u},(l,h,f)=>{const _=uo(this.serializer,h);s.size()<i||_.largestBatchId===a?(s.set(_.getKey(),_),a=_.largestBatchId):f.done()}).next(()=>s)}ht(e,t){return Vr(e).put(function(i,s,a){const[u,l,h]=bc(s,a.mutation.key);return{userId:s,collectionPath:l,documentId:h,collectionGroup:a.mutation.key.getCollectionGroup(),largestBatchId:a.largestBatchId,overlayMutation:Rr(i.ct,a.mutation)}}(this.serializer,this.userId,t))}}function Vr(r){return Te(r,"documentOverlays")}class u_{Pt(e){return Te(e,"globals")}getSessionToken(e){return this.Pt(e).get("sessionToken").next(t=>{const n=null==t?void 0:t.value;return n?me.fromUint8Array(n):me.EMPTY_BYTE_STRING})}setSessionToken(e,t){return this.Pt(e).put({name:"sessionToken",value:t.toUint8Array()})}}class Yt{constructor(){}It(e,t){this.Tt(e,t),t.Et()}Tt(e,t){if("nullValue"in e)this.dt(t,5);else if("booleanValue"in e)this.dt(t,10),t.At(e.booleanValue?1:0);else if("integerValue"in e)this.dt(t,15),t.At(he(e.integerValue));else if("doubleValue"in e){const n=he(e.doubleValue);isNaN(n)?this.dt(t,13):(this.dt(t,15),ur(n)?t.At(0):t.At(n))}else if("timestampValue"in e){let n=e.timestampValue;this.dt(t,20),"string"==typeof n&&(n=rt(n)),t.Rt(`${n.seconds||""}`),t.At(n.nanos||0)}else if("stringValue"in e)this.Vt(e.stringValue,t),this.ft(t);else if("bytesValue"in e)this.dt(t,30),t.gt(it(e.bytesValue)),this.ft(t);else if("referenceValue"in e)this.yt(e.referenceValue,t);else if("geoPointValue"in e){const n=e.geoPointValue;this.dt(t,45),t.At(n.latitude||0),t.At(n.longitude||0)}else"mapValue"in e?yl(e)?this.dt(t,Number.MAX_SAFE_INTEGER):vi(e)?this.wt(e.mapValue,t):(this.St(e.mapValue,t),this.ft(t)):"arrayValue"in e?(this.bt(e.arrayValue,t),this.ft(t)):L()}Vt(e,t){this.dt(t,25),this.Dt(e,t)}Dt(e,t){t.Rt(e)}St(e,t){const n=e.fields||{};this.dt(t,55);for(const i of Object.keys(n))this.Vt(i,t),this.Tt(n[i],t)}wt(e,t){var n,i;const s=e.fields||{};this.dt(t,53);const a="value",u=(null===(i=null===(n=s[a].arrayValue)||void 0===n?void 0:n.values)||void 0===i?void 0:i.length)||0;this.dt(t,15),t.At(he(u)),this.Vt(a,t),this.Tt(s[a],t)}bt(e,t){const n=e.values||[];this.dt(t,50);for(const i of n)this.Tt(i,t)}yt(e,t){this.dt(t,37),O.fromName(e).path.forEach(n=>{this.dt(t,60),this.Dt(n,t)})}dt(e,t){e.At(t)}ft(e){e.At(2)}}function l_(r){if(0===r)return 8;let e=0;return!(r>>4)&&(e+=4,r<<=4),!(r>>6)&&(e+=2,r<<=2),!(r>>7)&&(e+=1),e}function Nc(r){const e=64-function(n){let i=0;for(let s=0;s<8;++s){const a=l_(255&n[s]);if(i+=a,8!==a)break}return i}(r);return Math.ceil(e/8)}Yt.vt=new Yt;class c_{constructor(){this.buffer=new Uint8Array(1024),this.position=0}Ct(e){const t=e[Symbol.iterator]();let n=t.next();for(;!n.done;)this.Ft(n.value),n=t.next();this.Mt()}xt(e){const t=e[Symbol.iterator]();let n=t.next();for(;!n.done;)this.Ot(n.value),n=t.next();this.Nt()}Lt(e){for(const t of e){const n=t.charCodeAt(0);if(n<128)this.Ft(n);else if(n<2048)this.Ft(960|n>>>6),this.Ft(128|63&n);else if(t<"\ud800"||"\udbff"<t)this.Ft(480|n>>>12),this.Ft(128|63&n>>>6),this.Ft(128|63&n);else{const i=t.codePointAt(0);this.Ft(240|i>>>18),this.Ft(128|63&i>>>12),this.Ft(128|63&i>>>6),this.Ft(128|63&i)}}this.Mt()}Bt(e){for(const t of e){const n=t.charCodeAt(0);if(n<128)this.Ot(n);else if(n<2048)this.Ot(960|n>>>6),this.Ot(128|63&n);else if(t<"\ud800"||"\udbff"<t)this.Ot(480|n>>>12),this.Ot(128|63&n>>>6),this.Ot(128|63&n);else{const i=t.codePointAt(0);this.Ot(240|i>>>18),this.Ot(128|63&i>>>12),this.Ot(128|63&i>>>6),this.Ot(128|63&i)}}this.Nt()}kt(e){const t=this.qt(e),n=Nc(t);this.Qt(1+n),this.buffer[this.position++]=255&n;for(let i=t.length-n;i<t.length;++i)this.buffer[this.position++]=255&t[i]}Kt(e){const t=this.qt(e),n=Nc(t);this.Qt(1+n),this.buffer[this.position++]=~(255&n);for(let i=t.length-n;i<t.length;++i)this.buffer[this.position++]=~(255&t[i])}$t(){this.Ut(255),this.Ut(255)}Wt(){this.Gt(255),this.Gt(255)}reset(){this.position=0}seed(e){this.Qt(e.length),this.buffer.set(e,this.position),this.position+=e.length}zt(){return this.buffer.slice(0,this.position)}qt(e){const t=function(s){const a=new DataView(new ArrayBuffer(8));return a.setFloat64(0,s,!1),new Uint8Array(a.buffer)}(e),n=!!(128&t[0]);t[0]^=n?255:128;for(let i=1;i<t.length;++i)t[i]^=n?255:0;return t}Ft(e){const t=255&e;0===t?(this.Ut(0),this.Ut(255)):255===t?(this.Ut(255),this.Ut(0)):this.Ut(t)}Ot(e){const t=255&e;0===t?(this.Gt(0),this.Gt(255)):255===t?(this.Gt(255),this.Gt(0)):this.Gt(e)}Mt(){this.Ut(0),this.Ut(1)}Nt(){this.Gt(0),this.Gt(1)}Ut(e){this.Qt(1),this.buffer[this.position++]=e}Gt(e){this.Qt(1),this.buffer[this.position++]=~e}Qt(e){const t=e+this.position;if(t<=this.buffer.length)return;let n=2*this.buffer.length;n<t&&(n=t);const i=new Uint8Array(n);i.set(this.buffer),this.buffer=i}}class h_{constructor(e){this.jt=e}gt(e){this.jt.Ct(e)}Rt(e){this.jt.Lt(e)}At(e){this.jt.kt(e)}Et(){this.jt.$t()}}class d_{constructor(e){this.jt=e}gt(e){this.jt.xt(e)}Rt(e){this.jt.Bt(e)}At(e){this.jt.Kt(e)}Et(){this.jt.Wt()}}class Sr{constructor(){this.jt=new c_,this.Ht=new h_(this.jt),this.Jt=new d_(this.jt)}seed(e){this.jt.seed(e)}Yt(e){return 0===e?this.Ht:this.Jt}zt(){return this.jt.zt()}reset(){this.jt.reset()}}class Xt{constructor(e,t,n,i){this.indexId=e,this.documentKey=t,this.arrayValue=n,this.directionalValue=i}Zt(){const e=this.directionalValue.length,t=0===e||255===this.directionalValue[e-1]?e+1:e,n=new Uint8Array(t);return n.set(this.directionalValue,0),t!==e?n.set([0],this.directionalValue.length):++n[n.length-1],new Xt(this.indexId,this.documentKey,this.arrayValue,n)}}function Vt(r,e){let t=r.indexId-e.indexId;return 0!==t?t:(t=kc(r.arrayValue,e.arrayValue),0!==t?t:(t=kc(r.directionalValue,e.directionalValue),0!==t?t:O.comparator(r.documentKey,e.documentKey)))}function kc(r,e){for(let t=0;t<r.length&&t<e.length;++t){const n=r[t]-e[t];if(0!==n)return n}return r.length-e.length}class Fc{constructor(e){this.Xt=new ne((t,n)=>oe.comparator(t.field,n.field)),this.collectionId=null!=e.collectionGroup?e.collectionGroup:e.path.lastSegment(),this.en=e.orderBy,this.tn=[];for(const t of e.filters){const n=t;n.isInequality()?this.Xt=this.Xt.add(n):this.tn.push(n)}}get nn(){return this.Xt.size>1}rn(e){if(B(e.collectionGroup===this.collectionId),this.nn)return!1;const t=Fs(e);if(void 0!==t&&!this.sn(t))return!1;const n=qt(e);let i=new Set,s=0,a=0;for(;s<n.length&&this.sn(n[s]);++s)i=i.add(n[s].fieldPath.canonicalString());if(s===n.length)return!0;if(this.Xt.size>0){const u=this.Xt.getIterator().getNext();if(!i.has(u.field.canonicalString())){const l=n[s];if(!this.on(u,l)||!this._n(this.en[a++],l))return!1}++s}for(;s<n.length;++s)if(a>=this.en.length||!this._n(this.en[a++],n[s]))return!1;return!0}an(){if(this.nn)return null;let e=new ne(oe.comparator);const t=[];for(const n of this.tn)if(!n.field.isKeyField())if("array-contains"===n.op||"array-contains-any"===n.op)t.push(new zt(n.field,2));else{if(e.has(n.field))continue;e=e.add(n.field),t.push(new zt(n.field,0))}for(const n of this.en)n.field.isKeyField()||e.has(n.field)||(e=e.add(n.field),t.push(new zt(n.field,"asc"===n.dir?0:1)));return new yn(yn.UNKNOWN_ID,this.collectionId,t,In.empty())}sn(e){for(const t of this.tn)if(this.on(t,e))return!0;return!1}on(e,t){return!(void 0===e||!e.field.isEqual(t.fieldPath))&&2===t.kind==("array-contains"===e.op||"array-contains-any"===e.op)}_n(e,t){return!!e.field.isEqual(t.fieldPath)&&(0===t.kind&&"asc"===e.dir||1===t.kind&&"desc"===e.dir)}}function Mc(r){var e,t;if(B(r instanceof J||r instanceof te),r instanceof J){if(r instanceof Cl){const i=(null===(t=null===(e=r.value.arrayValue)||void 0===e?void 0:e.values)||void 0===t?void 0:t.map(s=>J.create(r.field,"==",s)))||[];return te.create(i,"or")}return r}const n=r.filters.map(i=>Mc(i));return te.create(n,r.op)}function f_(r){if(0===r.getFilters().length)return[];const e=ho(Mc(r));return B(Oc(e)),lo(e)||co(e)?[e]:e.getFilters()}function lo(r){return r instanceof J}function co(r){return r instanceof te&&Gs(r)}function Oc(r){return lo(r)||co(r)||function(t){if(t instanceof te&&$s(t)){for(const n of t.getFilters())if(!lo(n)&&!co(n))return!1;return!0}return!1}(r)}function ho(r){if(B(r instanceof J||r instanceof te),r instanceof J)return r;if(1===r.filters.length)return ho(r.filters[0]);const e=r.filters.map(n=>ho(n));let t=te.create(e,r.op);return t=ki(t),Oc(t)?t:(B(t instanceof te),B(vn(t)),B(t.filters.length>1),t.filters.reduce((n,i)=>fo(n,i)))}function fo(r,e){let t;return B(r instanceof J||r instanceof te),B(e instanceof J||e instanceof te),t=r instanceof J?e instanceof J?te.create([r,e],"and"):Lc(r,e):e instanceof J?Lc(e,r):function(i,s){if(B(i.filters.length>0&&s.filters.length>0),vn(i)&&vn(s))return Sl(i,s.getFilters());const a=$s(i)?i:s,u=$s(i)?s:i,l=a.filters.map(h=>fo(h,u));return te.create(l,"or")}(r,e),ki(t)}function Lc(r,e){if(vn(e))return Sl(e,r.getFilters());{const t=e.filters.map(n=>fo(r,n));return te.create(t,"or")}}function ki(r){if(B(r instanceof J||r instanceof te),r instanceof J)return r;const e=r.getFilters();if(1===e.length)return ki(e[0]);if(Pl(r))return r;const t=e.map(i=>ki(i)),n=[];return t.forEach(i=>{i instanceof J?n.push(i):i instanceof te&&(i.op===r.op?n.push(...i.filters):n.push(i))}),1===n.length?n[0]:te.create(n,r.op)}class m_{constructor(){this.un=new mo}addToCollectionParentIndex(e,t){return this.un.add(t),w.resolve()}getCollectionParents(e,t){return w.resolve(this.un.getEntries(t))}addFieldIndex(e,t){return w.resolve()}deleteFieldIndex(e,t){return w.resolve()}deleteAllFieldIndexes(e){return w.resolve()}createTargetIndexes(e,t){return w.resolve()}getDocumentsMatchingTarget(e,t){return w.resolve(null)}getIndexType(e,t){return w.resolve(0)}getFieldIndexes(e,t){return w.resolve([])}getNextCollectionGroupToUpdate(e){return w.resolve(null)}getMinOffset(e,t){return w.resolve($e.min())}getMinOffsetFromCollectionGroup(e,t){return w.resolve($e.min())}updateCollectionGroup(e,t,n){return w.resolve()}updateIndexEntries(e,t){return w.resolve()}}class mo{constructor(){this.index={}}add(e){const t=e.lastSegment(),n=e.popLast(),i=this.index[t]||new ne(H.comparator),s=!i.has(n);return this.index[t]=i.add(n),s}has(e){const t=e.lastSegment(),n=e.popLast(),i=this.index[t];return i&&i.has(n)}getEntries(e){return(this.index[e]||new ne(H.comparator)).toArray()}}const Fi=new Uint8Array(0);class __{constructor(e,t){this.databaseId=t,this.cn=new mo,this.ln=new ot(n=>Kt(n),(n,i)=>mr(n,i)),this.uid=e.uid||""}addToCollectionParentIndex(e,t){if(!this.cn.has(t)){const n=t.lastSegment(),i=t.popLast();e.addOnCommittedListener(()=>{this.cn.add(t)});const s={collectionId:n,parent:Se(i)};return Bc(e).put(s)}return w.resolve()}getCollectionParents(e,t){const n=[],i=IDBKeyRange.bound([t,""],[Hu(t),""],!1,!0);return Bc(e).U(i).next(s=>{for(const a of s){if(a.collectionId!==t)break;n.push(Je(a.parent))}return n})}addFieldIndex(e,t){const n=br(e),i={indexId:(u=t).indexId,collectionGroup:u.collectionGroup,fields:u.fields.map(l=>[l.fieldPath.canonicalString(),l.kind])};var u;delete i.indexId;const s=n.add(i);if(t.indexState){const a=Nn(e);return s.next(u=>{a.put(xc(u,this.uid,t.indexState.sequenceNumber,t.indexState.offset))})}return s.next()}deleteFieldIndex(e,t){const n=br(e),i=Nn(e),s=Dn(e);return n.delete(t.indexId).next(()=>i.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0))).next(()=>s.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0)))}deleteAllFieldIndexes(e){const t=br(e),n=Dn(e),i=Nn(e);return t.j().next(()=>n.j()).next(()=>i.j())}createTargetIndexes(e,t){return w.forEach(this.hn(t),n=>this.getIndexType(e,n).next(i=>{if(0===i||1===i){const s=new Fc(n).an();if(null!=s)return this.addFieldIndex(e,s)}}))}getDocumentsMatchingTarget(e,t){const n=Dn(e);let i=!0;const s=new Map;return w.forEach(this.hn(t),a=>this.Pn(e,a).next(u=>{i&&(i=!!u),s.set(a,u)})).next(()=>{if(i){let a=j();const u=[];return w.forEach(s,(l,h)=>{var q;N("IndexedDbIndexManager",`Using index ${q=l,`id=${q.indexId}|cg=${q.collectionGroup}|f=${q.fields.map(K=>`${K.fieldPath}:${K.kind}`).join(",")}`} to execute ${Kt(t)}`);const f=function(q,K){const X=Fs(K);if(void 0===X)return null;for(const W of wi(q,X.fieldPath))switch(W.op){case"array-contains-any":return W.value.arrayValue.values||[];case"array-contains":return[W.value]}return null}(h,l),_=function(q,K){const X=new Map;for(const W of qt(K))for(const T of wi(q,W.fieldPath))switch(T.op){case"==":case"in":X.set(W.fieldPath.canonicalString(),T.value);break;case"not-in":case"!=":return X.set(W.fieldPath.canonicalString(),T.value),Array.from(X.values())}return null}(h,l),p=function(q,K){const X=[];let W=!0;for(const T of qt(K)){const g=0===T.kind?Dl(q,T.fieldPath,q.startAt):Nl(q,T.fieldPath,q.startAt);X.push(g.value),W&&(W=g.inclusive)}return new Rt(X,W)}(h,l),R=function(q,K){const X=[];let W=!0;for(const T of qt(K)){const g=0===T.kind?Nl(q,T.fieldPath,q.endAt):Dl(q,T.fieldPath,q.endAt);X.push(g.value),W&&(W=g.inclusive)}return new Rt(X,W)}(h,l),x=this.In(l,h,p),k=this.In(l,h,R),D=this.Tn(l,h,_),U=this.En(l.indexId,f,x,p.inclusive,k,R.inclusive,D);return w.forEach(U,$=>n.G($,t.limit).next(q=>{q.forEach(K=>{const X=O.fromSegments(K.documentKey);a.has(X)||(a=a.add(X),u.push(X))})}))}).next(()=>u)}return w.resolve(null)})}hn(e){let t=this.ln.get(e);return t||(t=0===e.filters.length?[e]:f_(te.create(e.filters,"and")).map(n=>js(e.path,e.collectionGroup,e.orderBy,n.getFilters(),e.limit,e.startAt,e.endAt)),this.ln.set(e,t),t)}En(e,t,n,i,s,a,u){const l=(null!=t?t.length:1)*Math.max(n.length,s.length),h=l/(null!=t?t.length:1),f=[];for(let _=0;_<l;++_){const p=t?this.dn(t[_/h]):Fi,R=this.An(e,p,n[_%h],i),x=this.Rn(e,p,s[_%h],a),k=u.map(D=>this.An(e,p,D,!0));f.push(...this.createRange(R,x,k))}return f}An(e,t,n,i){const s=new Xt(e,O.empty(),t,n);return i?s:s.Zt()}Rn(e,t,n,i){const s=new Xt(e,O.empty(),t,n);return i?s.Zt():s}Pn(e,t){const n=new Fc(t),i=null!=t.collectionGroup?t.collectionGroup:t.path.lastSegment();return this.getFieldIndexes(e,i).next(s=>{let a=null;for(const u of s)n.rn(u)&&(!a||u.fields.length>a.fields.length)&&(a=u);return a})}getIndexType(e,t){let n=2;const i=this.hn(t);return w.forEach(i,s=>this.Pn(e,s).next(a=>{a?0!==n&&a.fields.length<function(l){let h=new ne(oe.comparator),f=!1;for(const _ of l.filters)for(const p of _.getFlattenedFilters())p.field.isKeyField()||("array-contains"===p.op||"array-contains-any"===p.op?f=!0:h=h.add(p.field));for(const _ of l.orderBy)_.field.isKeyField()||(h=h.add(_.field));return h.size+(f?1:0)}(s)&&(n=1):n=0})).next(()=>null!==t.limit&&i.length>1&&2===n?1:n)}Vn(e,t){const n=new Sr;for(const i of qt(e)){const s=t.data.field(i.fieldPath);if(null==s)return null;const a=n.Yt(i.kind);Yt.vt.It(s,a)}return n.zt()}dn(e){const t=new Sr;return Yt.vt.It(e,t.Yt(0)),t.zt()}mn(e,t){const n=new Sr;return Yt.vt.It(Gt(this.databaseId,t),n.Yt(function(s){const a=qt(s);return 0===a.length?0:a[a.length-1].kind}(e))),n.zt()}Tn(e,t,n){if(null===n)return[];let i=[];i.push(new Sr);let s=0;for(const a of qt(e)){const u=n[s++];for(const l of i)if(this.fn(t,a.fieldPath)&&hr(u))i=this.gn(i,a,u);else{const h=l.Yt(a.kind);Yt.vt.It(u,h)}}return this.pn(i)}In(e,t,n){return this.Tn(e,t,n.position)}pn(e){const t=[];for(let n=0;n<e.length;++n)t[n]=e[n].zt();return t}gn(e,t,n){const i=[...e],s=[];for(const a of n.arrayValue.values||[])for(const u of i){const l=new Sr;l.seed(u.zt()),Yt.vt.It(a,l.Yt(t.kind)),s.push(l)}return s}fn(e,t){return!!e.filters.find(n=>n instanceof J&&n.field.isEqual(t)&&("in"===n.op||"not-in"===n.op))}getFieldIndexes(e,t){const n=br(e),i=Nn(e);return(t?n.U("collectionGroupIndex",IDBKeyRange.bound(t,t)):n.U()).next(s=>{const a=[];return w.forEach(s,u=>i.get([u.indexId,this.uid]).next(l=>{a.push(function(f,_){const p=_?new In(_.sequenceNumber,new $e(Ht(_.readTime),new O(Je(_.documentKey)),_.largestBatchId)):In.empty(),R=f.fields.map(([x,k])=>new zt(oe.fromServerFormat(x),k));return new yn(f.indexId,f.collectionGroup,R,p)}(u,l))})).next(()=>a)})}getNextCollectionGroupToUpdate(e){return this.getFieldIndexes(e).next(t=>0===t.length?null:(t.sort((n,i)=>{const s=n.indexState.sequenceNumber-i.indexState.sequenceNumber;return 0!==s?s:G(n.collectionGroup,i.collectionGroup)}),t[0].collectionGroup))}updateCollectionGroup(e,t,n){const i=br(e),s=Nn(e);return this.yn(e).next(a=>i.U("collectionGroupIndex",IDBKeyRange.bound(t,t)).next(u=>w.forEach(u,l=>s.put(xc(l.indexId,this.uid,a,n)))))}updateIndexEntries(e,t){const n=new Map;return w.forEach(t,(i,s)=>{const a=n.get(i.collectionGroup);return(a?w.resolve(a):this.getFieldIndexes(e,i.collectionGroup)).next(u=>(n.set(i.collectionGroup,u),w.forEach(u,l=>this.wn(e,i,l).next(h=>{const f=this.Sn(s,l);return h.isEqual(f)?w.resolve():this.bn(e,s,l,h,f)}))))})}Dn(e,t,n,i){return Dn(e).put({indexId:i.indexId,uid:this.uid,arrayValue:i.arrayValue,directionalValue:i.directionalValue,orderedDocumentKey:this.mn(n,t.key),documentKey:t.key.path.toArray()})}vn(e,t,n,i){return Dn(e).delete([i.indexId,this.uid,i.arrayValue,i.directionalValue,this.mn(n,t.key),t.key.path.toArray()])}wn(e,t,n){const i=Dn(e);let s=new ne(Vt);return i.J({index:"documentKeyIndex",range:IDBKeyRange.only([n.indexId,this.uid,this.mn(n,t)])},(a,u)=>{s=s.add(new Xt(n.indexId,t,u.arrayValue,u.directionalValue))}).next(()=>s)}Sn(e,t){let n=new ne(Vt);const i=this.Vn(t,e);if(null==i)return n;const s=Fs(t);if(null!=s){const a=e.data.field(s.fieldPath);if(hr(a))for(const u of a.arrayValue.values||[])n=n.add(new Xt(t.indexId,e.key,this.dn(u),i))}else n=n.add(new Xt(t.indexId,e.key,Fi,i));return n}bn(e,t,n,i,s){N("IndexedDbIndexManager","Updating index entries for document '%s'",t.key);const a=[];return function(l,h,f,_,p){const R=l.getIterator(),x=h.getIterator();let k=Tn(R),D=Tn(x);for(;k||D;){let U=!1,$=!1;if(k&&D){const q=f(k,D);q<0?$=!0:q>0&&(U=!0)}else null!=k?$=!0:U=!0;U?(_(D),D=Tn(x)):$?(p(k),k=Tn(R)):(k=Tn(R),D=Tn(x))}}(i,s,Vt,u=>{a.push(this.Dn(e,t,n,u))},u=>{a.push(this.vn(e,t,n,u))}),w.waitFor(a)}yn(e){let t=1;return Nn(e).J({index:"sequenceNumberIndex",reverse:!0,range:IDBKeyRange.upperBound([this.uid,Number.MAX_SAFE_INTEGER])},(n,i,s)=>{s.done(),t=i.sequenceNumber+1}).next(()=>t)}createRange(e,t,n){n=n.sort((a,u)=>Vt(a,u)).filter((a,u,l)=>!u||0!==Vt(a,l[u-1]));const i=[];i.push(e);for(const a of n){const u=Vt(a,e),l=Vt(a,t);if(0===u)i[0]=e.Zt();else if(u>0&&l<0)i.push(a),i.push(a.Zt());else if(l>0)break}i.push(t);const s=[];for(let a=0;a<i.length;a+=2){if(this.Cn(i[a],i[a+1]))return[];s.push(IDBKeyRange.bound([i[a].indexId,this.uid,i[a].arrayValue,i[a].directionalValue,Fi,[]],[i[a+1].indexId,this.uid,i[a+1].arrayValue,i[a+1].directionalValue,Fi,[]]))}return s}Cn(e,t){return Vt(e,t)>0}getMinOffsetFromCollectionGroup(e,t){return this.getFieldIndexes(e,t).next(Uc)}getMinOffset(e,t){return w.mapArray(this.hn(t),n=>this.Pn(e,n).next(i=>i||L())).next(Uc)}}function Bc(r){return Te(r,"collectionParents")}function Dn(r){return Te(r,"indexEntries")}function br(r){return Te(r,"indexConfiguration")}function Nn(r){return Te(r,"indexState")}function Uc(r){B(0!==r.length);let e=r[0].indexState.offset,t=e.largestBatchId;for(let n=1;n<r.length;n++){const i=r[n].indexState.offset;Ms(i,e)<0&&(e=i),t<i.largestBatchId&&(t=i.largestBatchId)}return new $e(e.readTime,e.documentKey,t)}const qc={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0};class xe{constructor(e,t,n){this.cacheSizeCollectionThreshold=e,this.percentileToCollect=t,this.maximumSequenceNumbersToCollect=n}static withCacheSize(e){return new xe(e,xe.DEFAULT_COLLECTION_PERCENTILE,xe.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)}}function zc(r,e,t){const n=r.store("mutations"),i=r.store("documentMutations"),s=[],a=IDBKeyRange.only(t.batchId);let u=0;const l=n.J({range:a},(f,_,p)=>(u++,p.delete()));s.push(l.next(()=>{B(1===u)}));const h=[];for(const f of t.mutations){const _=sl(e,f.key.path,t.batchId);s.push(i.delete(_)),h.push(f.key)}return w.waitFor(s).next(()=>h)}function Mi(r){if(!r)return 0;let e;if(r.document)e=r.document;else if(r.unknownDocument)e=r.unknownDocument;else{if(!r.noDocument)throw L();e=r.noDocument}return JSON.stringify(e).length}xe.DEFAULT_COLLECTION_PERCENTILE=10,xe.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3,xe.DEFAULT=new xe(41943040,xe.DEFAULT_COLLECTION_PERCENTILE,xe.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),xe.DISABLED=new xe(-1,0,0);class Oi{constructor(e,t,n,i){this.userId=e,this.serializer=t,this.indexManager=n,this.referenceDelegate=i,this.Fn={}}static lt(e,t,n,i){B(""!==e.uid);const s=e.isAuthenticated()?e.uid:"";return new Oi(s,t,n,i)}checkEmpty(e){let t=!0;const n=IDBKeyRange.bound([this.userId,Number.NEGATIVE_INFINITY],[this.userId,Number.POSITIVE_INFINITY]);return St(e).J({index:"userMutationsIndex",range:n},(i,s,a)=>{t=!1,a.done()}).next(()=>t)}addMutationBatch(e,t,n,i){const s=kn(e),a=St(e);return a.add({}).next(u=>{B("number"==typeof u);const l=new Xs(u,t,n,i),h=function(R,x,k){const D=k.baseMutations.map($=>Rr(R.ct,$)),U=k.mutations.map($=>Rr(R.ct,$));return{userId:x,batchId:k.batchId,localWriteTimeMs:k.localWriteTime.toMillis(),baseMutations:D,mutations:U}}(this.serializer,this.userId,l),f=[];let _=new ne((p,R)=>G(p.canonicalString(),R.canonicalString()));for(const p of i){const R=sl(this.userId,p.key.path,u);_=_.add(p.key.path.popLast()),f.push(a.put(h)),f.push(s.put(R,nm))}return _.forEach(p=>{f.push(this.indexManager.addToCollectionParentIndex(e,p))}),e.addOnCommittedListener(()=>{this.Fn[u]=l.keys()}),w.waitFor(f).next(()=>l)})}lookupMutationBatch(e,t){return St(e).get(t).next(n=>n?(B(n.userId===this.userId),Jt(this.serializer,n)):null)}Mn(e,t){return this.Fn[t]?w.resolve(this.Fn[t]):this.lookupMutationBatch(e,t).next(n=>{if(n){const i=n.keys();return this.Fn[t]=i,i}return null})}getNextMutationBatchAfterBatchId(e,t){const n=t+1,i=IDBKeyRange.lowerBound([this.userId,n]);let s=null;return St(e).J({index:"userMutationsIndex",range:i},(a,u,l)=>{u.userId===this.userId&&(B(u.batchId>=n),s=Jt(this.serializer,u)),l.done()}).next(()=>s)}getHighestUnacknowledgedBatchId(e){const t=IDBKeyRange.upperBound([this.userId,Number.POSITIVE_INFINITY]);let n=-1;return St(e).J({index:"userMutationsIndex",range:t,reverse:!0},(i,s,a)=>{n=s.batchId,a.done()}).next(()=>n)}getAllMutationBatches(e){const t=IDBKeyRange.bound([this.userId,-1],[this.userId,Number.POSITIVE_INFINITY]);return St(e).U("userMutationsIndex",t).next(n=>n.map(i=>Jt(this.serializer,i)))}getAllMutationBatchesAffectingDocumentKey(e,t){const n=_i(this.userId,t.path),i=IDBKeyRange.lowerBound(n),s=[];return kn(e).J({range:i},(a,u,l)=>{const[h,f,_]=a,p=Je(f);if(h===this.userId&&t.path.isEqual(p))return St(e).get(_).next(R=>{if(!R)throw L();B(R.userId===this.userId),s.push(Jt(this.serializer,R))});l.done()}).next(()=>s)}getAllMutationBatchesAffectingDocumentKeys(e,t){let n=new ne(G);const i=[];return t.forEach(s=>{const a=_i(this.userId,s.path),u=IDBKeyRange.lowerBound(a),l=kn(e).J({range:u},(h,f,_)=>{const[p,R,x]=h,k=Je(R);p===this.userId&&s.path.isEqual(k)?n=n.add(x):_.done()});i.push(l)}),w.waitFor(i).next(()=>this.xn(e,n))}getAllMutationBatchesAffectingQuery(e,t){const n=t.path,i=n.length+1,s=_i(this.userId,n),a=IDBKeyRange.lowerBound(s);let u=new ne(G);return kn(e).J({range:a},(l,h,f)=>{const[_,p,R]=l,x=Je(p);_===this.userId&&n.isPrefixOf(x)?x.length===i&&(u=u.add(R)):f.done()}).next(()=>this.xn(e,u))}xn(e,t){const n=[],i=[];return t.forEach(s=>{i.push(St(e).get(s).next(a=>{if(null===a)throw L();B(a.userId===this.userId),n.push(Jt(this.serializer,a))}))}),w.waitFor(i).next(()=>n)}removeMutationBatch(e,t){return zc(e._e,this.userId,t).next(n=>(e.addOnCommittedListener(()=>{this.On(t.batchId)}),w.forEach(n,i=>this.referenceDelegate.markPotentiallyOrphaned(e,i))))}On(e){delete this.Fn[e]}performConsistencyCheck(e){return this.checkEmpty(e).next(t=>{if(!t)return w.resolve();const n=IDBKeyRange.lowerBound(function(a){return[a]}(this.userId)),i=[];return kn(e).J({range:n},(s,a,u)=>{if(s[0]===this.userId){const l=Je(s[1]);i.push(l)}else u.done()}).next(()=>{B(0===i.length)})})}containsKey(e,t){return $c(e,this.userId,t)}Nn(e){return Gc(e).get(this.userId).next(t=>t||{userId:this.userId,lastAcknowledgedBatchId:-1,lastStreamToken:""})}}function $c(r,e,t){const n=_i(e,t.path),i=n[1],s=IDBKeyRange.lowerBound(n);let a=!1;return kn(r).J({range:s,H:!0},(u,l,h)=>{const[f,_,p]=u;f===e&&_===i&&(a=!0),h.done()}).next(()=>a)}function St(r){return Te(r,"mutations")}function kn(r){return Te(r,"documentMutations")}function Gc(r){return Te(r,"mutationQueues")}class Zt{constructor(e){this.Ln=e}next(){return this.Ln+=2,this.Ln}static Bn(){return new Zt(0)}static kn(){return new Zt(-1)}}class g_{constructor(e,t){this.referenceDelegate=e,this.serializer=t}allocateTargetId(e){return this.qn(e).next(t=>{const n=new Zt(t.highestTargetId);return t.highestTargetId=n.next(),this.Qn(e,t).next(()=>t.highestTargetId)})}getLastRemoteSnapshotVersion(e){return this.qn(e).next(t=>z.fromTimestamp(new ce(t.lastRemoteSnapshotVersion.seconds,t.lastRemoteSnapshotVersion.nanoseconds)))}getHighestSequenceNumber(e){return this.qn(e).next(t=>t.highestListenSequenceNumber)}setTargetsMetadata(e,t,n){return this.qn(e).next(i=>(i.highestListenSequenceNumber=t,n&&(i.lastRemoteSnapshotVersion=n.toTimestamp()),t>i.highestListenSequenceNumber&&(i.highestListenSequenceNumber=t),this.Qn(e,i)))}addTargetData(e,t){return this.Kn(e,t).next(()=>this.qn(e).next(n=>(n.targetCount+=1,this.$n(t,n),this.Qn(e,n))))}updateTargetData(e,t){return this.Kn(e,t)}removeTargetData(e,t){return this.removeMatchingKeysForTargetId(e,t.targetId).next(()=>Fn(e).delete(t.targetId)).next(()=>this.qn(e)).next(n=>(B(n.targetCount>0),n.targetCount-=1,this.Qn(e,n)))}removeTargets(e,t,n){let i=0;const s=[];return Fn(e).J((a,u)=>{const l=Pr(u);l.sequenceNumber<=t&&null===n.get(l.targetId)&&(i++,s.push(this.removeTargetData(e,l)))}).next(()=>w.waitFor(s)).next(()=>i)}forEachTarget(e,t){return Fn(e).J((n,i)=>{const s=Pr(i);t(s)})}qn(e){return Kc(e).get("targetGlobalKey").next(t=>(B(null!==t),t))}Qn(e,t){return Kc(e).put("targetGlobalKey",t)}Kn(e,t){return Fn(e).put(Sc(this.serializer,t))}$n(e,t){let n=!1;return e.targetId>t.highestTargetId&&(t.highestTargetId=e.targetId,n=!0),e.sequenceNumber>t.highestListenSequenceNumber&&(t.highestListenSequenceNumber=e.sequenceNumber,n=!0),n}getTargetCount(e){return this.qn(e).next(t=>t.targetCount)}getTargetData(e,t){const n=Kt(t),i=IDBKeyRange.bound([n,Number.NEGATIVE_INFINITY],[n,Number.POSITIVE_INFINITY]);let s=null;return Fn(e).J({range:i,index:"queryTargetsIndex"},(a,u,l)=>{const h=Pr(u);mr(t,h.target)&&(s=h,l.done())}).next(()=>s)}addMatchingKeys(e,t,n){const i=[],s=bt(e);return t.forEach(a=>{const u=Se(a.path);i.push(s.put({targetId:n,path:u})),i.push(this.referenceDelegate.addReference(e,n,a))}),w.waitFor(i)}removeMatchingKeys(e,t,n){const i=bt(e);return w.forEach(t,s=>{const a=Se(s.path);return w.waitFor([i.delete([n,a]),this.referenceDelegate.removeReference(e,n,s)])})}removeMatchingKeysForTargetId(e,t){const n=bt(e),i=IDBKeyRange.bound([t],[t+1],!1,!0);return n.delete(i)}getMatchingKeysForTargetId(e,t){const n=IDBKeyRange.bound([t],[t+1],!1,!0),i=bt(e);let s=j();return i.J({range:n,H:!0},(a,u,l)=>{const h=Je(a[1]),f=new O(h);s=s.add(f)}).next(()=>s)}containsKey(e,t){const n=Se(t.path),i=IDBKeyRange.bound([n],[Hu(n)],!1,!0);let s=0;return bt(e).J({index:"documentTargetsIndex",H:!0,range:i},([a,u],l,h)=>{0!==a&&(s++,h.done())}).next(()=>s>0)}ot(e,t){return Fn(e).get(t).next(n=>n?Pr(n):null)}}function Fn(r){return Te(r,"targets")}function Kc(r){return Te(r,"targetGlobal")}function bt(r){return Te(r,"targetDocuments")}function jc([r,e],[t,n]){const i=G(r,t);return 0===i?G(e,n):i}class p_{constructor(e){this.Un=e,this.buffer=new ne(jc),this.Wn=0}Gn(){return++this.Wn}zn(e){const t=[e,this.Gn()];if(this.buffer.size<this.Un)this.buffer=this.buffer.add(t);else{const n=this.buffer.last();jc(t,n)<0&&(this.buffer=this.buffer.delete(n).add(t))}}get maxValue(){return this.buffer.last()[0]}}class Wc{constructor(e,t,n){this.garbageCollector=e,this.asyncQueue=t,this.localStore=n,this.jn=null}start(){-1!==this.garbageCollector.params.cacheSizeCollectionThreshold&&this.Hn(6e4)}stop(){this.jn&&(this.jn.cancel(),this.jn=null)}get started(){return null!==this.jn}Hn(e){var t=this;N("LruGarbageCollector",`Garbage collection scheduled in ${e}ms`),this.jn=this.asyncQueue.enqueueAfterDelay("lru_garbage_collection",e,(0,b.A)(function*(){t.jn=null;try{yield t.localStore.collectGarbage(t.garbageCollector)}catch(n){It(n)?N("LruGarbageCollector","Ignoring IndexedDB error during garbage collection: ",n):yield yt(n)}yield t.Hn(3e5)}))}}class y_{constructor(e,t){this.Jn=e,this.params=t}calculateTargetCount(e,t){return this.Jn.Yn(e).next(n=>Math.floor(t/100*n))}nthSequenceNumber(e,t){if(0===t)return w.resolve(Ge.oe);const n=new p_(t);return this.Jn.forEachTarget(e,i=>n.zn(i.sequenceNumber)).next(()=>this.Jn.Zn(e,i=>n.zn(i))).next(()=>n.maxValue)}removeTargets(e,t,n){return this.Jn.removeTargets(e,t,n)}removeOrphanedDocuments(e,t){return this.Jn.removeOrphanedDocuments(e,t)}collect(e,t){return-1===this.params.cacheSizeCollectionThreshold?(N("LruGarbageCollector","Garbage collection skipped; disabled"),w.resolve(qc)):this.getCacheSize(e).next(n=>n<this.params.cacheSizeCollectionThreshold?(N("LruGarbageCollector",`Garbage collection skipped; Cache size ${n} is lower than threshold ${this.params.cacheSizeCollectionThreshold}`),qc):this.Xn(e,t))}getCacheSize(e){return this.Jn.getCacheSize(e)}Xn(e,t){let n,i,s,a,u,l,h;const f=Date.now();return this.calculateTargetCount(e,this.params.percentileToCollect).next(_=>(_>this.params.maximumSequenceNumbersToCollect?(N("LruGarbageCollector",`Capping sequence numbers to collect down to the maximum of ${this.params.maximumSequenceNumbersToCollect} from ${_}`),i=this.params.maximumSequenceNumbersToCollect):i=_,a=Date.now(),this.nthSequenceNumber(e,i))).next(_=>(n=_,u=Date.now(),this.removeTargets(e,n,t))).next(_=>(s=_,l=Date.now(),this.removeOrphanedDocuments(e,n))).next(_=>(h=Date.now(),gn()<=Qe.$b.DEBUG&&N("LruGarbageCollector",`LRU Garbage Collection\n\tCounted targets in ${a-f}ms\n\tDetermined least recently used ${i} in `+(u-a)+`ms\n\tRemoved ${s} targets in `+(l-u)+`ms\n\tRemoved ${_} documents in `+(h-l)+`ms\nTotal Duration: ${h-f}ms`),w.resolve({didRun:!0,sequenceNumbersCollected:i,targetsRemoved:s,documentsRemoved:_})))}}function Qc(r,e){return new y_(r,e)}class I_{constructor(e,t){this.db=e,this.garbageCollector=Qc(this,t)}Yn(e){const t=this.er(e);return this.db.getTargetCache().getTargetCount(e).next(n=>t.next(i=>n+i))}er(e){let t=0;return this.Zn(e,n=>{t++}).next(()=>t)}forEachTarget(e,t){return this.db.getTargetCache().forEachTarget(e,t)}Zn(e,t){return this.tr(e,(n,i)=>t(i))}addReference(e,t,n){return Li(e,n)}removeReference(e,t,n){return Li(e,n)}removeTargets(e,t,n){return this.db.getTargetCache().removeTargets(e,t,n)}markPotentiallyOrphaned(e,t){return Li(e,t)}nr(e,t){return function(i,s){let a=!1;return Gc(i).Y(u=>$c(i,u,s).next(l=>(l&&(a=!0),w.resolve(!l)))).next(()=>a)}(e,t)}removeOrphanedDocuments(e,t){const n=this.db.getRemoteDocumentCache().newChangeBuffer(),i=[];let s=0;return this.tr(e,(a,u)=>{if(u<=t){const l=this.nr(e,a).next(h=>{if(!h)return s++,n.getEntry(e,a).next(()=>(n.removeEntry(a,z.min()),bt(e).delete([0,Se(a.path)])))});i.push(l)}}).next(()=>w.waitFor(i)).next(()=>n.apply(e)).next(()=>s)}removeTarget(e,t){const n=t.withSequenceNumber(e.currentSequenceNumber);return this.db.getTargetCache().updateTargetData(e,n)}updateLimboDocument(e,t){return Li(e,t)}tr(e,t){const n=bt(e);let i,s=Ge.oe;return n.J({index:"documentTargetsIndex"},([a,u],{path:l,sequenceNumber:h})=>{0===a?(s!==Ge.oe&&t(new O(Je(i)),s),s=h,i=l):s=Ge.oe}).next(()=>{s!==Ge.oe&&t(new O(Je(i)),s)})}getCacheSize(e){return this.db.getRemoteDocumentCache().getSize(e)}}function Li(r,e){return bt(r).put((i=r.currentSequenceNumber,{targetId:0,path:Se(e.path),sequenceNumber:i}));var i}class Hc{constructor(){this.changes=new ot(e=>e.toString(),(e,t)=>e.isEqual(t)),this.changesApplied=!1}addEntry(e){this.assertNotApplied(),this.changes.set(e.key,e)}removeEntry(e,t){this.assertNotApplied(),this.changes.set(e,ae.newInvalidDocument(e).setReadTime(t))}getEntry(e,t){this.assertNotApplied();const n=this.changes.get(t);return void 0!==n?w.resolve(n):this.getFromCache(e,t)}getEntries(e,t){return this.getAllFromCache(e,t)}apply(e){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(e)}assertNotApplied(){}}class T_{constructor(e){this.serializer=e}setIndexManager(e){this.indexManager=e}addEntry(e,t,n){return en(e).put(n)}removeEntry(e,t,n){return en(e).delete(function(s,a){const u=s.path.toArray();return[u.slice(0,u.length-2),u[u.length-2],Di(a),u[u.length-1]]}(t,n))}updateMetadata(e,t){return this.getMetadata(e).next(n=>(n.byteSize+=t,this.rr(e,n)))}getEntry(e,t){let n=ae.newInvalidDocument(t);return en(e).J({index:"documentKeyIndex",range:IDBKeyRange.only(xr(t))},(i,s)=>{n=this.ir(t,s)}).next(()=>n)}sr(e,t){let n={size:0,document:ae.newInvalidDocument(t)};return en(e).J({index:"documentKeyIndex",range:IDBKeyRange.only(xr(t))},(i,s)=>{n={document:this.ir(t,s),size:Mi(s)}}).next(()=>n)}getEntries(e,t){let n=qe();return this._r(e,t,(i,s)=>{const a=this.ir(i,s);n=n.insert(i,a)}).next(()=>n)}ar(e,t){let n=qe(),i=new se(O.comparator);return this._r(e,t,(s,a)=>{const u=this.ir(s,a);n=n.insert(s,u),i=i.insert(s,Mi(a))}).next(()=>({documents:n,ur:i}))}_r(e,t,n){if(t.isEmpty())return w.resolve();let i=new ne(Zc);t.forEach(l=>i=i.add(l));const s=IDBKeyRange.bound(xr(i.first()),xr(i.last())),a=i.getIterator();let u=a.getNext();return en(e).J({index:"documentKeyIndex",range:s},(l,h,f)=>{const _=O.fromSegments([...h.prefixPath,h.collectionGroup,h.documentId]);for(;u&&Zc(u,_)<0;)n(u,null),u=a.getNext();u&&u.isEqual(_)&&(n(u,h),u=a.hasNext()?a.getNext():null),u?f.$(xr(u)):f.done()}).next(()=>{for(;u;)n(u,null),u=a.hasNext()?a.getNext():null})}getDocumentsMatchingQuery(e,t,n,i,s){const a=t.path,u=[a.popLast().toArray(),a.lastSegment(),Di(n.readTime),n.documentKey.path.isEmpty()?"":n.documentKey.path.lastSegment()],l=[a.popLast().toArray(),a.lastSegment(),[Number.MAX_SAFE_INTEGER,Number.MAX_SAFE_INTEGER],""];return en(e).U(IDBKeyRange.bound(u,l,!0)).next(h=>{null==s||s.incrementDocumentReadCount(h.length);let f=qe();for(const _ of h){const p=this.ir(O.fromSegments(_.prefixPath.concat(_.collectionGroup,_.documentId)),_);p.isFoundDocument()&&(gr(t,p)||i.has(p.key))&&(f=f.insert(p.key,p))}return f})}getAllFromCollectionGroup(e,t,n,i){let s=qe();const a=Xc(t,n),u=Xc(t,$e.max());return en(e).J({index:"collectionGroupIndex",range:IDBKeyRange.bound(a,u,!0)},(l,h,f)=>{const _=this.ir(O.fromSegments(h.prefixPath.concat(h.collectionGroup,h.documentId)),h);s=s.insert(_.key,_),s.size===i&&f.done()}).next(()=>s)}newChangeBuffer(e){return new E_(this,!!e&&e.trackRemovals)}getSize(e){return this.getMetadata(e).next(t=>t.byteSize)}getMetadata(e){return Yc(e).get("remoteDocumentGlobalKey").next(t=>(B(!!t),t))}rr(e,t){return Yc(e).put("remoteDocumentGlobalKey",t)}ir(e,t){if(t){const n=function o_(r,e){let t;if(e.document)t=Ic(r.ct,e.document,!!e.hasCommittedMutations);else if(e.noDocument){const n=O.fromSegments(e.noDocument.path),i=Ht(e.noDocument.readTime);t=ae.newNoDocument(n,i),e.hasCommittedMutations&&t.setHasCommittedMutations()}else{if(!e.unknownDocument)return L();{const n=O.fromSegments(e.unknownDocument.path),i=Ht(e.unknownDocument.version);t=ae.newUnknownDocument(n,i)}}return e.readTime&&t.setReadTime(function(i){const s=new ce(i[0],i[1]);return z.fromTimestamp(s)}(e.readTime)),t}(this.serializer,t);if(!n.isNoDocument()||!n.version.isEqual(z.min()))return n}return ae.newInvalidDocument(e)}}function Jc(r){return new T_(r)}class E_ extends Hc{constructor(e,t){super(),this.cr=e,this.trackRemovals=t,this.lr=new ot(n=>n.toString(),(n,i)=>n.isEqual(i))}applyChanges(e){const t=[];let n=0,i=new ne((s,a)=>G(s.canonicalString(),a.canonicalString()));return this.changes.forEach((s,a)=>{const u=this.lr.get(s);if(t.push(this.cr.removeEntry(e,s,u.readTime)),a.isValidDocument()){const l=Vc(this.cr.serializer,a);i=i.add(s.path.popLast());const h=Mi(l);n+=h-u.size,t.push(this.cr.addEntry(e,s,l))}else if(n-=u.size,this.trackRemovals){const l=Vc(this.cr.serializer,a.convertToNoDocument(z.min()));t.push(this.cr.addEntry(e,s,l))}}),i.forEach(s=>{t.push(this.cr.indexManager.addToCollectionParentIndex(e,s))}),t.push(this.cr.updateMetadata(e,n)),w.waitFor(t)}getFromCache(e,t){return this.cr.sr(e,t).next(n=>(this.lr.set(t,{size:n.size,readTime:n.document.readTime}),n.document))}getAllFromCache(e,t){return this.cr.ar(e,t).next(({documents:n,ur:i})=>(i.forEach((s,a)=>{this.lr.set(s,{size:a,readTime:n.get(s).readTime})}),n))}}function Yc(r){return Te(r,"remoteDocumentGlobal")}function en(r){return Te(r,"remoteDocumentsV14")}function xr(r){const e=r.path.toArray();return[e.slice(0,e.length-2),e[e.length-2],e[e.length-1]]}function Xc(r,e){const t=e.documentKey.path.toArray();return[r,Di(e.readTime),t.slice(0,t.length-2),t.length>0?t[t.length-1]:""]}function Zc(r,e){const t=r.path.toArray(),n=e.path.toArray();let i=0;for(let s=0;s<t.length-2&&s<n.length-2;++s)if(i=G(t[s],n[s]),i)return i;return i=G(t.length,n.length),i||(i=G(t[t.length-2],n[n.length-2]),i||G(t[t.length-1],n[n.length-1]))}class v_{constructor(e,t){this.overlayedDocument=e,this.mutatedFields=t}}class eh{constructor(e,t,n,i){this.remoteDocumentCache=e,this.mutationQueue=t,this.documentOverlayCache=n,this.indexManager=i}getDocument(e,t){let n=null;return this.documentOverlayCache.getOverlay(e,t).next(i=>(n=i,this.remoteDocumentCache.getEntry(e,t))).next(i=>(null!==n&&Tr(n.mutation,i,Ue.empty(),ce.now()),i))}getDocuments(e,t){return this.remoteDocumentCache.getEntries(e,t).next(n=>this.getLocalViewOfDocuments(e,n,j()).next(()=>n))}getLocalViewOfDocuments(e,t,n=j()){const i=Xe();return this.populateOverlays(e,i,t).next(()=>this.computeViews(e,t,i,n).next(s=>{let a=pr();return s.forEach((u,l)=>{a=a.insert(u,l.overlayedDocument)}),a}))}getOverlayedDocuments(e,t){const n=Xe();return this.populateOverlays(e,n,t).next(()=>this.computeViews(e,t,n,j()))}populateOverlays(e,t,n){const i=[];return n.forEach(s=>{t.has(s)||i.push(s)}),this.documentOverlayCache.getOverlays(e,i).next(s=>{s.forEach((a,u)=>{t.set(a,u)})})}computeViews(e,t,n,i){let s=qe();const a=yr(),u=yr();return t.forEach((l,h)=>{const f=n.get(h.key);i.has(h.key)&&(void 0===f||f.mutation instanceof at)?s=s.insert(h.key,h):void 0!==f?(a.set(h.key,f.mutation.getFieldMask()),Tr(f.mutation,h,f.mutation.getFieldMask(),ce.now())):a.set(h.key,Ue.empty())}),this.recalculateAndSaveOverlays(e,s).next(l=>(l.forEach((h,f)=>a.set(h,f)),t.forEach((h,f)=>{var _;return u.set(h,new v_(f,null!==(_=a.get(h))&&void 0!==_?_:null))}),u))}recalculateAndSaveOverlays(e,t){const n=yr();let i=new se((a,u)=>a-u),s=j();return this.mutationQueue.getAllMutationBatchesAffectingDocumentKeys(e,t).next(a=>{for(const u of a)u.keys().forEach(l=>{const h=t.get(l);if(null===h)return;let f=n.get(l)||Ue.empty();f=u.applyToLocalView(h,f),n.set(l,f);const _=(i.get(u.batchId)||j()).add(l);i=i.insert(u.batchId,_)})}).next(()=>{const a=[],u=i.getReverseIterator();for(;u.hasNext();){const l=u.getNext(),h=l.key,f=l.value,_=$l();f.forEach(p=>{if(!s.has(p)){const R=Yl(t.get(p),n.get(p));null!==R&&_.set(p,R),s=s.add(p)}}),a.push(this.documentOverlayCache.saveOverlays(e,h,_))}return w.waitFor(a)}).next(()=>n)}recalculateAndSaveOverlaysForDocumentKeys(e,t){return this.remoteDocumentCache.getEntries(e,t).next(n=>this.recalculateAndSaveOverlays(e,n))}getDocumentsMatchingQuery(e,t,n,i){return O.isDocumentKey((a=t).path)&&null===a.collectionGroup&&0===a.filters.length?this.getDocumentsMatchingDocumentQuery(e,t.path):Ws(t)?this.getDocumentsMatchingCollectionGroupQuery(e,t,n,i):this.getDocumentsMatchingCollectionQuery(e,t,n,i);var a}getNextDocuments(e,t,n,i){return this.remoteDocumentCache.getAllFromCollectionGroup(e,t,n,i).next(s=>{const a=i-s.size>0?this.documentOverlayCache.getOverlaysForCollectionGroup(e,t,n.largestBatchId,i-s.size):w.resolve(Xe());let u=-1,l=s;return a.next(h=>w.forEach(h,(f,_)=>(u<_.largestBatchId&&(u=_.largestBatchId),s.get(f)?w.resolve():this.remoteDocumentCache.getEntry(e,f).next(p=>{l=l.insert(f,p)}))).next(()=>this.populateOverlays(e,h,s)).next(()=>this.computeViews(e,l,h,j())).next(f=>({batchId:u,changes:zl(f)})))})}getDocumentsMatchingDocumentQuery(e,t){return this.getDocument(e,new O(t)).next(n=>{let i=pr();return n.isFoundDocument()&&(i=i.insert(n.key,n)),i})}getDocumentsMatchingCollectionGroupQuery(e,t,n,i){const s=t.collectionGroup;let a=pr();return this.indexManager.getCollectionParents(e,s).next(u=>w.forEach(u,l=>{const h=(_=t,p=l.child(s),new st(p,null,_.explicitOrderBy.slice(),_.filters.slice(),_.limit,_.limitType,_.startAt,_.endAt));var _,p;return this.getDocumentsMatchingCollectionQuery(e,h,n,i).next(f=>{f.forEach((_,p)=>{a=a.insert(_,p)})})}).next(()=>a))}getDocumentsMatchingCollectionQuery(e,t,n,i){let s;return this.documentOverlayCache.getOverlaysForCollection(e,t.path,n.largestBatchId).next(a=>(s=a,this.remoteDocumentCache.getDocumentsMatchingQuery(e,t,n,s,i))).next(a=>{s.forEach((l,h)=>{const f=h.getKey();null===a.get(f)&&(a=a.insert(f,ae.newInvalidDocument(f)))});let u=pr();return a.forEach((l,h)=>{const f=s.get(l);void 0!==f&&Tr(f.mutation,h,Ue.empty(),ce.now()),gr(t,h)&&(u=u.insert(l,h))}),u})}}class A_{constructor(e){this.serializer=e,this.hr=new Map,this.Pr=new Map}getBundleMetadata(e,t){return w.resolve(this.hr.get(t))}saveBundleMetadata(e,t){return this.hr.set(t.id,{id:(i=t).id,version:i.version,createTime:ye(i.createTime)}),w.resolve();var i}getNamedQuery(e,t){return w.resolve(this.Pr.get(t))}saveNamedQuery(e,t){return this.Pr.set(t.name,{name:(i=t).name,query:ao(i.bundledQuery),readTime:ye(i.readTime)}),w.resolve();var i}}class w_{constructor(){this.overlays=new se(O.comparator),this.Ir=new Map}getOverlay(e,t){return w.resolve(this.overlays.get(t))}getOverlays(e,t){const n=Xe();return w.forEach(t,i=>this.getOverlay(e,i).next(s=>{null!==s&&n.set(i,s)})).next(()=>n)}saveOverlays(e,t,n){return n.forEach((i,s)=>{this.ht(e,t,s)}),w.resolve()}removeOverlaysForBatchId(e,t,n){const i=this.Ir.get(n);return void 0!==i&&(i.forEach(s=>this.overlays=this.overlays.remove(s)),this.Ir.delete(n)),w.resolve()}getOverlaysForCollection(e,t,n){const i=Xe(),s=t.length+1,a=new O(t.child("")),u=this.overlays.getIteratorFrom(a);for(;u.hasNext();){const l=u.getNext().value,h=l.getKey();if(!t.isPrefixOf(h.path))break;h.path.length===s&&l.largestBatchId>n&&i.set(l.getKey(),l)}return w.resolve(i)}getOverlaysForCollectionGroup(e,t,n,i){let s=new se((h,f)=>h-f);const a=this.overlays.getIterator();for(;a.hasNext();){const h=a.getNext().value;if(h.getKey().getCollectionGroup()===t&&h.largestBatchId>n){let f=s.get(h.largestBatchId);null===f&&(f=Xe(),s=s.insert(h.largestBatchId,f)),f.set(h.getKey(),h)}}const u=Xe(),l=s.getIterator();for(;l.hasNext()&&(l.getNext().value.forEach((h,f)=>u.set(h,f)),!(u.size()>=i)););return w.resolve(u)}ht(e,t,n){const i=this.overlays.get(n.key);if(null!==i){const a=this.Ir.get(i.largestBatchId).delete(n.key);this.Ir.set(i.largestBatchId,a)}this.overlays=this.overlays.insert(n.key,new eo(t,n));let s=this.Ir.get(t);void 0===s&&(s=j(),this.Ir.set(t,s)),this.Ir.set(t,s.add(n.key))}}class R_{constructor(){this.sessionToken=me.EMPTY_BYTE_STRING}getSessionToken(e){return w.resolve(this.sessionToken)}setSessionToken(e,t){return this.sessionToken=t,w.resolve()}}class _o{constructor(){this.Tr=new ne(Ae.Er),this.dr=new ne(Ae.Ar)}isEmpty(){return this.Tr.isEmpty()}addReference(e,t){const n=new Ae(e,t);this.Tr=this.Tr.add(n),this.dr=this.dr.add(n)}Rr(e,t){e.forEach(n=>this.addReference(n,t))}removeReference(e,t){this.Vr(new Ae(e,t))}mr(e,t){e.forEach(n=>this.removeReference(n,t))}gr(e){const t=new O(new H([])),n=new Ae(t,e),i=new Ae(t,e+1),s=[];return this.dr.forEachInRange([n,i],a=>{this.Vr(a),s.push(a.key)}),s}pr(){this.Tr.forEach(e=>this.Vr(e))}Vr(e){this.Tr=this.Tr.delete(e),this.dr=this.dr.delete(e)}yr(e){const t=new O(new H([])),n=new Ae(t,e),i=new Ae(t,e+1);let s=j();return this.dr.forEachInRange([n,i],a=>{s=s.add(a.key)}),s}containsKey(e){const t=new Ae(e,0),n=this.Tr.firstAfterOrEqual(t);return null!==n&&e.isEqual(n.key)}}class Ae{constructor(e,t){this.key=e,this.wr=t}static Er(e,t){return O.comparator(e.key,t.key)||G(e.wr,t.wr)}static Ar(e,t){return G(e.wr,t.wr)||O.comparator(e.key,t.key)}}class P_{constructor(e,t){this.indexManager=e,this.referenceDelegate=t,this.mutationQueue=[],this.Sr=1,this.br=new ne(Ae.Er)}checkEmpty(e){return w.resolve(0===this.mutationQueue.length)}addMutationBatch(e,t,n,i){const s=this.Sr;this.Sr++;const a=new Xs(s,t,n,i);this.mutationQueue.push(a);for(const u of i)this.br=this.br.add(new Ae(u.key,s)),this.indexManager.addToCollectionParentIndex(e,u.key.path.popLast());return w.resolve(a)}lookupMutationBatch(e,t){return w.resolve(this.Dr(t))}getNextMutationBatchAfterBatchId(e,t){const i=this.vr(t+1),s=i<0?0:i;return w.resolve(this.mutationQueue.length>s?this.mutationQueue[s]:null)}getHighestUnacknowledgedBatchId(){return w.resolve(0===this.mutationQueue.length?-1:this.Sr-1)}getAllMutationBatches(e){return w.resolve(this.mutationQueue.slice())}getAllMutationBatchesAffectingDocumentKey(e,t){const n=new Ae(t,0),i=new Ae(t,Number.POSITIVE_INFINITY),s=[];return this.br.forEachInRange([n,i],a=>{const u=this.Dr(a.wr);s.push(u)}),w.resolve(s)}getAllMutationBatchesAffectingDocumentKeys(e,t){let n=new ne(G);return t.forEach(i=>{const s=new Ae(i,0),a=new Ae(i,Number.POSITIVE_INFINITY);this.br.forEachInRange([s,a],u=>{n=n.add(u.wr)})}),w.resolve(this.Cr(n))}getAllMutationBatchesAffectingQuery(e,t){const n=t.path,i=n.length+1;let s=n;O.isDocumentKey(s)||(s=s.child(""));const a=new Ae(new O(s),0);let u=new ne(G);return this.br.forEachWhile(l=>{const h=l.key.path;return!!n.isPrefixOf(h)&&(h.length===i&&(u=u.add(l.wr)),!0)},a),w.resolve(this.Cr(u))}Cr(e){const t=[];return e.forEach(n=>{const i=this.Dr(n);null!==i&&t.push(i)}),t}removeMutationBatch(e,t){B(0===this.Fr(t.batchId,"removed")),this.mutationQueue.shift();let n=this.br;return w.forEach(t.mutations,i=>{const s=new Ae(i.key,t.batchId);return n=n.delete(s),this.referenceDelegate.markPotentiallyOrphaned(e,i.key)}).next(()=>{this.br=n})}On(e){}containsKey(e,t){const n=new Ae(t,0),i=this.br.firstAfterOrEqual(n);return w.resolve(t.isEqual(i&&i.key))}performConsistencyCheck(e){return w.resolve()}Fr(e,t){return this.vr(e)}vr(e){return 0===this.mutationQueue.length?0:e-this.mutationQueue[0].batchId}Dr(e){const t=this.vr(e);return t<0||t>=this.mutationQueue.length?null:this.mutationQueue[t]}}class V_{constructor(e){this.Mr=e,this.docs=new se(O.comparator),this.size=0}setIndexManager(e){this.indexManager=e}addEntry(e,t){const n=t.key,i=this.docs.get(n),s=i?i.size:0,a=this.Mr(t);return this.docs=this.docs.insert(n,{document:t.mutableCopy(),size:a}),this.size+=a-s,this.indexManager.addToCollectionParentIndex(e,n.path.popLast())}removeEntry(e){const t=this.docs.get(e);t&&(this.docs=this.docs.remove(e),this.size-=t.size)}getEntry(e,t){const n=this.docs.get(t);return w.resolve(n?n.document.mutableCopy():ae.newInvalidDocument(t))}getEntries(e,t){let n=qe();return t.forEach(i=>{const s=this.docs.get(i);n=n.insert(i,s?s.document.mutableCopy():ae.newInvalidDocument(i))}),w.resolve(n)}getDocumentsMatchingQuery(e,t,n,i){let s=qe();const a=t.path,u=new O(a.child("")),l=this.docs.getIteratorFrom(u);for(;l.hasNext();){const{key:h,value:{document:f}}=l.getNext();if(!a.isPrefixOf(h.path))break;h.path.length>a.length+1||Ms(Yu(f),n)<=0||(i.has(f.key)||gr(t,f))&&(s=s.insert(f.key,f.mutableCopy()))}return w.resolve(s)}getAllFromCollectionGroup(e,t,n,i){L()}Or(e,t){return w.forEach(this.docs,n=>t(n))}newChangeBuffer(e){return new S_(this)}getSize(e){return w.resolve(this.size)}}class S_ extends Hc{constructor(e){super(),this.cr=e}applyChanges(e){const t=[];return this.changes.forEach((n,i)=>{i.isValidDocument()?t.push(this.cr.addEntry(e,i)):this.cr.removeEntry(n)}),w.waitFor(t)}getFromCache(e,t){return this.cr.getEntry(e,t)}getAllFromCache(e,t){return this.cr.getEntries(e,t)}}class b_{constructor(e){this.persistence=e,this.Nr=new ot(t=>Kt(t),mr),this.lastRemoteSnapshotVersion=z.min(),this.highestTargetId=0,this.Lr=0,this.Br=new _o,this.targetCount=0,this.kr=Zt.Bn()}forEachTarget(e,t){return this.Nr.forEach((n,i)=>t(i)),w.resolve()}getLastRemoteSnapshotVersion(e){return w.resolve(this.lastRemoteSnapshotVersion)}getHighestSequenceNumber(e){return w.resolve(this.Lr)}allocateTargetId(e){return this.highestTargetId=this.kr.next(),w.resolve(this.highestTargetId)}setTargetsMetadata(e,t,n){return n&&(this.lastRemoteSnapshotVersion=n),t>this.Lr&&(this.Lr=t),w.resolve()}Kn(e){this.Nr.set(e.target,e);const t=e.targetId;t>this.highestTargetId&&(this.kr=new Zt(t),this.highestTargetId=t),e.sequenceNumber>this.Lr&&(this.Lr=e.sequenceNumber)}addTargetData(e,t){return this.Kn(t),this.targetCount+=1,w.resolve()}updateTargetData(e,t){return this.Kn(t),w.resolve()}removeTargetData(e,t){return this.Nr.delete(t.target),this.Br.gr(t.targetId),this.targetCount-=1,w.resolve()}removeTargets(e,t,n){let i=0;const s=[];return this.Nr.forEach((a,u)=>{u.sequenceNumber<=t&&null===n.get(u.targetId)&&(this.Nr.delete(a),s.push(this.removeMatchingKeysForTargetId(e,u.targetId)),i++)}),w.waitFor(s).next(()=>i)}getTargetCount(e){return w.resolve(this.targetCount)}getTargetData(e,t){const n=this.Nr.get(t)||null;return w.resolve(n)}addMatchingKeys(e,t,n){return this.Br.Rr(t,n),w.resolve()}removeMatchingKeys(e,t,n){this.Br.mr(t,n);const i=this.persistence.referenceDelegate,s=[];return i&&t.forEach(a=>{s.push(i.markPotentiallyOrphaned(e,a))}),w.waitFor(s)}removeMatchingKeysForTargetId(e,t){return this.Br.gr(t),w.resolve()}getMatchingKeysForTargetId(e,t){const n=this.Br.yr(t);return w.resolve(n)}containsKey(e,t){return w.resolve(this.Br.containsKey(t))}}class go{constructor(e,t){this.qr={},this.overlays={},this.Qr=new Ge(0),this.Kr=!1,this.Kr=!0,this.$r=new R_,this.referenceDelegate=e(this),this.Ur=new b_(this),this.indexManager=new m_,this.remoteDocumentCache=new V_(n=>this.referenceDelegate.Wr(n)),this.serializer=new Pc(t),this.Gr=new A_(this.serializer)}start(){return Promise.resolve()}shutdown(){return this.Kr=!1,Promise.resolve()}get started(){return this.Kr}setDatabaseDeletedListener(){}setNetworkEnabled(){}getIndexManager(e){return this.indexManager}getDocumentOverlayCache(e){let t=this.overlays[e.toKey()];return t||(t=new w_,this.overlays[e.toKey()]=t),t}getMutationQueue(e,t){let n=this.qr[e.toKey()];return n||(n=new P_(t,this.referenceDelegate),this.qr[e.toKey()]=n),n}getGlobalsCache(){return this.$r}getTargetCache(){return this.Ur}getRemoteDocumentCache(){return this.remoteDocumentCache}getBundleCache(){return this.Gr}runTransaction(e,t,n){N("MemoryPersistence","Starting transaction:",e);const i=new x_(this.Qr.next());return this.referenceDelegate.zr(),n(i).next(s=>this.referenceDelegate.jr(i).next(()=>s)).toPromise().then(s=>(i.raiseOnCommittedEvent(),s))}Hr(e,t){return w.or(Object.values(this.qr).map(n=>()=>n.containsKey(e,t)))}}class x_ extends Zu{constructor(e){super(),this.currentSequenceNumber=e}}class Bi{constructor(e){this.persistence=e,this.Jr=new _o,this.Yr=null}static Zr(e){return new Bi(e)}get Xr(){if(this.Yr)return this.Yr;throw L()}addReference(e,t,n){return this.Jr.addReference(n,t),this.Xr.delete(n.toString()),w.resolve()}removeReference(e,t,n){return this.Jr.removeReference(n,t),this.Xr.add(n.toString()),w.resolve()}markPotentiallyOrphaned(e,t){return this.Xr.add(t.toString()),w.resolve()}removeTarget(e,t){this.Jr.gr(t.targetId).forEach(i=>this.Xr.add(i.toString()));const n=this.persistence.getTargetCache();return n.getMatchingKeysForTargetId(e,t.targetId).next(i=>{i.forEach(s=>this.Xr.add(s.toString()))}).next(()=>n.removeTargetData(e,t))}zr(){this.Yr=new Set}jr(e){const t=this.persistence.getRemoteDocumentCache().newChangeBuffer();return w.forEach(this.Xr,n=>{const i=O.fromPath(n);return this.ei(e,i).next(s=>{s||t.removeEntry(i,z.min())})}).next(()=>(this.Yr=null,t.apply(e)))}updateLimboDocument(e,t){return this.ei(e,t).next(n=>{n?this.Xr.delete(t.toString()):this.Xr.add(t.toString())})}Wr(e){return 0}ei(e,t){return w.or([()=>w.resolve(this.Jr.containsKey(t)),()=>this.persistence.getTargetCache().containsKey(e,t),()=>this.persistence.Hr(e,t)])}}class Ui{constructor(e,t){this.persistence=e,this.ti=new ot(n=>Se(n.path),(n,i)=>n.isEqual(i)),this.garbageCollector=Qc(this,t)}static Zr(e,t){return new Ui(e,t)}zr(){}jr(e){return w.resolve()}forEachTarget(e,t){return this.persistence.getTargetCache().forEachTarget(e,t)}Yn(e){const t=this.er(e);return this.persistence.getTargetCache().getTargetCount(e).next(n=>t.next(i=>n+i))}er(e){let t=0;return this.Zn(e,n=>{t++}).next(()=>t)}Zn(e,t){return w.forEach(this.ti,(n,i)=>this.nr(e,n,i).next(s=>s?w.resolve():t(i)))}removeTargets(e,t,n){return this.persistence.getTargetCache().removeTargets(e,t,n)}removeOrphanedDocuments(e,t){let n=0;const i=this.persistence.getRemoteDocumentCache(),s=i.newChangeBuffer();return i.Or(e,a=>this.nr(e,a,t).next(u=>{u||(n++,s.removeEntry(a,z.min()))})).next(()=>s.apply(e)).next(()=>n)}markPotentiallyOrphaned(e,t){return this.ti.set(t,e.currentSequenceNumber),w.resolve()}removeTarget(e,t){const n=t.withSequenceNumber(e.currentSequenceNumber);return this.persistence.getTargetCache().updateTargetData(e,n)}addReference(e,t,n){return this.ti.set(n,e.currentSequenceNumber),w.resolve()}removeReference(e,t,n){return this.ti.set(n,e.currentSequenceNumber),w.resolve()}updateLimboDocument(e,t){return this.ti.set(t,e.currentSequenceNumber),w.resolve()}Wr(e){let t=e.key.toString().length;return e.isFoundDocument()&&(t+=Ti(e.data.value)),t}nr(e,t,n){return w.or([()=>this.persistence.Hr(e,t),()=>this.persistence.getTargetCache().containsKey(e,t),()=>{const i=this.ti.get(t);return w.resolve(void 0!==i&&i>n)}])}getCacheSize(e){return this.persistence.getRemoteDocumentCache().getSize(e)}}class C_{constructor(e){this.serializer=e}O(e,t,n,i){const s=new mi("createOrUpgrade",t);var l;n<1&&i>=1&&(e.createObjectStore("owner"),(l=e).createObjectStore("mutationQueues",{keyPath:"userId"}),l.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",il,{unique:!0}),l.createObjectStore("documentMutations"),th(e),function(l){l.createObjectStore("remoteDocuments")}(e));let a=w.resolve();return n<3&&i>=3&&(0!==n&&(function(l){l.deleteObjectStore("targetDocuments"),l.deleteObjectStore("targets"),l.deleteObjectStore("targetGlobal")}(e),th(e)),a=a.next(()=>function(l){const h=l.store("targetGlobal"),f={highestTargetId:0,highestListenSequenceNumber:0,lastRemoteSnapshotVersion:z.min().toTimestamp(),targetCount:0};return h.put("targetGlobalKey",f)}(s))),n<4&&i>=4&&(0!==n&&(a=a.next(()=>function(l,h){return h.store("mutations").U().next(f=>{l.deleteObjectStore("mutations"),l.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",il,{unique:!0});const _=h.store("mutations"),p=f.map(R=>_.put(R));return w.waitFor(p)})}(e,s))),a=a.next(()=>{!function(l){l.createObjectStore("clientMetadata",{keyPath:"clientId"})}(e)})),n<5&&i>=5&&(a=a.next(()=>this.ni(s))),n<6&&i>=6&&(a=a.next(()=>(function(l){l.createObjectStore("remoteDocumentGlobal")}(e),this.ri(s)))),n<7&&i>=7&&(a=a.next(()=>this.ii(s))),n<8&&i>=8&&(a=a.next(()=>this.si(e,s))),n<9&&i>=9&&(a=a.next(()=>{!function(l){l.objectStoreNames.contains("remoteDocumentChanges")&&l.deleteObjectStore("remoteDocumentChanges")}(e)})),n<10&&i>=10&&(a=a.next(()=>this.oi(s))),n<11&&i>=11&&(a=a.next(()=>{(function(l){l.createObjectStore("bundles",{keyPath:"bundleId"})})(e),function(l){l.createObjectStore("namedQueries",{keyPath:"name"})}(e)})),n<12&&i>=12&&(a=a.next(()=>{!function(l){const h=l.createObjectStore("documentOverlays",{keyPath:mm});h.createIndex("collectionPathOverlayIndex",_m,{unique:!1}),h.createIndex("collectionGroupOverlayIndex",gm,{unique:!1})}(e)})),n<13&&i>=13&&(a=a.next(()=>function(l){const h=l.createObjectStore("remoteDocumentsV14",{keyPath:rm});h.createIndex("documentKeyIndex",im),h.createIndex("collectionGroupIndex",sm)}(e)).next(()=>this._i(e,s)).next(()=>e.deleteObjectStore("remoteDocuments"))),n<14&&i>=14&&(a=a.next(()=>this.ai(e,s))),n<15&&i>=15&&(a=a.next(()=>function(l){l.createObjectStore("indexConfiguration",{keyPath:"indexId",autoIncrement:!0}).createIndex("collectionGroupIndex","collectionGroup",{unique:!1}),l.createObjectStore("indexState",{keyPath:cm}).createIndex("sequenceNumberIndex",hm,{unique:!1}),l.createObjectStore("indexEntries",{keyPath:dm}).createIndex("documentKeyIndex",fm,{unique:!1})}(e))),n<16&&i>=16&&(a=a.next(()=>{t.objectStore("indexState").clear()}).next(()=>{t.objectStore("indexEntries").clear()})),n<17&&i>=17&&(a=a.next(()=>{!function(l){l.createObjectStore("globals",{keyPath:"name"})}(e)})),a}ri(e){let t=0;return e.store("remoteDocuments").J((n,i)=>{t+=Mi(i)}).next(()=>{const n={byteSize:t};return e.store("remoteDocumentGlobal").put("remoteDocumentGlobalKey",n)})}ni(e){const t=e.store("mutationQueues"),n=e.store("mutations");return t.U().next(i=>w.forEach(i,s=>{const a=IDBKeyRange.bound([s.userId,-1],[s.userId,s.lastAcknowledgedBatchId]);return n.U("userMutationsIndex",a).next(u=>w.forEach(u,l=>{B(l.userId===s.userId);const h=Jt(this.serializer,l);return zc(e,s.userId,h).next(()=>{})}))}))}ii(e){const t=e.store("targetDocuments"),n=e.store("remoteDocuments");return e.store("targetGlobal").get("targetGlobalKey").next(i=>{const s=[];return n.J((a,u)=>{const l=new H(a),h=[0,Se(l)];s.push(t.get(h).next(f=>f?w.resolve():t.put({targetId:0,path:Se(l),sequenceNumber:i.highestListenSequenceNumber})))}).next(()=>w.waitFor(s))})}si(e,t){e.createObjectStore("collectionParents",{keyPath:lm});const n=t.store("collectionParents"),i=new mo,s=a=>{if(i.add(a)){const u=a.lastSegment(),l=a.popLast();return n.put({collectionId:u,parent:Se(l)})}};return t.store("remoteDocuments").J({H:!0},(a,u)=>{const l=new H(a);return s(l.popLast())}).next(()=>t.store("documentMutations").J({H:!0},([a,u,l],h)=>{const f=Je(u);return s(f.popLast())}))}oi(e){const t=e.store("targets");return t.J((n,i)=>{const s=Pr(i),a=Sc(this.serializer,s);return t.put(a)})}_i(e,t){const n=t.store("remoteDocuments"),i=[];return n.J((s,a)=>{const u=t.store("remoteDocumentsV14"),l=(_=a,_.document?new O(H.fromString(_.document.name).popFirst(5)):_.noDocument?O.fromSegments(_.noDocument.path):_.unknownDocument?O.fromSegments(_.unknownDocument.path):L()).path.toArray(),h={prefixPath:l.slice(0,l.length-2),collectionGroup:l[l.length-2],documentId:l[l.length-1],readTime:a.readTime||[0,0],unknownDocument:a.unknownDocument,noDocument:a.noDocument,document:a.document,hasCommittedMutations:!!a.hasCommittedMutations};var _;i.push(u.put(h))}).next(()=>w.waitFor(i))}ai(e,t){const n=t.store("mutations"),i=Jc(this.serializer),s=new go(Bi.Zr,this.serializer.ct);return n.U().next(a=>{const u=new Map;return a.forEach(l=>{var h;let f=null!==(h=u.get(l.userId))&&void 0!==h?h:j();Jt(this.serializer,l).keys().forEach(_=>f=f.add(_)),u.set(l.userId,f)}),w.forEach(u,(l,h)=>{const f=new Ee(h),_=Ni.lt(this.serializer,f),p=s.getIndexManager(f),R=Oi.lt(f,this.serializer,p,s.referenceDelegate);return new eh(i,R,_,p).recalculateAndSaveOverlaysForDocumentKeys(new Us(t,Ge.oe),l).next()})})}}function th(r){r.createObjectStore("targetDocuments",{keyPath:am}).createIndex("documentTargetsIndex",um,{unique:!0}),r.createObjectStore("targets",{keyPath:"targetId"}).createIndex("queryTargetsIndex",om,{unique:!0}),r.createObjectStore("targetGlobal")}const po="Failed to obtain exclusive access to the persistence layer. To allow shared access, multi-tab synchronization has to be enabled in all tabs. If you are using `experimentalForceOwningTab:true`, make sure that only one tab has persistence enabled at any given time.";class yo{constructor(e,t,n,i,s,a,u,l,h,f,_=17){if(this.allowTabSynchronization=e,this.persistenceKey=t,this.clientId=n,this.ui=s,this.window=a,this.document=u,this.ci=h,this.li=f,this.hi=_,this.Qr=null,this.Kr=!1,this.isPrimary=!1,this.networkEnabled=!0,this.Pi=null,this.inForeground=!1,this.Ii=null,this.Ti=null,this.Ei=Number.NEGATIVE_INFINITY,this.di=p=>Promise.resolve(),!yo.D())throw new C(V.UNIMPLEMENTED,"This platform is either missing IndexedDB or is known to have an incomplete implementation. Offline persistence has been disabled.");this.referenceDelegate=new I_(this,i),this.Ai=t+"main",this.serializer=new Pc(l),this.Ri=new He(this.Ai,this.hi,new C_(this.serializer)),this.$r=new u_,this.Ur=new g_(this.referenceDelegate,this.serializer),this.remoteDocumentCache=Jc(this.serializer),this.Gr=new a_,this.window&&this.window.localStorage?this.Vi=this.window.localStorage:(this.Vi=null,!1===f&&pe("IndexedDbPersistence","LocalStorage is unavailable. As a result, persistence may not work reliably. In particular enablePersistence() could fail immediately after refreshing the page."))}start(){return this.mi().then(()=>{if(!this.isPrimary&&!this.allowTabSynchronization)throw new C(V.FAILED_PRECONDITION,po);return this.fi(),this.gi(),this.pi(),this.runTransaction("getHighestListenSequenceNumber","readonly",e=>this.Ur.getHighestSequenceNumber(e))}).then(e=>{this.Qr=new Ge(e,this.ci)}).then(()=>{this.Kr=!0}).catch(e=>(this.Ri&&this.Ri.close(),Promise.reject(e)))}yi(e){var t=this;return this.di=function(){var n=(0,b.A)(function*(i){if(t.started)return e(i)});return function(i){return n.apply(this,arguments)}}(),e(this.isPrimary)}setDatabaseDeletedListener(e){this.Ri.L(function(){var t=(0,b.A)(function*(n){null===n.newVersion&&(yield e())});return function(n){return t.apply(this,arguments)}}())}setNetworkEnabled(e){var t=this;this.networkEnabled!==e&&(this.networkEnabled=e,this.ui.enqueueAndForget((0,b.A)(function*(){t.started&&(yield t.mi())})))}mi(){return this.runTransaction("updateClientMetadataAndTryBecomePrimary","readwrite",e=>qi(e).put({clientId:this.clientId,updateTimeMs:Date.now(),networkEnabled:this.networkEnabled,inForeground:this.inForeground}).next(()=>{if(this.isPrimary)return this.wi(e).next(t=>{t||(this.isPrimary=!1,this.ui.enqueueRetryable(()=>this.di(!1)))})}).next(()=>this.Si(e)).next(t=>this.isPrimary&&!t?this.bi(e).next(()=>!1):!!t&&this.Di(e).next(()=>!0))).catch(e=>{if(It(e))return N("IndexedDbPersistence","Failed to extend owner lease: ",e),this.isPrimary;if(!this.allowTabSynchronization)throw e;return N("IndexedDbPersistence","Releasing owner lease after error during lease refresh",e),!1}).then(e=>{this.isPrimary!==e&&this.ui.enqueueRetryable(()=>this.di(e)),this.isPrimary=e})}wi(e){return Cr(e).get("owner").next(t=>w.resolve(this.vi(t)))}Ci(e){return qi(e).delete(this.clientId)}Fi(){var e=this;return(0,b.A)(function*(){if(e.isPrimary&&!e.Mi(e.Ei,18e5)){e.Ei=Date.now();const t=yield e.runTransaction("maybeGarbageCollectMultiClientState","readwrite-primary",n=>{const i=Te(n,"clientMetadata");return i.U().next(s=>{const a=e.xi(s,18e5),u=s.filter(l=>-1===a.indexOf(l));return w.forEach(u,l=>i.delete(l.clientId)).next(()=>u)})}).catch(()=>[]);if(e.Vi)for(const n of t)e.Vi.removeItem(e.Oi(n.clientId))}})()}pi(){this.Ti=this.ui.enqueueAfterDelay("client_metadata_refresh",4e3,()=>this.mi().then(()=>this.Fi()).then(()=>this.pi()))}vi(e){return!!e&&e.ownerId===this.clientId}Si(e){return this.li?w.resolve(!0):Cr(e).get("owner").next(t=>{if(null!==t&&this.Mi(t.leaseTimestampMs,5e3)&&!this.Ni(t.ownerId)){if(this.vi(t)&&this.networkEnabled)return!0;if(!this.vi(t)){if(!t.allowTabSynchronization)throw new C(V.FAILED_PRECONDITION,po);return!1}}return!(!this.networkEnabled||!this.inForeground)||qi(e).U().next(n=>void 0===this.xi(n,5e3).find(i=>!(this.clientId===i.clientId||!(!this.networkEnabled&&i.networkEnabled||!this.inForeground&&i.inForeground&&this.networkEnabled===i.networkEnabled))))}).next(t=>(this.isPrimary!==t&&N("IndexedDbPersistence",`Client ${t?"is":"is not"} eligible for a primary lease.`),t))}shutdown(){var e=this;return(0,b.A)(function*(){e.Kr=!1,e.Li(),e.Ti&&(e.Ti.cancel(),e.Ti=null),e.Bi(),e.ki(),yield e.Ri.runTransaction("shutdown","readwrite",["owner","clientMetadata"],t=>{const n=new Us(t,Ge.oe);return e.bi(n).next(()=>e.Ci(n))}),e.Ri.close(),e.qi()})()}xi(e,t){return e.filter(n=>this.Mi(n.updateTimeMs,t)&&!this.Ni(n.clientId))}Qi(){return this.runTransaction("getActiveClients","readonly",e=>qi(e).U().next(t=>this.xi(t,18e5).map(n=>n.clientId)))}get started(){return this.Kr}getGlobalsCache(){return this.$r}getMutationQueue(e,t){return Oi.lt(e,this.serializer,t,this.referenceDelegate)}getTargetCache(){return this.Ur}getRemoteDocumentCache(){return this.remoteDocumentCache}getIndexManager(e){return new __(e,this.serializer.ct.databaseId)}getDocumentOverlayCache(e){return Ni.lt(this.serializer,e)}getBundleCache(){return this.Gr}runTransaction(e,t,n){N("IndexedDbPersistence","Starting transaction:",e);const i="readonly"===t?"readonly":"readwrite",s=17===(l=this.hi)?Im:16===l?ym:15===l?Bs:14===l?ul:13===l?al:12===l?pm:11===l?ol:void L();var l;let a;return this.Ri.runTransaction(e,i,s,u=>(a=new Us(u,this.Qr?this.Qr.next():Ge.oe),"readwrite-primary"===t?this.wi(a).next(l=>!!l||this.Si(a)).next(l=>{if(!l)throw pe(`Failed to obtain primary lease for action '${e}'.`),this.isPrimary=!1,this.ui.enqueueRetryable(()=>this.di(!1)),new C(V.FAILED_PRECONDITION,Xu);return n(a)}).next(l=>this.Di(a).next(()=>l)):this.Ki(a).next(()=>n(a)))).then(u=>(a.raiseOnCommittedEvent(),u))}Ki(e){return Cr(e).get("owner").next(t=>{if(null!==t&&this.Mi(t.leaseTimestampMs,5e3)&&!this.Ni(t.ownerId)&&!this.vi(t)&&!(this.li||this.allowTabSynchronization&&t.allowTabSynchronization))throw new C(V.FAILED_PRECONDITION,po)})}Di(e){const t={ownerId:this.clientId,allowTabSynchronization:this.allowTabSynchronization,leaseTimestampMs:Date.now()};return Cr(e).put("owner",t)}static D(){return He.D()}bi(e){const t=Cr(e);return t.get("owner").next(n=>this.vi(n)?(N("IndexedDbPersistence","Releasing primary lease."),t.delete("owner")):w.resolve())}Mi(e,t){const n=Date.now();return!(e<n-t||e>n&&(pe(`Detected an update time that is in the future: ${e} > ${n}`),1))}fi(){null!==this.document&&"function"==typeof this.document.addEventListener&&(this.Ii=()=>{this.ui.enqueueAndForget(()=>(this.inForeground="visible"===this.document.visibilityState,this.mi()))},this.document.addEventListener("visibilitychange",this.Ii),this.inForeground="visible"===this.document.visibilityState)}Bi(){this.Ii&&(this.document.removeEventListener("visibilitychange",this.Ii),this.Ii=null)}gi(){var e;"function"==typeof(null===(e=this.window)||void 0===e?void 0:e.addEventListener)&&(this.Pi=()=>{this.Li();const t=/(?:Version|Mobile)\/1[456]/;(0,ee.nr)()&&(navigator.appVersion.match(t)||navigator.userAgent.match(t))&&this.ui.enterRestrictedMode(!0),this.ui.enqueueAndForget(()=>this.shutdown())},this.window.addEventListener("pagehide",this.Pi))}ki(){this.Pi&&(this.window.removeEventListener("pagehide",this.Pi),this.Pi=null)}Ni(e){var t;try{const n=null!==(null===(t=this.Vi)||void 0===t?void 0:t.getItem(this.Oi(e)));return N("IndexedDbPersistence",`Client '${e}' ${n?"is":"is not"} zombied in LocalStorage`),n}catch(n){return pe("IndexedDbPersistence","Failed to get zombied client id.",n),!1}}Li(){if(this.Vi)try{this.Vi.setItem(this.Oi(this.clientId),String(Date.now()))}catch(e){pe("Failed to set zombie client id.",e)}}qi(){if(this.Vi)try{this.Vi.removeItem(this.Oi(this.clientId))}catch{}}Oi(e){return`firestore_zombie_${this.persistenceKey}_${e}`}}function Cr(r){return Te(r,"owner")}function qi(r){return Te(r,"clientMetadata")}function Io(r,e){let t=r.projectId;return r.isDefaultDatabase||(t+="."+r.database),"firestore/"+e+"/"+t+"/"}class To{constructor(e,t,n,i){this.targetId=e,this.fromCache=t,this.$i=n,this.Ui=i}static Wi(e,t){let n=j(),i=j();for(const s of t.docChanges)switch(s.type){case 0:n=n.add(s.doc.key);break;case 1:i=i.add(s.doc.key)}return new To(e,t.fromCache,n,i)}}class D_{constructor(){this._documentReadCount=0}get documentReadCount(){return this._documentReadCount}incrementDocumentReadCount(e){this._documentReadCount+=e}}class nh{constructor(){this.Gi=!1,this.zi=!1,this.ji=100,this.Hi=(0,ee.nr)()?8:el((0,ee.ZQ)())>0?6:4}initialize(e,t){this.Ji=e,this.indexManager=t,this.Gi=!0}getDocumentsMatchingQuery(e,t,n,i){const s={result:null};return this.Yi(e,t).next(a=>{s.result=a}).next(()=>{if(!s.result)return this.Zi(e,t,i,n).next(a=>{s.result=a})}).next(()=>{if(s.result)return;const a=new D_;return this.Xi(e,t,a).next(u=>{if(s.result=u,this.zi)return this.es(e,t,a,u.size)})}).next(()=>s.result)}es(e,t,n,i){return n.documentReadCount<this.ji?(gn()<=Qe.$b.DEBUG&&N("QueryEngine","SDK will not create cache indexes for query:",Rn(t),"since it only creates cache indexes for collection contains","more than or equal to",this.ji,"documents"),w.resolve()):(gn()<=Qe.$b.DEBUG&&N("QueryEngine","Query:",Rn(t),"scans",n.documentReadCount,"local documents and returns",i,"documents as results."),n.documentReadCount>this.Hi*i?(gn()<=Qe.$b.DEBUG&&N("QueryEngine","The SDK decides to create cache indexes for query:",Rn(t),"as using cache indexes may help improve performance."),this.indexManager.createTargetIndexes(e,be(t))):w.resolve())}Yi(e,t){if(Fl(t))return w.resolve(null);let n=be(t);return this.indexManager.getIndexType(e,n).next(i=>0===i?null:(null!==t.limit&&1===i&&(t=Ri(t,null,"F"),n=be(t)),this.indexManager.getDocumentsMatchingTarget(e,n).next(s=>{const a=j(...s);return this.Ji.getDocuments(e,a).next(u=>this.indexManager.getMinOffset(e,n).next(l=>{const h=this.ts(t,u);return this.ns(t,h,a,l.readTime)?this.Yi(e,Ri(t,null,"F")):this.rs(e,h,t,l)}))})))}Zi(e,t,n,i){return Fl(t)||i.isEqual(z.min())?w.resolve(null):this.Ji.getDocuments(e,n).next(s=>{const a=this.ts(t,s);return this.ns(t,a,n,i)?w.resolve(null):(gn()<=Qe.$b.DEBUG&&N("QueryEngine","Re-using previous result from %s to execute query: %s",i.toString(),Rn(t)),this.rs(e,a,t,Ju(i,-1)).next(u=>u))})}ts(e,t){let n=new ne(Ul(e));return t.forEach((i,s)=>{gr(e,s)&&(n=n.add(s))}),n}ns(e,t,n,i){if(null===e.limit)return!1;if(n.size!==t.size)return!0;const s="F"===e.limitType?t.last():t.first();return!!s&&(s.hasPendingWrites||s.version.compareTo(i)>0)}Xi(e,t,n){return gn()<=Qe.$b.DEBUG&&N("QueryEngine","Using full collection scan to execute query:",Rn(t)),this.Ji.getDocumentsMatchingQuery(e,t,$e.min(),n)}rs(e,t,n,i){return this.Ji.getDocumentsMatchingQuery(e,n,i).next(s=>(t.forEach(a=>{s=s.insert(a.key,a)}),s))}}class N_{constructor(e,t,n,i){this.persistence=e,this.ss=t,this.serializer=i,this.os=new se(G),this._s=new ot(s=>Kt(s),mr),this.us=new Map,this.cs=e.getRemoteDocumentCache(),this.Ur=e.getTargetCache(),this.Gr=e.getBundleCache(),this.ls(n)}ls(e){this.documentOverlayCache=this.persistence.getDocumentOverlayCache(e),this.indexManager=this.persistence.getIndexManager(e),this.mutationQueue=this.persistence.getMutationQueue(e,this.indexManager),this.localDocuments=new eh(this.cs,this.mutationQueue,this.documentOverlayCache,this.indexManager),this.cs.setIndexManager(this.indexManager),this.ss.initialize(this.localDocuments,this.indexManager)}collectGarbage(e){return this.persistence.runTransaction("Collect garbage","readwrite-primary",t=>e.collect(t,this.os))}}function rh(r,e,t,n){return new N_(r,e,t,n)}function ih(r,e){return Eo.apply(this,arguments)}function Eo(){return(Eo=(0,b.A)(function*(r,e){const t=F(r);return yield t.persistence.runTransaction("Handle user change","readonly",n=>{let i;return t.mutationQueue.getAllMutationBatches(n).next(s=>(i=s,t.ls(e),t.mutationQueue.getAllMutationBatches(n))).next(s=>{const a=[],u=[];let l=j();for(const h of i){a.push(h.batchId);for(const f of h.mutations)l=l.add(f.key)}for(const h of s){u.push(h.batchId);for(const f of h.mutations)l=l.add(f.key)}return t.localDocuments.getDocuments(n,l).next(h=>({hs:h,removedBatchIds:a,addedBatchIds:u}))})})})).apply(this,arguments)}function sh(r){const e=F(r);return e.persistence.runTransaction("Get last remote snapshot version","readonly",t=>e.Ur.getLastRemoteSnapshotVersion(t))}function oh(r,e,t){let n=j(),i=j();return t.forEach(s=>n=n.add(s)),e.getEntries(r,n).next(s=>{let a=qe();return t.forEach((u,l)=>{const h=s.get(u);l.isFoundDocument()!==h.isFoundDocument()&&(i=i.add(u)),l.isNoDocument()&&l.version.isEqual(z.min())?(e.removeEntry(u,l.readTime),a=a.insert(u,l)):!h.isValidDocument()||l.version.compareTo(h.version)>0||0===l.version.compareTo(h.version)&&h.hasPendingWrites?(e.addEntry(l),a=a.insert(u,l)):N("LocalStore","Ignoring outdated watch update for ",u,". Current version:",h.version," Watch version:",l.version)}),{Ps:a,Is:i}})}function M_(r,e){const t=F(r);return t.persistence.runTransaction("Get next mutation batch","readonly",n=>(void 0===e&&(e=-1),t.mutationQueue.getNextMutationBatchAfterBatchId(n,e)))}function Mn(r,e){const t=F(r);return t.persistence.runTransaction("Allocate target","readwrite",n=>{let i;return t.Ur.getTargetData(n,e).next(s=>s?(i=s,w.resolve(i)):t.Ur.allocateTargetId(n).next(a=>(i=new ut(e,a,"TargetPurposeListen",n.currentSequenceNumber),t.Ur.addTargetData(n,i).next(()=>i))))}).then(n=>{const i=t.os.get(n.targetId);return(null===i||n.snapshotVersion.compareTo(i.snapshotVersion)>0)&&(t.os=t.os.insert(n.targetId,n),t._s.set(e,n.targetId)),n})}function On(r,e,t){return vo.apply(this,arguments)}function vo(){return(vo=(0,b.A)(function*(r,e,t){const n=F(r),i=n.os.get(e),s=t?"readwrite":"readwrite-primary";try{t||(yield n.persistence.runTransaction("Release target",s,a=>n.persistence.referenceDelegate.removeTarget(a,i)))}catch(a){if(!It(a))throw a;N("LocalStore",`Failed to update sequence numbers for target ${e}: ${a}`)}n.os=n.os.remove(e),n._s.delete(i.target)})).apply(this,arguments)}function zi(r,e,t){const n=F(r);let i=z.min(),s=j();return n.persistence.runTransaction("Execute query","readwrite",a=>function(l,h,f){const _=F(l),p=_._s.get(f);return void 0!==p?w.resolve(_.os.get(p)):_.Ur.getTargetData(h,f)}(n,a,be(e)).next(u=>{if(u)return i=u.lastLimboFreeSnapshotVersion,n.Ur.getMatchingKeysForTargetId(a,u.targetId).next(l=>{s=l})}).next(()=>n.ss.getDocumentsMatchingQuery(a,e,t?i:z.min(),t?s:j())).next(u=>(lh(n,Bl(e),u),{documents:u,Ts:s})))}function ah(r,e){const t=F(r),n=F(t.Ur),i=t.os.get(e);return i?Promise.resolve(i.target):t.persistence.runTransaction("Get target data","readonly",s=>n.ot(s,e).next(a=>a?a.target:null))}function uh(r,e){const t=F(r),n=t.us.get(e)||z.min();return t.persistence.runTransaction("Get new document changes","readonly",i=>t.cs.getAllFromCollectionGroup(i,e,Ju(n,-1),Number.MAX_SAFE_INTEGER)).then(i=>(lh(t,e,i),i))}function lh(r,e,t){let n=r.us.get(e)||z.min();t.forEach((i,s)=>{s.readTime.compareTo(n)>0&&(n=s.readTime)}),r.us.set(e,n)}function Ao(){return(Ao=(0,b.A)(function*(r,e,t,n){const i=F(r);let s=j(),a=qe();for(const h of t){const f=e.Es(h.metadata.name);h.document&&(s=s.add(f));const _=e.ds(h);_.setReadTime(e.As(h.metadata.readTime)),a=a.insert(f,_)}const u=i.cs.newChangeBuffer({trackRemovals:!0}),l=yield Mn(i,(f=n,be(An(H.fromString(`__bundle__/docs/${f}`)))));var f;return i.persistence.runTransaction("Apply bundle documents","readwrite",h=>oh(h,u,a).next(f=>(u.apply(h),f)).next(f=>i.Ur.removeMatchingKeysForTargetId(h,l.targetId).next(()=>i.Ur.addMatchingKeys(h,s,l.targetId)).next(()=>i.localDocuments.getLocalViewOfDocuments(h,f.Ps,f.Is)).next(()=>f.Ps)))})).apply(this,arguments)}function L_(r,e){return wo.apply(this,arguments)}function wo(){return(wo=(0,b.A)(function*(r,e,t=j()){const n=yield Mn(r,be(ao(e.bundledQuery))),i=F(r);return i.persistence.runTransaction("Save named query","readwrite",s=>{const a=ye(e.readTime);if(n.snapshotVersion.compareTo(a)>=0)return i.Gr.saveNamedQuery(s,e);const u=n.withResumeToken(me.EMPTY_BYTE_STRING,a);return i.os=i.os.insert(u.targetId,u),i.Ur.updateTargetData(s,u).next(()=>i.Ur.removeMatchingKeysForTargetId(s,n.targetId)).next(()=>i.Ur.addMatchingKeys(s,t,n.targetId)).next(()=>i.Gr.saveNamedQuery(s,e))})})).apply(this,arguments)}function ch(r,e){return`firestore_clients_${r}_${e}`}function hh(r,e,t){let n=`firestore_mutations_${r}_${t}`;return e.isAuthenticated()&&(n+=`_${e.uid}`),n}function Ro(r,e){return`firestore_targets_${r}_${e}`}class $i{constructor(e,t,n,i){this.user=e,this.batchId=t,this.state=n,this.error=i}static Rs(e,t,n){const i=JSON.parse(n);let s,a="object"==typeof i&&-1!==["pending","acknowledged","rejected"].indexOf(i.state)&&(void 0===i.error||"object"==typeof i.error);return a&&i.error&&(a="string"==typeof i.error.message&&"string"==typeof i.error.code,a&&(s=new C(i.error.code,i.error.message))),a?new $i(e,t,i.state,s):(pe("SharedClientState",`Failed to parse mutation state for ID '${t}': ${n}`),null)}Vs(){const e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}}class Dr{constructor(e,t,n){this.targetId=e,this.state=t,this.error=n}static Rs(e,t){const n=JSON.parse(t);let i,s="object"==typeof n&&-1!==["not-current","current","rejected"].indexOf(n.state)&&(void 0===n.error||"object"==typeof n.error);return s&&n.error&&(s="string"==typeof n.error.message&&"string"==typeof n.error.code,s&&(i=new C(n.error.code,n.error.message))),s?new Dr(e,n.state,i):(pe("SharedClientState",`Failed to parse target state for ID '${e}': ${t}`),null)}Vs(){const e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}}class Gi{constructor(e,t){this.clientId=e,this.activeTargetIds=t}static Rs(e,t){const n=JSON.parse(t);let i="object"==typeof n&&n.activeTargetIds instanceof Array,s=Hs();for(let a=0;i&&a<n.activeTargetIds.length;++a)i=nl(n.activeTargetIds[a]),s=s.add(n.activeTargetIds[a]);return i?new Gi(e,s):(pe("SharedClientState",`Failed to parse client data for instance '${e}': ${t}`),null)}}class Po{constructor(e,t){this.clientId=e,this.onlineState=t}static Rs(e){const t=JSON.parse(e);return"object"==typeof t&&-1!==["Unknown","Online","Offline"].indexOf(t.onlineState)&&"string"==typeof t.clientId?new Po(t.clientId,t.onlineState):(pe("SharedClientState",`Failed to parse online state: ${e}`),null)}}class Vo{constructor(){this.activeTargetIds=Hs()}fs(e){this.activeTargetIds=this.activeTargetIds.add(e)}gs(e){this.activeTargetIds=this.activeTargetIds.delete(e)}Vs(){const e={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(e)}}class So{constructor(e,t,n,i,s){this.window=e,this.ui=t,this.persistenceKey=n,this.ps=i,this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null,this.ys=this.ws.bind(this),this.Ss=new se(G),this.started=!1,this.bs=[];const a=n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");this.storage=this.window.localStorage,this.currentUser=s,this.Ds=ch(this.persistenceKey,this.ps),this.vs=`firestore_sequence_number_${this.persistenceKey}`,this.Ss=this.Ss.insert(this.ps,new Vo),this.Cs=new RegExp(`^firestore_clients_${a}_([^_]*)$`),this.Fs=new RegExp(`^firestore_mutations_${a}_(\\d+)(?:_(.*))?$`),this.Ms=new RegExp(`^firestore_targets_${a}_(\\d+)$`),this.xs=`firestore_online_state_${this.persistenceKey}`,this.Os=function(l){return`firestore_bundle_loaded_v2_${l}`}(this.persistenceKey),this.window.addEventListener("storage",this.ys)}static D(e){return!(!e||!e.localStorage)}start(){var e=this;return(0,b.A)(function*(){const t=yield e.syncEngine.Qi();for(const i of t){if(i===e.ps)continue;const s=e.getItem(ch(e.persistenceKey,i));if(s){const a=Gi.Rs(i,s);a&&(e.Ss=e.Ss.insert(a.clientId,a))}}e.Ns();const n=e.storage.getItem(e.xs);if(n){const i=e.Ls(n);i&&e.Bs(i)}for(const i of e.bs)e.ws(i);e.bs=[],e.window.addEventListener("pagehide",()=>e.shutdown()),e.started=!0})()}writeSequenceNumber(e){this.setItem(this.vs,JSON.stringify(e))}getAllActiveQueryTargets(){return this.ks(this.Ss)}isActiveQueryTarget(e){let t=!1;return this.Ss.forEach((n,i)=>{i.activeTargetIds.has(e)&&(t=!0)}),t}addPendingMutation(e){this.qs(e,"pending")}updateMutationState(e,t,n){this.qs(e,t,n),this.Qs(e)}addLocalQueryTarget(e,t=!0){let n="not-current";if(this.isActiveQueryTarget(e)){const i=this.storage.getItem(Ro(this.persistenceKey,e));if(i){const s=Dr.Rs(e,i);s&&(n=s.state)}}return t&&this.Ks.fs(e),this.Ns(),n}removeLocalQueryTarget(e){this.Ks.gs(e),this.Ns()}isLocalQueryTarget(e){return this.Ks.activeTargetIds.has(e)}clearQueryState(e){this.removeItem(Ro(this.persistenceKey,e))}updateQueryState(e,t,n){this.$s(e,t,n)}handleUserChange(e,t,n){t.forEach(i=>{this.Qs(i)}),this.currentUser=e,n.forEach(i=>{this.addPendingMutation(i)})}setOnlineState(e){this.Us(e)}notifyBundleLoaded(e){this.Ws(e)}shutdown(){this.started&&(this.window.removeEventListener("storage",this.ys),this.removeItem(this.Ds),this.started=!1)}getItem(e){const t=this.storage.getItem(e);return N("SharedClientState","READ",e,t),t}setItem(e,t){N("SharedClientState","SET",e,t),this.storage.setItem(e,t)}removeItem(e){N("SharedClientState","REMOVE",e),this.storage.removeItem(e)}ws(e){var t=this;const n=e;if(n.storageArea===this.storage){if(N("SharedClientState","EVENT",n.key,n.newValue),n.key===this.Ds)return void pe("Received WebStorage notification for local change. Another client might have garbage-collected our state");this.ui.enqueueRetryable((0,b.A)(function*(){if(t.started){if(null!==n.key)if(t.Cs.test(n.key)){if(null==n.newValue){const i=t.Gs(n.key);return t.zs(i,null)}{const i=t.js(n.key,n.newValue);if(i)return t.zs(i.clientId,i)}}else if(t.Fs.test(n.key)){if(null!==n.newValue){const i=t.Hs(n.key,n.newValue);if(i)return t.Js(i)}}else if(t.Ms.test(n.key)){if(null!==n.newValue){const i=t.Ys(n.key,n.newValue);if(i)return t.Zs(i)}}else if(n.key===t.xs){if(null!==n.newValue){const i=t.Ls(n.newValue);if(i)return t.Bs(i)}}else if(n.key===t.vs){const i=function(a){let u=Ge.oe;if(null!=a)try{const l=JSON.parse(a);B("number"==typeof l),u=l}catch(l){pe("SharedClientState","Failed to read sequence number from WebStorage",l)}return u}(n.newValue);i!==Ge.oe&&t.sequenceNumberHandler(i)}else if(n.key===t.Os){const i=t.Xs(n.newValue);yield Promise.all(i.map(s=>t.syncEngine.eo(s)))}}else t.bs.push(n)}))}}get Ks(){return this.Ss.get(this.ps)}Ns(){this.setItem(this.Ds,this.Ks.Vs())}qs(e,t,n){const i=new $i(this.currentUser,e,t,n),s=hh(this.persistenceKey,this.currentUser,e);this.setItem(s,i.Vs())}Qs(e){const t=hh(this.persistenceKey,this.currentUser,e);this.removeItem(t)}Us(e){this.storage.setItem(this.xs,JSON.stringify({clientId:this.ps,onlineState:e}))}$s(e,t,n){const i=Ro(this.persistenceKey,e),s=new Dr(e,t,n);this.setItem(i,s.Vs())}Ws(e){const t=JSON.stringify(Array.from(e));this.setItem(this.Os,t)}Gs(e){const t=this.Cs.exec(e);return t?t[1]:null}js(e,t){const n=this.Gs(e);return Gi.Rs(n,t)}Hs(e,t){const n=this.Fs.exec(e),i=Number(n[1]);return $i.Rs(new Ee(void 0!==n[2]?n[2]:null),i,t)}Ys(e,t){const n=this.Ms.exec(e),i=Number(n[1]);return Dr.Rs(i,t)}Ls(e){return Po.Rs(e)}Xs(e){return JSON.parse(e)}Js(e){var t=this;return(0,b.A)(function*(){if(e.user.uid===t.currentUser.uid)return t.syncEngine.no(e.batchId,e.state,e.error);N("SharedClientState",`Ignoring mutation for non-active user ${e.user.uid}`)})()}Zs(e){return this.syncEngine.ro(e.targetId,e.state,e.error)}zs(e,t){const n=t?this.Ss.insert(e,t):this.Ss.remove(e),i=this.ks(this.Ss),s=this.ks(n),a=[],u=[];return s.forEach(l=>{i.has(l)||a.push(l)}),i.forEach(l=>{s.has(l)||u.push(l)}),this.syncEngine.io(a,u).then(()=>{this.Ss=n})}Bs(e){this.Ss.get(e.clientId)&&this.onlineStateHandler(e.onlineState)}ks(e){let t=Hs();return e.forEach((n,i)=>{t=t.unionWith(i.activeTargetIds)}),t}}class dh{constructor(){this.so=new Vo,this.oo={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}addPendingMutation(e){}updateMutationState(e,t,n){}addLocalQueryTarget(e,t=!0){return t&&this.so.fs(e),this.oo[e]||"not-current"}updateQueryState(e,t,n){this.oo[e]=t}removeLocalQueryTarget(e){this.so.gs(e)}isLocalQueryTarget(e){return this.so.activeTargetIds.has(e)}clearQueryState(e){delete this.oo[e]}getAllActiveQueryTargets(){return this.so.activeTargetIds}isActiveQueryTarget(e){return this.so.activeTargetIds.has(e)}start(){return this.so=new Vo,Promise.resolve()}handleUserChange(e,t,n){}setOnlineState(e){}shutdown(){}writeSequenceNumber(e){}notifyBundleLoaded(e){}}class B_{_o(e){}shutdown(){}}class fh{constructor(){this.ao=()=>this.uo(),this.co=()=>this.lo(),this.ho=[],this.Po()}_o(e){this.ho.push(e)}shutdown(){window.removeEventListener("online",this.ao),window.removeEventListener("offline",this.co)}Po(){window.addEventListener("online",this.ao),window.addEventListener("offline",this.co)}uo(){N("ConnectivityMonitor","Network connectivity changed: AVAILABLE");for(const e of this.ho)e(0)}lo(){N("ConnectivityMonitor","Network connectivity changed: UNAVAILABLE");for(const e of this.ho)e(1)}static D(){return typeof window<"u"&&void 0!==window.addEventListener&&void 0!==window.removeEventListener}}let Ki=null;function bo(){return null===Ki?Ki=268435456+Math.round(2147483648*Math.random()):Ki++,"0x"+Ki.toString(16)}const U_={BatchGetDocuments:"batchGet",Commit:"commit",RunQuery:"runQuery",RunAggregationQuery:"runAggregationQuery"};class q_{constructor(e){this.Io=e.Io,this.To=e.To}Eo(e){this.Ao=e}Ro(e){this.Vo=e}mo(e){this.fo=e}onMessage(e){this.po=e}close(){this.To()}send(e){this.Io(e)}yo(){this.Ao()}wo(){this.Vo()}So(e){this.fo(e)}bo(e){this.po(e)}}const Ce="WebChannelConnection";class z_ extends class{constructor(t){this.databaseInfo=t,this.databaseId=t.databaseId;const n=t.ssl?"https":"http",i=encodeURIComponent(this.databaseId.projectId),s=encodeURIComponent(this.databaseId.database);this.Do=n+"://"+t.host,this.vo=`projects/${i}/databases/${s}`,this.Co="(default)"===this.databaseId.database?`project_id=${i}`:`project_id=${i}&database_id=${s}`}get Fo(){return!1}Mo(t,n,i,s,a){const u=bo(),l=this.xo(t,n.toUriEncodedString());N("RestConnection",`Sending RPC '${t}' ${u}:`,l,i);const h={"google-cloud-resource-prefix":this.vo,"x-goog-request-params":this.Co};return this.Oo(h,s,a),this.No(t,l,h,i).then(f=>(N("RestConnection",`Received RPC '${t}' ${u}: `,f),f),f=>{throw ze("RestConnection",`RPC '${t}' ${u} failed with error: `,f,"url: ",l,"request:",i),f})}Lo(t,n,i,s,a,u){return this.Mo(t,n,i,s,a)}Oo(t,n,i){t["X-Goog-Api-Client"]="gl-js/ fire/"+_n,t["Content-Type"]="text/plain",this.databaseInfo.appId&&(t["X-Firebase-GMPID"]=this.databaseInfo.appId),n&&n.headers.forEach((s,a)=>t[a]=s),i&&i.headers.forEach((s,a)=>t[a]=s)}xo(t,n){return`${this.Do}/v1/${n}:${U_[t]}`}terminate(){}}{constructor(e){super(e),this.forceLongPolling=e.forceLongPolling,this.autoDetectLongPolling=e.autoDetectLongPolling,this.useFetchStreams=e.useFetchStreams,this.longPollingOptions=e.longPollingOptions}No(e,t,n,i){const s=bo();return new Promise((a,u)=>{const l=new Uu;l.setWithCredentials(!0),l.listenOnce(qu.COMPLETE,()=>{try{switch(l.getLastErrorCode()){case fi.NO_ERROR:const f=l.getResponseJson();N(Ce,`XHR for RPC '${e}' ${s} received:`,JSON.stringify(f)),a(f);break;case fi.TIMEOUT:N(Ce,`RPC '${e}' ${s} timed out`),u(new C(V.DEADLINE_EXCEEDED,"Request time out"));break;case fi.HTTP_ERROR:const _=l.getStatus();if(N(Ce,`RPC '${e}' ${s} failed with status:`,_,"response text:",l.getResponseText()),_>0){let p=l.getResponseJson();Array.isArray(p)&&(p=p[0]);const R=null==p?void 0:p.error;if(R&&R.status&&R.message){const x=function(D){const U=D.toLowerCase().replace(/_/g,"-");return Object.values(V).indexOf(U)>=0?U:V.UNKNOWN}(R.status);u(new C(x,R.message))}else u(new C(V.UNKNOWN,"Server responded with status "+l.getStatus()))}else u(new C(V.UNAVAILABLE,"Connection failed."));break;default:L()}}finally{N(Ce,`RPC '${e}' ${s} completed.`)}});const h=JSON.stringify(i);N(Ce,`RPC '${e}' ${s} sending request:`,i),l.send(t,"POST",h,n,15)})}Bo(e,t,n){const i=bo(),s=[this.Do,"/","google.firestore.v1.Firestore","/",e,"/channel"],a=Gu(),u=$u(),l={httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:`projects/${this.databaseId.projectId}/databases/${this.databaseId.database}`},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling,detectBufferingProxy:this.autoDetectLongPolling},h=this.longPollingOptions.timeoutSeconds;void 0!==h&&(l.longPollingTimeout=Math.round(1e3*h)),this.useFetchStreams&&(l.useFetchStreams=!0),this.Oo(l.initMessageHeaders,t,n),l.encodeInitMessageHeaders=!0;const f=s.join("");N(Ce,`Creating RPC '${e}' stream ${i}: ${f}`,l);const _=a.createWebChannel(f,l);let p=!1,R=!1;const x=new q_({Io:D=>{R?N(Ce,`Not sending because RPC '${e}' stream ${i} is closed:`,D):(p||(N(Ce,`Opening RPC '${e}' stream ${i} transport.`),_.open(),p=!0),N(Ce,`RPC '${e}' stream ${i} sending:`,D),_.send(D))},To:()=>_.close()}),k=(D,U,$)=>{D.listen(U,q=>{try{$(q)}catch(K){setTimeout(()=>{throw K},0)}})};return k(_,ir.EventType.OPEN,()=>{R||(N(Ce,`RPC '${e}' stream ${i} transport opened.`),x.yo())}),k(_,ir.EventType.CLOSE,()=>{R||(R=!0,N(Ce,`RPC '${e}' stream ${i} transport closed`),x.So())}),k(_,ir.EventType.ERROR,D=>{R||(R=!0,ze(Ce,`RPC '${e}' stream ${i} transport errored:`,D),x.So(new C(V.UNAVAILABLE,"The operation could not be completed")))}),k(_,ir.EventType.MESSAGE,D=>{var U;if(!R){const $=D.data[0];B(!!$);const K=$.error||(null===(U=$[0])||void 0===U?void 0:U.error);if(K){N(Ce,`RPC '${e}' stream ${i} received error:`,K);const X=K.status;let W=function(I){const E=Ie[I];if(void 0!==E)return ic(E)}(X),T=K.message;void 0===W&&(W=V.INTERNAL,T="Unknown error status: "+X+" with message "+K.message),R=!0,x.So(new C(W,T)),_.close()}else N(Ce,`RPC '${e}' stream ${i} received:`,$),x.bo($)}}),k(u,zu.STAT_EVENT,D=>{D.stat===Ns.PROXY?N(Ce,`RPC '${e}' stream ${i} detected buffering proxy`):D.stat===Ns.NOPROXY&&N(Ce,`RPC '${e}' stream ${i} detected no buffering proxy`)}),setTimeout(()=>{x.wo()},0),x}}function mh(){return typeof window<"u"?window:null}function ji(){return typeof document<"u"?document:null}function Nr(r){return new Jm(r,!0)}class xo{constructor(e,t,n=1e3,i=1.5,s=6e4){this.ui=e,this.timerId=t,this.ko=n,this.qo=i,this.Qo=s,this.Ko=0,this.$o=null,this.Uo=Date.now(),this.reset()}reset(){this.Ko=0}Wo(){this.Ko=this.Qo}Go(e){this.cancel();const t=Math.floor(this.Ko+this.zo()),n=Math.max(0,Date.now()-this.Uo),i=Math.max(0,t-n);i>0&&N("ExponentialBackoff",`Backing off for ${i} ms (base delay: ${this.Ko} ms, delay with jitter: ${t} ms, last attempt: ${n} ms ago)`),this.$o=this.ui.enqueueAfterDelay(this.timerId,i,()=>(this.Uo=Date.now(),e())),this.Ko*=this.qo,this.Ko<this.ko&&(this.Ko=this.ko),this.Ko>this.Qo&&(this.Ko=this.Qo)}jo(){null!==this.$o&&(this.$o.skipDelay(),this.$o=null)}cancel(){null!==this.$o&&(this.$o.cancel(),this.$o=null)}zo(){return(Math.random()-.5)*this.Ko}}class _h{constructor(e,t,n,i,s,a,u,l){this.ui=e,this.Ho=n,this.Jo=i,this.connection=s,this.authCredentialsProvider=a,this.appCheckCredentialsProvider=u,this.listener=l,this.state=0,this.Yo=0,this.Zo=null,this.Xo=null,this.stream=null,this.e_=0,this.t_=new xo(e,t)}n_(){return 1===this.state||5===this.state||this.r_()}r_(){return 2===this.state||3===this.state}start(){this.e_=0,4!==this.state?this.auth():this.i_()}stop(){var e=this;return(0,b.A)(function*(){e.n_()&&(yield e.close(0))})()}s_(){this.state=0,this.t_.reset()}o_(){this.r_()&&null===this.Zo&&(this.Zo=this.ui.enqueueAfterDelay(this.Ho,6e4,()=>this.__()))}a_(e){this.u_(),this.stream.send(e)}__(){var e=this;return(0,b.A)(function*(){if(e.r_())return e.close(0)})()}u_(){this.Zo&&(this.Zo.cancel(),this.Zo=null)}c_(){this.Xo&&(this.Xo.cancel(),this.Xo=null)}close(e,t){var n=this;return(0,b.A)(function*(){n.u_(),n.c_(),n.t_.cancel(),n.Yo++,4!==e?n.t_.reset():t&&t.code===V.RESOURCE_EXHAUSTED?(pe(t.toString()),pe("Using maximum backoff delay to prevent overloading the backend."),n.t_.Wo()):t&&t.code===V.UNAUTHENTICATED&&3!==n.state&&(n.authCredentialsProvider.invalidateToken(),n.appCheckCredentialsProvider.invalidateToken()),null!==n.stream&&(n.l_(),n.stream.close(),n.stream=null),n.state=e,yield n.listener.mo(t)})()}l_(){}auth(){this.state=1;const e=this.h_(this.Yo),t=this.Yo;Promise.all([this.authCredentialsProvider.getToken(),this.appCheckCredentialsProvider.getToken()]).then(([n,i])=>{this.Yo===t&&this.P_(n,i)},n=>{e(()=>{const i=new C(V.UNKNOWN,"Fetching auth token failed: "+n.message);return this.I_(i)})})}P_(e,t){const n=this.h_(this.Yo);this.stream=this.T_(e,t),this.stream.Eo(()=>{n(()=>this.listener.Eo())}),this.stream.Ro(()=>{n(()=>(this.state=2,this.Xo=this.ui.enqueueAfterDelay(this.Jo,1e4,()=>(this.r_()&&(this.state=3),Promise.resolve())),this.listener.Ro()))}),this.stream.mo(i=>{n(()=>this.I_(i))}),this.stream.onMessage(i=>{n(()=>1==++this.e_?this.E_(i):this.onNext(i))})}i_(){var e=this;this.state=5,this.t_.Go((0,b.A)(function*(){e.state=0,e.start()}))}I_(e){return N("PersistentStream",`close with error: ${e}`),this.stream=null,this.close(4,e)}h_(e){return t=>{this.ui.enqueueAndForget(()=>this.Yo===e?t():(N("PersistentStream","stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve()))}}}class $_ extends _h{constructor(e,t,n,i,s,a){super(e,"listen_stream_connection_backoff","listen_stream_idle","health_check_timeout",t,n,i,a),this.serializer=s}T_(e,t){return this.connection.Bo("Listen",e,t)}E_(e){return this.onNext(e)}onNext(e){this.t_.reset();const t=function Zm(r,e){let t;if("targetChange"in e){const n="NO_CHANGE"===(h=e.targetChange.targetChangeType||"NO_CHANGE")?0:"ADD"===h?1:"REMOVE"===h?2:"CURRENT"===h?3:"RESET"===h?4:L(),i=e.targetChange.targetIds||[],s=function(h,f){return h.useProto3Json?(B(void 0===f||"string"==typeof f),me.fromBase64String(f||"")):(B(void 0===f||f instanceof Buffer||f instanceof Uint8Array),me.fromUint8Array(f||new Uint8Array))}(r,e.targetChange.resumeToken),a=e.targetChange.cause,u=a&&function(h){const f=void 0===h.code?V.UNKNOWN:ic(h.code);return new C(f,h.message||"")}(a);t=new lc(n,i,s,u||null)}else if("documentChange"in e){const n=e.documentChange,i=Ze(r,n.document.name),s=ye(n.document.updateTime),a=n.document.createTime?ye(n.document.createTime):z.min(),u=new Re({mapValue:{fields:n.document.fields}}),l=ae.newFoundDocument(i,s,a,u);t=new xi(n.targetIds||[],n.removedTargetIds||[],l.key,l)}else if("documentDelete"in e){const n=e.documentDelete,i=Ze(r,n.document),s=n.readTime?ye(n.readTime):z.min(),a=ae.newNoDocument(i,s);t=new xi([],n.removedTargetIds||[],a.key,a)}else if("documentRemove"in e){const n=e.documentRemove,i=Ze(r,n.document);t=new xi([],n.removedTargetIds||[],i,null)}else{if(!("filter"in e))return L();{const n=e.filter,{count:i=0,unchangedNames:s}=n,a=new Gm(i,s);t=new uc(n.targetId,a)}}var h;return t}(this.serializer,e),n=function(s){if(!("targetChange"in s))return z.min();const a=s.targetChange;return a.targetIds&&a.targetIds.length?z.min():a.readTime?ye(a.readTime):z.min()}(e);return this.listener.d_(t,n)}A_(e){const t={};t.database=so(this.serializer),t.addTarget=function(s,a){let u;const l=a.target;if(u=Ai(l)?{documents:Tc(s,l)}:{query:Ci(s,l)._t},u.targetId=a.targetId,a.resumeToken.approximateByteSize()>0){u.resumeToken=fc(s,a.resumeToken);const h=no(s,a.expectedCount);null!==h&&(u.expectedCount=h)}else if(a.snapshotVersion.compareTo(z.min())>0){u.readTime=xn(s,a.snapshotVersion.toTimestamp());const h=no(s,a.expectedCount);null!==h&&(u.expectedCount=h)}return u}(this.serializer,e);const n=function t_(r,e){const t=function(i){switch(i){case"TargetPurposeListen":return null;case"TargetPurposeExistenceFilterMismatch":return"existence-filter-mismatch";case"TargetPurposeExistenceFilterMismatchBloom":return"existence-filter-mismatch-bloom";case"TargetPurposeLimboResolution":return"limbo-document";default:return L()}}(e.purpose);return null==t?null:{"goog-listen-tags":t}}(0,e);n&&(t.labels=n),this.a_(t)}R_(e){const t={};t.database=so(this.serializer),t.removeTarget=e,this.a_(t)}}class G_ extends _h{constructor(e,t,n,i,s,a){super(e,"write_stream_connection_backoff","write_stream_idle","health_check_timeout",t,n,i,a),this.serializer=s}get V_(){return this.e_>0}start(){this.lastStreamToken=void 0,super.start()}l_(){this.V_&&this.m_([])}T_(e,t){return this.connection.Bo("Write",e,t)}E_(e){return B(!!e.streamToken),this.lastStreamToken=e.streamToken,B(!e.writeResults||0===e.writeResults.length),this.listener.f_()}onNext(e){B(!!e.streamToken),this.lastStreamToken=e.streamToken,this.t_.reset();const t=function e_(r,e){return r&&r.length>0?(B(void 0!==e),r.map(t=>function(i,s){let a=ye(i.updateTime?i.updateTime:s);return a.isEqual(z.min())&&(a=ye(s)),new qm(a,i.transformResults||[])}(t,e))):[]}(e.writeResults,e.commitTime),n=ye(e.commitTime);return this.listener.g_(n,t)}p_(){const e={};e.database=so(this.serializer),this.a_(e)}m_(e){const t={streamToken:this.lastStreamToken,writes:e.map(n=>Rr(this.serializer,n))};this.a_(t)}}class K_ extends class{}{constructor(e,t,n,i){super(),this.authCredentials=e,this.appCheckCredentials=t,this.connection=n,this.serializer=i,this.y_=!1}w_(){if(this.y_)throw new C(V.FAILED_PRECONDITION,"The client has already been terminated.")}Mo(e,t,n,i){return this.w_(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([s,a])=>this.connection.Mo(e,io(t,n),i,s,a)).catch(s=>{throw"FirebaseError"===s.name?(s.code===V.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),s):new C(V.UNKNOWN,s.toString())})}Lo(e,t,n,i,s){return this.w_(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([a,u])=>this.connection.Lo(e,io(t,n),i,a,u,s)).catch(a=>{throw"FirebaseError"===a.name?(a.code===V.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),a):new C(V.UNKNOWN,a.toString())})}terminate(){this.y_=!0,this.connection.terminate()}}class j_{constructor(e,t){this.asyncQueue=e,this.onlineStateHandler=t,this.state="Unknown",this.S_=0,this.b_=null,this.D_=!0}v_(){0===this.S_&&(this.C_("Unknown"),this.b_=this.asyncQueue.enqueueAfterDelay("online_state_timeout",1e4,()=>(this.b_=null,this.F_("Backend didn't respond within 10 seconds."),this.C_("Offline"),Promise.resolve())))}M_(e){"Online"===this.state?this.C_("Unknown"):(this.S_++,this.S_>=1&&(this.x_(),this.F_(`Connection failed 1 times. Most recent error: ${e.toString()}`),this.C_("Offline")))}set(e){this.x_(),this.S_=0,"Online"===e&&(this.D_=!1),this.C_(e)}C_(e){e!==this.state&&(this.state=e,this.onlineStateHandler(e))}F_(e){const t=`Could not reach Cloud Firestore backend. ${e}\nThis typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.`;this.D_?(pe(t),this.D_=!1):N("OnlineStateTracker",t)}x_(){null!==this.b_&&(this.b_.cancel(),this.b_=null)}}class W_{constructor(e,t,n,i,s){var a=this;this.localStore=e,this.datastore=t,this.asyncQueue=n,this.remoteSyncer={},this.O_=[],this.N_=new Map,this.L_=new Set,this.B_=[],this.k_=s,this.k_._o(u=>{n.enqueueAndForget((0,b.A)(function*(){var l;xt(a)&&(N("RemoteStore","Restarting streams for network reachability change."),yield(l=(0,b.A)(function*(f){const _=F(f);_.L_.add(4),yield Ln(_),_.q_.set("Unknown"),_.L_.delete(4),yield kr(_)}),function h(f){return l.apply(this,arguments)})(a))}))}),this.q_=new j_(n,i)}}function kr(r){return Co.apply(this,arguments)}function Co(){return(Co=(0,b.A)(function*(r){if(xt(r))for(const e of r.B_)yield e(!0)})).apply(this,arguments)}function Ln(r){return Do.apply(this,arguments)}function Do(){return(Do=(0,b.A)(function*(r){for(const e of r.B_)yield e(!1)})).apply(this,arguments)}function Wi(r,e){const t=F(r);t.N_.has(e.targetId)||(t.N_.set(e.targetId,e),Fo(t)?ko(t):qn(t).r_()&&No(t,e))}function Bn(r,e){const t=F(r),n=qn(t);t.N_.delete(e),n.r_()&&gh(t,e),0===t.N_.size&&(n.r_()?n.o_():xt(t)&&t.q_.set("Unknown"))}function No(r,e){if(r.Q_.xe(e.targetId),e.resumeToken.approximateByteSize()>0||e.snapshotVersion.compareTo(z.min())>0){const t=r.remoteSyncer.getRemoteKeysForTarget(e.targetId).size;e=e.withExpectedCount(t)}qn(r).A_(e)}function gh(r,e){r.Q_.xe(e),qn(r).R_(e)}function ko(r){r.Q_=new jm({getRemoteKeysForTarget:e=>r.remoteSyncer.getRemoteKeysForTarget(e),ot:e=>r.N_.get(e)||null,tt:()=>r.datastore.serializer.databaseId}),qn(r).start(),r.q_.v_()}function Fo(r){return xt(r)&&!qn(r).n_()&&r.N_.size>0}function xt(r){return 0===F(r).L_.size}function ph(r){r.Q_=void 0}function Q_(r){return Mo.apply(this,arguments)}function Mo(){return(Mo=(0,b.A)(function*(r){r.q_.set("Online")})).apply(this,arguments)}function H_(r){return Oo.apply(this,arguments)}function Oo(){return(Oo=(0,b.A)(function*(r){r.N_.forEach((e,t)=>{No(r,e)})})).apply(this,arguments)}function J_(r,e){return Lo.apply(this,arguments)}function Lo(){return(Lo=(0,b.A)(function*(r,e){ph(r),Fo(r)?(r.q_.M_(e),ko(r)):r.q_.set("Unknown")})).apply(this,arguments)}function Y_(r,e,t){return Bo.apply(this,arguments)}function Bo(){return Bo=(0,b.A)(function*(r,e,t){if(r.q_.set("Online"),e instanceof lc&&2===e.state&&e.cause)try{yield(n=(0,b.A)(function*(s,a){const u=a.cause;for(const l of a.targetIds)s.N_.has(l)&&(yield s.remoteSyncer.rejectListen(l,u),s.N_.delete(l),s.Q_.removeTarget(l))}),function i(s,a){return n.apply(this,arguments)})(r,e)}catch(n){N("RemoteStore","Failed to remove targets %s: %s ",e.targetIds.join(","),n),yield Qi(r,n)}else if(e instanceof xi?r.Q_.Ke(e):e instanceof uc?r.Q_.He(e):r.Q_.We(e),!t.isEqual(z.min()))try{const n=yield sh(r.localStore);t.compareTo(n)>=0&&(yield function(s,a){const u=s.Q_.rt(a);return u.targetChanges.forEach((l,h)=>{if(l.resumeToken.approximateByteSize()>0){const f=s.N_.get(h);f&&s.N_.set(h,f.withResumeToken(l.resumeToken,a))}}),u.targetMismatches.forEach((l,h)=>{const f=s.N_.get(l);if(!f)return;s.N_.set(l,f.withResumeToken(me.EMPTY_BYTE_STRING,f.snapshotVersion)),gh(s,l);const _=new ut(f.target,l,h,f.sequenceNumber);No(s,_)}),s.remoteSyncer.applyRemoteEvent(u)}(r,t))}catch(n){N("RemoteStore","Failed to raise snapshot:",n),yield Qi(r,n)}var n}),Bo.apply(this,arguments)}function Qi(r,e,t){return Uo.apply(this,arguments)}function Uo(){return(Uo=(0,b.A)(function*(r,e,t){if(!It(e))throw e;r.L_.add(1),yield Ln(r),r.q_.set("Offline"),t||(t=()=>sh(r.localStore)),r.asyncQueue.enqueueRetryable((0,b.A)(function*(){N("RemoteStore","Retrying IndexedDB access"),yield t(),r.L_.delete(1),yield kr(r)}))})).apply(this,arguments)}function yh(r,e){return e().catch(t=>Qi(r,t,e))}function Un(r){return qo.apply(this,arguments)}function qo(){return(qo=(0,b.A)(function*(r){const e=F(r),t=Ct(e);let n=e.O_.length>0?e.O_[e.O_.length-1].batchId:-1;for(;X_(e);)try{const i=yield M_(e.localStore,n);if(null===i){0===e.O_.length&&t.o_();break}n=i.batchId,Z_(e,i)}catch(i){yield Qi(e,i)}Ih(e)&&Th(e)})).apply(this,arguments)}function X_(r){return xt(r)&&r.O_.length<10}function Z_(r,e){r.O_.push(e);const t=Ct(r);t.r_()&&t.V_&&t.m_(e.mutations)}function Ih(r){return xt(r)&&!Ct(r).n_()&&r.O_.length>0}function Th(r){Ct(r).start()}function eg(r){return zo.apply(this,arguments)}function zo(){return(zo=(0,b.A)(function*(r){Ct(r).p_()})).apply(this,arguments)}function tg(r){return $o.apply(this,arguments)}function $o(){return($o=(0,b.A)(function*(r){const e=Ct(r);for(const t of r.O_)e.m_(t.mutations)})).apply(this,arguments)}function ng(r,e,t){return Go.apply(this,arguments)}function Go(){return(Go=(0,b.A)(function*(r,e,t){const n=r.O_.shift(),i=Zs.from(n,e,t);yield yh(r,()=>r.remoteSyncer.applySuccessfulWrite(i)),yield Un(r)})).apply(this,arguments)}function rg(r,e){return Ko.apply(this,arguments)}function Ko(){return Ko=(0,b.A)(function*(r,e){var t;e&&Ct(r).V_&&(yield(t=(0,b.A)(function*(i,s){if(rc(u=s.code)&&u!==V.ABORTED){const a=i.O_.shift();Ct(i).s_(),yield yh(i,()=>i.remoteSyncer.rejectFailedWrite(a.batchId,s)),yield Un(i)}var u}),function n(i,s){return t.apply(this,arguments)})(r,e)),Ih(r)&&Th(r)}),Ko.apply(this,arguments)}function Eh(r,e){return jo.apply(this,arguments)}function jo(){return(jo=(0,b.A)(function*(r,e){const t=F(r);t.asyncQueue.verifyOperationInProgress(),N("RemoteStore","RemoteStore received new credentials");const n=xt(t);t.L_.add(3),yield Ln(t),n&&t.q_.set("Unknown"),yield t.remoteSyncer.handleCredentialChange(e),t.L_.delete(3),yield kr(t)})).apply(this,arguments)}function Wo(r,e){return Qo.apply(this,arguments)}function Qo(){return(Qo=(0,b.A)(function*(r,e){const t=F(r);e?(t.L_.delete(2),yield kr(t)):e||(t.L_.add(2),yield Ln(t),t.q_.set("Unknown"))})).apply(this,arguments)}function qn(r){return r.K_||(r.K_=function(t,n,i){const s=F(t);return s.w_(),new $_(n,s.connection,s.authCredentials,s.appCheckCredentials,s.serializer,i)}(r.datastore,r.asyncQueue,{Eo:Q_.bind(null,r),Ro:H_.bind(null,r),mo:J_.bind(null,r),d_:Y_.bind(null,r)}),r.B_.push(function(){var e=(0,b.A)(function*(t){t?(r.K_.s_(),Fo(r)?ko(r):r.q_.set("Unknown")):(yield r.K_.stop(),ph(r))});return function(t){return e.apply(this,arguments)}}())),r.K_}function Ct(r){return r.U_||(r.U_=function(t,n,i){const s=F(t);return s.w_(),new G_(n,s.connection,s.authCredentials,s.appCheckCredentials,s.serializer,i)}(r.datastore,r.asyncQueue,{Eo:()=>Promise.resolve(),Ro:eg.bind(null,r),mo:rg.bind(null,r),f_:tg.bind(null,r),g_:ng.bind(null,r)}),r.B_.push(function(){var e=(0,b.A)(function*(t){t?(r.U_.s_(),yield Un(r)):(yield r.U_.stop(),r.O_.length>0&&(N("RemoteStore",`Stopping write stream with ${r.O_.length} pending writes`),r.O_=[]))});return function(t){return e.apply(this,arguments)}}())),r.U_}class Ho{constructor(e,t,n,i,s){this.asyncQueue=e,this.timerId=t,this.targetTimeMs=n,this.op=i,this.removalCallback=s,this.deferred=new ve,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch(a=>{})}get promise(){return this.deferred.promise}static createAndSchedule(e,t,n,i,s){const a=Date.now()+n,u=new Ho(e,t,a,i,s);return u.start(n),u}start(e){this.timerHandle=setTimeout(()=>this.handleDelayElapsed(),e)}skipDelay(){return this.handleDelayElapsed()}cancel(e){null!==this.timerHandle&&(this.clearTimeout(),this.deferred.reject(new C(V.CANCELLED,"Operation cancelled"+(e?": "+e:""))))}handleDelayElapsed(){this.asyncQueue.enqueueAndForget(()=>null!==this.timerHandle?(this.clearTimeout(),this.op().then(e=>this.deferred.resolve(e))):Promise.resolve())}clearTimeout(){null!==this.timerHandle&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)}}function zn(r,e){if(pe("AsyncQueue",`${e}: ${r}`),It(r))return new C(V.UNAVAILABLE,`${e}: ${r}`);throw r}class $n{constructor(e){this.comparator=e?(t,n)=>e(t,n)||O.comparator(t.key,n.key):(t,n)=>O.comparator(t.key,n.key),this.keyedMap=pr(),this.sortedSet=new se(this.comparator)}static emptySet(e){return new $n(e.comparator)}has(e){return null!=this.keyedMap.get(e)}get(e){return this.keyedMap.get(e)}first(){return this.sortedSet.minKey()}last(){return this.sortedSet.maxKey()}isEmpty(){return this.sortedSet.isEmpty()}indexOf(e){const t=this.keyedMap.get(e);return t?this.sortedSet.indexOf(t):-1}get size(){return this.sortedSet.size}forEach(e){this.sortedSet.inorderTraversal((t,n)=>(e(t),!1))}add(e){const t=this.delete(e.key);return t.copy(t.keyedMap.insert(e.key,e),t.sortedSet.insert(e,null))}delete(e){const t=this.get(e);return t?this.copy(this.keyedMap.remove(e),this.sortedSet.remove(t)):this}isEqual(e){if(!(e instanceof $n)||this.size!==e.size)return!1;const t=this.sortedSet.getIterator(),n=e.sortedSet.getIterator();for(;t.hasNext();){const i=t.getNext().key,s=n.getNext().key;if(!i.isEqual(s))return!1}return!0}toString(){const e=[];return this.forEach(t=>{e.push(t.toString())}),0===e.length?"DocumentSet ()":"DocumentSet (\n  "+e.join("  \n")+"\n)"}copy(e,t){const n=new $n;return n.comparator=this.comparator,n.keyedMap=e,n.sortedSet=t,n}}class vh{constructor(){this.W_=new se(O.comparator)}track(e){const t=e.doc.key,n=this.W_.get(t);n?0!==e.type&&3===n.type?this.W_=this.W_.insert(t,e):3===e.type&&1!==n.type?this.W_=this.W_.insert(t,{type:n.type,doc:e.doc}):2===e.type&&2===n.type?this.W_=this.W_.insert(t,{type:2,doc:e.doc}):2===e.type&&0===n.type?this.W_=this.W_.insert(t,{type:0,doc:e.doc}):1===e.type&&0===n.type?this.W_=this.W_.remove(t):1===e.type&&2===n.type?this.W_=this.W_.insert(t,{type:1,doc:n.doc}):0===e.type&&1===n.type?this.W_=this.W_.insert(t,{type:2,doc:e.doc}):L():this.W_=this.W_.insert(t,e)}G_(){const e=[];return this.W_.inorderTraversal((t,n)=>{e.push(n)}),e}}class Gn{constructor(e,t,n,i,s,a,u,l,h){this.query=e,this.docs=t,this.oldDocs=n,this.docChanges=i,this.mutatedKeys=s,this.fromCache=a,this.syncStateChanged=u,this.excludesMetadataChanges=l,this.hasCachedResults=h}static fromInitialDocuments(e,t,n,i,s){const a=[];return t.forEach(u=>{a.push({type:0,doc:u})}),new Gn(e,t,$n.emptySet(t),a,n,i,!0,!1,s)}get hasPendingWrites(){return!this.mutatedKeys.isEmpty()}isEqual(e){if(!(this.fromCache===e.fromCache&&this.hasCachedResults===e.hasCachedResults&&this.syncStateChanged===e.syncStateChanged&&this.mutatedKeys.isEqual(e.mutatedKeys)&&_r(this.query,e.query)&&this.docs.isEqual(e.docs)&&this.oldDocs.isEqual(e.oldDocs)))return!1;const t=this.docChanges,n=e.docChanges;if(t.length!==n.length)return!1;for(let i=0;i<t.length;i++)if(t[i].type!==n[i].type||!t[i].doc.isEqual(n[i].doc))return!1;return!0}}class ig{constructor(){this.z_=void 0,this.j_=[]}H_(){return this.j_.some(e=>e.J_())}}class sg{constructor(){this.queries=Ah(),this.onlineState="Unknown",this.Y_=new Set}terminate(){!function(t,n){const i=F(t),s=i.queries;i.queries=Ah(),s.forEach((a,u)=>{for(const l of u.j_)l.onError(n)})}(this,new C(V.ABORTED,"Firestore shutting down"))}}function Ah(){return new ot(r=>Ll(r),_r)}function Jo(r,e){return Yo.apply(this,arguments)}function Yo(){return(Yo=(0,b.A)(function*(r,e){const t=F(r);let n=3;const i=e.query;let s=t.queries.get(i);s?!s.H_()&&e.J_()&&(n=2):(s=new ig,n=e.J_()?0:1);try{switch(n){case 0:s.z_=yield t.onListen(i,!0);break;case 1:s.z_=yield t.onListen(i,!1);break;case 2:yield t.onFirstRemoteStoreListen(i)}}catch(a){const u=zn(a,`Initialization of query '${Rn(e.query)}' failed`);return void e.onError(u)}t.queries.set(i,s),s.j_.push(e),e.Z_(t.onlineState),s.z_&&e.X_(s.z_)&&ea(t)})).apply(this,arguments)}function Xo(r,e){return Zo.apply(this,arguments)}function Zo(){return(Zo=(0,b.A)(function*(r,e){const t=F(r),n=e.query;let i=3;const s=t.queries.get(n);if(s){const a=s.j_.indexOf(e);a>=0&&(s.j_.splice(a,1),0===s.j_.length?i=e.J_()?0:1:!s.H_()&&e.J_()&&(i=2))}switch(i){case 0:return t.queries.delete(n),t.onUnlisten(n,!0);case 1:return t.queries.delete(n),t.onUnlisten(n,!1);case 2:return t.onLastRemoteStoreUnlisten(n);default:return}})).apply(this,arguments)}function og(r,e){const t=F(r);let n=!1;for(const i of e){const a=t.queries.get(i.query);if(a){for(const u of a.j_)u.X_(i)&&(n=!0);a.z_=i}}n&&ea(t)}function ag(r,e,t){const n=F(r),i=n.queries.get(e);if(i)for(const s of i.j_)s.onError(t);n.queries.delete(e)}function ea(r){r.Y_.forEach(e=>{e.next()})}var ta,wh;(wh=ta||(ta={})).ea="default",wh.Cache="cache";class na{constructor(e,t,n){this.query=e,this.ta=t,this.na=!1,this.ra=null,this.onlineState="Unknown",this.options=n||{}}X_(e){if(!this.options.includeMetadataChanges){const n=[];for(const i of e.docChanges)3!==i.type&&n.push(i);e=new Gn(e.query,e.docs,e.oldDocs,n,e.mutatedKeys,e.fromCache,e.syncStateChanged,!0,e.hasCachedResults)}let t=!1;return this.na?this.ia(e)&&(this.ta.next(e),t=!0):this.sa(e,this.onlineState)&&(this.oa(e),t=!0),this.ra=e,t}onError(e){this.ta.error(e)}Z_(e){this.onlineState=e;let t=!1;return this.ra&&!this.na&&this.sa(this.ra,e)&&(this.oa(this.ra),t=!0),t}sa(e,t){return!e.fromCache||!this.J_()||(!this.options._a||!("Offline"!==t))&&(!e.docs.isEmpty()||e.hasCachedResults||"Offline"===t)}ia(e){return e.docChanges.length>0||!!(e.syncStateChanged||this.ra&&this.ra.hasPendingWrites!==e.hasPendingWrites)&&!0===this.options.includeMetadataChanges}oa(e){e=Gn.fromInitialDocuments(e.query,e.docs,e.mutatedKeys,e.fromCache,e.hasCachedResults),this.na=!0,this.ta.next(e)}J_(){return this.options.source!==ta.Cache}}class ug{constructor(e,t){this.aa=e,this.byteLength=t}ua(){return"metadata"in this.aa}}class Rh{constructor(e){this.serializer=e}Es(e){return Ze(this.serializer,e)}ds(e){return e.metadata.exists?Ic(this.serializer,e.document,!1):ae.newNoDocument(this.Es(e.metadata.name),this.As(e.metadata.readTime))}As(e){return ye(e)}}class lg{constructor(e,t,n){this.ca=e,this.localStore=t,this.serializer=n,this.queries=[],this.documents=[],this.collectionGroups=new Set,this.progress=Ph(e)}la(e){this.progress.bytesLoaded+=e.byteLength;let t=this.progress.documentsLoaded;if(e.aa.namedQuery)this.queries.push(e.aa.namedQuery);else if(e.aa.documentMetadata){this.documents.push({metadata:e.aa.documentMetadata}),e.aa.documentMetadata.exists||++t;const n=H.fromString(e.aa.documentMetadata.name);this.collectionGroups.add(n.get(n.length-2))}else e.aa.document&&(this.documents[this.documents.length-1].document=e.aa.document,++t);return t!==this.progress.documentsLoaded?(this.progress.documentsLoaded=t,Object.assign({},this.progress)):null}ha(e){const t=new Map,n=new Rh(this.serializer);for(const i of e)if(i.metadata.queries){const s=n.Es(i.metadata.name);for(const a of i.metadata.queries){const u=(t.get(a)||j()).add(s);t.set(a,u)}}return t}complete(){var e=this;return(0,b.A)(function*(){const t=yield function O_(r,e,t,n){return Ao.apply(this,arguments)}(e.localStore,new Rh(e.serializer),e.documents,e.ca.id),n=e.ha(e.documents);for(const i of e.queries)yield L_(e.localStore,i,n.get(i.name));return e.progress.taskState="Success",{progress:e.progress,Pa:e.collectionGroups,Ia:t}})()}}function Ph(r){return{taskState:"Running",documentsLoaded:0,bytesLoaded:0,totalDocuments:r.totalDocuments,totalBytes:r.totalBytes}}class Vh{constructor(e){this.key=e}}class Sh{constructor(e){this.key=e}}class bh{constructor(e,t){this.query=e,this.Ta=t,this.Ea=null,this.hasCachedResults=!1,this.current=!1,this.da=j(),this.mutatedKeys=j(),this.Aa=Ul(e),this.Ra=new $n(this.Aa)}get Va(){return this.Ta}ma(e,t){const n=t?t.fa:new vh,i=t?t.Ra:this.Ra;let s=t?t.mutatedKeys:this.mutatedKeys,a=i,u=!1;const l="F"===this.query.limitType&&i.size===this.query.limit?i.last():null,h="L"===this.query.limitType&&i.size===this.query.limit?i.first():null;if(e.inorderTraversal((f,_)=>{const p=i.get(f),R=gr(this.query,_)?_:null,x=!!p&&this.mutatedKeys.has(p.key),k=!!R&&(R.hasLocalMutations||this.mutatedKeys.has(R.key)&&R.hasCommittedMutations);let D=!1;p&&R?p.data.isEqual(R.data)?x!==k&&(n.track({type:3,doc:R}),D=!0):this.ga(p,R)||(n.track({type:2,doc:R}),D=!0,(l&&this.Aa(R,l)>0||h&&this.Aa(R,h)<0)&&(u=!0)):!p&&R?(n.track({type:0,doc:R}),D=!0):p&&!R&&(n.track({type:1,doc:p}),D=!0,(l||h)&&(u=!0)),D&&(R?(a=a.add(R),s=k?s.add(f):s.delete(f)):(a=a.delete(f),s=s.delete(f)))}),null!==this.query.limit)for(;a.size>this.query.limit;){const f="F"===this.query.limitType?a.last():a.first();a=a.delete(f.key),s=s.delete(f.key),n.track({type:1,doc:f})}return{Ra:a,fa:n,ns:u,mutatedKeys:s}}ga(e,t){return e.hasLocalMutations&&t.hasCommittedMutations&&!t.hasLocalMutations}applyChanges(e,t,n,i){const s=this.Ra;this.Ra=e.Ra,this.mutatedKeys=e.mutatedKeys;const a=e.fa.G_();a.sort((f,_)=>function(R,x){const k=D=>{switch(D){case 0:return 1;case 2:case 3:return 2;case 1:return 0;default:return L()}};return k(R)-k(x)}(f.type,_.type)||this.Aa(f.doc,_.doc)),this.pa(n),i=null!=i&&i;const u=t&&!i?this.ya():[],l=0===this.da.size&&this.current&&!i?1:0,h=l!==this.Ea;return this.Ea=l,0!==a.length||h?{snapshot:new Gn(this.query,e.Ra,s,a,e.mutatedKeys,0===l,h,!1,!!n&&n.resumeToken.approximateByteSize()>0),wa:u}:{wa:u}}Z_(e){return this.current&&"Offline"===e?(this.current=!1,this.applyChanges({Ra:this.Ra,fa:new vh,mutatedKeys:this.mutatedKeys,ns:!1},!1)):{wa:[]}}Sa(e){return!this.Ta.has(e)&&!!this.Ra.has(e)&&!this.Ra.get(e).hasLocalMutations}pa(e){e&&(e.addedDocuments.forEach(t=>this.Ta=this.Ta.add(t)),e.modifiedDocuments.forEach(t=>{}),e.removedDocuments.forEach(t=>this.Ta=this.Ta.delete(t)),this.current=e.current)}ya(){if(!this.current)return[];const e=this.da;this.da=j(),this.Ra.forEach(n=>{this.Sa(n.key)&&(this.da=this.da.add(n.key))});const t=[];return e.forEach(n=>{this.da.has(n)||t.push(new Sh(n))}),this.da.forEach(n=>{e.has(n)||t.push(new Vh(n))}),t}ba(e){this.Ta=e.Ts,this.da=j();const t=this.ma(e.documents);return this.applyChanges(t,!0)}Da(){return Gn.fromInitialDocuments(this.query,this.Ra,this.mutatedKeys,0===this.Ea,this.hasCachedResults)}}class cg{constructor(e,t,n){this.query=e,this.targetId=t,this.view=n}}class hg{constructor(e){this.key=e,this.va=!1}}class dg{constructor(e,t,n,i,s,a){this.localStore=e,this.remoteStore=t,this.eventManager=n,this.sharedClientState=i,this.currentUser=s,this.maxConcurrentLimboResolutions=a,this.Ca={},this.Fa=new ot(u=>Ll(u),_r),this.Ma=new Map,this.xa=new Set,this.Oa=new se(O.comparator),this.Na=new Map,this.La=new _o,this.Ba={},this.ka=new Map,this.qa=Zt.kn(),this.onlineState="Unknown",this.Qa=void 0}get isPrimaryClient(){return!0===this.Qa}}function fg(r,e){return ra.apply(this,arguments)}function ra(){return(ra=(0,b.A)(function*(r,e,t=!0){const n=Hi(r);let i;const s=n.Fa.get(e);return s?(n.sharedClientState.addLocalQueryTarget(s.targetId),i=s.view.Da()):i=yield xh(n,e,t,!0),i})).apply(this,arguments)}function mg(r,e){return ia.apply(this,arguments)}function ia(){return(ia=(0,b.A)(function*(r,e){const t=Hi(r);yield xh(t,e,!0,!1)})).apply(this,arguments)}function xh(r,e,t,n){return sa.apply(this,arguments)}function sa(){return(sa=(0,b.A)(function*(r,e,t,n){const i=yield Mn(r.localStore,be(e)),s=i.targetId,a=r.sharedClientState.addLocalQueryTarget(s,t);let u;return n&&(u=yield oa(r,e,s,"current"===a,i.resumeToken)),r.isPrimaryClient&&t&&Wi(r.remoteStore,i),u})).apply(this,arguments)}function oa(r,e,t,n,i){return aa.apply(this,arguments)}function aa(){return aa=(0,b.A)(function*(r,e,t,n,i){r.Ka=(_,p,R)=>{return(x=(0,b.A)(function*(D,U,$,q){let K=U.view.ma($);K.ns&&(K=yield zi(D.localStore,U.query,!1).then(({documents:g})=>U.view.ma(g,K)));const X=q&&q.targetChanges.get(U.targetId),W=q&&null!=q.targetMismatches.get(U.targetId),T=U.view.applyChanges(K,D.isPrimaryClient,X,W);return ya(D,U.targetId,T.wa),T.snapshot}),function k(D,U,$,q){return x.apply(this,arguments)})(r,_,p,R);var x};const s=yield zi(r.localStore,e,!0),a=new bh(e,s.Ts),u=a.ma(s.documents),l=Ar.createSynthesizedTargetChangeForCurrentChange(t,n&&"Offline"!==r.onlineState,i),h=a.applyChanges(u,r.isPrimaryClient,l);ya(r,t,h.wa);const f=new cg(e,t,a);return r.Fa.set(e,f),r.Ma.has(t)?r.Ma.get(t).push(e):r.Ma.set(t,[e]),h.snapshot}),aa.apply(this,arguments)}function _g(r,e,t){return ua.apply(this,arguments)}function ua(){return(ua=(0,b.A)(function*(r,e,t){const n=F(r),i=n.Fa.get(e),s=n.Ma.get(i.targetId);if(s.length>1)return n.Ma.set(i.targetId,s.filter(a=>!_r(a,e))),void n.Fa.delete(e);n.isPrimaryClient?(n.sharedClientState.removeLocalQueryTarget(i.targetId),n.sharedClientState.isActiveQueryTarget(i.targetId)||(yield On(n.localStore,i.targetId,!1).then(()=>{n.sharedClientState.clearQueryState(i.targetId),t&&Bn(n.remoteStore,i.targetId),Kn(n,i.targetId)}).catch(yt))):(Kn(n,i.targetId),yield On(n.localStore,i.targetId,!0))})).apply(this,arguments)}function gg(r,e){return la.apply(this,arguments)}function la(){return(la=(0,b.A)(function*(r,e){const t=F(r),n=t.Fa.get(e),i=t.Ma.get(n.targetId);t.isPrimaryClient&&1===i.length&&(t.sharedClientState.removeLocalQueryTarget(n.targetId),Bn(t.remoteStore,n.targetId))})).apply(this,arguments)}function ca(){return(ca=(0,b.A)(function*(r,e,t){const n=ba(r);try{const i=yield function(a,u){const l=F(a),h=ce.now(),f=u.reduce((R,x)=>R.add(x.key),j());let _,p;return l.persistence.runTransaction("Locally write mutations","readwrite",R=>{let x=qe(),k=j();return l.cs.getEntries(R,f).next(D=>{x=D,x.forEach((U,$)=>{$.isValidDocument()||(k=k.add(U))})}).next(()=>l.localDocuments.getOverlayedDocuments(R,x)).next(D=>{_=D;const U=[];for(const $ of u){const q=$m($,_.get($.key).overlayedDocument);null!=q&&U.push(new at($.key,q,vl(q.value.mapValue),de.exists(!0)))}return l.mutationQueue.addMutationBatch(R,h,U,u)}).next(D=>{p=D;const U=D.applyToLocalDocumentSet(_,k);return l.documentOverlayCache.saveOverlays(R,D.batchId,U)})}).then(()=>({batchId:p.batchId,changes:zl(_)}))}(n.localStore,e);n.sharedClientState.addPendingMutation(i.batchId),function(a,u,l){let h=a.Ba[a.currentUser.toKey()];h||(h=new se(G)),h=h.insert(u,l),a.Ba[a.currentUser.toKey()]=h}(n,i.batchId,t),yield lt(n,i.changes),yield Un(n.remoteStore)}catch(i){const s=zn(i,"Failed to persist write");t.reject(s)}})).apply(this,arguments)}function Ch(r,e){return ha.apply(this,arguments)}function ha(){return(ha=(0,b.A)(function*(r,e){const t=F(r);try{const n=yield function F_(r,e){const t=F(r),n=e.snapshotVersion;let i=t.os;return t.persistence.runTransaction("Apply remote event","readwrite-primary",s=>{const a=t.cs.newChangeBuffer({trackRemovals:!0});i=t.os;const u=[];e.targetChanges.forEach((f,_)=>{const p=i.get(_);if(!p)return;u.push(t.Ur.removeMatchingKeys(s,f.removedDocuments,_).next(()=>t.Ur.addMatchingKeys(s,f.addedDocuments,_)));let R=p.withSequenceNumber(s.currentSequenceNumber);var k,D,U;null!==e.targetMismatches.get(_)?R=R.withResumeToken(me.EMPTY_BYTE_STRING,z.min()).withLastLimboFreeSnapshotVersion(z.min()):f.resumeToken.approximateByteSize()>0&&(R=R.withResumeToken(f.resumeToken,n)),i=i.insert(_,R),D=R,U=f,(0===(k=p).resumeToken.approximateByteSize()||D.snapshotVersion.toMicroseconds()-k.snapshotVersion.toMicroseconds()>=3e8||U.addedDocuments.size+U.modifiedDocuments.size+U.removedDocuments.size>0)&&u.push(t.Ur.updateTargetData(s,R))});let l=qe(),h=j();if(e.documentUpdates.forEach(f=>{e.resolvedLimboDocuments.has(f)&&u.push(t.persistence.referenceDelegate.updateLimboDocument(s,f))}),u.push(oh(s,a,e.documentUpdates).next(f=>{l=f.Ps,h=f.Is})),!n.isEqual(z.min())){const f=t.Ur.getLastRemoteSnapshotVersion(s).next(_=>t.Ur.setTargetsMetadata(s,s.currentSequenceNumber,n));u.push(f)}return w.waitFor(u).next(()=>a.apply(s)).next(()=>t.localDocuments.getLocalViewOfDocuments(s,l,h)).next(()=>l)}).then(s=>(t.os=i,s))}(t.localStore,e);e.targetChanges.forEach((i,s)=>{const a=t.Na.get(s);a&&(B(i.addedDocuments.size+i.modifiedDocuments.size+i.removedDocuments.size<=1),i.addedDocuments.size>0?a.va=!0:i.modifiedDocuments.size>0?B(a.va):i.removedDocuments.size>0&&(B(a.va),a.va=!1))}),yield lt(t,n,e)}catch(n){yield yt(n)}})).apply(this,arguments)}function Dh(r,e,t){const n=F(r);if(n.isPrimaryClient&&0===t||!n.isPrimaryClient&&1===t){const i=[];n.Fa.forEach((s,a)=>{const u=a.view.Z_(e);u.snapshot&&i.push(u.snapshot)}),function(a,u){const l=F(a);l.onlineState=u;let h=!1;l.queries.forEach((f,_)=>{for(const p of _.j_)p.Z_(u)&&(h=!0)}),h&&ea(l)}(n.eventManager,e),i.length&&n.Ca.d_(i),n.onlineState=e,n.isPrimaryClient&&n.sharedClientState.setOnlineState(e)}}function yg(r,e,t){return da.apply(this,arguments)}function da(){return(da=(0,b.A)(function*(r,e,t){const n=F(r);n.sharedClientState.updateQueryState(e,"rejected",t);const i=n.Na.get(e),s=i&&i.key;if(s){let a=new se(O.comparator);a=a.insert(s,ae.newNoDocument(s,z.min()));const u=j().add(s),l=new vr(z.min(),new Map,new se(G),a,u);yield Ch(n,l),n.Oa=n.Oa.remove(s),n.Na.delete(e),Ia(n)}else yield On(n.localStore,e,!1).then(()=>Kn(n,e,t)).catch(yt)})).apply(this,arguments)}function Ig(r,e){return fa.apply(this,arguments)}function fa(){return(fa=(0,b.A)(function*(r,e){const t=F(r),n=e.batch.batchId;try{const i=yield function k_(r,e){const t=F(r);return t.persistence.runTransaction("Acknowledge batch","readwrite-primary",n=>{const i=e.batch.keys(),s=t.cs.newChangeBuffer({trackRemovals:!0});return function(u,l,h,f){const _=h.batch,p=_.keys();let R=w.resolve();return p.forEach(x=>{R=R.next(()=>f.getEntry(l,x)).next(k=>{const D=h.docVersions.get(x);B(null!==D),k.version.compareTo(D)<0&&(_.applyToRemoteDocument(k,h),k.isValidDocument()&&(k.setReadTime(h.commitVersion),f.addEntry(k)))})}),R.next(()=>u.mutationQueue.removeMutationBatch(l,_))}(t,n,e,s).next(()=>s.apply(n)).next(()=>t.mutationQueue.performConsistencyCheck(n)).next(()=>t.documentOverlayCache.removeOverlaysForBatchId(n,i,e.batch.batchId)).next(()=>t.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(n,function(u){let l=j();for(let h=0;h<u.mutationResults.length;++h)u.mutationResults[h].transformResults.length>0&&(l=l.add(u.batch.mutations[h].key));return l}(e))).next(()=>t.localDocuments.getDocuments(n,i))})}(t.localStore,e);pa(t,n,null),ga(t,n),t.sharedClientState.updateMutationState(n,"acknowledged"),yield lt(t,i)}catch(i){yield yt(i)}})).apply(this,arguments)}function Tg(r,e,t){return ma.apply(this,arguments)}function ma(){return(ma=(0,b.A)(function*(r,e,t){const n=F(r);try{const i=yield function(a,u){const l=F(a);return l.persistence.runTransaction("Reject batch","readwrite-primary",h=>{let f;return l.mutationQueue.lookupMutationBatch(h,u).next(_=>(B(null!==_),f=_.keys(),l.mutationQueue.removeMutationBatch(h,_))).next(()=>l.mutationQueue.performConsistencyCheck(h)).next(()=>l.documentOverlayCache.removeOverlaysForBatchId(h,f,u)).next(()=>l.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(h,f)).next(()=>l.localDocuments.getDocuments(h,f))})}(n.localStore,e);pa(n,e,t),ga(n,e),n.sharedClientState.updateMutationState(e,"rejected",t),yield lt(n,i)}catch(i){yield yt(i)}})).apply(this,arguments)}function _a(){return(_a=(0,b.A)(function*(r,e){const t=F(r);xt(t.remoteStore)||N("SyncEngine","The network is disabled. The task returned by 'awaitPendingWrites()' will not complete until the network is enabled.");try{const n=yield function(a){const u=F(a);return u.persistence.runTransaction("Get highest unacknowledged batch id","readonly",l=>u.mutationQueue.getHighestUnacknowledgedBatchId(l))}(t.localStore);if(-1===n)return void e.resolve();const i=t.ka.get(n)||[];i.push(e),t.ka.set(n,i)}catch(n){const i=zn(n,"Initialization of waitForPendingWrites() operation failed");e.reject(i)}})).apply(this,arguments)}function ga(r,e){(r.ka.get(e)||[]).forEach(t=>{t.resolve()}),r.ka.delete(e)}function pa(r,e,t){const n=F(r);let i=n.Ba[n.currentUser.toKey()];if(i){const s=i.get(e);s&&(t?s.reject(t):s.resolve(),i=i.remove(e)),n.Ba[n.currentUser.toKey()]=i}}function Kn(r,e,t=null){r.sharedClientState.removeLocalQueryTarget(e);for(const n of r.Ma.get(e))r.Fa.delete(n),t&&r.Ca.$a(n,t);r.Ma.delete(e),r.isPrimaryClient&&r.La.gr(e).forEach(n=>{r.La.containsKey(n)||Nh(r,n)})}function Nh(r,e){r.xa.delete(e.path.canonicalString());const t=r.Oa.get(e);null!==t&&(Bn(r.remoteStore,t),r.Oa=r.Oa.remove(e),r.Na.delete(t),Ia(r))}function ya(r,e,t){for(const n of t)n instanceof Vh?(r.La.addReference(n.key,e),vg(r,n)):n instanceof Sh?(N("SyncEngine","Document no longer in limbo: "+n.key),r.La.removeReference(n.key,e),r.La.containsKey(n.key)||Nh(r,n.key)):L()}function vg(r,e){const t=e.key,n=t.path.canonicalString();r.Oa.get(t)||r.xa.has(n)||(N("SyncEngine","New document in limbo: "+t),r.xa.add(n),Ia(r))}function Ia(r){for(;r.xa.size>0&&r.Oa.size<r.maxConcurrentLimboResolutions;){const e=r.xa.values().next().value;r.xa.delete(e);const t=new O(H.fromString(e)),n=r.qa.next();r.Na.set(n,new hg(t)),r.Oa=r.Oa.insert(t,n),Wi(r.remoteStore,new ut(be(An(t.path)),n,"TargetPurposeLimboResolution",Ge.oe))}}function lt(r,e,t){return Ta.apply(this,arguments)}function Ta(){return Ta=(0,b.A)(function*(r,e,t){const n=F(r),i=[],s=[],a=[];var u;n.Fa.isEmpty()||(n.Fa.forEach((u,l)=>{a.push(n.Ka(l,e,t).then(h=>{var f;if((h||t)&&n.isPrimaryClient){const _=h?!h.fromCache:null===(f=null==t?void 0:t.targetChanges.get(l.targetId))||void 0===f?void 0:f.current;n.sharedClientState.updateQueryState(l.targetId,_?"current":"not-current")}if(h){i.push(h);const _=To.Wi(l.targetId,h);s.push(_)}}))}),yield Promise.all(a),n.Ca.d_(i),yield(u=(0,b.A)(function*(h,f){const _=F(h);try{yield _.persistence.runTransaction("notifyLocalViewChanges","readwrite",p=>w.forEach(f,R=>w.forEach(R.$i,x=>_.persistence.referenceDelegate.addReference(p,R.targetId,x)).next(()=>w.forEach(R.Ui,x=>_.persistence.referenceDelegate.removeReference(p,R.targetId,x)))))}catch(p){if(!It(p))throw p;N("LocalStore","Failed to update sequence numbers: "+p)}for(const p of f){const R=p.targetId;if(!p.fromCache){const x=_.os.get(R),D=x.withLastLimboFreeSnapshotVersion(x.snapshotVersion);_.os=_.os.insert(R,D)}}}),function l(h,f){return u.apply(this,arguments)})(n.localStore,s))}),Ta.apply(this,arguments)}function Ag(r,e){return Ea.apply(this,arguments)}function Ea(){return(Ea=(0,b.A)(function*(r,e){const t=F(r);if(!t.currentUser.isEqual(e)){N("SyncEngine","User change. New user:",e.toKey());const n=yield ih(t.localStore,e);t.currentUser=e,(s=t).ka.forEach(u=>{u.forEach(l=>{l.reject(new C(V.CANCELLED,"'waitForPendingWrites' promise is rejected due to a user change."))})}),s.ka.clear(),t.sharedClientState.handleUserChange(e,n.removedBatchIds,n.addedBatchIds),yield lt(t,n.hs)}var s})).apply(this,arguments)}function wg(r,e){const t=F(r),n=t.Na.get(e);if(n&&n.va)return j().add(n.key);{let i=j();const s=t.Ma.get(e);if(!s)return i;for(const a of s){const u=t.Fa.get(a);i=i.unionWith(u.view.Va)}return i}}function Rg(r,e){return va.apply(this,arguments)}function va(){return(va=(0,b.A)(function*(r,e){const t=F(r),n=yield zi(t.localStore,e.query,!0),i=e.view.ba(n);return t.isPrimaryClient&&ya(t,e.targetId,i.wa),i})).apply(this,arguments)}function Pg(r,e){return Aa.apply(this,arguments)}function Aa(){return(Aa=(0,b.A)(function*(r,e){const t=F(r);return uh(t.localStore,e).then(n=>lt(t,n))})).apply(this,arguments)}function Vg(r,e,t,n){return wa.apply(this,arguments)}function wa(){return(wa=(0,b.A)(function*(r,e,t,n){const i=F(r),s=yield function(u,l){const h=F(u),f=F(h.mutationQueue);return h.persistence.runTransaction("Lookup mutation documents","readonly",_=>f.Mn(_,l).next(p=>p?h.localDocuments.getDocuments(_,p):w.resolve(null)))}(i.localStore,e);var l;null!==s?("pending"===t?yield Un(i.remoteStore):"acknowledged"===t||"rejected"===t?(pa(i,e,n||null),ga(i,e),l=e,F(F(i.localStore).mutationQueue).On(l)):L(),yield lt(i,s)):N("SyncEngine","Cannot apply mutation batch with id: "+e)})).apply(this,arguments)}function Ra(){return(Ra=(0,b.A)(function*(r,e){const t=F(r);if(Hi(t),ba(t),!0===e&&!0!==t.Qa){const n=t.sharedClientState.getAllActiveQueryTargets(),i=yield kh(t,n.toArray());t.Qa=!0,yield Wo(t.remoteStore,!0);for(const s of i)Wi(t.remoteStore,s)}else if(!1===e&&!1!==t.Qa){const n=[];let i=Promise.resolve();t.Ma.forEach((s,a)=>{t.sharedClientState.isLocalQueryTarget(a)?n.push(a):i=i.then(()=>(Kn(t,a),On(t.localStore,a,!0))),Bn(t.remoteStore,a)}),yield i,yield kh(t,n),function(a){const u=F(a);u.Na.forEach((l,h)=>{Bn(u.remoteStore,h)}),u.La.pr(),u.Na=new Map,u.Oa=new se(O.comparator)}(t),t.Qa=!1,yield Wo(t.remoteStore,!1)}})).apply(this,arguments)}function kh(r,e,t){return Pa.apply(this,arguments)}function Pa(){return(Pa=(0,b.A)(function*(r,e,t){const n=F(r),i=[],s=[];for(const a of e){let u;const l=n.Ma.get(a);if(l&&0!==l.length){u=yield Mn(n.localStore,be(l[0]));for(const h of l){const f=n.Fa.get(h),_=yield Rg(n,f);_.snapshot&&s.push(_.snapshot)}}else{const h=yield ah(n.localStore,a);u=yield Mn(n.localStore,h),yield oa(n,Fh(h),a,!1,u.resumeToken)}i.push(u)}return n.Ca.d_(s),i})).apply(this,arguments)}function Fh(r){return kl(r.path,r.collectionGroup,r.orderBy,r.filters,r.limit,"F",r.startAt,r.endAt)}function bg(r){return t=F(r).localStore,F(F(t).persistence).Qi();var t}function xg(r,e,t,n){return Va.apply(this,arguments)}function Va(){return(Va=(0,b.A)(function*(r,e,t,n){const i=F(r);if(i.Qa)return void N("SyncEngine","Ignoring unexpected query state notification.");const s=i.Ma.get(e);if(s&&s.length>0)switch(t){case"current":case"not-current":{const a=yield uh(i.localStore,Bl(s[0])),u=vr.createSynthesizedRemoteEventForCurrentChange(e,"current"===t,me.EMPTY_BYTE_STRING);yield lt(i,a,u);break}case"rejected":yield On(i.localStore,e,!0),Kn(i,e,n);break;default:L()}})).apply(this,arguments)}function Cg(r,e,t){return Sa.apply(this,arguments)}function Sa(){return(Sa=(0,b.A)(function*(r,e,t){const n=Hi(r);if(n.Qa){for(const i of e){if(n.Ma.has(i)&&n.sharedClientState.isActiveQueryTarget(i)){N("SyncEngine","Adding an already active target "+i);continue}const s=yield ah(n.localStore,i),a=yield Mn(n.localStore,s);yield oa(n,Fh(s),a.targetId,!1,a.resumeToken),Wi(n.remoteStore,a)}for(const i of t)n.Ma.has(i)&&(yield On(n.localStore,i,!1).then(()=>{Bn(n.remoteStore,i),Kn(n,i)}).catch(yt))}})).apply(this,arguments)}function Hi(r){const e=F(r);return e.remoteStore.remoteSyncer.applyRemoteEvent=Ch.bind(null,e),e.remoteStore.remoteSyncer.getRemoteKeysForTarget=wg.bind(null,e),e.remoteStore.remoteSyncer.rejectListen=yg.bind(null,e),e.Ca.d_=og.bind(null,e.eventManager),e.Ca.$a=ag.bind(null,e.eventManager),e}function ba(r){const e=F(r);return e.remoteStore.remoteSyncer.applySuccessfulWrite=Ig.bind(null,e),e.remoteStore.remoteSyncer.rejectFailedWrite=Tg.bind(null,e),e}let Ji=(()=>{class r{constructor(){this.kind="memory",this.synchronizeTabs=!1}initialize(t){var n=this;return(0,b.A)(function*(){n.serializer=Nr(t.databaseInfo.databaseId),n.sharedClientState=n.Wa(t),n.persistence=n.Ga(t),yield n.persistence.start(),n.localStore=n.za(t),n.gcScheduler=n.ja(t,n.localStore),n.indexBackfillerScheduler=n.Ha(t,n.localStore)})()}ja(t,n){return null}Ha(t,n){return null}za(t){return rh(this.persistence,new nh,t.initialUser,this.serializer)}Ga(t){return new go(Bi.Zr,this.serializer)}Wa(t){return new dh}terminate(){var t=this;return(0,b.A)(function*(){var n,i;null===(n=t.gcScheduler)||void 0===n||n.stop(),null===(i=t.indexBackfillerScheduler)||void 0===i||i.stop(),t.sharedClientState.shutdown(),yield t.persistence.shutdown()})()}}return r.provider={build:()=>new r},r})();class xa extends Ji{constructor(e){super(),this.cacheSizeBytes=e}ja(e,t){return B(this.persistence.referenceDelegate instanceof Ui),new Wc(this.persistence.referenceDelegate.garbageCollector,e.asyncQueue,t)}Ga(e){const t=void 0!==this.cacheSizeBytes?xe.withCacheSize(this.cacheSizeBytes):xe.DEFAULT;return new go(n=>Ui.Zr(n,t),this.serializer)}}class Ca extends Ji{constructor(e,t,n){super(),this.Ja=e,this.cacheSizeBytes=t,this.forceOwnership=n,this.kind="persistent",this.synchronizeTabs=!1}initialize(e){var t=()=>super.initialize,n=this;return(0,b.A)(function*(){yield t().call(n,e),yield n.Ja.initialize(n,e),yield ba(n.Ja.syncEngine),yield Un(n.Ja.remoteStore),yield n.persistence.yi(()=>(n.gcScheduler&&!n.gcScheduler.started&&n.gcScheduler.start(),n.indexBackfillerScheduler&&!n.indexBackfillerScheduler.started&&n.indexBackfillerScheduler.start(),Promise.resolve()))})()}za(e){return rh(this.persistence,new nh,e.initialUser,this.serializer)}ja(e,t){return new Wc(this.persistence.referenceDelegate.garbageCollector,e.asyncQueue,t)}Ha(e,t){const n=new em(t,this.persistence);return new Zf(e.asyncQueue,n)}Ga(e){const t=Io(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey),n=void 0!==this.cacheSizeBytes?xe.withCacheSize(this.cacheSizeBytes):xe.DEFAULT;return new yo(this.synchronizeTabs,t,e.clientId,n,e.asyncQueue,mh(),ji(),this.serializer,this.sharedClientState,!!this.forceOwnership)}Wa(e){return new dh}}class Mh extends Ca{constructor(e,t){super(e,t,!1),this.Ja=e,this.cacheSizeBytes=t,this.synchronizeTabs=!0}initialize(e){var t=()=>super.initialize,n=this;return(0,b.A)(function*(){yield t().call(n,e);const i=n.Ja.syncEngine;n.sharedClientState instanceof So&&(n.sharedClientState.syncEngine={no:Vg.bind(null,i),ro:xg.bind(null,i),io:Cg.bind(null,i),Qi:bg.bind(null,i),eo:Pg.bind(null,i)},yield n.sharedClientState.start()),yield n.persistence.yi(function(){var s=(0,b.A)(function*(a){yield function Sg(r,e){return Ra.apply(this,arguments)}(n.Ja.syncEngine,a),n.gcScheduler&&(a&&!n.gcScheduler.started?n.gcScheduler.start():a||n.gcScheduler.stop()),n.indexBackfillerScheduler&&(a&&!n.indexBackfillerScheduler.started?n.indexBackfillerScheduler.start():a||n.indexBackfillerScheduler.stop())});return function(a){return s.apply(this,arguments)}}())})()}Wa(e){const t=mh();if(!So.D(t))throw new C(V.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");const n=Io(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey);return new So(t,e.asyncQueue,n,e.clientId,e.initialUser)}}let jn=(()=>{class r{initialize(t,n){var i=this;return(0,b.A)(function*(){i.localStore||(i.localStore=t.localStore,i.sharedClientState=t.sharedClientState,i.datastore=i.createDatastore(n),i.remoteStore=i.createRemoteStore(n),i.eventManager=i.createEventManager(n),i.syncEngine=i.createSyncEngine(n,!t.synchronizeTabs),i.sharedClientState.onlineStateHandler=s=>Dh(i.syncEngine,s,1),i.remoteStore.remoteSyncer.handleCredentialChange=Ag.bind(null,i.syncEngine),yield Wo(i.remoteStore,i.syncEngine.isPrimaryClient))})()}createEventManager(t){return new sg}createDatastore(t){const n=Nr(t.databaseInfo.databaseId),i=new z_(t.databaseInfo);return new K_(t.authCredentials,t.appCheckCredentials,i,n)}createRemoteStore(t){return i=this.localStore,s=this.datastore,a=t.asyncQueue,u=n=>Dh(this.syncEngine,n,0),l=fh.D()?new fh:new B_,new W_(i,s,a,u,l);var i,s,a,u,l}createSyncEngine(t,n){return function(s,a,u,l,h,f,_){const p=new dg(s,a,u,l,h,f);return _&&(p.Qa=!0),p}(this.localStore,this.remoteStore,this.eventManager,this.sharedClientState,t.initialUser,t.maxConcurrentLimboResolutions,n)}terminate(){var t=this;return(0,b.A)(function*(){var n,i,s;yield(s=(0,b.A)(function*(u){const l=F(u);N("RemoteStore","RemoteStore shutting down."),l.L_.add(5),yield Ln(l),l.k_.shutdown(),l.q_.set("Unknown")}),function a(u){return s.apply(this,arguments)})(t.remoteStore),null===(n=t.datastore)||void 0===n||n.terminate(),null===(i=t.eventManager)||void 0===i||i.terminate()})()}}return r.provider={build:()=>new r},r})();function Oh(r,e=10240){let t=0;return{read:()=>(0,b.A)(function*(){if(t<r.byteLength){const n={value:r.slice(t,t+e),done:!1};return t+=e,n}return{done:!0}})(),cancel:()=>(0,b.A)(function*(){})(),releaseLock(){},closed:Promise.resolve()}}class Yi{constructor(e){this.observer=e,this.muted=!1}next(e){this.muted||this.observer.next&&this.Ya(this.observer.next,e)}error(e){this.muted||(this.observer.error?this.Ya(this.observer.error,e):pe("Uncaught Error in snapshot listener:",e.toString()))}Za(){this.muted=!0}Ya(e,t){setTimeout(()=>{this.muted||e(t)},0)}}class Ng{constructor(e,t){this.Xa=e,this.serializer=t,this.metadata=new ve,this.buffer=new Uint8Array,this.eu=new TextDecoder("utf-8"),this.tu().then(n=>{n&&n.ua()?this.metadata.resolve(n.aa.metadata):this.metadata.reject(new Error(`The first element of the bundle is not a metadata, it is\n             ${JSON.stringify(null==n?void 0:n.aa)}`))},n=>this.metadata.reject(n))}close(){return this.Xa.cancel()}getMetadata(){var e=this;return(0,b.A)(function*(){return e.metadata.promise})()}Ua(){var e=this;return(0,b.A)(function*(){return yield e.getMetadata(),e.tu()})()}tu(){var e=this;return(0,b.A)(function*(){const t=yield e.nu();if(null===t)return null;const n=e.eu.decode(t),i=Number(n);isNaN(i)&&e.ru(`length string (${n}) is not valid number`);const s=yield e.iu(i);return new ug(JSON.parse(s),t.length+i)})()}su(){return this.buffer.findIndex(e=>123===e)}nu(){var e=this;return(0,b.A)(function*(){for(;e.su()<0&&!(yield e.ou()););if(0===e.buffer.length)return null;const t=e.su();t<0&&e.ru("Reached the end of bundle when a length string is expected.");const n=e.buffer.slice(0,t);return e.buffer=e.buffer.slice(t),n})()}iu(e){var t=this;return(0,b.A)(function*(){for(;t.buffer.length<e;)(yield t.ou())&&t.ru("Reached the end of bundle when more is expected.");const n=t.eu.decode(t.buffer.slice(0,e));return t.buffer=t.buffer.slice(e),n})()}ru(e){throw this.Xa.cancel(),new Error(`Invalid bundle format: ${e}`)}ou(){var e=this;return(0,b.A)(function*(){const t=yield e.Xa.read();if(!t.done){const n=new Uint8Array(e.buffer.length+t.value.length);n.set(e.buffer),n.set(t.value,e.buffer.length),e.buffer=n}return t.done})()}}class kg{constructor(e){this.datastore=e,this.readVersions=new Map,this.mutations=[],this.committed=!1,this.lastTransactionError=null,this.writtenDocs=new Set}lookup(e){var t=this;return(0,b.A)(function*(){if(t.ensureCommitNotCalled(),t.mutations.length>0)throw t.lastTransactionError=new C(V.INVALID_ARGUMENT,"Firestore transactions require all reads to be executed before all writes."),t.lastTransactionError;const n=yield(i=(0,b.A)(function*(a,u){const l=F(a),h={documents:u.map(R=>wr(l.serializer,R))},f=yield l.Lo("BatchGetDocuments",l.serializer.databaseId,H.emptyPath(),h,u.length),_=new Map;f.forEach(R=>{const x=function Xm(r,e){return"found"in e?function(n,i){B(!!i.found);const s=Ze(n,i.found.name),a=ye(i.found.updateTime),u=i.found.createTime?ye(i.found.createTime):z.min(),l=new Re({mapValue:{fields:i.found.fields}});return ae.newFoundDocument(s,a,u,l)}(r,e):"missing"in e?function(n,i){B(!!i.missing),B(!!i.readTime);const s=Ze(n,i.missing),a=ye(i.readTime);return ae.newNoDocument(s,a)}(r,e):L()}(l.serializer,R);_.set(x.key.toString(),x)});const p=[];return u.forEach(R=>{const x=_.get(R.toString());B(!!x),p.push(x)}),p}),function s(a,u){return i.apply(this,arguments)})(t.datastore,e);var i;return n.forEach(i=>t.recordVersion(i)),n})()}set(e,t){this.write(t.toMutation(e,this.precondition(e))),this.writtenDocs.add(e.toString())}update(e,t){try{this.write(t.toMutation(e,this.preconditionForUpdate(e)))}catch(n){this.lastTransactionError=n}this.writtenDocs.add(e.toString())}delete(e){this.write(new bn(e,this.precondition(e))),this.writtenDocs.add(e.toString())}commit(){var e=this;return(0,b.A)(function*(){if(e.ensureCommitNotCalled(),e.lastTransactionError)throw e.lastTransactionError;const t=e.readVersions;var n;e.mutations.forEach(n=>{t.delete(n.key.toString())}),t.forEach((n,i)=>{const s=O.fromPath(i);e.mutations.push(new Ys(s,e.precondition(s)))}),yield(n=(0,b.A)(function*(s,a){const u=F(s),l={writes:a.map(h=>Rr(u.serializer,h))};yield u.Mo("Commit",u.serializer.databaseId,H.emptyPath(),l)}),function i(s,a){return n.apply(this,arguments)})(e.datastore,e.mutations),e.committed=!0})()}recordVersion(e){let t;if(e.isFoundDocument())t=e.version;else{if(!e.isNoDocument())throw L();t=z.min()}const n=this.readVersions.get(e.key.toString());if(n){if(!t.isEqual(n))throw new C(V.ABORTED,"Document version changed between two reads.")}else this.readVersions.set(e.key.toString(),t)}precondition(e){const t=this.readVersions.get(e.toString());return!this.writtenDocs.has(e.toString())&&t?t.isEqual(z.min())?de.exists(!1):de.updateTime(t):de.none()}preconditionForUpdate(e){const t=this.readVersions.get(e.toString());if(!this.writtenDocs.has(e.toString())&&t){if(t.isEqual(z.min()))throw new C(V.INVALID_ARGUMENT,"Can't update a document that doesn't exist.");return de.updateTime(t)}return de.exists(!0)}write(e){this.ensureCommitNotCalled(),this.mutations.push(e)}ensureCommitNotCalled(){}}class Fg{constructor(e,t,n,i,s){this.asyncQueue=e,this.datastore=t,this.options=n,this.updateFunction=i,this.deferred=s,this._u=n.maxAttempts,this.t_=new xo(this.asyncQueue,"transaction_retry")}au(){this._u-=1,this.uu()}uu(){var e=this;this.t_.Go((0,b.A)(function*(){const t=new kg(e.datastore),n=e.cu(t);n&&n.then(i=>{e.asyncQueue.enqueueAndForget(()=>t.commit().then(()=>{e.deferred.resolve(i)}).catch(s=>{e.lu(s)}))}).catch(i=>{e.lu(i)})}))}cu(e){try{const t=this.updateFunction(e);return!ar(t)&&t.catch&&t.then?t:(this.deferred.reject(Error("Transaction callback must return a Promise")),null)}catch(t){return this.deferred.reject(t),null}}lu(e){this._u>0&&this.hu(e)?(this._u-=1,this.asyncQueue.enqueueAndForget(()=>(this.uu(),Promise.resolve()))):this.deferred.reject(e)}hu(e){if("FirebaseError"===e.name){const t=e.code;return"aborted"===t||"failed-precondition"===t||"already-exists"===t||!rc(t)}return!1}}class Mg{constructor(e,t,n,i,s){var a=this;this.authCredentials=e,this.appCheckCredentials=t,this.asyncQueue=n,this.databaseInfo=i,this.user=Ee.UNAUTHENTICATED,this.clientId=Qu.newId(),this.authCredentialListener=()=>Promise.resolve(),this.appCheckCredentialListener=()=>Promise.resolve(),this._uninitializedComponentsProvider=s,this.authCredentials.start(n,function(){var u=(0,b.A)(function*(l){N("FirestoreClient","Received user=",l.uid),yield a.authCredentialListener(l),a.user=l});return function(l){return u.apply(this,arguments)}}()),this.appCheckCredentials.start(n,u=>(N("FirestoreClient","Received new app check token=",u),this.appCheckCredentialListener(u,this.user)))}get configuration(){return{asyncQueue:this.asyncQueue,databaseInfo:this.databaseInfo,clientId:this.clientId,authCredentials:this.authCredentials,appCheckCredentials:this.appCheckCredentials,initialUser:this.user,maxConcurrentLimboResolutions:100}}setCredentialChangeListener(e){this.authCredentialListener=e}setAppCheckTokenChangeListener(e){this.appCheckCredentialListener=e}terminate(){var e=this;this.asyncQueue.enterRestrictedMode();const t=new ve;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted((0,b.A)(function*(){try{e._onlineComponents&&(yield e._onlineComponents.terminate()),e._offlineComponents&&(yield e._offlineComponents.terminate()),e.authCredentials.shutdown(),e.appCheckCredentials.shutdown(),t.resolve()}catch(n){const i=zn(n,"Failed to shutdown persistence");t.reject(i)}})),t.promise}}function Da(r,e){return Na.apply(this,arguments)}function Na(){return Na=(0,b.A)(function*(r,e){r.asyncQueue.verifyOperationInProgress(),N("FirestoreClient","Initializing OfflineComponentProvider");const t=r.configuration;yield e.initialize(t);let n=t.initialUser;r.setCredentialChangeListener(function(){var i=(0,b.A)(function*(s){n.isEqual(s)||(yield ih(e.localStore,s),n=s)});return function(s){return i.apply(this,arguments)}}()),e.persistence.setDatabaseDeletedListener(()=>r.terminate()),r._offlineComponents=e}),Na.apply(this,arguments)}function Lh(r,e){return ka.apply(this,arguments)}function ka(){return(ka=(0,b.A)(function*(r,e){r.asyncQueue.verifyOperationInProgress();const t=yield Fa(r);N("FirestoreClient","Initializing OnlineComponentProvider"),yield e.initialize(t,r.configuration),r.setCredentialChangeListener(n=>Eh(e.remoteStore,n)),r.setAppCheckTokenChangeListener((n,i)=>Eh(e.remoteStore,i)),r._onlineComponents=e})).apply(this,arguments)}function Fa(r){return Ma.apply(this,arguments)}function Ma(){return(Ma=(0,b.A)(function*(r){if(!r._offlineComponents)if(r._uninitializedComponentsProvider){N("FirestoreClient","Using user provided OfflineComponentProvider");try{yield Da(r,r._uninitializedComponentsProvider._offline)}catch(e){if(!("FirebaseError"===(i=e).name?i.code===V.FAILED_PRECONDITION||i.code===V.UNIMPLEMENTED:!(typeof DOMException<"u"&&i instanceof DOMException)||22===i.code||20===i.code||11===i.code))throw e;ze("Error using user provided cache. Falling back to memory cache: "+e),yield Da(r,new Ji)}}else N("FirestoreClient","Using default OfflineComponentProvider"),yield Da(r,new xa(void 0));var i;return r._offlineComponents})).apply(this,arguments)}function Xi(r){return Oa.apply(this,arguments)}function Oa(){return(Oa=(0,b.A)(function*(r){return r._onlineComponents||(r._uninitializedComponentsProvider?(N("FirestoreClient","Using user provided OnlineComponentProvider"),yield Lh(r,r._uninitializedComponentsProvider._online)):(N("FirestoreClient","Using default OnlineComponentProvider"),yield Lh(r,new jn))),r._onlineComponents})).apply(this,arguments)}function Bh(r){return Fa(r).then(e=>e.persistence)}function Wn(r){return Fa(r).then(e=>e.localStore)}function Uh(r){return Xi(r).then(e=>e.remoteStore)}function La(r){return Xi(r).then(e=>e.syncEngine)}function Qn(r){return Ba.apply(this,arguments)}function Ba(){return(Ba=(0,b.A)(function*(r){const e=yield Xi(r),t=e.eventManager;return t.onListen=fg.bind(null,e.syncEngine),t.onUnlisten=_g.bind(null,e.syncEngine),t.onFirstRemoteStoreListen=mg.bind(null,e.syncEngine),t.onLastRemoteStoreUnlisten=gg.bind(null,e.syncEngine),t})).apply(this,arguments)}function zh(r,e,t={}){const n=new ve;return r.asyncQueue.enqueueAndForget((0,b.A)(function*(){return function(s,a,u,l,h){const f=new Yi({next:p=>{f.Za(),a.enqueueAndForget(()=>Xo(s,_));const R=p.docs.has(u);!R&&p.fromCache?h.reject(new C(V.UNAVAILABLE,"Failed to get document because the client is offline.")):R&&p.fromCache&&l&&"server"===l.source?h.reject(new C(V.UNAVAILABLE,'Failed to get document from server. (However, this document does exist in the local cache. Run again without setting source to "server" to retrieve the cached document.)')):h.resolve(p)},error:p=>h.reject(p)}),_=new na(An(u.path),f,{includeMetadataChanges:!0,_a:!0});return Jo(s,_)}(yield Qn(r),r.asyncQueue,e,t,n)})),n.promise}function $h(r,e,t={}){const n=new ve;return r.asyncQueue.enqueueAndForget((0,b.A)(function*(){return function(s,a,u,l,h){const f=new Yi({next:p=>{f.Za(),a.enqueueAndForget(()=>Xo(s,_)),p.fromCache&&"server"===l.source?h.reject(new C(V.UNAVAILABLE,'Failed to get documents from server. (However, these documents may exist in the local cache. Run again without setting source to "server" to retrieve the cached documents.)')):h.resolve(p)},error:p=>h.reject(p)}),_=new na(u,f,{includeMetadataChanges:!0,_a:!0});return Jo(s,_)}(yield Qn(r),r.asyncQueue,e,t,n)})),n.promise}function Gh(r){const e={};return void 0!==r.timeoutSeconds&&(e.timeoutSeconds=r.timeoutSeconds),e}const Kh=new Map;function Ua(r,e,t){if(!t)throw new C(V.INVALID_ARGUMENT,`Function ${r}() cannot be called with an empty ${e}.`)}function jh(r,e,t,n){if(!0===e&&!0===n)throw new C(V.INVALID_ARGUMENT,`${r} and ${t} cannot be used together.`)}function Wh(r){if(!O.isDocumentKey(r))throw new C(V.INVALID_ARGUMENT,`Invalid document reference. Document references must have an even number of segments, but ${r} has ${r.length}.`)}function Qh(r){if(O.isDocumentKey(r))throw new C(V.INVALID_ARGUMENT,`Invalid collection reference. Collection references must have an odd number of segments, but ${r} has ${r.length}.`)}function Zi(r){if(void 0===r)return"undefined";if(null===r)return"null";if("string"==typeof r)return r.length>20&&(r=`${r.substring(0,20)}...`),JSON.stringify(r);if("number"==typeof r||"boolean"==typeof r)return""+r;if("object"==typeof r){if(r instanceof Array)return"an array";{const e=(n=r).constructor?n.constructor.name:null;return e?`a custom ${e} object`:"an object"}}var n;return"function"==typeof r?"a function":L()}function Q(r,e){if("_delegate"in r&&(r=r._delegate),!(r instanceof e)){if(e.name===r.constructor.name)throw new C(V.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");{const t=Zi(r);throw new C(V.INVALID_ARGUMENT,`Expected type '${e.name}', but it was: ${t}`)}}return r}function Hh(r,e){if(e<=0)throw new C(V.INVALID_ARGUMENT,`Function ${r}() requires a positive number, but it was: ${e}.`)}class Jh{constructor(e){var t,n;if(void 0===e.host){if(void 0!==e.ssl)throw new C(V.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host="firestore.googleapis.com",this.ssl=!0}else this.host=e.host,this.ssl=null===(t=e.ssl)||void 0===t||t;if(this.credentials=e.credentials,this.ignoreUndefinedProperties=!!e.ignoreUndefinedProperties,this.localCache=e.localCache,void 0===e.cacheSizeBytes)this.cacheSizeBytes=41943040;else{if(-1!==e.cacheSizeBytes&&e.cacheSizeBytes<1048576)throw new C(V.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=e.cacheSizeBytes}jh("experimentalForceLongPolling",e.experimentalForceLongPolling,"experimentalAutoDetectLongPolling",e.experimentalAutoDetectLongPolling),this.experimentalForceLongPolling=!!e.experimentalForceLongPolling,this.experimentalAutoDetectLongPolling=!(this.experimentalForceLongPolling||void 0!==e.experimentalAutoDetectLongPolling&&!e.experimentalAutoDetectLongPolling),this.experimentalLongPollingOptions=Gh(null!==(n=e.experimentalLongPollingOptions)&&void 0!==n?n:{}),function(s){if(void 0!==s.timeoutSeconds){if(isNaN(s.timeoutSeconds))throw new C(V.INVALID_ARGUMENT,`invalid long polling timeout: ${s.timeoutSeconds} (must not be NaN)`);if(s.timeoutSeconds<5)throw new C(V.INVALID_ARGUMENT,`invalid long polling timeout: ${s.timeoutSeconds} (minimum allowed value is 5)`);if(s.timeoutSeconds>30)throw new C(V.INVALID_ARGUMENT,`invalid long polling timeout: ${s.timeoutSeconds} (maximum allowed value is 30)`)}}(this.experimentalLongPollingOptions),this.useFetchStreams=!!e.useFetchStreams}isEqual(e){return this.host===e.host&&this.ssl===e.ssl&&this.credentials===e.credentials&&this.cacheSizeBytes===e.cacheSizeBytes&&this.experimentalForceLongPolling===e.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===e.experimentalAutoDetectLongPolling&&this.experimentalLongPollingOptions.timeoutSeconds===e.experimentalLongPollingOptions.timeoutSeconds&&this.ignoreUndefinedProperties===e.ignoreUndefinedProperties&&this.useFetchStreams===e.useFetchStreams}}class Fr{constructor(e,t,n,i){this._authCredentials=e,this._appCheckCredentials=t,this._databaseId=n,this._app=i,this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new Jh({}),this._settingsFrozen=!1,this._terminateTask="notTerminated"}get app(){if(!this._app)throw new C(V.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._app}get _initialized(){return this._settingsFrozen}get _terminated(){return"notTerminated"!==this._terminateTask}_setSettings(e){if(this._settingsFrozen)throw new C(V.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new Jh(e),void 0!==e.credentials&&(this._authCredentials=function(n){if(!n)return new qf;switch(n.type){case"firstParty":return new Kf(n.sessionIndex||"0",n.iamToken||null,n.authTokenFactory||null);case"provider":return n.client;default:throw new C(V.INVALID_ARGUMENT,"makeAuthCredentialsProvider failed due to invalid credential type")}}(e.credentials))}_getSettings(){return this._settings}_freezeSettings(){return this._settingsFrozen=!0,this._settings}_delete(){return"notTerminated"===this._terminateTask&&(this._terminateTask=this._terminate()),this._terminateTask}_restart(){var e=this;return(0,b.A)(function*(){"notTerminated"===e._terminateTask?yield e._terminate():e._terminateTask="notTerminated"})()}toJSON(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}}_terminate(){return function(t){const n=Kh.get(t);n&&(N("ComponentProvider","Removing Datastore"),Kh.delete(t),n.terminate())}(this),Promise.resolve()}}class Pe{constructor(e,t,n){this.converter=t,this._query=n,this.type="query",this.firestore=e}withConverter(e){return new Pe(this.firestore,e,this._query)}}class ue{constructor(e,t,n){this.converter=t,this._key=n,this.type="document",this.firestore=e}get _path(){return this._key.path}get id(){return this._key.path.lastSegment()}get path(){return this._key.path.canonicalString()}get parent(){return new et(this.firestore,this.converter,this._key.path.popLast())}withConverter(e){return new ue(this.firestore,e,this._key)}}class et extends Pe{constructor(e,t,n){super(e,t,An(n)),this._path=n,this.type="collection"}get id(){return this._query.path.lastSegment()}get path(){return this._query.path.canonicalString()}get parent(){const e=this._path.popLast();return e.isEmpty()?null:new ue(this.firestore,null,new O(e))}withConverter(e){return new et(this.firestore,e,this._path)}}function Xh(r,e,...t){if(r=(0,ee.Ku)(r),Ua("collection","path",e),r instanceof Fr){const n=H.fromString(e,...t);return Qh(n),new et(r,null,n)}{if(!(r instanceof ue||r instanceof et))throw new C(V.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const n=r._path.child(H.fromString(e,...t));return Qh(n),new et(r.firestore,null,n)}}function es(r,e,...t){if(r=(0,ee.Ku)(r),1===arguments.length&&(e=Qu.newId()),Ua("doc","path",e),r instanceof Fr){const n=H.fromString(e,...t);return Wh(n),new ue(r,null,new O(n))}{if(!(r instanceof ue||r instanceof et))throw new C(V.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const n=r._path.child(H.fromString(e,...t));return Wh(n),new ue(r.firestore,r instanceof et?r.converter:null,new O(n))}}function Zh(r,e){return r=(0,ee.Ku)(r),e=(0,ee.Ku)(e),(r instanceof ue||r instanceof et)&&(e instanceof ue||e instanceof et)&&r.firestore===e.firestore&&r.path===e.path&&r.converter===e.converter}function qa(r,e){return r=(0,ee.Ku)(r),e=(0,ee.Ku)(e),r instanceof Pe&&e instanceof Pe&&r.firestore===e.firestore&&_r(r._query,e._query)&&r.converter===e.converter}class ed{constructor(e=Promise.resolve()){this.Pu=[],this.Iu=!1,this.Tu=[],this.Eu=null,this.du=!1,this.Au=!1,this.Ru=[],this.t_=new xo(this,"async_queue_retry"),this.Vu=()=>{const n=ji();n&&N("AsyncQueue","Visibility state changed to "+n.visibilityState),this.t_.jo()},this.mu=e;const t=ji();t&&"function"==typeof t.addEventListener&&t.addEventListener("visibilitychange",this.Vu)}get isShuttingDown(){return this.Iu}enqueueAndForget(e){this.enqueue(e)}enqueueAndForgetEvenWhileRestricted(e){this.fu(),this.gu(e)}enterRestrictedMode(e){if(!this.Iu){this.Iu=!0,this.Au=e||!1;const t=ji();t&&"function"==typeof t.removeEventListener&&t.removeEventListener("visibilitychange",this.Vu)}}enqueue(e){if(this.fu(),this.Iu)return new Promise(()=>{});const t=new ve;return this.gu(()=>this.Iu&&this.Au?Promise.resolve():(e().then(t.resolve,t.reject),t.promise)).then(()=>t.promise)}enqueueRetryable(e){this.enqueueAndForget(()=>(this.Pu.push(e),this.pu()))}pu(){var e=this;return(0,b.A)(function*(){if(0!==e.Pu.length){try{yield e.Pu[0](),e.Pu.shift(),e.t_.reset()}catch(t){if(!It(t))throw t;N("AsyncQueue","Operation failed with retryable error: "+t)}e.Pu.length>0&&e.t_.Go(()=>e.pu())}})()}gu(e){const t=this.mu.then(()=>(this.du=!0,e().catch(n=>{throw this.Eu=n,this.du=!1,pe("INTERNAL UNHANDLED ERROR: ",function(a){let u=a.message||"";return a.stack&&(u=a.stack.includes(a.message)?a.stack:a.message+"\n"+a.stack),u}(n)),n}).then(n=>(this.du=!1,n))));return this.mu=t,t}enqueueAfterDelay(e,t,n){this.fu(),this.Ru.indexOf(e)>-1&&(t=0);const i=Ho.createAndSchedule(this,e,t,n,s=>this.yu(s));return this.Tu.push(i),i}fu(){this.Eu&&L()}verifyOperationInProgress(){}wu(){var e=this;return(0,b.A)(function*(){let t;do{t=e.mu,yield t}while(t!==e.mu)})()}Su(e){for(const t of this.Tu)if(t.timerId===e)return!0;return!1}bu(e){return this.wu().then(()=>{this.Tu.sort((t,n)=>t.targetTimeMs-n.targetTimeMs);for(const t of this.Tu)if(t.skipDelay(),"all"!==e&&t.timerId===e)break;return this.wu()})}Du(e){this.Ru.push(e)}yu(e){const t=this.Tu.indexOf(e);this.Tu.splice(t,1)}}function za(r){return function(t){if("object"!=typeof t||null===t)return!1;const i=t;for(const s of["next","error","complete"])if(s in i&&"function"==typeof i[s])return!0;return!1}(r)}class Hg{constructor(){this._progressObserver={},this._taskCompletionResolver=new ve,this._lastProgress={taskState:"Running",totalBytes:0,totalDocuments:0,bytesLoaded:0,documentsLoaded:0}}onProgress(e,t,n){this._progressObserver={next:e,error:t,complete:n}}catch(e){return this._taskCompletionResolver.promise.catch(e)}then(e,t){return this._taskCompletionResolver.promise.then(e,t)}_completeWith(e){this._updateProgress(e),this._progressObserver.complete&&this._progressObserver.complete(),this._taskCompletionResolver.resolve(e)}_failWith(e){this._lastProgress.taskState="Error",this._progressObserver.next&&this._progressObserver.next(this._lastProgress),this._progressObserver.error&&this._progressObserver.error(e),this._taskCompletionResolver.reject(e)}_updateProgress(e){this._lastProgress=e,this._progressObserver.next&&this._progressObserver.next(e)}}class re extends Fr{constructor(e,t,n,i){super(e,t,n,i),this.type="firestore",this._queue=new ed,this._persistenceKey=(null==i?void 0:i.name)||"[DEFAULT]"}_terminate(){var e=this;return(0,b.A)(function*(){if(e._firestoreClient){const t=e._firestoreClient.terminate();e._queue=new ed(t),e._firestoreClient=void 0,yield t}})()}}function fe(r){if(r._terminated)throw new C(V.FAILED_PRECONDITION,"The client has already been terminated.");return r._firestoreClient||td(r),r._firestoreClient}function td(r){var e,t,n;const i=r._freezeSettings(),s=(l=(null===(e=r._app)||void 0===e?void 0:e.options.appId)||"",new vm(r._databaseId,l,r._persistenceKey,(f=i).host,f.ssl,f.experimentalForceLongPolling,f.experimentalAutoDetectLongPolling,Gh(f.experimentalLongPollingOptions),f.useFetchStreams));var l,f;r._componentsProvider||!(null===(t=i.localCache)||void 0===t)&&t._offlineComponentProvider&&!(null===(n=i.localCache)||void 0===n)&&n._onlineComponentProvider&&(r._componentsProvider={_offline:i.localCache._offlineComponentProvider,_online:i.localCache._onlineComponentProvider}),r._firestoreClient=new Mg(r._authCredentials,r._appCheckCredentials,r._queue,s,r._componentsProvider&&function(u){const l=null==u?void 0:u._online.build();return{_offline:null==u?void 0:u._offline.build(l),_online:l}}(r._componentsProvider))}function $a(){return($a=(0,b.A)(function*(r){ze("enableMultiTabIndexedDbPersistence() will be deprecated in the future, you can use `FirestoreSettings.cache` instead.");const e=r._freezeSettings();nd(r,jn.provider,{build:t=>new Mh(t,e.cacheSizeBytes)})})).apply(this,arguments)}function nd(r,e,t){if((r=Q(r,re))._firestoreClient||r._terminated)throw new C(V.FAILED_PRECONDITION,"Firestore has already been started and persistence can no longer be enabled. You can only enable persistence before calling any other methods on a Firestore object.");if(r._componentsProvider||r._getSettings().localCache)throw new C(V.FAILED_PRECONDITION,"SDK cache is already specified.");r._componentsProvider={_online:e,_offline:t},td(r)}class tt{constructor(e){this._byteString=e}static fromBase64String(e){try{return new tt(me.fromBase64String(e))}catch(t){throw new C(V.INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+t)}}static fromUint8Array(e){return new tt(me.fromUint8Array(e))}toBase64(){return this._byteString.toBase64()}toUint8Array(){return this._byteString.toUint8Array()}toString(){return"Bytes(base64: "+this.toBase64()+")"}isEqual(e){return this._byteString.isEqual(e._byteString)}}class ct{constructor(...e){for(let t=0;t<e.length;++t)if(0===e[t].length)throw new C(V.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new oe(e)}isEqual(e){return this._internalPath.isEqual(e._internalPath)}}class tn{constructor(e){this._methodName=e}}class ts{constructor(e,t){if(!isFinite(e)||e<-90||e>90)throw new C(V.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+e);if(!isFinite(t)||t<-180||t>180)throw new C(V.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+t);this._lat=e,this._long=t}get latitude(){return this._lat}get longitude(){return this._long}isEqual(e){return this._lat===e._lat&&this._long===e._long}toJSON(){return{latitude:this._lat,longitude:this._long}}_compareTo(e){return G(this._lat,e._lat)||G(this._long,e._long)}}class ns{constructor(e){this._values=(e||[]).map(t=>t)}toArray(){return this._values.map(e=>e)}isEqual(e){return function(n,i){if(n.length!==i.length)return!1;for(let s=0;s<n.length;++s)if(n[s]!==i[s])return!1;return!0}(this._values,e._values)}}const op=/^__.*__$/;class ap{constructor(e,t,n){this.data=e,this.fieldMask=t,this.fieldTransforms=n}toMutation(e,t){return null!==this.fieldMask?new at(e,this.data,this.fieldMask,t,this.fieldTransforms):new Sn(e,this.data,t,this.fieldTransforms)}}class rd{constructor(e,t,n){this.data=e,this.fieldMask=t,this.fieldTransforms=n}toMutation(e,t){return new at(e,this.data,this.fieldMask,t,this.fieldTransforms)}}function id(r){switch(r){case 0:case 2:case 1:return!0;case 3:case 4:return!1;default:throw L()}}class rs{constructor(e,t,n,i,s,a){this.settings=e,this.databaseId=t,this.serializer=n,this.ignoreUndefinedProperties=i,void 0===s&&this.vu(),this.fieldTransforms=s||[],this.fieldMask=a||[]}get path(){return this.settings.path}get Cu(){return this.settings.Cu}Fu(e){return new rs(Object.assign(Object.assign({},this.settings),e),this.databaseId,this.serializer,this.ignoreUndefinedProperties,this.fieldTransforms,this.fieldMask)}Mu(e){var t;const n=null===(t=this.path)||void 0===t?void 0:t.child(e),i=this.Fu({path:n,xu:!1});return i.Ou(e),i}Nu(e){var t;const n=null===(t=this.path)||void 0===t?void 0:t.child(e),i=this.Fu({path:n,xu:!1});return i.vu(),i}Lu(e){return this.Fu({path:void 0,xu:!0})}Bu(e){return os(e,this.settings.methodName,this.settings.ku||!1,this.path,this.settings.qu)}contains(e){return void 0!==this.fieldMask.find(t=>e.isPrefixOf(t))||void 0!==this.fieldTransforms.find(t=>e.isPrefixOf(t.field))}vu(){if(this.path)for(let e=0;e<this.path.length;e++)this.Ou(this.path.get(e))}Ou(e){if(0===e.length)throw this.Bu("Document fields must not be empty");if(id(this.Cu)&&op.test(e))throw this.Bu('Document fields cannot begin and end with "__"')}}class up{constructor(e,t,n){this.databaseId=e,this.ignoreUndefinedProperties=t,this.serializer=n||Nr(e)}Qu(e,t,n,i=!1){return new rs({Cu:e,methodName:t,qu:n,path:oe.emptyPath(),xu:!1,ku:i},this.databaseId,this.serializer,this.ignoreUndefinedProperties)}}function nn(r){const e=r._freezeSettings(),t=Nr(r._databaseId);return new up(r._databaseId,!!e.ignoreUndefinedProperties,t)}function is(r,e,t,n,i,s={}){const a=r.Qu(s.merge||s.mergeFields?2:0,e,t,i);Ja("Data must be an object, but it was:",a,n);const u=ad(n,a);let l,h;if(s.merge)l=new Ue(a.fieldMask),h=a.fieldTransforms;else if(s.mergeFields){const f=[];for(const _ of s.mergeFields){const p=Lr(e,_,t);if(!a.contains(p))throw new C(V.INVALID_ARGUMENT,`Field '${p}' is specified in your field mask but missing from your input data.`);ld(f,p)||f.push(p)}l=new Ue(f),h=a.fieldTransforms.filter(_=>l.covers(_.field))}else l=null,h=a.fieldTransforms;return new ap(new Re(u),l,h)}class Or extends tn{_toFieldTransform(e){if(2!==e.Cu)throw e.Bu(1===e.Cu?`${this._methodName}() can only appear at the top level of your update data`:`${this._methodName}() cannot be used with set() unless you pass {merge:true}`);return e.fieldMask.push(e.path),null}isEqual(e){return e instanceof Or}}function sd(r,e,t){return new rs({Cu:3,qu:e.settings.qu,methodName:r._methodName,xu:t},e.databaseId,e.serializer,e.ignoreUndefinedProperties)}class Ga extends tn{_toFieldTransform(e){return new Ir(e.path,new Pn)}isEqual(e){return e instanceof Ga}}class Ka extends tn{constructor(e,t){super(e),this.Ku=t}_toFieldTransform(e){const t=sd(this,e,!0),n=this.Ku.map(s=>rn(s,t)),i=new jt(n);return new Ir(e.path,i)}isEqual(e){return e instanceof Ka&&(0,ee.bD)(this.Ku,e.Ku)}}class ja extends tn{constructor(e,t){super(e),this.Ku=t}_toFieldTransform(e){const t=sd(this,e,!0),n=this.Ku.map(s=>rn(s,t)),i=new Wt(n);return new Ir(e.path,i)}isEqual(e){return e instanceof ja&&(0,ee.bD)(this.Ku,e.Ku)}}class Wa extends tn{constructor(e,t){super(e),this.$u=t}_toFieldTransform(e){const t=new Vn(e.serializer,Kl(e.serializer,this.$u));return new Ir(e.path,t)}isEqual(e){return e instanceof Wa&&this.$u===e.$u}}function Qa(r,e,t,n){const i=r.Qu(1,e,t);Ja("Data must be an object, but it was:",i,n);const s=[],a=Re.empty();Tt(n,(l,h)=>{const f=ss(e,l,t);h=(0,ee.Ku)(h);const _=i.Nu(f);if(h instanceof Or)s.push(f);else{const p=rn(h,_);null!=p&&(s.push(f),a.set(f,p))}});const u=new Ue(s);return new rd(a,u,i.fieldTransforms)}function Ha(r,e,t,n,i,s){const a=r.Qu(1,e,t),u=[Lr(e,n,t)],l=[i];if(s.length%2!=0)throw new C(V.INVALID_ARGUMENT,`Function ${e}() needs to be called with an even number of arguments that alternate between field names and values.`);for(let p=0;p<s.length;p+=2)u.push(Lr(e,s[p])),l.push(s[p+1]);const h=[],f=Re.empty();for(let p=u.length-1;p>=0;--p)if(!ld(h,u[p])){const R=u[p];let x=l[p];x=(0,ee.Ku)(x);const k=a.Nu(R);if(x instanceof Or)h.push(R);else{const D=rn(x,k);null!=D&&(h.push(R),f.set(R,D))}}const _=new Ue(h);return new rd(f,_,a.fieldTransforms)}function od(r,e,t,n=!1){return rn(t,r.Qu(n?4:3,e))}function rn(r,e){if(ud(r=(0,ee.Ku)(r)))return Ja("Unsupported field value:",e,r),ad(r,e);if(r instanceof tn)return function(n,i){if(!id(i.Cu))throw i.Bu(`${n._methodName}() can only be used with update() and set()`);if(!i.path)throw i.Bu(`${n._methodName}() is not currently supported inside arrays`);const s=n._toFieldTransform(i);s&&i.fieldTransforms.push(s)}(r,e),null;if(void 0===r&&e.ignoreUndefinedProperties)return null;if(e.path&&e.fieldMask.push(e.path),r instanceof Array){if(e.settings.xu&&4!==e.Cu)throw e.Bu("Nested arrays are not supported");return function(n,i){const s=[];let a=0;for(const u of n){let l=rn(u,i.Lu(a));null==l&&(l={nullValue:"NULL_VALUE"}),s.push(l),a++}return{arrayValue:{values:s}}}(r,e)}return function(n,i){if(null===(n=(0,ee.Ku)(n)))return{nullValue:"NULL_VALUE"};if("number"==typeof n)return Kl(i.serializer,n);if("boolean"==typeof n)return{booleanValue:n};if("string"==typeof n)return{stringValue:n};if(n instanceof Date){const s=ce.fromDate(n);return{timestampValue:xn(i.serializer,s)}}if(n instanceof ce){const s=new ce(n.seconds,1e3*Math.floor(n.nanoseconds/1e3));return{timestampValue:xn(i.serializer,s)}}if(n instanceof ts)return{geoPointValue:{latitude:n.latitude,longitude:n.longitude}};if(n instanceof tt)return{bytesValue:fc(i.serializer,n._byteString)};if(n instanceof ue){const s=i.databaseId,a=n.firestore._databaseId;if(!a.isEqual(s))throw i.Bu(`Document reference is for database ${a.projectId}/${a.database} but should be for database ${s.projectId}/${s.database}`);return{referenceValue:ro(n.firestore._databaseId||i.databaseId,n._key.path)}}if(n instanceof ns)return u=i,{mapValue:{fields:{__type__:{stringValue:"__vector__"},value:{arrayValue:{values:n.toArray().map(l=>{if("number"!=typeof l)throw u.Bu("VectorValues must only contain numeric values.");return Js(u.serializer,l)})}}}}};var u;throw i.Bu(`Unsupported field value: ${Zi(n)}`)}(r,e)}function ad(r,e){const t={};return hl(r)?e.path&&e.path.length>0&&e.fieldMask.push(e.path):Tt(r,(n,i)=>{const s=rn(i,e.Mu(n));null!=s&&(t[n]=s)}),{mapValue:{fields:t}}}function ud(r){return!("object"!=typeof r||null===r||r instanceof Array||r instanceof Date||r instanceof ce||r instanceof ts||r instanceof tt||r instanceof ue||r instanceof tn||r instanceof ns)}function Ja(r,e,t){if(!ud(t)||"object"!=typeof(i=t)||null===i||Object.getPrototypeOf(i)!==Object.prototype&&null!==Object.getPrototypeOf(i)){const n=Zi(t);throw e.Bu("an object"===n?r+" a custom object":r+" "+n)}var i}function Lr(r,e,t){if((e=(0,ee.Ku)(e))instanceof ct)return e._internalPath;if("string"==typeof e)return ss(r,e);throw os("Field path arguments must be of type string or ",r,!1,void 0,t)}const lp=new RegExp("[~\\*/\\[\\]]");function ss(r,e,t){if(e.search(lp)>=0)throw os(`Invalid field path (${e}). Paths must not contain '~', '*', '/', '[', or ']'`,r,!1,void 0,t);try{return new ct(...e.split("."))._internalPath}catch{throw os(`Invalid field path (${e}). Paths must not be empty, begin with '.', end with '.', or contain '..'`,r,!1,void 0,t)}}function os(r,e,t,n,i){const s=n&&!n.isEmpty(),a=void 0!==i;let u=`Function ${e}() called with invalid data`;t&&(u+=" (via `toFirestore()`)"),u+=". ";let l="";return(s||a)&&(l+=" (found",s&&(l+=` in field ${n}`),a&&(l+=` in document ${i}`),l+=")"),new C(V.INVALID_ARGUMENT,u+r+l)}function ld(r,e){return r.some(t=>t.isEqual(e))}class Br{constructor(e,t,n,i,s){this._firestore=e,this._userDataWriter=t,this._key=n,this._document=i,this._converter=s}get id(){return this._key.path.lastSegment()}get ref(){return new ue(this._firestore,this._converter,this._key)}exists(){return null!==this._document}data(){if(this._document){if(this._converter){const e=new cp(this._firestore,this._userDataWriter,this._key,this._document,null);return this._converter.fromFirestore(e)}return this._userDataWriter.convertValue(this._document.data.value)}}get(e){if(this._document){const t=this._document.data.field(as("DocumentSnapshot.get",e));if(null!==t)return this._userDataWriter.convertValue(t)}}}class cp extends Br{data(){return super.data()}}function as(r,e){return"string"==typeof e?ss(r,e):e instanceof ct?e._internalPath:e._delegate._internalPath}function cd(r){if("L"===r.limitType&&0===r.explicitOrderBy.length)throw new C(V.UNIMPLEMENTED,"limitToLast() queries require specifying at least one orderBy() clause")}class Ya{}class Ur extends Ya{}function Dt(r,e,...t){let n=[];e instanceof Ya&&n.push(e),n=n.concat(t),function(s){const a=s.filter(l=>l instanceof Hn).length,u=s.filter(l=>l instanceof qr).length;if(a>1||a>0&&u>0)throw new C(V.INVALID_ARGUMENT,"InvalidQuery. When using composite filters, you cannot use more than one filter at the top level. Consider nesting the multiple filters within an `and(...)` statement. For example: change `query(query, where(...), or(...))` to `query(query, and(where(...), or(...)))`.")}(n);for(const i of n)r=i._apply(r);return r}class qr extends Ur{constructor(e,t,n){super(),this._field=e,this._op=t,this._value=n,this.type="where"}static _create(e,t,n){return new qr(e,t,n)}_apply(e){const t=this._parse(e);return md(e._query,t),new Pe(e.firestore,e.converter,Qs(e._query,t))}_parse(e){const t=nn(e.firestore);return function(s,a,u,l,h,f,_){let p;if(h.isKeyField()){if("array-contains"===f||"array-contains-any"===f)throw new C(V.INVALID_ARGUMENT,`Invalid Query. You can't perform '${f}' queries on documentId().`);if("in"===f||"not-in"===f){fd(_,f);const R=[];for(const x of _)R.push(dd(l,s,x));p={arrayValue:{values:R}}}else p=dd(l,s,_)}else"in"!==f&&"not-in"!==f&&"array-contains-any"!==f||fd(_,f),p=od(u,"where",_,"in"===f||"not-in"===f);return J.create(h,f,p)}(e._query,0,t,e.firestore._databaseId,this._field,this._op,this._value)}}class Hn extends Ya{constructor(e,t){super(),this.type=e,this._queryConstraints=t}static _create(e,t){return new Hn(e,t)}_parse(e){const t=this._queryConstraints.map(n=>n._parse(e)).filter(n=>n.getFilters().length>0);return 1===t.length?t[0]:te.create(t,this._getOperator())}_apply(e){const t=this._parse(e);return 0===t.getFilters().length?e:(function(i,s){let a=i;const u=s.getFlattenedFilters();for(const l of u)md(a,l),a=Qs(a,l)}(e._query,t),new Pe(e.firestore,e.converter,Qs(e._query,t)))}_getQueryConstraints(){return this._queryConstraints}_getOperator(){return"and"===this.type?"and":"or"}}class Xa extends Ur{constructor(e,t){super(),this._field=e,this._direction=t,this.type="orderBy"}static _create(e,t){return new Xa(e,t)}_apply(e){const t=function(i,s,a){if(null!==i.startAt)throw new C(V.INVALID_ARGUMENT,"Invalid query. You must not call startAt() or startAfter() before calling orderBy().");if(null!==i.endAt)throw new C(V.INVALID_ARGUMENT,"Invalid query. You must not call endAt() or endBefore() before calling orderBy().");return new fr(s,a)}(e._query,this._field,this._direction);return new Pe(e.firestore,e.converter,function(i,s){const a=i.explicitOrderBy.concat([s]);return new st(i.path,i.collectionGroup,a,i.filters.slice(),i.limit,i.limitType,i.startAt,i.endAt)}(e._query,t))}}class us extends Ur{constructor(e,t,n){super(),this.type=e,this._limit=t,this._limitType=n}static _create(e,t,n){return new us(e,t,n)}_apply(e){return new Pe(e.firestore,e.converter,Ri(e._query,this._limit,this._limitType))}}class ls extends Ur{constructor(e,t,n){super(),this.type=e,this._docOrFields=t,this._inclusive=n}static _create(e,t,n){return new ls(e,t,n)}_apply(e){const t=hd(e,this.type,this._docOrFields,this._inclusive);return new Pe(e.firestore,e.converter,(s=t,new st((i=e._query).path,i.collectionGroup,i.explicitOrderBy.slice(),i.filters.slice(),i.limit,i.limitType,s,i.endAt)));var i,s}}class cs extends Ur{constructor(e,t,n){super(),this.type=e,this._docOrFields=t,this._inclusive=n}static _create(e,t,n){return new cs(e,t,n)}_apply(e){const t=hd(e,this.type,this._docOrFields,this._inclusive);return new Pe(e.firestore,e.converter,(s=t,new st((i=e._query).path,i.collectionGroup,i.explicitOrderBy.slice(),i.filters.slice(),i.limit,i.limitType,i.startAt,s)));var i,s}}function hd(r,e,t,n){if(t[0]=(0,ee.Ku)(t[0]),t[0]instanceof Br)return function(s,a,u,l,h){if(!l)throw new C(V.NOT_FOUND,`Can't use a DocumentSnapshot that doesn't exist for ${u}().`);const f=[];for(const _ of wn(s))if(_.field.isKeyField())f.push(Gt(a,l.key));else{const p=l.data.field(_.field);if(pi(p))throw new C(V.INVALID_ARGUMENT,'Invalid query. You are trying to start or end a query using a document for which the field "'+_.field+'" is an uncommitted server timestamp. (Since the value of this field is unknown, you cannot start/end a query with it.)');if(null===p){const R=_.field.canonicalString();throw new C(V.INVALID_ARGUMENT,`Invalid query. You are trying to start or end a query using a document for which the field '${R}' (used as the orderBy) does not exist.`)}f.push(p)}return new Rt(f,h)}(r._query,r.firestore._databaseId,e,t[0]._document,n);{const i=nn(r.firestore);return function(a,u,l,h,f,_){const p=a.explicitOrderBy;if(f.length>p.length)throw new C(V.INVALID_ARGUMENT,`Too many arguments provided to ${h}(). The number of arguments must be less than or equal to the number of orderBy() clauses`);const R=[];for(let x=0;x<f.length;x++){const k=f[x];if(p[x].field.isKeyField()){if("string"!=typeof k)throw new C(V.INVALID_ARGUMENT,`Invalid query. Expected a string for document ID in ${h}(), but got a ${typeof k}`);if(!Ws(a)&&-1!==k.indexOf("/"))throw new C(V.INVALID_ARGUMENT,`Invalid query. When querying a collection and ordering by documentId(), the value passed to ${h}() must be a plain document ID, but '${k}' contains a slash.`);const D=a.path.child(H.fromString(k));if(!O.isDocumentKey(D))throw new C(V.INVALID_ARGUMENT,`Invalid query. When querying a collection group and ordering by documentId(), the value passed to ${h}() must result in a valid document path, but '${D}' is not because it contains an odd number of segments.`);const U=new O(D);R.push(Gt(u,U))}else{const D=od(l,h,k);R.push(D)}}return new Rt(R,_)}(r._query,r.firestore._databaseId,i,e,t,n)}}function dd(r,e,t){if("string"==typeof(t=(0,ee.Ku)(t))){if(""===t)throw new C(V.INVALID_ARGUMENT,"Invalid query. When querying with documentId(), you must provide a valid document ID, but it was an empty string.");if(!Ws(e)&&-1!==t.indexOf("/"))throw new C(V.INVALID_ARGUMENT,`Invalid query. When querying a collection by documentId(), you must provide a plain document ID, but '${t}' contains a '/' character.`);const n=e.path.child(H.fromString(t));if(!O.isDocumentKey(n))throw new C(V.INVALID_ARGUMENT,`Invalid query. When querying a collection group by documentId(), the value provided must result in a valid document path, but '${n}' is not because it has an odd number of segments (${n.length}).`);return Gt(r,new O(n))}if(t instanceof ue)return Gt(r,t._key);throw new C(V.INVALID_ARGUMENT,`Invalid query. When querying with documentId(), you must provide a valid string or a DocumentReference, but it was: ${Zi(t)}.`)}function fd(r,e){if(!Array.isArray(r)||0===r.length)throw new C(V.INVALID_ARGUMENT,`Invalid Query. A non-empty array is required for '${e.toString()}' filters.`)}function md(r,e){const t=function(i,s){for(const a of i)for(const u of a.getFlattenedFilters())if(s.indexOf(u.op)>=0)return u.op;return null}(r.filters,function(i){switch(i){case"!=":return["!=","not-in"];case"array-contains-any":case"in":return["not-in"];case"not-in":return["array-contains-any","in","not-in","!="];default:return[]}}(e.op));if(null!==t)throw new C(V.INVALID_ARGUMENT,t===e.op?`Invalid query. You cannot use more than one '${e.op.toString()}' filter.`:`Invalid query. You cannot use '${e.op.toString()}' filters with '${t.toString()}' filters.`)}class Za{convertValue(e,t="none"){switch(At(e)){case 0:return null;case 1:return e.booleanValue;case 2:return he(e.integerValue||e.doubleValue);case 3:return this.convertTimestamp(e.timestampValue);case 4:return this.convertServerTimestamp(e,t);case 5:return e.stringValue;case 6:return this.convertBytes(it(e.bytesValue));case 7:return this.convertReference(e.referenceValue);case 8:return this.convertGeoPoint(e.geoPointValue);case 9:return this.convertArray(e.arrayValue,t);case 11:return this.convertObject(e.mapValue,t);case 10:return this.convertVectorValue(e.mapValue);default:throw L()}}convertObject(e,t){return this.convertObjectMap(e.fields,t)}convertObjectMap(e,t="none"){const n={};return Tt(e,(i,s)=>{n[i]=this.convertValue(s,t)}),n}convertVectorValue(e){var t,n,i;const s=null===(i=null===(n=null===(t=e.fields)||void 0===t?void 0:t.value.arrayValue)||void 0===n?void 0:n.values)||void 0===i?void 0:i.map(a=>he(a.doubleValue));return new ns(s)}convertGeoPoint(e){return new ts(he(e.latitude),he(e.longitude))}convertArray(e,t){return(e.values||[]).map(n=>this.convertValue(n,t))}convertServerTimestamp(e,t){switch(t){case"previous":const n=yi(e);return null==n?null:this.convertValue(n,t);case"estimate":return this.convertTimestamp(lr(e));default:return null}}convertTimestamp(e){const t=rt(e);return new ce(t.seconds,t.nanos)}convertDocumentKey(e,t){const n=H.fromString(e);B(Rc(n));const i=new Et(n.get(1),n.get(3)),s=new O(n.popFirst(5));return i.isEqual(t)||pe(`Document ${s} contains a document reference within a different database (${i.projectId}/${i.database}) which is not supported. It will be treated as a reference in the current database (${t.projectId}/${t.database}) instead.`),s}}function hs(r,e,t){let n;return n=r?t&&(t.merge||t.mergeFields)?r.toFirestore(e,t):r.toFirestore(e):e,n}class Ip extends Za{constructor(e){super(),this.firestore=e}convertBytes(e){return new tt(e)}convertReference(e){const t=this.convertDocumentKey(e,this.firestore._databaseId);return new ue(this.firestore,null,t)}}class sn{constructor(e,t){this.hasPendingWrites=e,this.fromCache=t}isEqual(e){return this.hasPendingWrites===e.hasPendingWrites&&this.fromCache===e.fromCache}}class ht extends Br{constructor(e,t,n,i,s,a){super(e,t,n,i,a),this._firestore=e,this._firestoreImpl=e,this.metadata=s}exists(){return super.exists()}data(e={}){if(this._document){if(this._converter){const t=new zr(this._firestore,this._userDataWriter,this._key,this._document,this.metadata,null);return this._converter.fromFirestore(t,e)}return this._userDataWriter.convertValue(this._document.data.value,e.serverTimestamps)}}get(e,t={}){if(this._document){const n=this._document.data.field(as("DocumentSnapshot.get",e));if(null!==n)return this._userDataWriter.convertValue(n,t.serverTimestamps)}}}class zr extends ht{data(e={}){return super.data(e)}}class Nt{constructor(e,t,n,i){this._firestore=e,this._userDataWriter=t,this._snapshot=i,this.metadata=new sn(i.hasPendingWrites,i.fromCache),this.query=n}get docs(){const e=[];return this.forEach(t=>e.push(t)),e}get size(){return this._snapshot.docs.size}get empty(){return 0===this.size}forEach(e,t){this._snapshot.docs.forEach(n=>{e.call(t,new zr(this._firestore,this._userDataWriter,n.key,n,new sn(this._snapshot.mutatedKeys.has(n.key),this._snapshot.fromCache),this.query.converter))})}docChanges(e={}){const t=!!e.includeMetadataChanges;if(t&&this._snapshot.excludesMetadataChanges)throw new C(V.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===t||(this._cachedChanges=function(i,s){if(i._snapshot.oldDocs.isEmpty()){let a=0;return i._snapshot.docChanges.map(u=>({type:"added",doc:new zr(i._firestore,i._userDataWriter,u.doc.key,u.doc,new sn(i._snapshot.mutatedKeys.has(u.doc.key),i._snapshot.fromCache),i.query.converter),oldIndex:-1,newIndex:a++}))}{let a=i._snapshot.oldDocs;return i._snapshot.docChanges.filter(u=>s||3!==u.type).map(u=>{const l=new zr(i._firestore,i._userDataWriter,u.doc.key,u.doc,new sn(i._snapshot.mutatedKeys.has(u.doc.key),i._snapshot.fromCache),i.query.converter);let h=-1,f=-1;return 0!==u.type&&(h=a.indexOf(u.doc.key),a=a.delete(u.doc.key)),1!==u.type&&(a=a.add(u.doc),f=a.indexOf(u.doc.key)),{type:Ep(u.type),doc:l,oldIndex:h,newIndex:f}})}}(this,t),this._cachedChangesIncludeMetadataChanges=t),this._cachedChanges}}function Ep(r){switch(r){case 0:return"added";case 2:case 3:return"modified";case 1:return"removed";default:return L()}}function gd(r,e){return r instanceof ht&&e instanceof ht?r._firestore===e._firestore&&r._key.isEqual(e._key)&&(null===r._document?null===e._document:r._document.isEqual(e._document))&&r._converter===e._converter:r instanceof Nt&&e instanceof Nt&&r._firestore===e._firestore&&qa(r.query,e.query)&&r.metadata.isEqual(e.metadata)&&r._snapshot.isEqual(e._snapshot)}class kt extends Za{constructor(e){super(),this.firestore=e}convertBytes(e){return new tt(e)}convertReference(e){const t=this.convertDocumentKey(e,this.firestore._databaseId);return new ue(this.firestore,null,t)}}function pd(r,e,t){r=Q(r,ue);const n=Q(r.firestore,re),i=hs(r.converter,e,t);return Jn(n,[is(nn(n),"setDoc",r._key,i,null!==r.converter,t).toMutation(r._key,de.none())])}function yd(r,e,t,...n){r=Q(r,ue);const i=Q(r.firestore,re),s=nn(i);let a;return a="string"==typeof(e=(0,ee.Ku)(e))||e instanceof ct?Ha(s,"updateDoc",r._key,e,t,n):Qa(s,"updateDoc",r._key,e),Jn(i,[a.toMutation(r._key,de.exists(!0))])}function Id(r,...e){var t,n,i;r=(0,ee.Ku)(r);let s={includeMetadataChanges:!1,source:"default"},a=0;"object"!=typeof e[a]||za(e[a])||(s=e[a],a++);const u={includeMetadataChanges:s.includeMetadataChanges,source:s.source};if(za(e[a])){const _=e[a];e[a]=null===(t=_.next)||void 0===t?void 0:t.bind(_),e[a+1]=null===(n=_.error)||void 0===n?void 0:n.bind(_),e[a+2]=null===(i=_.complete)||void 0===i?void 0:i.bind(_)}let l,h,f;if(r instanceof ue)h=Q(r.firestore,re),f=An(r._key.path),l={next:_=>{e[a]&&e[a](eu(h,r,_))},error:e[a+1],complete:e[a+2]};else{const _=Q(r,Pe);h=Q(_.firestore,re),f=_._query;const p=new kt(h);l={next:R=>{e[a]&&e[a](new Nt(h,p,_,R))},error:e[a+1],complete:e[a+2]},cd(r._query)}return function(p,R,x,k){const D=new Yi(k),U=new na(R,D,x);return p.asyncQueue.enqueueAndForget((0,b.A)(function*(){return Jo(yield Qn(p),U)})),()=>{D.Za(),p.asyncQueue.enqueueAndForget((0,b.A)(function*(){return Xo(yield Qn(p),U)}))}}(fe(h),f,u,l)}function Jn(r,e){return function(n,i){const s=new ve;return n.asyncQueue.enqueueAndForget((0,b.A)(function*(){return function pg(r,e,t){return ca.apply(this,arguments)}(yield La(n),i,s)})),s.promise}(fe(r),e)}function eu(r,e,t){const n=t.docs.get(e._key),i=new kt(r);return new ht(r,i,e._key,n,new sn(t.hasPendingWrites,t.fromCache),e.converter)}const Bp={maxAttempts:5};class Td{constructor(e,t){this._firestore=e,this._commitHandler=t,this._mutations=[],this._committed=!1,this._dataReader=nn(e)}set(e,t,n){this._verifyNotCommitted();const i=Ft(e,this._firestore),s=hs(i.converter,t,n),a=is(this._dataReader,"WriteBatch.set",i._key,s,null!==i.converter,n);return this._mutations.push(a.toMutation(i._key,de.none())),this}update(e,t,n,...i){this._verifyNotCommitted();const s=Ft(e,this._firestore);let a;return a="string"==typeof(t=(0,ee.Ku)(t))||t instanceof ct?Ha(this._dataReader,"WriteBatch.update",s._key,t,n,i):Qa(this._dataReader,"WriteBatch.update",s._key,t),this._mutations.push(a.toMutation(s._key,de.exists(!0))),this}delete(e){this._verifyNotCommitted();const t=Ft(e,this._firestore);return this._mutations=this._mutations.concat(new bn(t._key,de.none())),this}commit(){return this._verifyNotCommitted(),this._committed=!0,this._mutations.length>0?this._commitHandler(this._mutations):Promise.resolve()}_verifyNotCommitted(){if(this._committed)throw new C(V.FAILED_PRECONDITION,"A write batch can no longer be used after commit() has been called.")}}function Ft(r,e){if((r=(0,ee.Ku)(r)).firestore!==e)throw new C(V.INVALID_ARGUMENT,"Provided document reference is from a different Firestore instance.");return r}class Up extends class{constructor(t,n){this._firestore=t,this._transaction=n,this._dataReader=nn(t)}get(t){const n=Ft(t,this._firestore),i=new Ip(this._firestore);return this._transaction.lookup([n._key]).then(s=>{if(!s||1!==s.length)return L();const a=s[0];if(a.isFoundDocument())return new Br(this._firestore,i,a.key,a,n.converter);if(a.isNoDocument())return new Br(this._firestore,i,n._key,null,n.converter);throw L()})}set(t,n,i){const s=Ft(t,this._firestore),a=hs(s.converter,n,i),u=is(this._dataReader,"Transaction.set",s._key,a,null!==s.converter,i);return this._transaction.set(s._key,u),this}update(t,n,i,...s){const a=Ft(t,this._firestore);let u;return u="string"==typeof(n=(0,ee.Ku)(n))||n instanceof ct?Ha(this._dataReader,"Transaction.update",a._key,n,i,s):Qa(this._dataReader,"Transaction.update",a._key,n),this._transaction.update(a._key,u),this}delete(t){const n=Ft(t,this._firestore);return this._transaction.delete(n._key),this}}{constructor(e,t){super(e,t),this._firestore=e}get(e){const t=Ft(e,this._firestore),n=new kt(this._firestore);return super.get(e).then(i=>new ht(this._firestore,n,t._key,i._document,new sn(!1,!1),t.converter))}}function nu(r,e){if(void 0===e)return{merge:!1};if(void 0!==e.mergeFields&&void 0!==e.merge)throw new C("invalid-argument",`Invalid options passed to function ${r}(): You cannot specify both "merge" and "mergeFields".`);return e}function wd(){if(typeof Uint8Array>"u")throw new C("unimplemented","Uint8Arrays are not available in this environment.")}function Rd(){if(!function Tm(){return typeof atob<"u"}())throw new C("unimplemented","Blobs are unavailable in Firestore in this environment.")}!function(e,t=!0){_n=hi.SDK_VERSION,(0,hi._registerComponent)(new Mu.uA("firestore",(n,{instanceIdentifier:i,options:s})=>{const a=n.getProvider("app").getImmediate(),u=new re(new $f(n.getProvider("auth-internal")),new jf(n.getProvider("app-check-internal")),function(h,f){if(!Object.prototype.hasOwnProperty.apply(h.options,["projectId"]))throw new C(V.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');return new Et(h.options.projectId,f)}(a,i),a);return s=Object.assign({useFetchStreams:t},s),u._setSettings(s),u},"PUBLIC").setMultipleInstances(!0)),(0,hi.registerVersion)(Ku,"4.7.4",e),(0,hi.registerVersion)(Ku,"4.7.4","esm2017")}();class $r{constructor(e){this._delegate=e}static fromBase64String(e){return Rd(),new $r(tt.fromBase64String(e))}static fromUint8Array(e){return wd(),new $r(tt.fromUint8Array(e))}toBase64(){return Rd(),this._delegate.toBase64()}toUint8Array(){return wd(),this._delegate.toUint8Array()}isEqual(e){return this._delegate.isEqual(e._delegate)}toString(){return"Blob(base64: "+this.toBase64()+")"}}function ru(r){return function Jp(r,e){if("object"!=typeof r||null===r)return!1;const t=r;for(const n of e)if(n in t&&"function"==typeof t[n])return!0;return!1}(r,["next","error","complete"])}class Yp{enableIndexedDbPersistence(e,t){return function Yg(r,e){ze("enableIndexedDbPersistence() will be deprecated in the future, you can use `FirestoreSettings.cache` instead.");const t=r._freezeSettings();return nd(r,jn.provider,{build:n=>new Ca(n,t.cacheSizeBytes,null==e?void 0:e.forceOwnership)}),Promise.resolve()}(e._delegate,{forceOwnership:t})}enableMultiTabIndexedDbPersistence(e){return function Xg(r){return $a.apply(this,arguments)}(e._delegate)}clearIndexedDbPersistence(e){return function Zg(r){if(r._initialized&&!r._terminated)throw new C(V.FAILED_PRECONDITION,"Persistence can only be cleared before a Firestore instance is initialized or after it is terminated.");const e=new ve;return r._queue.enqueueAndForgetEvenWhileRestricted((0,b.A)(function*(){try{yield(t=(0,b.A)(function*(i){if(!He.D())return Promise.resolve();const s=i+"main";yield He.delete(s)}),function n(i){return t.apply(this,arguments)})(Io(r._databaseId,r._persistenceKey)),e.resolve()}catch(t){e.reject(t)}var t})),e.promise}(e._delegate)}}class Pd{constructor(e,t,n){this._delegate=t,this._persistenceProvider=n,this.INTERNAL={delete:()=>this.terminate()},e instanceof Et||(this._appCompat=e)}get _databaseId(){return this._delegate._databaseId}settings(e){const t=this._delegate._getSettings();!e.merge&&t.host!==e.host&&ze("You are overriding the original host. If you did not intend to override your settings, use {merge: true}."),e.merge&&delete(e=Object.assign(Object.assign({},t),e)).merge,this._delegate._setSettings(e)}useEmulator(e,t,n={}){!function Yh(r,e,t,n={}){var i;const s=(r=Q(r,Fr))._getSettings(),a=`${e}:${t}`;if("firestore.googleapis.com"!==s.host&&s.host!==a&&ze("Host has been set in both settings() and connectFirestoreEmulator(), emulator host will be used."),r._setSettings(Object.assign(Object.assign({},s),{host:a,ssl:!1})),n.mockUserToken){let u,l;if("string"==typeof n.mockUserToken)u=n.mockUserToken,l=Ee.MOCK_USER;else{u=(0,ee.Fy)(n.mockUserToken,null===(i=r._app)||void 0===i?void 0:i.options.projectId);const h=n.mockUserToken.sub||n.mockUserToken.user_id;if(!h)throw new C(V.INVALID_ARGUMENT,"mockUserToken must contain 'sub' or 'user_id' field!");l=new Ee(h)}r._authCredentials=new zf(new ju(u,l))}}(this._delegate,e,t,n)}enableNetwork(){return function tp(r){return function Og(r){return r.asyncQueue.enqueue((0,b.A)(function*(){const e=yield Bh(r),t=yield Uh(r);return e.setNetworkEnabled(!0),function(i){const s=F(i);return s.L_.delete(0),kr(s)}(t)}))}(fe(r=Q(r,re)))}(this._delegate)}disableNetwork(){return function np(r){return function Lg(r){return r.asyncQueue.enqueue((0,b.A)(function*(){const e=yield Bh(r),t=yield Uh(r);return e.setNetworkEnabled(!1),(n=(0,b.A)(function*(s){const a=F(s);a.L_.add(0),yield Ln(a),a.q_.set("Offline")}),function i(s){return n.apply(this,arguments)})(t);var n}))}(fe(r=Q(r,re)))}(this._delegate)}enablePersistence(e){let t=!1,n=!1;return e&&(t=!!e.synchronizeTabs,n=!!e.experimentalForceOwningTab,jh("synchronizeTabs",t,"experimentalForceOwningTab",n)),t?this._persistenceProvider.enableMultiTabIndexedDbPersistence(this):this._persistenceProvider.enableIndexedDbPersistence(this,n)}clearPersistence(){return this._persistenceProvider.clearIndexedDbPersistence(this)}terminate(){return this._appCompat&&(this._appCompat._removeServiceInstance("firestore-compat"),this._appCompat._removeServiceInstance("firestore")),this._delegate._delete()}waitForPendingWrites(){return function ep(r){return function(t){const n=new ve;return t.asyncQueue.enqueueAndForget((0,b.A)(function*(){return function Eg(r,e){return _a.apply(this,arguments)}(yield La(t),n)})),n.promise}(fe(r=Q(r,re)))}(this._delegate)}onSnapshotsInSync(e){return function xp(r,e){return function zg(r,e){const t=new Yi(e);return r.asyncQueue.enqueueAndForget((0,b.A)(function*(){return i=yield Qn(r),s=t,F(i).Y_.add(s),void s.next();var i,s})),()=>{t.Za(),r.asyncQueue.enqueueAndForget((0,b.A)(function*(){return i=yield Qn(r),s=t,void F(i).Y_.delete(s);var i,s}))}}(fe(r=Q(r,re)),za(e)?e:{next:e})}(this._delegate,e)}get app(){if(!this._appCompat)throw new C("failed-precondition","Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._appCompat}collection(e){try{return new Yn(this,Xh(this._delegate,e))}catch(t){throw Me(t,"collection()","Firestore.collection()")}}doc(e){try{return new je(this,es(this._delegate,e))}catch(t){throw Me(t,"doc()","Firestore.doc()")}}collectionGroup(e){try{return new Oe(this,function Qg(r,e){if(r=Q(r,Fr),Ua("collectionGroup","collection id",e),e.indexOf("/")>=0)throw new C(V.INVALID_ARGUMENT,`Invalid collection ID '${e}' passed to function collectionGroup(). Collection IDs must not contain '/'.`);return new Pe(r,null,(n=e,new st(H.emptyPath(),n)));var n}(this._delegate,e))}catch(t){throw Me(t,"collectionGroup()","Firestore.collectionGroup()")}}runTransaction(e){return function qp(r,e,t){r=Q(r,re);const n=Object.assign(Object.assign({},Bp),t);return function(s){if(s.maxAttempts<1)throw new C(V.INVALID_ARGUMENT,"Max attempts must be at least 1")}(n),function(s,a,u){const l=new ve;return s.asyncQueue.enqueueAndForget((0,b.A)(function*(){const h=yield function qh(r){return Xi(r).then(e=>e.datastore)}(s);new Fg(s.asyncQueue,h,u,a,l).au()})),l.promise}(fe(r),i=>e(new Up(r,i)),n)}(this._delegate,t=>e(new Vd(this,t)))}batch(){return fe(this._delegate),new Sd(new Td(this._delegate,e=>Jn(this._delegate,e)))}loadBundle(e){return function rp(r,e){const t=fe(r=Q(r,re)),n=new Hg;return function $g(r,e,t,n){const i=function(a,u){let l;return l="string"==typeof a?sc().encode(a):a,f=function(f,_){if(f instanceof Uint8Array)return Oh(f,_);if(f instanceof ArrayBuffer)return Oh(new Uint8Array(f),_);if(f instanceof ReadableStream)return f.getReader();throw new Error("Source of `toByteStreamReader` has to be a ArrayBuffer or ReadableStream")}(l),new Ng(f,u);var f}(t,Nr(e));r.asyncQueue.enqueueAndForget((0,b.A)(function*(){!function Dg(r,e,t){const n=F(r);var i;(i=(0,b.A)(function*(a,u,l){try{const h=yield u.getMetadata();if(yield function(x,k){const D=F(x),U=ye(k.createTime);return D.persistence.runTransaction("hasNewerBundle","readonly",$=>D.Gr.getBundleMetadata($,k.id)).then($=>!!$&&$.createTime.compareTo(U)>=0)}(a.localStore,h))return yield u.close(),l._completeWith({taskState:"Success",documentsLoaded:(x=h).totalDocuments,bytesLoaded:x.totalBytes,totalDocuments:x.totalDocuments,totalBytes:x.totalBytes}),Promise.resolve(new Set);l._updateProgress(Ph(h));const f=new lg(h,a.localStore,u.serializer);let _=yield u.Ua();for(;_;){const R=yield f.la(_);R&&l._updateProgress(R),_=yield u.Ua()}const p=yield f.complete();return yield lt(a,p.Ia,void 0),yield function(x,k){const D=F(x);return D.persistence.runTransaction("Save bundle","readwrite",U=>D.Gr.saveBundleMetadata(U,k))}(a.localStore,h),l._completeWith(p.progress),Promise.resolve(p.Pa)}catch(h){return ze("SyncEngine",`Loading bundle failed with ${h}`),l._failWith(h),Promise.resolve(new Set)}var x}),function s(a,u,l){return i.apply(this,arguments)})(n,e,t).then(i=>{n.sharedClientState.notifyBundleLoaded(i)})}(yield La(r),i,n)}))}(t,r._databaseId,e,n),n}(this._delegate,e)}namedQuery(e){return function ip(r,e){return function Gg(r,e){return r.asyncQueue.enqueue((0,b.A)(function*(){return function(n,i){const s=F(n);return s.persistence.runTransaction("Get named query","readonly",a=>s.Gr.getNamedQuery(a,i))}(yield Wn(r),e)}))}(fe(r=Q(r,re)),e).then(t=>t?new Pe(r,null,t.query):null)}(this._delegate,e).then(t=>t?new Oe(this,t):null)}}class fs extends Za{constructor(e){super(),this.firestore=e}convertBytes(e){return new $r(new tt(e))}convertReference(e){const t=this.convertDocumentKey(e,this.firestore._databaseId);return je.forKey(t,this.firestore,null)}}class Vd{constructor(e,t){this._firestore=e,this._delegate=t,this._userDataWriter=new fs(e)}get(e){const t=an(e);return this._delegate.get(t).then(n=>new Gr(this._firestore,new ht(this._firestore._delegate,this._userDataWriter,n._key,n._document,n.metadata,t.converter)))}set(e,t,n){const i=an(e);return n?(nu("Transaction.set",n),this._delegate.set(i,t,n)):this._delegate.set(i,t),this}update(e,t,n,...i){const s=an(e);return 2===arguments.length?this._delegate.update(s,t):this._delegate.update(s,t,n,...i),this}delete(e){const t=an(e);return this._delegate.delete(t),this}}class Sd{constructor(e){this._delegate=e}set(e,t,n){const i=an(e);return n?(nu("WriteBatch.set",n),this._delegate.set(i,t,n)):this._delegate.set(i,t),this}update(e,t,n,...i){const s=an(e);return 2===arguments.length?this._delegate.update(s,t):this._delegate.update(s,t,n,...i),this}delete(e){const t=an(e);return this._delegate.delete(t),this}commit(){return this._delegate.commit()}}class on{constructor(e,t,n){this._firestore=e,this._userDataWriter=t,this._delegate=n}fromFirestore(e,t){const n=new zr(this._firestore._delegate,this._userDataWriter,e._key,e._document,e.metadata,null);return this._delegate.fromFirestore(new Kr(this._firestore,n),null!=t?t:{})}toFirestore(e,t){return t?this._delegate.toFirestore(e,t):this._delegate.toFirestore(e)}static getInstance(e,t){const n=on.INSTANCES;let i=n.get(e);i||(i=new WeakMap,n.set(e,i));let s=i.get(t);return s||(s=new on(e,new fs(e),t),i.set(t,s)),s}}on.INSTANCES=new WeakMap;class je{constructor(e,t){this.firestore=e,this._delegate=t,this._userDataWriter=new fs(e)}static forPath(e,t,n){if(e.length%2!=0)throw new C("invalid-argument",`Invalid document reference. Document references must have an even number of segments, but ${e.canonicalString()} has ${e.length}`);return new je(t,new ue(t._delegate,n,new O(e)))}static forKey(e,t,n){return new je(t,new ue(t._delegate,n,e))}get id(){return this._delegate.id}get parent(){return new Yn(this.firestore,this._delegate.parent)}get path(){return this._delegate.path}collection(e){try{return new Yn(this.firestore,Xh(this._delegate,e))}catch(t){throw Me(t,"collection()","DocumentReference.collection()")}}isEqual(e){return(e=(0,ee.Ku)(e))instanceof ue&&Zh(this._delegate,e)}set(e,t){t=nu("DocumentReference.set",t);try{return t?pd(this._delegate,e,t):pd(this._delegate,e)}catch(n){throw Me(n,"setDoc()","DocumentReference.set()")}}update(e,t,...n){try{return 1===arguments.length?yd(this._delegate,e):yd(this._delegate,e,t,...n)}catch(i){throw Me(i,"updateDoc()","DocumentReference.update()")}}delete(){return function Sp(r){return Jn(Q(r.firestore,re),[new bn(r._key,de.none())])}(this._delegate)}onSnapshot(...e){const t=bd(e),n=xd(e,i=>new Gr(this.firestore,new ht(this.firestore._delegate,this._userDataWriter,i._key,i._document,i.metadata,this._delegate.converter)));return Id(this._delegate,t,n)}get(e){let t;return t="cache"===(null==e?void 0:e.source)?function Ap(r){r=Q(r,ue);const e=Q(r.firestore,re),t=fe(e),n=new kt(e);return function Bg(r,e){const t=new ve;return r.asyncQueue.enqueueAndForget((0,b.A)(function*(){return(n=(0,b.A)(function*(s,a,u){try{const l=yield function(f,_){const p=F(f);return p.persistence.runTransaction("read document","readonly",R=>p.localDocuments.getDocument(R,_))}(s,a);l.isFoundDocument()?u.resolve(l):l.isNoDocument()?u.resolve(null):u.reject(new C(V.UNAVAILABLE,"Failed to get document from cache. (However, this document may exist on the server. Run again without setting 'source' in the GetOptions to attempt to retrieve the document from the server.)"))}catch(l){const h=zn(l,`Failed to get document '${a} from cache`);u.reject(h)}}),function i(s,a,u){return n.apply(this,arguments)})(yield Wn(r),e,t);var n})),t.promise}(t,r._key).then(i=>new ht(e,n,r._key,i,new sn(null!==i&&i.hasLocalMutations,!0),r.converter))}(this._delegate):"server"===(null==e?void 0:e.source)?function wp(r){r=Q(r,ue);const e=Q(r.firestore,re);return zh(fe(e),r._key,{source:"server"}).then(t=>eu(e,r,t))}(this._delegate):function vp(r){r=Q(r,ue);const e=Q(r.firestore,re);return zh(fe(e),r._key).then(t=>eu(e,r,t))}(this._delegate),t.then(n=>new Gr(this.firestore,new ht(this.firestore._delegate,this._userDataWriter,n._key,n._document,n.metadata,this._delegate.converter)))}withConverter(e){return new je(this.firestore,this._delegate.withConverter(e?on.getInstance(this.firestore,e):null))}}function Me(r,e,t){return r.message=r.message.replace(e,t),r}function bd(r){for(const e of r)if("object"==typeof e&&!ru(e))return e;return{}}function xd(r,e){var t,n;let i;return i=ru(r[0])?r[0]:ru(r[1])?r[1]:"function"==typeof r[0]?{next:r[0],error:r[1],complete:r[2]}:{next:r[1],error:r[2],complete:r[3]},{next:s=>{i.next&&i.next(e(s))},error:null===(t=i.error)||void 0===t?void 0:t.bind(i),complete:null===(n=i.complete)||void 0===n?void 0:n.bind(i)}}class Gr{constructor(e,t){this._firestore=e,this._delegate=t}get ref(){return new je(this._firestore,this._delegate.ref)}get id(){return this._delegate.id}get metadata(){return this._delegate.metadata}get exists(){return this._delegate.exists()}data(e){return this._delegate.data(e)}get(e,t){return this._delegate.get(e,t)}isEqual(e){return gd(this._delegate,e._delegate)}}class Kr extends Gr{data(e){const t=this._delegate.data(e);return this._delegate._converter||function Uf(r){r||L()}(void 0!==t),t}}class Oe{constructor(e,t){this.firestore=e,this._delegate=t,this._userDataWriter=new fs(e)}where(e,t,n){try{return new Oe(this.firestore,Dt(this._delegate,function hp(r,e,t){const n=e,i=as("where",r);return qr._create(i,n,t)}(e,t,n)))}catch(i){throw Me(i,/(orderBy|where)\(\)/,"Query.$1()")}}orderBy(e,t){try{return new Oe(this.firestore,Dt(this._delegate,function dp(r,e="asc"){const t=e,n=as("orderBy",r);return Xa._create(n,t)}(e,t)))}catch(n){throw Me(n,/(orderBy|where)\(\)/,"Query.$1()")}}limit(e){try{return new Oe(this.firestore,Dt(this._delegate,function fp(r){return Hh("limit",r),us._create("limit",r,"F")}(e)))}catch(t){throw Me(t,"limit()","Query.limit()")}}limitToLast(e){try{return new Oe(this.firestore,Dt(this._delegate,function mp(r){return Hh("limitToLast",r),us._create("limitToLast",r,"L")}(e)))}catch(t){throw Me(t,"limitToLast()","Query.limitToLast()")}}startAt(...e){try{return new Oe(this.firestore,Dt(this._delegate,function _p(...r){return ls._create("startAt",r,!0)}(...e)))}catch(t){throw Me(t,"startAt()","Query.startAt()")}}startAfter(...e){try{return new Oe(this.firestore,Dt(this._delegate,function gp(...r){return ls._create("startAfter",r,!1)}(...e)))}catch(t){throw Me(t,"startAfter()","Query.startAfter()")}}endBefore(...e){try{return new Oe(this.firestore,Dt(this._delegate,function pp(...r){return cs._create("endBefore",r,!1)}(...e)))}catch(t){throw Me(t,"endBefore()","Query.endBefore()")}}endAt(...e){try{return new Oe(this.firestore,Dt(this._delegate,function yp(...r){return cs._create("endAt",r,!0)}(...e)))}catch(t){throw Me(t,"endAt()","Query.endAt()")}}isEqual(e){return qa(this._delegate,e._delegate)}get(e){let t;return t="cache"===(null==e?void 0:e.source)?function Pp(r){r=Q(r,Pe);const e=Q(r.firestore,re),t=fe(e),n=new kt(e);return function Ug(r,e){const t=new ve;return r.asyncQueue.enqueueAndForget((0,b.A)(function*(){return(n=(0,b.A)(function*(s,a,u){try{const l=yield zi(s,a,!0),h=new bh(a,l.Ts),f=h.ma(l.documents),_=h.applyChanges(f,!1);u.resolve(_.snapshot)}catch(l){const h=zn(l,`Failed to execute query '${a} against cache`);u.reject(h)}}),function i(s,a,u){return n.apply(this,arguments)})(yield Wn(r),e,t);var n})),t.promise}(t,r._query).then(i=>new Nt(e,n,r,i))}(this._delegate):"server"===(null==e?void 0:e.source)?function Vp(r){r=Q(r,Pe);const e=Q(r.firestore,re),t=fe(e),n=new kt(e);return $h(t,r._query,{source:"server"}).then(i=>new Nt(e,n,r,i))}(this._delegate):function Rp(r){r=Q(r,Pe);const e=Q(r.firestore,re),t=fe(e),n=new kt(e);return cd(r._query),$h(t,r._query).then(i=>new Nt(e,n,r,i))}(this._delegate),t.then(n=>new iu(this.firestore,new Nt(this.firestore._delegate,this._userDataWriter,this._delegate,n._snapshot)))}onSnapshot(...e){const t=bd(e),n=xd(e,i=>new iu(this.firestore,new Nt(this.firestore._delegate,this._userDataWriter,this._delegate,i._snapshot)));return Id(this._delegate,t,n)}withConverter(e){return new Oe(this.firestore,this._delegate.withConverter(e?on.getInstance(this.firestore,e):null))}}class Zp{constructor(e,t){this._firestore=e,this._delegate=t}get type(){return this._delegate.type}get doc(){return new Kr(this._firestore,this._delegate.doc)}get oldIndex(){return this._delegate.oldIndex}get newIndex(){return this._delegate.newIndex}}class iu{constructor(e,t){this._firestore=e,this._delegate=t}get query(){return new Oe(this._firestore,this._delegate.query)}get metadata(){return this._delegate.metadata}get size(){return this._delegate.size}get empty(){return this._delegate.empty}get docs(){return this._delegate.docs.map(e=>new Kr(this._firestore,e))}docChanges(e){return this._delegate.docChanges(e).map(t=>new Zp(this._firestore,t))}forEach(e,t){this._delegate.forEach(n=>{e.call(t,new Kr(this._firestore,n))})}isEqual(e){return gd(this._delegate,e._delegate)}}class Yn extends Oe{constructor(e,t){super(e,t),this.firestore=e,this._delegate=t}get id(){return this._delegate.id}get path(){return this._delegate.path}get parent(){const e=this._delegate.parent;return e?new je(this.firestore,e):null}doc(e){try{return new je(this.firestore,void 0===e?es(this._delegate):es(this._delegate,e))}catch(t){throw Me(t,"doc()","CollectionReference.doc()")}}add(e){return function bp(r,e){const t=Q(r.firestore,re),n=es(r),i=hs(r.converter,e);return Jn(t,[is(nn(r.firestore),"addDoc",n._key,i,null!==r.converter,{}).toMutation(n._key,de.exists(!1))]).then(()=>n)}(this._delegate,e).then(t=>new je(this.firestore,t))}isEqual(e){return Zh(this._delegate,e._delegate)}withConverter(e){return new Yn(this.firestore,this._delegate.withConverter(e?on.getInstance(this.firestore,e):null))}}function an(r){return Q(r,ue)}class su{constructor(...e){this._delegate=new ct(...e)}static documentId(){return new su(oe.keyField().canonicalString())}isEqual(e){return(e=(0,ee.Ku)(e))instanceof ct&&this._delegate._internalPath.isEqual(e._internalPath)}}class un{constructor(e){this._delegate=e}static serverTimestamp(){const e=function $p(){return new Ga("serverTimestamp")}();return e._methodName="FieldValue.serverTimestamp",new un(e)}static delete(){const e=function zp(){return new Or("deleteField")}();return e._methodName="FieldValue.delete",new un(e)}static arrayUnion(...e){const t=function Gp(...r){return new Ka("arrayUnion",r)}(...e);return t._methodName="FieldValue.arrayUnion",new un(t)}static arrayRemove(...e){const t=function Kp(...r){return new ja("arrayRemove",r)}(...e);return t._methodName="FieldValue.arrayRemove",new un(t)}static increment(e){const t=function jp(r){return new Wa("increment",r)}(e);return t._methodName="FieldValue.increment",new un(t)}isEqual(e){return this._delegate.isEqual(e._delegate)}}const ey={Firestore:Pd,GeoPoint:ts,Timestamp:ce,Blob:$r,Transaction:Vd,WriteBatch:Sd,DocumentReference:je,DocumentSnapshot:Gr,Query:Oe,QueryDocumentSnapshot:Kr,QuerySnapshot:iu,CollectionReference:Yn,FieldPath:su,FieldValue:un,setLogLevel:function Xp(r){!function Bf(r){pt.setLogLevel(r)}(r)},CACHE_SIZE_UNLIMITED:-1};!function ny(r){(function ty(r,e){r.INTERNAL.registerComponent(new Mu.uA("firestore-compat",t=>{const n=t.getProvider("app-compat").getImmediate(),i=t.getProvider("firestore").getImmediate();return e(n,i)},"PUBLIC").setServiceProps(Object.assign({},ey)))})(r,(e,t)=>new Pd(e,t,new Yp)),r.registerVersion("@firebase/firestore-compat","0.3.39")}(Of.A);var ou=ge(5407),dt=ge(4438);ge(7037);var uy=ge(1526);const my=(0,ou.S3)(uy.O5,!0);var _y=ge(7687),gy=ge(1740);let py=(()=>{var r;class e{constructor(n,i){this.firestore=n,this.authService=i,this.lastMessagesSubject=new Mf.t({})}updateLastMessage(n,i){this.lastMessagesSubject.next({...this.lastMessagesSubject.value,[n]:i})}getLastMessages(){return this.lastMessagesSubject.asObservable()}getMessages(n){return this.firestore.collection(`chats/${n}/messages`,i=>i.orderBy("timestamp")).valueChanges({idField:"id"})}getChatMessages(n){return this.firestore.collection(`chats/${n}/messages`,i=>i.orderBy("timestamp","asc")).valueChanges({idField:"id"}).pipe((0,fn.n)(i=>{const s=[...new Set(i.map(a=>a.senderId))];return(0,nr.z)([(0,gt.of)(i),...s.map(a=>this.firestore.doc(`users/${a}`).valueChanges())])}),(0,mn.T)(([i,...s])=>{const a=s.reduce((u,l)=>(l&&l.uid&&(u[l.uid]=l),u),{});return i.map(u=>({...u,sender:a[u.senderId]||{}}))}),(0,rr.W)(i=>(console.error("Error fetching chat messages:",i),(0,gt.of)([]))))}sendMessage(n,i){return(0,Ds.H)(this.authService.getCurrentUserId()).pipe((0,fn.n)(s=>{if(!s)throw new Error("User not authenticated");const a={content:i,senderId:s,timestamp:my()};return(0,Ds.H)(this.firestore.collection(`chats/${n}/messages`).add(a)).pipe((0,fn.n)(()=>this.firestore.collection("chats").doc(n).update({lastMessage:a})))}),(0,rr.W)(s=>(console.error("Error sending message:",s),(0,gt.of)(null))))}getOtherUser(n){return(0,nr.z)([this.firestore.doc(`chats/${n}`).valueChanges(),(0,Ds.H)(this.authService.getCurrentUserId())]).pipe((0,fn.n)(([i,s])=>{if(!s)throw new Error("User not authenticated");const a=i.participants.find(h=>h!==s);if(!a)return(0,gt.of)({fullName:"User",isOnline:!1});const u=this.firestore.doc(`users/${a}`).valueChanges(),l=this.firestore.doc(`userStatus/${a}`).valueChanges();return(0,nr.z)([u,l]).pipe((0,mn.T)(([h,f])=>({uid:a,fullName:(null==h?void 0:h.fullName)||"User",profilePictureUrl:(null==h?void 0:h.profilePictureUrl)||"./assets/profile-placeholder.jpg",isOnline:(null==f?void 0:f.isOnline)||!1})))}),(0,rr.W)(i=>(console.error("Error loading other user:",i),(0,gt.of)({fullName:"User",isOnline:!1}))))}getRecentChats(){return this.authService.getUserData$().pipe((0,fn.n)(n=>{const i=null==n?void 0:n.uid;if(!i)throw console.error("User ID not found"),new Error("User ID not found");return this.firestore.collection("chats",a=>a.where("participants","array-contains",i)).valueChanges({idField:"id"}).pipe((0,fn.n)(a=>{const u=a.map(l=>{const h=l.participants.find(f=>f!==i);return h?(console.log("Fetching user document:",`users/${h}`),this.firestore.doc(`users/${h}`).valueChanges().pipe((0,mn.T)(f=>(console.log("Fetched user data:",f),{...l,otherParticipant:{uid:h,fullName:(null==f?void 0:f.fullName)||"Unknown User",profilePictureUrl:null!=f&&f.profilePictureUrl&&""!==f.profilePictureUrl.trim()?f.profilePictureUrl:"./assets/profile-placeholder.jpg"},lastMessage:l.lastMessage||{content:"No messages yet"}})))):(0,gt.of)({...l,otherParticipant:{uid:"",fullName:"Unknown User",profilePictureUrl:"./assets/profile-placeholder.jpg"},lastMessage:l.lastMessage||{content:"No messages yet"}})});return(0,nr.z)(u)}),(0,mn.T)(a=>(console.log("Final processed chats:",a),a)),(0,rr.W)(a=>(console.error("Error fetching recent chats:",a),(0,gt.of)([]))))}))}getActiveUsers(){const n=this.firestore.collection("userStatus",i=>i.where("isOnline","==",!0));return(0,nr.z)([n.valueChanges({idField:"id"}),this.firestore.collection("users").valueChanges({idField:"id"})]).pipe((0,mn.T)(([i,s])=>s.filter(a=>i.some(u=>u.id===a.id))))}createOrGetChat(n){var i=this;return(0,b.A)(function*(){console.log("Creating or getting chat with userId:",n);try{const s=yield i.authService.getCurrentUserId();if(!s)return console.error("User is not authenticated"),null;const a=[s,n].sort();console.log("Participants:",a);const l=yield i.firestore.collection("chats",h=>h.where("participants","==",a)).get().toPromise();if(l.empty){console.log("No existing chat, creating a new one");const h=yield i.firestore.collection("chats").add({participants:a});return yield i.firestore.collection("chats").doc(h.id).update({createdAt:Fu.A.firestore.FieldValue.serverTimestamp()}),console.log("New chat created with ID:",h.id),h.id}return console.log("Existing chat found with ID:",l.docs[0].id),l.docs[0].id}catch(s){return console.error("Error executing Firestore query or creating chat:",s),null}})()}testCreateChatDocument(){var n=this;return(0,b.A)(function*(){try{const i=yield n.firestore.collection("chats").add({participants:["testUserId1","testUserId2"],createdAt:Fu.A.firestore.FieldValue.serverTimestamp()});console.log("Test chat created with ID:",i.id)}catch(i){console.error("Error creating test chat document:",i)}})()}getUserNameById(n){return this.firestore.doc(`users/${n}`).valueChanges().pipe((0,mn.T)(i=>(null==i?void 0:i.name)||`User #${n}`),(0,rr.W)(()=>(0,gt.of)(`User #${n}`)))}updateUserStatus(n,i){return this.firestore.collection("userStatus").doc(n).set({isOnline:i},{merge:!0})}}return(r=e).\u0275fac=function(n){return new(n||r)(dt.KVO(_y.Qe),dt.KVO(gy.k))},r.\u0275prov=dt.jDH({token:r,factory:r.\u0275fac,providedIn:"root"}),e})()}}]);